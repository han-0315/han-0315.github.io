---
layout: post
title: Calico ì•Œì•„ë³´ê¸°
date: 2024-09-15 09:00 +0900 
description: Calico ì•Œì•„ë³´ê¸°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS# ] 
pin: false
math: true
mermaid: true
---
Calico ì´í•´í•˜ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.



### ì‹¤ìŠµí™˜ê²½


AWSì—ì„œ ec2 x 4ea, Calico ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì›Œì»¤ ë…¸ë“œ í•˜ë‚˜ëŠ” ë³„ë„ì˜ ì„œë¸Œë„·ì— êµ¬ì„±í•œë‹¤.


**(AWSëŠ” ë‚´ë¶€ ë¼ìš°í„°ê°€ ìˆê¸°ì—, BGPâ†”ë¼ìš°í„° ì—°ë™ ì‹¤ìŠµì€ ì§„í–‰ë¶ˆê°€)


![image.png](/assets/img/post/Calico%20ì´í•´í•˜ê¸°/1.png)


ìŠ¤í„°ë””ì—ì„œ ì œê³µí•´ì£¼ì‹  CloudFormation íŒŒì¼ì€ ì•„ë˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆê³  ì£¼ìš” íŠ¹ì´ì ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

- Calicoê°€ k8s v1.31ì— ëŒ€í•œ stablesì´ í™•ì¸ë˜ì§€ ì•Šì•„, v1.30ìœ¼ë¡œ ì§„í–‰
- Calico Defaultì—ì„œ ê¸°ë³¸ IPv4 pool CIDR ë³€ê²½í•¨

```bash
curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/kans/**kans-3w.yaml**
```


## Calicoë€


[GitHub](https://github.com/projectcalico/calico)ì— ë‚˜ì™€ìˆëŠ” ì„¤ëª…ì„ ë³´ë©´, Tigeraì— ì˜í•´ ìƒì„±ë˜ê³  ê´€ë¦¬ë˜ê³  ìˆëŠ” CNI í”„ë¡œì íŠ¸ì´ë‹¤. í˜„ì¬ ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ê³  ìˆëŠ” ì†”ë£¨ì…˜ìœ¼ë¡œ 166ê°œêµ­ì—ì„œ ë§¤ì¼ 8ë°±ë§Œ ê°œ ì´ìƒì˜ ë…¸ë“œì—ì„œ ì‚¬ìš©ë˜ê³  ìˆë‹¤ê³  í•œë‹¤.


*TigeraëŠ” ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí‚¹ ë³´ì•ˆì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” ê¸°ì—…ì´ê³  Calico ê¸°ë°˜ Cloud ì„œë¹„ìŠ¤ì™€ EnterPrise ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•œë‹¤. 


### ì•„í‚¤í…ì²˜


![image.png](/assets/img/post/Calico%20ì´í•´í•˜ê¸°/2.png)


ê·¸ë¦¼ ì¶œì²˜: [https://docs.tigera.io/calico/latest/reference/architecture/overview](https://docs.tigera.io/calico/latest/reference/architecture/overview)


#### Component


ì£¼ìš” ìš”ì†Œë“¤ì„ ê°„ë‹¨íˆ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

- **Bird**(ì˜¤í”ˆì†ŒìŠ¤ ë¼ìš°íŒ… ë°ëª¬): **ìê¸° ë…¸ë“œì˜ íŒŒë“œ CIDR**ì„ BGP ë¼ìš°íŒ…ì„ í†µí•´ ë‹¤ë¥¸ ë…¸ë“œë“¤ì—ê²Œ **ê´‘ê³ **í•¨
	- BirdëŠ” ì£½ê¸°ì „ì—ë„ ì‹ í˜¸ë¥¼ ë‚ ë ¤ ë‹¤ë¥¸ ë…¸ë“œì—ê²Œ ì•Œë ¤ì¤€ë‹¤.
- **Felix:** Birdë¥¼ í†µí•´ íŒŒì•…í•œ **ë‹¤ë¥¸ ë…¸ë“œì˜ íŒŒë“œ CIDR**ì„ í˜¸ìŠ¤íŠ¸ **ë¼ìš°íŒ… í…Œì´ë¸”ì— ì—…ë°ì´íŠ¸** (iptables)
- **Confd:** calico ì„¤ì •, BGP ì„¤ì • ë³€ê²½ì´ **Birdì— ì ìš©**í•´ì£¼ëŠ” ì—­í• 
- **calico datastore:** Calico ê´€ë ¨ ì •ë³´ ì €ì¥
- **calico-IPAM**: IPAM(IP address management)ì´ë‹¤. k8s ë‚´ì¥ IPAMì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë³„ë„ IPAMì„ ì‚¬ìš©í•œë‹¤.
- **calico-kube-controllers**: calico ë™ì‘ ê´€ë ¨ ê°ì‹œ(watch)

*Calicoì—ì„œ ë¼ìš°íŒ… í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ê³¼ì •ì— ëŒ€í•œ ê·¸ë¦¼ì…ë‹ˆë‹¤.  


![image.png](/assets/img/post/Calico%20ì´í•´í•˜ê¸°/3.png)


#### ì‹¤ìŠµ ì§„í–‰


CloudFormation YAMLì„ ë°°í¬í•œë‹¤.


```bash
aws cloudformation deploy --template-file kans-3w.yaml --stack-name mylab --parameter-overrides KeyName={ìì‹ ì˜ key} SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32 --region ap-northeast-2
```


ë°°í¬ í›„ k8s-mì— í•´ë‹¹ë˜ëŠ” ec2ì— sshë¡œ ì ‘ì†í•œë‹¤.


```bash
ssh -i {key ê²½ë¡œ} ubuntu@{k8s-m public ip}
```


ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´, calicoctl ëª…ë ¹ì–´ë¥¼ í†µí•´ í˜„ì¬ ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.


ì•„ë˜ì˜ ì‚¬ì§„ê³¼ ê°™ì´ IPIPMODEì™€ Pod CIDRì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20ì´í•´í•˜ê¸°/4.png)


#### datastore


datastoreë¡œ kubernetesë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì€ kubernetes apiì™€ ì—°ê²°í•˜ì—¬ CRD í˜•ì‹ìœ¼ë¡œ etcdì— ì €ì¥í•œë‹¤ëŠ” í‘œí˜„ì´ë‹¤. ë°˜ë©´ etcdë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ë§ì€ etcd í´ëŸ¬ìŠ¤í„°ì™€ ì§ì ‘ ì—°ê²°í•˜ì—¬ ì„¤ì •ì„ key-value í˜•ì‹ìœ¼ë¡œ ì €ì¥í•œë‹¤.


í˜„ì¬ëŠ” kubernetes ëª¨ë“œì´ë‹ˆ CRDë¥¼ ì¡°íšŒí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë‚˜ì˜¨ë‹¤.


```bash
k get crd
NAME                                                  CREATED AT
bgpconfigurations.crd.projectcalico.org               2024-09-15T11:25:53Z
bgpfilters.crd.projectcalico.org                      2024-09-15T11:25:53Z
bgppeers.crd.projectcalico.org                        2024-09-15T11:25:53Z
blockaffinities.crd.projectcalico.org                 2024-09-15T11:25:53Z
caliconodestatuses.crd.projectcalico.org              2024-09-15T11:25:53Z
clusterinformations.crd.projectcalico.org             2024-09-15T11:25:53Z
felixconfigurations.crd.projectcalico.org             2024-09-15T11:25:53Z
globalnetworkpolicies.crd.projectcalico.org           2024-09-15T11:25:53Z
globalnetworksets.crd.projectcalico.org               2024-09-15T11:25:53Z
hostendpoints.crd.projectcalico.org                   2024-09-15T11:25:53Z
ipamblocks.crd.projectcalico.org                      2024-09-15T11:25:53Z
ipamconfigs.crd.projectcalico.org                     2024-09-15T11:25:53Z
ipamhandles.crd.projectcalico.org                     2024-09-15T11:25:53Z
ippools.crd.projectcalico.org                         2024-09-15T11:25:53Z
ipreservations.crd.projectcalico.org                  2024-09-15T11:25:53Z
kubecontrollersconfigurations.crd.projectcalico.org   2024-09-15T11:25:53Z
networkpolicies.crd.projectcalico.org                 2024-09-15T11:25:53Z
networksets.crd.projectcalico.org                     2024-09-15T11:25:53Z
```


etcd ëª¨ë“œë¡œ ì„¤ì •í•˜ëŠ” ë²•ì€ [ì—¬ê¸°](https://docs.tigera.io/calico/latest/operations/calicoctl/configure/etcd)ë¥¼ ì°¸ê³ í•˜ë©´ ëœë‹¤.


### IPAM


CNI ìš”êµ¬ì‚¬í•­ ì¤‘ì— í•˜ë‚˜ëŠ” IPAMì´ë‹¤. ì—¬ê¸°ì„œ calicoì— IPAMì„ í™•ì¸í•œë‹¤.


calicoctlì„ í†µí•´ ipam ì„¤ì •ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
calicoctl ipam show --show-blocks
+----------+-----------------+-----------+------------+--------------+
| GROUPING |      CIDR       | IPS TOTAL | IPS IN USE |   IPS FREE   |
+----------+-----------------+-----------+------------+--------------+
| IP Pool  | 172.16.0.0/16   |     65536 | 7 (0%)     | 65529 (100%) |
| Block    | 172.16.116.0/24 |       256 | 4 (2%)     | 252 (98%)    |
| Block    | 172.16.158.0/24 |       256 | 1 (0%)     | 255 (100%)   |
| Block    | 172.16.184.0/24 |       256 | 1 (0%)     | 255 (100%)   |
| Block    | 172.16.34.0/24  |       256 | 1 (0%)     | 255 (100%)   |
+----------+-----------------+-----------+------------+--------------+
```


ì´ê²ƒì€ k8s ë‚´ë¶€ IPAM ì •ë³´ì™€ ë‹¤ë¥´ë‹¤. ìœ„ì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´ calicoëŠ” ë³„ë„ì˜ IPAM í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•œë‹¤.


```bash
kubectl get node k8s-m -o json | jq '.spec.podCIDR'
"172.16.0.0/24"
```


ë¬¼ë¡  ë‚´ë¶€ local IPAM í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•  ìˆœ ìˆëŠ”ë°, í˜„ì¬ ì–´ë–¤ í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ëŠ” ì§€ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì•Œ ìˆ˜ ìˆë‹¤. 


```bash
root@k8s-m:~# cat /etc/cni/net.d/10-calico.conflist | jq '.plugins[0].ipam'
{
  "type": "calico-ipam"
}
```


### íŒŒë“œ í•˜ë‚˜ ìƒì„± í›„ iptables í™•ì¸


íŒŒë“œë¥¼ í•˜ë‚˜ ìƒì„±í•˜ê³  network interface ì •ë³´ë¥¼ í™•ì¸í•œë‹¤.


![image.png](/assets/img/post/Calico%20ì´í•´í•˜ê¸°/5.png)


ì•„ë˜ì™€ ê°™ì´ chainí•˜ë‚˜ê°€ ìƒì„±ë˜ê³ , chainí•˜ë‚˜ë‹¹ ì•„ë˜ì™€ ê°™ì€ iptables ì„¤ì •ì´ ìƒê¸´ë‹¤.


```bash
iptables -v --numeric --table filter --list cali-tw-calic9f294a6bbf
Chain cali-tw-calic9f294a6bbf (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:gdGCd7pAItfwyTLA */ ctstate RELATED,ESTABLISHED
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:JPvEc7l-QoWNA6WQ */ ctstate INVALID
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:JBLdNQgG6AU0aBoD */ MARK and 0xfffcffff
    0     0 cali-pri-kns.default  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:FxDPE7nrp1ZsAMQa */
    0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:VQd-z8yw78VeSlXp */ /* Return if profile accepted */
    0     0 cali-pri-ksa.default.default  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:_3kBlEdzM5JBdsV3 */
    0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:zQmrLF4vo1Sil_cI */ /* Return if profile accepted */
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:D-XKZRe8N6NYhdLa */ /* Drop if no profiles matched */
```


### ì •ë¦¬


ì—¬ê¸°ì„œëŠ” Calicoì˜ ì•„í‚¤í…ì²˜ì™€ ìš”ì†Œë“¤ì— ëŒ€í•´ ì‚´í´ë´¤ë‹¤. 

1. CalicoëŠ” Birdë¥¼ í†µí•´ ê° ë…¸ë“œë§ˆë‹¤ í˜¸ìŠ¤íŠ¸ì— ìœ„ì¹˜í•œ íŒŒë“œì˜ IP ëŒ€ì—­ì„ ë‹¤ë¥¸ ë…¸ë“œë“¤ì—ê²Œ ì•Œë ¤ì¤€ë‹¤.
2. ë³„ë„ì˜ IPAMì„ ì‚¬ìš©í•œë‹¤.
3. Datastoreë¡œëŠ” CRDë¥¼ ì´ìš©í•˜ì—¬ kubernetes APIë¥¼ í†µí•´ ì €ì¥í•œë‹¤. (etcdì— ì§ì ‘ ì €ì¥í• ìˆ˜ë„ ìˆë‹¤.)
