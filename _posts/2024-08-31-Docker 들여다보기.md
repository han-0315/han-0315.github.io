---
layout: post
title: Docker CI ì•Œì•„ë³´ê¸°
date: 2024-08-31 09:00 +0900 
description: Docker CI 
category: [Docker, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#1] 
pin: false
math: true
mermaid: true
---
KANS ìŠ¤í„°ë”” 1ì£¼ì°¨ Docker CI ì•Œì•„ë³´ê¸°

<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


### ë“¤ì–´ê°€ë©°


ì»¨í…Œì´ë„ˆ ê¸°ë°˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìš´ì˜í•˜ê³  ìˆë‹¤ë©´, CI ê³¼ì •ì—ì„œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œê°€ í•„ìš”í•˜ë‹¤. ì—¬ê¸°ì„œëŠ” Docker ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¸ í›„ ì§ì ‘ ì‘ì—…í•´ë³´ë©° ë¹Œë“œ ê³¼ì •ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œì ì„ ì‚´í´ë³¸ë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ Kanikoì™€ ê°™ì€ ëŒ€ì²´ë°©ì•ˆì„ ì‚´í´ë³´ë©° ë§ˆë¬´ë¦¬í•œë‹¤.


## Docker CI


Docker CIë¥¼ ìœ„í•´ì„  DinD(Docker in Docker) í˜¹ì€ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë„ dockerë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆê²Œ socket ë§ˆìš´íŠ¸ê°€ í•„ìš”í•˜ë‹¤. ìš°ì„  socketì— ëŒ€í•´ ì‚´í´ë³´ì.


#### socket


dockerëŠ” Unix domain-socketì„ ì‚¬ìš©í•œë‹¤. socketì„ í†µí•´ docker daemonê³¼ í†µì‹ í•˜ë¯€ë¡œ Hostì— ìˆëŠ” docker socketì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ë©´, ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë„ dockerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.


tcpë¥¼ ì‚¬ìš©í•˜ê²Œ ì„¤ì •í•˜ë©´, ë‹¤ë¥¸ ì„œë²„ì—ì„œë„ docker ë°ëª¬ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ k8së¼ëŠ” ì¢‹ì€ ë°©ë²•ì´ ìˆë‹¤.


```bash
lsof /run/docker.sock
COMMAND  PID USER   FD   TYPE             DEVICE SIZE/OFF  NODE NAME
systemd    1 root   40u  unix 0xffff966d51faddc0      0t0 31848 /run/docker.sock type=STREAM
dockerd 3966 root    4u  unix 0xffff966d51faddc0      0t0 31848 /run/docker.sock type=STREAM
```


### DinD vs mount docker.socket


ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ DinDì™€ socket ë§ˆìš´íŠ¸ ë°©ì‹ì„ ë¹„êµí•˜ì.


[docker community](https://forums.docker.com/t/docker-in-docker-vs-mounting-var-run-docker-sock/9450)ì™€ [jpetazzo Post](https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/)ì—ì„œ DinDì™€ docker.socket mountì˜ ì°¨ì´ê°€ ì˜ ì •ë¦¬ë˜ì–´ìˆë‹¤. ê°„ë‹¨í•˜ê²Œ ìš”ì•½í•˜ë©´, ì•„ë˜ì™€ ê°™ë‹¤.

1. `--privileged` ë¡œ ì¸í•´ SElinuxì™€ ê°™ì€ ë³´ì•ˆ ëª¨ë“ˆê³¼ ì¶©ëŒí•  ìˆ˜ ìˆë‹¤.
2. ë‚´ë¶€ DockerëŠ” COW ì‹œìŠ¤í…œ ìœ„ì—ì„œ ì‹¤í–‰ë˜ê¸°ì— ì—¬ëŸ¬ íŒŒì¼ì‹œìŠ¤í…œ ì¡°í•©ì´ ì‘ë™ë˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.

	 ex) AUFS on top of AUFS

3. ë„ì»¤ ì»¨í…Œì´ë„ˆì—ì„œ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•´ë„, Host Dockerì—ì„œ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë˜ë¯€ë¡œ ìºì‹œ íš¨ìœ¨ì„±ì´ ë†’ì•„ì§„ë‹¤.

ê²°ë¡ ì ìœ¼ë¡œ ë³´ì•ˆìƒ, ì„±ëŠ¥ ì°¨ì›ì—ì„œ DinDë³´ë‹¤ socket mount ë°©ì‹ì´ ê°•ë ¥íˆ ì¶”ì²œëœë‹¤. ì´ì œ socket mount ë°©ì‹ìœ¼ë¡œ ì»¨í…Œì´ë„ˆì•ˆì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.


#### í™˜ê²½


Jenkinsë¥¼ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ìœ¼ë¡œ ê°€ë™í•˜ê³ , í•´ë‹¹ ì»¨í…Œì´ë„ˆì— socketì„ ë§ˆìš´íŠ¸í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•œë‹¤.

- Jenkins ì»¨í…Œì´ë„ˆ ìƒì„±

```bash
docker run -d -p 8080:8080 -p 50000:50000 --name jenkins-server --restart=on-failure -v jenkins_home:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker jenkins/jenkins
```


ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•˜ë©´ Init ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
docker exec -it jenkins-server cat /var/jenkins_home/secrets/initialAdminPassword
```

- docker api ê°€ëŠ¥ì—¬ë¶€ í™•ì¸

docker api ì‚¬ìš©ê°€ëŠ¥ì—¬ë¶€ í™•ì¸í•´ë³´ë©´ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.


```bash
docker exec -it --user 0 jenkins-server docker ps
CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                                                                                      NAMES
86170af3b1ab   jenkins/jenkins   "/usr/bin/tini -- /uâ€¦"   44 seconds ago   Up 43 seconds   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp, 0.0.0.0:50000->50000/tcp, :::50000->50000/tcp   jenkins-server
```

- ì´ì œ rootê°€ ì•„ë‹Œ jenkins ìœ ì €ë„ dockerë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤.

```bash
docker exec -it --user 0 jenkins-server bash
root@8266345972f8:/# groupadd -for -g $(stat -c '%g' /var/run/docker.sock) docker
root@8266345972f8:/# usermod -aG docker jenkins

```


ì‹¤ì œ Jenkins ìœ ì €ë¡œ ì ‘ì†í•˜ì—¬ APIë¥¼ í™•ì¸í•œë‹¤.


```bash
docker ps
CONTAINER ID   IMAGE             COMMAND                  CREATED       STATUS       PORTS                                                                                      NAMES
8266345972f8   jenkins/jenkins   "/usr/bin/tini -- /uâ€¦"   1 hours ago   Up 1 hours   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp, 0.0.0.0:50000->50000/tcp, :::50000->50000/tcp   jenkins-server
```


ì„œë²„ì˜ IPì£¼ì†Œì˜ 8080 í¬íŠ¸ë¡œ ì ‘ì†í•˜ë©´, ì•„ë˜ì™€ ê°™ì´ Jenkinsë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Docker%20CI%20ì•Œì•„ë³´ê¸°/1.png)


docker pipeline pulginì„ ì„¤ì¹˜ í›„ ì•„ë˜ì™€ ê°™ì€ ê°„ë‹¨í•œ íŒŒì´í”„ë¼ì¸ì„ ë§Œë“ ë‹¤.


```groovy
pipeline {
    agent any

    stages {
        stage('Create Dockerfile and a.txt') {
            steps {
                script {
                    // a.txt íŒŒì¼ ìƒì„±
                    writeFile file: 'a.txt', text: "This is a simple file."
                    
                    // ê°„ë‹¨í•œ Dockerfile ìƒì„±
                    writeFile file: 'Dockerfile', text: """
                    FROM alpine:latest
                    COPY a.txt /a.txt
                    CMD ["cat", "/a.txt"]
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Docker ì´ë¯¸ì§€ ë¹Œë“œ
                    docker.build("simple-jenkins-image")
                }
            }
        }

        stage('Run Docker Image') {
            steps {
                script {
                    // ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•˜ê³  a.txt íŒŒì¼ì˜ ë‚´ìš©ì„ ì¶œë ¥
                    docker.image("simple-jenkins-image").inside {
                        sh 'cat /a.txt'
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
            // í•„ìš” ì‹œ í´ë¦°ì—… ì½”ë“œ ì¶”ê°€
        }
        success {
            echo 'Build completed successfully!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}

```


Jobì„ ì‹œì‘í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì˜ ë™ì‘í•œë‹¤.


![image.png](/assets/img/post/Docker%20CI%20ì•Œì•„ë³´ê¸°/2.png)


ë˜, í˜¸ìŠ¤íŠ¸ ì„œë²„ì—ì„œ ì´ë¯¸ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```groovy
root@MyServer:~# docker image ls
REPOSITORY             TAG       IMAGE ID       CREATED          SIZE
simple-jenkins-image   latest    f6943e3910a7   59 seconds ago   7.8MB
jenkins/jenkins        latest    fd13cb1b7315   2 days ago       471MB
alpine                 latest    324bc02ae123   5 weeks ago      7.8MB
```


### ëŒ€ì•ˆ ë°©ë²•


ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œì— Docker ìì²´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë°©ì‹ì´ ì¡´ì¬í•œë‹¤. 


#### kaniko


DinDëŠ” ë„ì»¤ìì²´ì—ì„œ sudo ê¶Œí•œì´ í•„ìš”í•˜ë¯€ë¡œ, ì»¨í…Œì´ë„ˆê°€ root ê¶Œí•œì„ ê°€ì§€ë©° ì´ëŠ” ë³´ì•ˆìƒ ì¢‹ì§€ ì•Šë‹¤. ì´ë¥¼ ìœ„í•´ Kanikoê°€ ë‚˜ì˜¤ê²Œëœë‹¤. ë£¨íŠ¸ ê¶Œí•œì—†ì´, ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•  ìˆ˜ ìˆëŠ” ë„êµ¬ì´ë‹¤. êµ¬ê¸€ì—ì„œ ë§Œë“¤ì—ˆìœ¼ë©°, ìœˆë„ìš° ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ëŠ” ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.


![kaniko-arch.webp](/assets/img/post/Docker%20CI%20ì•Œì•„ë³´ê¸°/3.webp)


ì¶œì²˜: [https://blog.nashtechglobal.com/deep-dive-into-kaniko-understanding-the-architecture-and-workflow/](https://blog.nashtechglobal.com/deep-dive-into-kaniko-understanding-the-architecture-and-workflow/)


GitLabìœ¼ë¡œ CI/CDë¥¼ êµ¬ì„±í–ˆì„ ë•Œ, DinDëŠ” root ê¶Œí•œì´ í•„ìš”í•˜ì—¬ ë³„ë„ë¡œ Runnerì— privileged ì˜µì…˜ì„ í—ˆìš©í•´ì¤˜ì•¼ í–ˆë‹¤. ì´ëŠ” ë³´ì•ˆìƒ ì¢‹ì§€ ì•Šê³ , GitLabì—ì„œë„ ì´ë¥¼ ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤. ë³„ë„ë¡œ Kanikoì— ëŒ€í•œ GitLab [ê°€ì´ë“œ ë¬¸ì„œ](https://docs.gitlab.com/ee/ci/docker/using_kaniko.html)ê°€ ìˆë‹¤. 


ë˜ ë‹¤ë¥¸ ë¹Œë“œë„êµ¬ë¡œëŠ” Buildkit, Buildahê°€ ìˆë‹¤ê³  í•œë‹¤. í•´ë‹¹ [í¬ìŠ¤íŠ¸](https://nangman14.tistory.com/92)ì—ì„œ ì˜ ì •ë¦¬ë˜ì–´ìˆë‹¤.

