---
layout: post
title: MetalLB ì•Œì•„ë³´ê¸°
date: 2024-10-03 09:00 +0900 
description: MetalLB ì•Œì•„ë³´ê¸°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#5, MetalLB, BGP, ARP] 
pin: false
math: true
mermaid: true
---
MetalLB ì•Œì•„ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


### ë“¤ì–´ê°€ë©°


4ì£¼ì°¨ì—ì„œëŠ” Service ë¦¬ì†ŒìŠ¤ì˜ ë°°ê²½ê³¼ ClusterIP, NodePort, LB Typeì— ëŒ€í•´ ê°„ëµí•˜ê²Œ ì‚´í´ë³´ê³  ClusterIPì™€ NodePortì— ëŒ€í•´ ìì„¸í•˜ê²Œ ì•Œì•„ë´¤ë‹¤. ì—¬ê¸°ì„œëŠ” LB Typeì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ê³  MetalLBë¡œ ì‹¤ìŠµì„ ì§„í–‰í•œë‹¤.


## Load Balancer Type


ë¡œë“œë°¸ëŸ°ì„œ íƒ€ì…ì€ **í´ë¼ìš°ë“œ ì œê³µì**ê°€ ì§€ì›í•˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œì™€ ì—°ë™ë˜ëŠ” ì„œë¹„ìŠ¤ íƒ€ì…ì´ë‹¤. ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œëŠ” êµ¬ì„±í•˜ê¸° í˜ë“¤ë‹¤ëŠ” ì œì•½ì´ ìˆë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/1.png)


ë¡œë“œë°¸ëŸ°ì„œ íƒ€ì… ì¥ì ì€ ì•„ë˜ì™€ ê°™ë‹¤.


#### Failover


ì™¸ë¶€ ë¡œë“œë°¸ëŸ°ì„œì™€ ì—°ë™ì‹œ, Health Checkë¥¼ í†µí•´ ë…¸ë“œì˜ ìƒíƒœë¥¼ íŒŒì•…í•˜ê³  ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì œê±° ë° ìƒì„±í•  ìˆ˜ ìˆë‹¤.


#### íŠ¸ë˜í”½ ë¶„ì‚°

1. ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ íŠ¹ì • ë…¸ë“œë¡œ ê³„ì† ì¸ì…ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ ëª¨ë“  ë…¸ë“œì— ê³¨ê³ ë£¨ íŠ¸ë˜í”½ì´ ë¶„ì‚°ëœë‹¤.
2. `externalTrafficPolicy` ì„¤ì •ì„ í†µí•´ ë“¤ì–´ì˜¨ ë…¸ë“œì— ìˆëŠ” íŒŒë“œë¡œ ë¼ìš°íŒ…í•˜ì—¬ ìµœì í™”í•  ìˆ˜ ìˆë‹¤.
3. í´ë¼ìš°ë“œì—ì„œ ë™ì‘í•  ê²½ìš°, ì œê³µí•˜ëŠ” CNIë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ í™‰ì„ ìµœì í™”í•  ìˆ˜ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, VPC-CNIì˜ ê²½ìš° íŒŒë“œì™€ ë…¸ë“œì˜ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì´ ê°™ê¸°ì— ë¡œë“œë°¸ëŸ°ì„œì—ì„œ ë°”ë¡œ íŒŒë“œë¡œ ë¼ìš°íŒ…í•  ìˆ˜ ìˆë‹¤.


#### ë³´ì•ˆ


NodePortë¡œ ë…¸ì¶œí•  ê²½ìš°, Worker Nodeì˜ IPë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ë‹ˆ ë³´ì•ˆì ìœ¼ë¡œ ì¢‹ì§€ ì•Šë‹¤. Load Balancerë¥¼ í†µí•´ì„œ ì´ë¥¼ ê°œì„ í•  ìˆ˜ ìˆë‹¤.


### ì‹¤ìŠµ í™˜ê²½


ì•„ë˜ì˜ YAMLì„ í†µí•´ AWS EC2 í˜¹ì€ ìì‹ ì˜ ì»´í“¨í„°ì—ì„œ kind ê¸°ë°˜ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  "InPlacePodVerticalScaling": true #ì‹¤í–‰ ì¤‘ì¸ íŒŒë“œì˜ ë¦¬ì†ŒìŠ¤ ìš”ì²­ ë° ì œí•œì„ ë³€ê²½í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
  "MultiCIDRServiceAllocator": true #ì„œë¹„ìŠ¤ì— ëŒ€í•´ ì—¬ëŸ¬ CIDR ë¸”ë¡ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
nodes:
  - role: control-plane
    labels:
      mynode: control-plane
      topology.kubernetes.io/zone: ap-northeast-2a 
    extraPortMappings: #ì»¨í…Œì´ë„ˆ í¬íŠ¸ë¥¼ í˜¸ìŠ¤íŠ¸ í¬íŠ¸ì— ë§¤í•‘í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
      - containerPort: 30000
        hostPort: 30000
      - containerPort: 30001
        hostPort: 30001
      - containerPort: 30002
        hostPort: 30002
      - containerPort: 30003
        hostPort: 30003
      - containerPort: 30004
        hostPort: 30004
    kubeadmConfigPatches:
      - |
        kind: ClusterConfiguration
        apiServer:
          extraArgs:  #API ì„œë²„ì— ì¶”ê°€ ì¸ìˆ˜ë¥¼ ì œê³µ
            runtime-config: api/all=true  #ëª¨ë“  API ë²„ì „ì„ í™œì„±í™”
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        etcd:
          local:
            extraArgs:
              listen-metrics-urls: http://0.0.0.0:2381
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0
      - |
        kind: KubeProxyConfiguration
        metricsBindAddress: 0.0.0.0
  - role: worker
    labels:
      mynode: worker1
      topology.kubernetes.io/zone: ap-northeast-2a
  - role: worker
    labels:
      mynode: worker2
      topology.kubernetes.io/zone: ap-northeast-2b
  - role: worker
    labels:
      mynode: worker3
      topology.kubernetes.io/zone: ap-northeast-2c
networking:
  podSubnet: 10.10.0.0/16 #íŒŒë“œ IPë¥¼ ìœ„í•œ CIDR ë²”ìœ„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. íŒŒë“œëŠ” ì´ ë²”ìœ„ì—ì„œ IPë¥¼ í• ë‹¹ë°›ìŠµë‹ˆë‹¤.
  serviceSubnet: 10.200.1.0/24 #ì„œë¹„ìŠ¤ IPë¥¼ ìœ„í•œ CIDR ë²”ìœ„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ëŠ” ì´ ë²”ìœ„ì—ì„œ IPë¥¼ í• ë‹¹ë°›ìŠµë‹ˆë‹¤.

```


## MetalLB


Load Balancer Typeì€ **í´ë¼ìš°ë“œ ë²¤ë”**ì˜ ë¡œë“œë°¸ëŸ°ì„œë§Œ ì§€ì›í•œë‹¤. ê·¸ë ‡ê¸°ì— OnPremise í™˜ê²½ì—ì„œëŠ” ì ìš©í•  ìˆ˜ ì—†ëŠ”ë°, [MetalLB](https://metallb.universe.tf/)ëŠ” **bare metal ì „ìš© ë¡œë“œë°¸ëŸ°ì„œë¥¼** ì œê³µí•œë‹¤. 


MetallLBëŠ” ARP, BPG 2ê°€ì§€ ëª¨ë“œë¥¼ ì§€ì›í•œë‹¤. 


### ARP(L2)


ì„œë¹„ìŠ¤ê°€ ìƒì„±ë˜ë©´ Hash ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ Leader ë…¸ë“œë¥¼ ì„ ì •í•œë‹¤. ì„ ì •ëœ ë…¸ë“œì— ì¡´ì¬í•˜ëŠ” Speaker íŒŒë“œê°€ í•´ë‹¹ LBì˜ ì™¸ë¶€ IPë¥¼ ARPë¡œ ê´‘ê³ í•œë‹¤. ë•ë¶„ì— í´ë¼ì´ì–¸íŠ¸ê°€ LBë¡œ ì ‘ê·¼í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” í•´ë‹¹ ë…¸ë“œë¡œ ë“¤ì˜¤ê²Œ ëœë‹¤. ì´í›„ë¡œëŠ” ì„œë¹„ìŠ¤ì˜ Iptables ë£°ì— ì˜í•´ ê° ì—”ë“œí¬ì¸íŠ¸ íŒŒë“œë¡œ ë¼ìš°íŒ…ëœë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/2.png)


í•´ë‹¹ ëª¨ë“œëŠ” Failoverê°€ ê°€ëŠ¥í•˜ì§€ë§Œ, íŠ¸ë˜í”½ ë¶„ì‚°ì´ ì–´ë µë‹¤. íŠ¹ì • ë…¸ë“œë¡œ ìœ ì…ëœ í›„ ë‹¤ì‹œ ë¶„ì‚°ë˜ê¸°ì— ë„¤íŠ¸ì›Œí¬ í™‰ì´ ë¹„íš¨ìœ¨ì ì´ë‹¤. ë˜í•œ, í•˜ì§€ë§Œ ë¦¬ë” ì¥ì• ì‹œ Failoverë˜ëŠ”ë° 1ë¶„ì •ë„ ê±¸ë¦°ë‹¤ê³  í•˜ì—¬ ìš´ì˜í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ê¸°ì—” ë¬´ë¦¬ê°€ ìˆë‹¤.


#### ì‹¤ìŠµ


##### ë°°í¬


MetalLB YAML íŒŒì¼ì„ ë°°í¬í•œë‹¤.


```bash
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml
```


ë°°í¬ í›„ ìŠ¤í”¼ì»¤ íŒŒë“œë¥¼ í™•ì¸í•˜ë©´, ë„¤íŠ¸ì›Œí¬ ëª¨ë“œê°€ Hostë¡œ ë™ì‘í•˜ì—¬ ë…¸ë“œì˜ IPì™€ ê°™ì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
kubectl get pod -n metallb-system -o wide
NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES
controller-8694df9d9b-5ljkq   1/1     Running   0          33s   10.10.1.2    myk8s-worker3         <none>           <none>
speaker-558tq                 1/1     Running   0          31s   172.18.0.5   myk8s-control-plane   <none>           <none>
speaker-mmckd                 1/1     Running   0          32s   172.18.0.3   myk8s-worker          <none>           <none>
speaker-pcjs2                 1/1     Running   0          32s   172.18.0.2   myk8s-worker3         <none>           <none>
speaker-xlbzv                 1/1     Running   0          31s   172.18.0.4   myk8s-worker2         <none>           <none>
```


dockerì˜ IP ëŒ€ì—­ì„ í™•ì¸í•œë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/3.png)


ExternalIP Poolì„ ì„¤ì •í•œë‹¤. kindì™€ ê°™ì€ ip ëŒ€ì—­ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ íŠ¸ë˜í”½ì´ í´ëŸ¬ìŠ¤í„°ë¡œ ìœ ì…ë˜ë„ë¡ í•œë‹¤.


```bash
cat <<EOF | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: my-ippool
  namespace: metallb-system
spec:
  addresses:
  - 172.18.255.200-172.18.255.250
EOF
```


L2Advertisement ìƒì„±í•œë‹¤. ìœ„ì—ì„œ í™•ì¸í•œ Docker IP ëŒ€ì—­ì„ ê¸°ë°˜ìœ¼ë¡œ L2 ëª¨ë“œë¡œ LoadBalancer IPë¥¼ ì‚¬ìš©í•œë‹¤.


```bash
cat <<EOF | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: my-l2-advertise
  namespace: metallb-system
spec:
  ipAddressPools:
  - my-ippool
EOF
```


íŒŒë“œì™€ ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•œë‹¤ 


```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
EOF
```


ì„œë¹„ìŠ¤ ë°°í¬


```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: svc1
spec:
  ports:
    - name: svc1-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer  # ì„œë¹„ìŠ¤ íƒ€ì…ì´ LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc2
spec:
  ports:
    - name: svc2-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: svc3
spec:
  ports:
    - name: svc3-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: LoadBalancer
EOF
service/svc1 created
service/svc2 created
service/svc3 created
```


ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆê³ , describe í•´ë³´ë©´ ë¦¬ë”ê°€ ì–´ë””ì— í• ë‹¹ë˜ì—ˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆë‹¤. 


*ì„œë¹„ìŠ¤ë¥¼ ì‚­ì œ ë° ì¬ë°°í¬í•´ë„, IPë¥¼ í†µí•´ í•´ì‹œê°’ìœ¼ë¡œ ë¦¬ë”ë¥¼ ì„ ì¶œí•˜ê¸°ì— ë¦¬ë”ëŠ” ë™ì¼í•˜ë‹¤. (ì•„ë˜ì˜ ì½”ë“œ ì„¤ëª… ì°¸ê³ )


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/4.png)


ì´ì œ controlplaneì—ì„œ ARP-Scanì„ í™œì„±í™”í•˜ì—¬, ARPë¡œ ExternalIPë¥¼ ê´‘ê³ í•˜ëŠ” ê²ƒì„ í™•ì¸í•œë‹¤. ì•„ë˜ì˜ ì‚¬ì§„ì²˜ëŸ¼ 172.18.255.200 ~ 202ê¹Œì§€ ì„œë¹„ìŠ¤ì˜ ExternalIPë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/5.png)


##### ë¶€í•˜ë¶„ì‚° í™•ì¸


ì´ì œ mypc ì»¨í…Œì´ë„ˆì— ì ‘ê·¼í•˜ì—¬ ë¶€í•˜ ë¶„ì‚°ì„ í™•ì¸í•´ë³¸ë‹¤.


```bash
docker exec -it mypc zsh -c "for i in {1..100}; do curl -s $SVC1EXIP | grep Hostname; done | sort | uniq -c | sort -nr"

     51 Hostname: webpod1
     49 Hostname: webpod2
```


```bash
docker exec -it mypc zsh -c "for i in {1..100}; do curl -s $SVC2EXIP | grep Hostname; done | sort | uniq -c | sort -nr"

     55 Hostname: webpod1
     45 Hostname: webpod2
```


##### iptables Rule


Iptablesì˜ ê·œì¹™ ë˜í•œ NodePortì™€ ê±°ì˜ ë™ì¼í•˜ë‹¤ê³  í•œë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/6.png)


ë¦¬ë” íŒŒë“œë¡œ ì„ ì¶œëœ ë…¸ë“œì— ì ‘ê·¼í•˜ì—¬, iptables ê·œì¹™ì„ í™•ì¸í•œë‹¤. ì•„ë˜ì™€ ê°™ì´ ExternalIPì— ëŒ€í•´ì„œ KUBE-EXT > KUBE-SVC ë¡œ ë¼ìš°íŒ…ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/7.png)


##### ì¥ì•  ì¬í˜„


ì´ì œ ë¦¬ë” ë…¸ë“œì— ì¥ì• ë¥¼ ì¬í˜„í•˜ì—¬ Failoverë¥¼ í™•ì¸í•´ë³¸ë‹¤.


```bash
docker stop myk8s-worker --signal 9
myk8s-worker
```


myk8s-worker ë…¸ë“œê°€ ì£½ì€ ê²ƒì„ í™•ì¸í•œë‹¤.


```bash
docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED             STATUS             PORTS                                                             NAMES
c08665282fca   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   About an hour ago   Up About an hour                                                                     myk8s-worker3
21a0814fe11b   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   About an hour ago   Up About an hour                                                                     myk8s-worker2
637f93f4b5d1   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   About an hour ago   Up About an hour   0.0.0.0:30000-30004->30000-30004/tcp, 127.0.0.1:54294->6443/tcp   myk8s-control-plane
7f63f1e8a000   nicolaka/netshoot      "sleep infinity"         2 hours ago         Up 2 hours                                                                           mypc
```


ì•„ë˜ì™€ ê°™ì´ â€œspeakerlist.goâ€ì—ì„œ ì¥ì• ê°€ ë°œìƒí•œ ì›Œì»¤ë…¸ë“œ IP ëŒ€ì—­ì— ëŒ€í•œ ì—ëŸ¬ë¡œê·¸ê°€ ë‚˜ì˜¨ë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/8.png)


ì¡°ê¸ˆ ê¸°ë‹¤ë¦° í›„ svcì— ëŒ€í•œ ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ ìƒˆë¡œìš´ ë¦¬ë”ê°€ ì„ ì¶œëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/9.png)


ì´ì œ ì ‘ì†ì„ ì§„í–‰í•´ë³´ë©´, worker ë…¸ë“œì— ìˆëŠ” pod1ë„ ê°™ì´ ì£½ì–´ pod2ë¡œë§Œ ì ‘ê·¼ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
k get pods -o wide
NAME      READY   STATUS    RESTARTS   AGE   IP          NODE            NOMINATED NODE   READINESS GATES
webpod1   1/1     Running   0          69m   10.10.2.4   myk8s-worker    <none>           <none>
webpod2   1/1     Running   0          69m   10.10.1.3   myk8s-worker2   <none>           <none> 
```


```bash
docker exec -it mypc zsh -c "for i in {1..100}; do curl -s $SVC1EXIP | grep Hostname; done | sort | uniq -c | sort -nr"
    100 Hostname: webpod2
```


### BGP


BPG ëª¨ë“œëŠ” ì™¸ë¶€ ë¼ìš°í„°ì™€ ì—°ë™í•˜ì—¬ ë™ì‘í•œë‹¤. speaker íŒŒë“œëŠ” BGP í”„ë¡œí† ì½œì„ í†µí•´ ExternalIPë¥¼ ë¼ìš°í„°ì—ê²Œ ì „íŒŒí•œë‹¤. ì™¸ë¶€ ë¼ìš°í„°ì™€ ì—°ë™ë˜ê¸°ì— `externalTrafficPolicy: Local`ë¡œ ì„¤ì •í•˜ì—¬ ë“¤ì–´ì˜¨ ë…¸ë“œì— íŒŒë“œë¡œ ë¼ìš°íŒ…í•œë‹¤. ì´ë¥¼ í†µí•´ ë…¸ë“œë¡œ íŠ¸ë˜í”½ì´ ë“¤ì–´ì˜¤ê³  ë‹¤ì‹œ ë¶„ì‚°ë˜ëŠ” ë¶ˆí•„ìš”í•œ ê³¼ì •ì„ ì—†ì•¨ ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/MetalLB%20ì•Œì•„ë³´ê¸°/10.png)


ì¶œì²˜: [https://docs.redhat.com/ko/documentation/openshift_container_platform/4.12/html/networking/load-balancing-with-metallb#about-metallb](https://docs.redhat.com/ko/documentation/openshift_container_platform/4.12/html/networking/load-balancing-with-metallb#about-metallb)


ë˜í•œ, `externalTrafficPolicy: Local` ë¡œ ì„¤ì •ë˜ëŠ” ê²½ìš° íŒŒë“œê°€ ë…¸ë“œì— ê³¨ê³ ë£¨ ë¶„ì‚°ëœê²Œ ì•„ë‹Œ íŠ¹ì • ë…¸ë“œì— ëª°ë ¤ìˆë‹¤ë©´ ë¶€í•˜ê°€ ë°œìƒí•œë‹¤. ê·¸ë ‡ê¸°ì— pod anti-affinityê³¼ ê°™ì€ ì˜µì…˜ìœ¼ë¡œ íŒŒë“œë¥¼ ê³¨ê³ ë£¨ ë¶„ì‚°ì„ ê¶Œì¥í•œë‹¤ê³  í•œë‹¤.


*BGPëŠ” ì™¸ë¶€ ë¼ìš°í„°ì™€ ì—°ë™ë˜ì–´ì•¼ í•˜ë¯€ë¡œ ì‹¤ìŠµì€ ë‹¤ë£¨ì§€ ì•ŠìŠµë‹ˆë‹¤.


### metalLB ì½”ë“œ ì‚´í´ë³´ê¸°


`speaker/main.go` [ì½”ë“œ](https://github.com/metallb/metallb/blob/main/speaker/main.go#L398)ë¥¼ ì‚´í´ë³´ë©´


handleServiceì—ì„œ VIP(ExternalIP)ì— ëŒ€í•œ ê´‘ê³ ë¥¼ ì§„í–‰í•œë‹¤.

1. í•´ë‹¹ ì„œë¹„ìŠ¤ê°€ ì™¸ë¶€ IPë¥¼ ê°€ì§„ LB íƒ€ì…ì˜ ì„œë¹„ìŠ¤ì´ê³ , ì™¸ë¶€ IPê°€ MetalLB IP poolì— ì†í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.(func `SetBalancer`)
2. í•´ë‹¹ ë…¸ë“œê°€ ë¦¬ë”ì¸ì§€ í™•ì¸í•œë‹¤. (`func ShouldAnnounce`)

ë§ë‹¤ë©´ ExternalIPì— ëŒ€í•œ ê´‘ê³ ë¥¼ ì§„í–‰í•œë‹¤.


#### ë¦¬ë” ì„ ì¶œ(Layer2)


[layer2_controller.go](https://github.com/metallb/metallb/blob/main/speaker/layer2_controller.go) ì½”ë“œë¥¼ í™•ì¸í•´ë³´ë©´, `usablesNode` í•¨ìˆ˜ì—ì„œ ê°€ìš©í•œ ë…¸ë“œë¥¼ íŒŒì•…í•œë‹¤. `ShouldAnnounce` í•¨ìˆ˜ì—ì„œ ì„œë¹„ìŠ¤ ë³„ë¡œ ë…¸ë“œë¥¼ ì„ ì •í•˜ëŠ”ë°, `NodeName + â€œ#â€ + externalIP` ì— ëŒ€í•œ í•´ì‹œê°’ìœ¼ë¡œ ì„ ì •í•œë‹¤. 


ì´ ë°©ì‹ ë•ë¶„ì— ë…¸ë“œê°€ ì¶”ê°€ë˜ì–´ë„, í•´ë‹¹ ë…¸ë“œì— ëŒ€í•œ í•´ì‹œê°’ì´ ê°€ì¥ ë¨¼ì €ì˜¤ëŠ” ê²½ìš°ê°€ ì•„ë‹ˆë¼ë©´ ë¦¬ë”ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ëœë‹¤. í•´ì‹œ ë•ë¶„ì— ì–´ë–¤ ë…¸ë“œê°€ ë¦¬ë”ë¡œ ì„ ì •ë˜ì—ˆëŠ”ì§€ ê¸°ì–µí•˜ì§€ ì•Šì•„ë„ statelessí•˜ê²Œ ì‘ì—…ì„ ì§„í–‰í•  ìˆ˜ ìˆë‹¤. 


```go
...
	// Using the first IP should work for both single and dual stack.
	ipString := toAnnounce[0].String()
	// Sort the slice by the hash of node + load balancer ips. This
	// produces an ordering of ready nodes that is unique to all the services
	// with the same ip.
	sort.Slice(availableNodes, func(i, j int) bool {
		hi := sha256.Sum256([]byte(availableNodes[i] + "#" + ipString))
		hj := sha256.Sum256([]byte(availableNodes[j] + "#" + ipString))

		return bytes.Compare(hi[:], hj[:]) < 0
	})

	// Are we first in the list? If so, we win and should announce.
	if len(availableNodes) > 0 && availableNodes[0] == c.myNode {
		return ""
	}

	// Either not eligible, or lost the election entirely.
	return "notOwner"
```

