---
layout: post
title: kind(kubernetes in docker)ë€?
date: 2024-09-03 09:00 +0900 
description: KANS ìŠ¤í„°ë”” 2ì£¼ì°¨ ì‹¤ìŠµí™˜ê²½ì¸ kind ì•Œì•„ë³´ê¸°
category: [Kubernetes, kind] 
tags: [KANS, CloudNet, kind, docker, Kubernetes, Network, KANS#2 ] 
pin: false
math: true
mermaid: true
---
KANS ìŠ¤í„°ë”” 2ì£¼ì°¨ ì‹¤ìŠµí™˜ê²½ì¸ kind ì•Œì•„ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


### ë“¤ì–´ê°€ë©°


ì´ë²ˆ ë„¤íŠ¸ì›Œí¬ ì‹¤ìŠµì€ kind(Kubernetes in Docker)ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•˜ì—¬ ì§„í–‰í•©ë‹ˆë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí¬ì— ëŒ€í•´ ì•Œì•„ë³´ê¸°ì „ì— ìš°ë¦¬ì˜ ì‹¤ìŠµ í™˜ê²½ì¸ kindì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.


ì•„ë˜ì˜ ê¸€ì€ [CloudNet ë¸”ë¡œê·¸](/c966e307a9ec489f9d8b943e30c6cd1f)ë¥¼ ì°¸ê³ í•´ì„œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


## kind


### kindë€?


kindì˜ ë¦¬í¬ì§€í„°ë¦¬ Aboutì—ëŠ”, â€œKubernetes IN Docker - local clusters for testing Kubernetesâ€ë¼ê³  ì†Œê°œë˜ì–´ìˆìŠµë‹ˆë‹¤. 


[ë¬¸ì„œ](https://github.com/kubernetes-sigs/kind/)ì— ë‚˜ì˜¨ kindì˜ ì¥ì ìœ¼ë¡œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

- Multi-node(HA) í´ëŸ¬ìŠ¤í„° ì§€ì›
- kind supports building Kubernetes release builds from source
	- support for make / bash or docker, in addition to pre-published builds
- Linux, macOS, ìœˆë„ìš° ì§€ì›
- CNCF ì¸ì¦ëœ Kubernetes installer

ì´ë²ˆ ì‹¤ìŠµì„ í•˜ë©´ì„œ ëŠë‚€ ì¥ì ì€ ë…¸ë“œë¥¼ ì»¨í…Œì´ë„ˆë¡œ ì‚¬ìš©í•˜ê¸°ì— ë¡œì»¬ì—ì„œ ì—¬ëŸ¬ ë…¸ë“œë¥¼ ëŒë¦´ ìˆ˜ ìˆê³ , í¬íŠ¸í¬ì›Œë”©ì„ í†µí•´ í¸í•˜ê²Œ í†µì‹ ë„ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì ê°™ìŠµë‹ˆë‹¤.

- ì‹¤ì œ VM í˜¹ì€ ì„œë²„ë¥¼ ì¤€ë¹„í•´ì„œ ë°°í¬í•œë‹¤ë©´ í´ëŸ¬ìŠ¤í„° í”„ë¡œë¹„ì €ë‹ì´ ê¹Œë‹¤ë¡­ìŠµë‹ˆë‹¤. ë°˜ë©´, kindëŠ” ê·¸ëŸ° ê³¼ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

### ì•„í‚¤í…ì²˜


ë‚´ë¶€ì ìœ¼ë¡œ kubeadmì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ í˜•ì„±í•œë‹¤ê³  í•©ë‹ˆë‹¤.


![image.png](/assets/img/post/kind/1.png)


ê·¸ë¦¼ ì¶œì²˜: [https://kind.sigs.k8s.io/](https://kind.sigs.k8s.io/)


## ì‹¤ìŠµ


### ì„¤ì¹˜ë°©ë²•


_ì‚¬ì „ì— Dockerê°€ ì„¤ì¹˜ëœ í™˜ê²½ì´ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤._

- kind ì„¤ì¹˜(ìœˆë„ìš° í™˜ê²½ì´ë¼ë©´, [ë¬¸ì„œ](https://kind.sigs.k8s.io/docs/user/quick-start/#installation)ë¥¼ ì°¸ê³ )

```bash
brew install kind
```

- ì•„ë˜ì˜ YAMLíŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
    extraPortMappings:
      - containerPort: 30000
        hostPort: 30000
      - containerPort: 30001
        hostPort: 30001
```


### í´ëŸ¬ìŠ¤í„° ìƒì„±


```bash
kind create cluster --config {ìœ„ì˜ YAML ê²½ë¡œ} --name {ì›í•˜ëŠ” í´ëŸ¬ìŠ¤í„°ëª…}
```

- ì •ë³´ í™•ì¸

```bash
docker ps
```


![image.png](/assets/img/post/kind/2.png)


ì‚¬ì§„ì„ í†µí•´ ì •ë³´ë¥¼ í™•ì¸í•˜ë©´ controlplaneì˜ í¬íŠ¸í¬ì›Œë”©ì€ 61208 > 6443ìœ¼ë¡œ ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. worker nodeì˜ í¬ì›Œë”©ì€ ìœ„ì—ì„œ ì„¤ì •í•œ ê²ƒê³¼ ê°™ì´ 30000,30001ë²ˆì„ í¬ì›Œë”©í–ˆìŠµë‹ˆë‹¤.


kind ëª…ë ¹ì–´ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•˜ë©´, ìë™ìœ¼ë¡œ kubeconfig íŒŒì¼ì— ê´€ë ¨ ë‚´ìš©ì„ ì¶”ê°€í•´ì£¼ëŠ”ë°ìš”, í•œë²ˆ ë‚´ìš©ì„ í™•ì¸í•´ë´…ë‹ˆë‹¤.


```bash
cat ~/.kube/config
```


![image.png](/assets/img/post/kind/3.png)


â€œserver: [https://127.0.0.1:61208](https://127.0.0.1:61208/)â€ ìœ¼ë¡œ ì„¤ì •ê°’ì„ ë„£ì—ˆìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ë´¤ë˜ controlplane í¬íŠ¸ì›Œë”© ì •ë³´ì™€ ê°™ê³ , ìš°ë¦¬ê°€ ë¡œì»¬ì—ì„œ kubectl ëª…ë ¹ì„ ë‚ ë¦¬ë©´ 61208 > 6443 ìœ¼ë¡œ ì ‘ì†í•˜ì—¬ apiserverì— ì „ë‹¬ë©ë‹ˆë‹¤.


```bash
k get nodes
NAME                  STATUS   ROLES           AGE   VERSION
myk8s-control-plane   Ready    control-plane   24h   v1.30.0
myk8s-worker          Ready    <none>          24h   v1.30.0
```


ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ api-serverì˜ ê²½ë¡œê°€ :6443ì´ ë§ë‹¤ëŠ” ê²ƒì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```bash
docker exec -it myk8s-control-plane curl -k https://localhost:6443/livez ;echo
ok
```


### ê°„ë‹¨í•œ ì›¹ì„œë²„ ë°°í¬


```bash
cat <<EOF | kubectl create -f -
apiVersion: apps/v1
kind: **Deployment**
metadata:
  name: **deploy-websrv**
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: deploy-websrv
        image: **nginx:alpine**
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: **Service**
metadata:
  name: **deploy-websrv**
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
      nodePort: **30001**
  selector:
    app: deploy-websrv
  type: NodePort
EOF
```

- ë°°í¬ í™•ì¸

```bash
k get svc,deploy
NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/deploy-websrv   NodePort    10.96.205.151   <none>        80:30001/TCP   18s
service/kubernetes      ClusterIP   10.96.0.1       <none>        443/TCP        24h

NAME                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deploy-websrv   2/2     2            2           18s
```

- ì ‘ì†í™•ì¸

í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•  ë•Œ í¬íŠ¸ë¥¼ ì—´ì–´ë’€ê¸°ì—, ì•„ë˜ì™€ ê°™ì´ ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.


ë§Œì•½, ì›í•˜ì‹œëŠ” ë…¸ë“œ í¬íŠ¸ ë²”ìœ„ê°€ ìˆë‹¤ë©´ ë°°í¬í•  ë•Œ ì—´ì–´ë‘¡ë‹ˆë‹¤.


![image.png](/assets/img/post/kind/4.png)


ì´ì œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.


```bash
kind delete cluster --name {í´ëŸ¬ìŠ¤í„°ëª…}
Deleting cluster "myk8s" ...
Deleted nodes: ["myk8s-worker" "myk8s-control-plane"]
```


### Ingress ì ìš©í•´ë³´ê¸°


Ingress ì ìš©ì„ ìœ„í•´, ì•„ë˜ì˜ YAML íŒŒì¼ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ í”„ë¡œë¹„ì €ë‹í•©ë‹ˆë‹¤.


** ingressëŠ” L7 ë¼ìš°íŒ…ì„ ì œê³µí•˜ëŠ” ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤. ì™¸ë¶€ LBì™€ ì—°ë™ë˜ì–´ ë³„ë„ì˜ Controller Podì—ì„œ ë„ë©”ì¸ì— ëŒ€í•œ ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ê³  entpoint(pod)ë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.


```bash
**cat <<EOT> kind-ingress.yaml**
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  **kubeadmConfigPatches**:
  - |
    kind: InitConfiguration
    nodeRegistration:
      kubeletExtraArgs:
        **node-labels**: "**ingress-ready=true**"
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP
  - containerPort: 30000
    hostPort: 30000
**EOT**
```


ì´ë²ˆì—ëŠ” api-server í¬íŠ¸í¬ì›Œë”©ì´ 50017ë¡œ ì§€ì •ëìŠµë‹ˆë‹¤.


```bash
docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                                                           NAMES
bd7dcca07462   kindest/node:v1.30.0   "/usr/local/bin/entrâ€¦"   31 seconds ago   Up 30 seconds   0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp, 0.0.0.0:30000->30000/tcp, 127.0.0.1:50017->6443/tcp   myk8s-control-plane
```


#### Nginx-Ingress ë°°í¬


```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
```

- Nginx Ingress ë°°í¬ í™•ì¸

```bash
k get pods -n ingress-nginx -o wide
NAME                                       READY   STATUS      RESTARTS   AGE    IP           NODE                  NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-lbm56       0/1     Completed   0          3m8s   10.244.0.5   myk8s-control-plane   <none>           <none>
ingress-nginx-admission-patch-z4dqs        0/1     Completed   0          3m8s   10.244.0.6   myk8s-control-plane   <none>           <none>
ingress-nginx-controller-8fb8cdb7c-q2s8v   1/1     Running     0          3m8s   10.244.0.7   myk8s-control-plane   <none>           <none>
```


#### Sample ì•± ì‚´í´ë³´ê¸°


ìš°ë¦¬ê°€ ì‚¬ìš©í•  YAML íŒŒì¼ì€ https://kind.sigs.k8s.io/examples/ingress/usage.yamlì…ë‹ˆë‹¤. ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ ê°„ë‹¨íˆ ì‚´í´ë³´ë©´ k8sì—ì„œ ì œê³µí•˜ëŠ” â€œe2e-test-images/agnhostâ€ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.


```bash
kind: Pod
apiVersion: v1
metadata:
  name: bar-app
  labels:
    app: bar
spec:
  containers:
  - command:
    - /agnhost
    - netexec
    - --http-port
    - "8080"
    image: registry.k8s.io/e2e-test-images/agnhost:2.39
    name: bar-app
```


í•´ë‹¹ ì´ë¯¸ì§€ëŠ” kubernetesì—ì„œ ì œê³µí•˜ëŠ” end to end í…ŒìŠ¤íŠ¸ ë„êµ¬ì…ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì—¬ê¸°ì„œ ì‚¬ìš©í•˜ëŠ”  **netexecëŠ”** HTTPë¡œ ì˜¤ëŠ” ìš”ì²­ì— ëŒ€í•´ ë‹¤ì–‘í•œ ì‘ë‹µì„ ë¦¬í„´í•©ë‹ˆë‹¤.

- `/`: Timestamp
- `/clientip`: ìš”ì²­ì„ ë³´ë‚¸ í´ë¼ì´ì–¸íŠ¸ IP ë°˜í™˜
- `/hostname`: í˜¸ìŠ¤íŠ¸ë„¤ì„ ë°˜í™˜
- `/echo`: íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸´ ë©”ì‹œì§€ë¥¼ ë°˜í™˜. (`/echo?msg=echoed_msg`)

IngressëŠ” /foo/ í˜¹ì€ /fooë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ëª…ë ¹ì„ foo-services(bar-services)ë¡œ ë¼ìš°íŒ…í•œë‹¤ëŠ” ë‚´ìš©ì…ë‹ˆë‹¤.


```bash
apiVersion: networking.k8s.io/v1
kind: Ingress
...
spec:
  rules:
  - http:
      paths:
      - pathType: Prefix
        path: /foo(/|$)(.*)
        backend:
          service:
            name: foo-service
            port:
              number: 8080
...
```

- ë°°í¬ ì§„í–‰

```bash
kubectl apply -f https://kind.sigs.k8s.io/examples/ingress/usage.yaml
```


ë°°í¬ëœ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.


![image.png](/assets/img/post/kind/5.png)

- í•œë²ˆ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´…ë‹ˆë‹¤.

```bash
curl localhost/foo/hostname
foo-app
curl localhost/bar/hostname
bar-app
```


ì•„ì£¼ ì˜ ì‘ë™ë©ë‹ˆë‹¤. ìœ„ì—ì„œ í™•ì¸í•œ netexecì˜ ë‹¤ë¥¸ ì˜µì…˜ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë´…ë‹ˆë‹¤.


```bash
curl localhost/foo/
NOW: 2024-09-02 12:55:54.205389173 +0000 UTC m=+1352.963004871
curl localhost/foo/clientip
10.244.0.7:39658
curl http://localhost/foo//echo\?msg\=test_msg
test_msg
```


![image.png](/assets/img/post/kind/6.png)


í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ì§€ì†ì ìœ¼ë¡œ ë‚ ë ¤ë´…ë‹ˆë‹¤. ì„ì‹œí¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ê¸°ì—, í¬íŠ¸ê°€ ê³„ì† ë°”ë€ŒëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```bash
curl localhost/foo/clientip
10.244.0.7:38562%          
curl localhost/foo/clientip
10.244.0.7:58766%   
curl localhost/foo/clientip
10.244.0.7:43040%                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
```


ìœ„ì™€ ê°™ì´ ingressê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


#### Ingress controllerì— ë¡œê·¸ í™•ì¸


ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.


```bash
kubectl logs -n ingress-nginx deploy/ingress-nginx-controller -f

-------------------------------------------------------------------------------
NGINX Ingress controller
  Release:       v1.11.2
  Build:         46e76e5916813cfca2a9b0bfdc34b69a0000f6b9
  Repository:    https://github.com/kubernetes/ingress-nginx
  nginx version: nginx/1.25.5

-------------------------------------------------------------------------------

W0902 12:30:41.709884      10 client_config.go:659] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
I0902 12:30:41.710019      10 main.go:205] "Creating API client" host="https://10.96.0.1:443"
...
W0902 12:33:14.755691      10 controller.go:1216] Service "default/foo-service" does not have any active Endpoint.
W0902 12:33:14.755744      10 controller.go:1216] Service "default/bar-service" does not have any active Endpoint.
W0902 12:33:22.128651      10 controller.go:1216] Service "default/bar-service" does not have any active Endpoint.
I0902 12:33:43.037560      10 status.go:304] "updating Ingress status" namespace="default" ingress="example-ingress" currentValue=null newValue=[{"hostname":"localhost"}]
I0902 12:33:43.048937      10 event.go:377] Event(v1.ObjectReference{Kind:"Ingress", Namespace:"default", Name:"example-ingress", UID:"b0a9eddb-4bf5-43d4-9420-8dac73ff3286", APIVersion:"networking.k8s.io/v1", ResourceVersion:"1050", FieldPath:""}): type: 'Normal' reason: 'Sync' Scheduled for sync
172.18.0.1 - - [02/Sep/2024:12:35:00 +0000] "GET /foo/hostname HTTP/1.1" 200 7 "-" "curl/8.4.0" 84 0.003 [default-foo-service-8080] [] 10.244.0.9:8080 7 0.003 200 7c7c48eb2349724f9299560e49ff98eb
172.18.0.1 - - [02/Sep/2024:12:35:16 +0000] "GET /bar/hostname HTTP/1.1" 200 7 "-" "curl/8.4.0" 84 0.001 [default-bar-service-8080] [] 10.244.0.8:8080 7 0.002 200 d2b2b45924a2d78017d51e236556a3e0
```


ë§ˆì§€ë§‰ ì¤„ì„ í™•ì¸í•˜ë©´  /bar/hostnameìœ¼ë¡œ ë“¤ì–´ì˜¨ íŠ¸ë˜í”½ì„ `10.244.0.8:8080`ìœ¼ë¡œ ë¼ìš°íŒ…í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`GET /bar/hostname HTTP/1.1" 200 7 "-" "curl/8.4.0" 84 0.001 [default-bar-service-8080] [] 10.244.0.8:8080 7 0.002 200`


`10.244.0.8`ëŠ” ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ bar-app íŒŒë“œì˜ IPì…ë‹ˆë‹¤.


![image.png](/assets/img/post/kind/7.png)


ì´ì™€ ê°™ì´ kindì—ì„œë„ nginx-ingressê°€ ì˜ ì‘ë™ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

