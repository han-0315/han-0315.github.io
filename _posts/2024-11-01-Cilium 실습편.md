---
layout: post
title: Cilium ì‹¤ìŠµí¸
date: 2024-10-30 09:00 +0900 
description: Cilium ì‹¤ìŠµí¸
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#8 ] 
pin: false
math: true
mermaid: true
---
Ciliumì„ ì‹¤ìŠµí•´ë³´ë©° íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ ì•Œì•„ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


## ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±


ì´ë²ˆ ì£¼ì°¨ëŠ” AWSë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ìŠµ í™˜ê²½ì„ êµ¬ì„±í•œë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.
â€œ**VPC** 1ê°œ(í¼ë¸”ë¦­ ì„œë¸Œë„· 2ê°œ), **EC2 ì¸ìŠ¤í„´ìŠ¤** 3ëŒ€ (Ubuntu 22.04 LTS, **t3.xlarge** - vCPU 4 , Mem 16) , **testpc** 1ëŒ€ëŠ” **t3.smallâ€**


### AWS ë¦¬ì†ŒìŠ¤ ë°°í¬


ê°€ì‹œë‹¤ë‹˜ì´ ì¤€ë¹„í•´ì£¼ì‹  CloudFormation íŒŒì¼ì„ í†µí•´ ë°°í¬ë¥¼ ì§„í–‰í•œë‹¤.


```bash
# YAML íŒŒì¼ ë‹¤ìš´ë¡œë“œ
curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/kans/kans-8w.yaml
# ë°°í¬ ì§„í–‰
aws cloudformation deploy --template-file kans-8w.yaml --stack-name mylab --parameter-overrides KeyName={key-pair name} SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32 --region ap-northeast-2
```


ë°°í¬ê°€ ì™„ë£Œëœ í›„ k8s-s EC2ì— ì ‘ì†í•˜ì—¬ ë…¸ë“œ ìƒíƒœë¥¼ í™•ì¸í•œë‹¤. CNIê°€ ì—†ì–´ NotReady ìƒíƒœì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 


```bash
kc get nodes
NAME     STATUS     ROLES           AGE   VERSION
k8s-s    NotReady   control-plane   95s   v1.30.6
k8s-w1   NotReady   <none>          74s   v1.30.6
k8s-w2   NotReady   <none>          75s   v1.30.6
```


### Cilium ì„¤ì¹˜


ì´ì œ Helmì„ í†µí•´ Ciliumì„ ì„¤ì¹˜í•œë‹¤. ì•„ë˜ì—ì„œ `kubeProxyReplacement` ì˜µì…˜ì„ ì‚´í´ë³¼ ìˆ˜ ìˆë‹¤. Ciliumì—ì„œëŠ” kube-proxyë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  kube-proxyì˜ ì—­í• , ì„œë¹„ìŠ¤ì— ëŒ€í•œ êµ¬í˜„ì„ ëŒ€ì‹  ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.


```bash
helm repo add cilium https://helm.cilium.io/
helm repo update

helm install cilium cilium/cilium --version 1.16.3 --namespace kube-system \
--set k8sServiceHost=192.168.10.10 --set k8sServicePort=6443 --set debug.enabled=true \
--set rollOutCiliumPods=true --set routingMode=native --set autoDirectNodeRoutes=true \
--set bpf.masquerade=true --set bpf.hostRouting=true --set endpointRoutes.enabled=true \
--set ipam.mode=kubernetes --set k8s.requireIPv4PodCIDR=true --set kubeProxyReplacement=true \ #without kube-proxy
--set ipv4NativeRoutingCIDR=192.168.0.0/16 --set installNoConntrackIptablesRules=true \ #kube-porxy ì•ˆì“°ë‹ˆê¹Œ conntract tablesë„ No
--set hubble.ui.enabled=true --set hubble.relay.enabled=true --set prometheus.enabled=true --set operator.prometheus.enabled=true --set hubble.metrics.enableOpenMetrics=true \
--set hubble.metrics.enabled="{dns:query;ignoreAAAA,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}" \
--set operator.replicas=1
```


Cilium íŒŒë“œê°€ ëœ¨ë©´ì„œ, íŒŒë“œë“¤ë„ IPë¥¼ ë°›ì•„ì˜¤ë©° Pending ìƒíƒœì—ì„œ Runningìœ¼ë¡œ ë³€í•˜ê³  nodeì˜ ìƒíƒœê°€ Readyê°€ ë˜ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/1.png)


#### iptables í™•ì¸


iptables NATë¥¼ í™•ì¸í•´ë³¸ë‹¤. ì›ë˜ëŠ” kube-proxyë‚˜ ê¸°ë³¸ì ìœ¼ë¡œ ë°°í¬ë˜ëŠ” kubernetes ì„œë¹„ìŠ¤ì— ëŒ€í•œ NAT ê·œì¹™ì´ ìˆì–´ì•¼í•˜ì§€ë§Œ ì—†ë‹¤!


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/2.png)


ì•„ë˜ì˜ gloo ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ í…ŒìŠ¤íŠ¸í–ˆë˜ kind ì»¨í…Œì´ë„ˆì—ì„œ ë˜‘ê°™ì€ ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•˜ë©´ 157ê°œì˜ ê·œì¹™ì´ ë‚˜ì˜¨ë‹¤. 


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/3.png)


ì´ì œ conntrackì„ í†µí•´ ì‚´í´ë³´ì. etcd ê´€ë ¨ í¬íŠ¸ë¥¼ ì œì™¸í•˜ê³  ë³´ë©´, ë³„ë‹¤ë¥¸ ê·œì¹™ì´ ì—†ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. iptablesë¥¼ ì‚¬ìš©í•˜ëŠ” CNIì™€ kube-proxyê°€ ì¡´ì¬í•  ë•Œë‘ ë¹„êµí•˜ë©´ ì •ë§ ë§ì€ ì°¨ì´ê°€ ìˆë‹¤.


```bash
conntrack -L | grep -v 2379
tcp      6 116 TIME_WAIT src=127.0.0.1 dst=127.0.0.1 sport=42192 dport=9878 src=127.0.0.1 dst=127.0.0.1 sport=9878 dport=42192 [ASSURED] mark=0 use=1
tcp      6 115 TIME_WAIT src=127.0.0.1 dst=127.0.0.1 sport=55044 dport=9879 src=127.0.0.1 dst=127.0.0.1 sport=9879 dport=55044 [ASSURED] mark=0 use=1
tcp      6 114 TIME_WAIT src=127.0.0.1 dst=127.0.0.1 sport=43108 dport=2381 src=127.0.0.1 dst=127.0.0.1 sport=2381 dport=43108 [ASSURED] mark=0 use=1
tcp      6 115 TIME_WAIT src=127.0.0.1 dst=127.0.0.1 sport=55050 dport=9879 src=127.0.0.1 dst=127.0.0.1 sport=9879 dport=55050 [ASSURED] mark=0 use=1
tcp      6 2 CLOSE src=127.0.0.1 dst=127.0.0.1 sport=54500 dport=10257 src=127.0.0.1 dst=127.0.0.1 sport=10257 dport=54500 [ASSURED] mark=0 use=1
tcp      6 104 TIME_WAIT src=127.0.0.1 dst=127.0.0.1 sport=44074 dport=2381 src=127.0.0.1 dst=127.0.0.1 sport=2381 dport=44074 [ASSURED] mark=0 use=1
conntrack v1.4.6 (conntrack-tools): tcp      6 2 CLOSE src=127.0.0.1 dst=127.0.0.1 sport=60814 dport=10259 src=127.0.0.1 dst=127.0.0.1 sport=10259 dport=60814 [ASSURED] mark=0 use=1
81 flow entries have been shown.
tcp      6 116 TIME_WAIT src=127.0.0.1 dst=127.0.0.1 sport=42190 dport=9878 src=127.0.0.1 dst=127.0.0.1 sport=9878 dport=42190 [ASSURED] mark=0 use=1
```


#### ì¸í„°í˜ì´ìŠ¤ í™•ì¸


ë…¸ë“œì— ì ‘ì†í•˜ì—¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¸í•˜ë©´ lxc_healthë¼ëŠ” health check ì „ìš© ì¸í„°í˜ì´ìŠ¤ê°€ ë³´ì´ê³ ,  cilium_hostì™€ cilium_netê°€ ë³´ì¸ë‹¤. ì´ ë‘˜ì€ peerë¡œ ë¬¶ì—¬ìˆëŠ” ê²ƒë„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê° ì¸í„°í˜ì´ìŠ¤ì˜ ì—­í• ê³¼ ìì„¸í•œ ë‚´ìš©ì€ ì¶”í›„ Packet flowì—ì„œ í™•ì¸í•´ë³¸ë‹¤.


```bash
ip -c addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
...
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
...
3: cilium_net@cilium_host: <BROADCAST,MULTICAST,NOARP,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether 16:cf:27:70:e7:01 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::14cf:27ff:fe70:e701/64 scope link
       valid_lft forever preferred_lft forever
4: cilium_host@cilium_net: <BROADCAST,MULTICAST,NOARP,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether 36:c8:ec:67:2d:e5 brd ff:ff:ff:ff:ff:ff
    inet 172.16.0.189/32 scope global cilium_host
       valid_lft forever preferred_lft forever
    inet6 fe80::34c8:ecff:fe67:2de5/64 scope link
       valid_lft forever preferred_lft forever
6: lxc_health@if5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether ae:60:52:63:40:61 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::ac60:52ff:fe63:4061/64 scope link
       valid_lft forever preferred_lft forever
```


### Cilium CLI ì„¤ì¹˜


ì•„ë˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ Cilium CLIë¥¼ ì„¤ì¹˜í•œë‹¤. 


```bash
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
```


ì„¤ì¹˜ë¥¼ ì™„ë£Œí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì•Œë¡ë‹¬ë¡í•œ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/4.png)


### ë¦¬ì†ŒìŠ¤ í™•ì¸


#### ë‹¨ì¶•í‚¤ ì„¤ì •


ê° ë…¸ë“œì— ì¡´ì¬í•˜ëŠ” Cilium Agent íŒŒë“œë¥¼ ë‹¨ì¶•í‚¤ë¡œ ì§€ì •í•œë‹¤. ë§Œì•½, Helmì„ í†µí•´ Cilium ê´€ë ¨ ì„¤ì •ì„ ë°”ê¾¸ë©´ Agentë„ ì¬ìƒì„±ë˜ì–´ ì´ë¦„ì´ ë³€ê²½ë˜ë¯€ë¡œ ì•„ë˜ ë‹¨ì¶•í‚¤ë¥¼ ë‹¤ì‹œ ì„¤ì •í•´ì¤˜ì•¼ í•œë‹¤.


```bash
# cilium íŒŒë“œ ì´ë¦„
export CILIUMPOD0=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=**k8s-s**  -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD1=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=**k8s-w1** -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD2=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=**k8s-w2** -o jsonpath='{.items[0].metadata.name}')

# ë‹¨ì¶•í‚¤(alias) ì§€ì •
alias c0="kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- cilium"
alias c1="kubectl exec -it $CILIUMPOD1 -n kube-system -c cilium-agent -- cilium"
alias c2="kubectl exec -it $CILIUMPOD2 -n kube-system -c cilium-agent -- cilium"

alias c0bpf="kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- bpftool"
alias c1bpf="kubectl exec -it $CILIUMPOD1 -n kube-system -c cilium-agent -- bpftool"
alias c2bpf="kubectl exec -it $CILIUMPOD2 -n kube-system -c cilium-agent -- bpftool"

```


#### êµ¬ì„±ìš”ì†Œ


Agentì— ì ‘ì†í•˜ì—¬ ìƒíƒœë¥¼ ì‚´í´ë³¸ë‹¤.

- ì‚¬ìš©í•˜ëŠ” API: EndpointSliceOrEndpoint, Service, NetworkPolicy, ê°ì¢… Cilium CRD, â€¦
- ebpfì—ì„œ ì‚¬ìš©í•˜ëŠ” mapìœ¼ë¡œ ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ mapë„ ë³´ì¸ë‹¤.
- ë§ˆì§€ë§‰ìœ¼ë¡œ ebpf ê´€ë ¨ ëª¨ë“ˆë„ í™•ì¸ëœë‹¤.

```bash
c0 status --verbose
KVStore:                Ok   Disabled
Kubernetes:             Ok   1.30 (v1.30.6) [linux/amd64]
Kubernetes APIs:        ["EndpointSliceOrEndpoint", "cilium/v2::CiliumClusterwideNetworkPolicy", "cilium/v2::CiliumEndpoint", "cilium/v2::CiliumNetworkPolicy", "cilium/v2::CiliumNode", "cilium/v2alpha1::CiliumCIDRGroup", "core/v1::Namespace", "core/v1::Pods", "core/v1::Service", "networking.k8s.io/v1::NetworkPolicy"]
KubeProxyReplacement:   True   [ens5   192.168.10.10 fe80::7e:aeff:fe5f:c8a9 (Direct Routing)]
Host firewall:          Disabled
SRv6:                   Disabled
CNI Chaining:           none
CNI Config file:        successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist
Cilium:                 Ok   1.16.3 (v1.16.3-f2217191)
NodeMonitor:            Listening for events on 4 CPUs with 64x4096 of shared memory
Cilium health daemon:   Ok
IPAM:                   IPv4: 2/254 allocated from 172.16.0.0/24,
Allocated addresses:
  172.16.0.13 (health)
  172.16.0.186 (router)
IPv4 BIG TCP:           Disabled
IPv6 BIG TCP:           Disabled
BandwidthManager:       Disabled
Routing:                Network: Native   Host: BPF
Attach Mode:            TCX
Device Mode:            veth
Masquerading:           BPF   [ens5]   192.168.0.0/16 [IPv4: Enabled, IPv6: Disabled]
Clock Source for BPF:   ktime
Controller Status:      19/19 healthy
  Name                                  Last success   Last error   Count   Message
  cilium-health-ep                      9s ago         never        0       no error
  ct-map-pressure                       22s ago        never        0       no error
  daemon-validate-config                21s ago        never        0       no error
  dns-garbage-collector-job             23s ago        never        0       no error
  endpoint-1519-regeneration-recovery   never          never        0       no error
  endpoint-2104-regeneration-recovery   never          never        0       no error
  endpoint-gc                           23s ago        never        0       no error
  ep-bpf-prog-watchdog                  21s ago        never        0       no error
  ipcache-inject-labels                 20s ago        never        0       no error
  k8s-heartbeat                         23s ago        never        0       no error
  link-cache                            6s ago         never        0       no error
  node-neighbor-link-updater            2s ago         never        0       no error
  resolve-identity-1519                 22s ago        never        0       no error
  resolve-identity-2104                 20s ago        never        0       no error
  sync-lb-maps-with-k8s-services        22s ago        never        0       no error
  sync-policymap-1519                   18s ago        never        0       no error
  sync-policymap-2104                   12s ago        never        0       no error
  sync-utime                            22s ago        never        0       no error
  write-cni-file                        23s ago        never        0       no error
Proxy Status:            OK, ip 172.16.0.186, 0 redirects active on ports 10000-20000, Envoy: external
Global Identity Range:   min 256, max 65535
Hubble:                  Ok   Current/Max Flows: 93/4095 (2.27%), Flows/s: 3.35   Metrics: Ok
KubeProxyReplacement Details:
  Status:                 True
  Socket LB:              Enabled
  Socket LB Tracing:      Enabled
  Socket LB Coverage:     Full
  Devices:                ens5   192.168.10.10 fe80::7e:aeff:fe5f:c8a9 (Direct Routing)
  Mode:                   SNAT
  Backend Selection:      Random
  Session Affinity:       Enabled
  Graceful Termination:   Enabled
  NAT46/64 Support:       Disabled
  XDP Acceleration:       Disabled
  Services:
  - ClusterIP:      Enabled
  - NodePort:       Enabled (Range: 30000-32767)
  - LoadBalancer:   Enabled
  - externalIPs:    Enabled
  - HostPort:       Enabled
BPF Maps:   dynamic sizing: on (ratio: 0.002500)
  Name                          Size
  Auth                          524288
  Non-TCP connection tracking   72610
  TCP connection tracking       145220
  Endpoint policy               65535
  IP cache                      512000
  IPv4 masquerading agent       16384
  IPv6 masquerading agent       16384
  IPv4 fragmentation            8192
  IPv4 service                  65536
  IPv6 service                  65536
  IPv4 service backend          65536
  IPv6 service backend          65536
  IPv4 service reverse NAT      65536
  IPv6 service reverse NAT      65536
  Metrics                       1024
  NAT                           145220
  Neighbor table                145220
  Global policy                 16384
  Session affinity              65536
  Sock reverse NAT              72610
  Tunnel                        65536
Encryption:           Disabled
Cluster health:       0/3 reachable    (2024-10-27T09:14:55Z)
  Name                IP               Node          Endpoints
  k8s-s (localhost)   192.168.10.10    reachable     unreachable
  k8s-w1              192.168.10.101   reachable     unreachable
  k8s-w2              192.168.10.102   unreachable   unreachable
Modules Health:
      agent
      â”œâ”€â”€ controlplane
      â”‚   â”œâ”€â”€ auth
      â”‚   â”‚   â”œâ”€â”€ observer-job-auth gc-identity-events            [OK] Primed (23s, x1)
      â”‚   â”‚   â”œâ”€â”€ observer-job-auth request-authentication        [OK] Primed (23s, x1)
      â”‚   â”‚   â””â”€â”€ timer-job-auth gc-cleanup                       [OK] Primed (23s, x1)
      â”‚   â”œâ”€â”€ bgp-control-plane
      â”‚   â”‚   â”œâ”€â”€ job-bgp-crd-status-initialize                   [OK] Running (22s, x1)
      â”‚   â”‚   â”œâ”€â”€ job-bgp-crd-status-update-job                   [OK] Running (22s, x1)
      â”‚   â”‚   â”œâ”€â”€ job-bgp-state-observer                          [OK] Running (22s, x1)
      â”‚   â”‚   â””â”€â”€ job-diffstore-events                            [OK] Running (22s, x2)
      â”‚   â”œâ”€â”€ daemon
      â”‚   â”‚   â”œâ”€â”€                                                 [OK] daemon-validate-config (21s, x1)
      â”‚   â”‚   â”œâ”€â”€ ep-bpf-prog-watchdog
      â”‚   â”‚   â”‚   â””â”€â”€ ep-bpf-prog-watchdog                        [OK] ep-bpf-prog-watchdog (22s, x1)
      â”‚   â”‚   â””â”€â”€ job-sync-hostips                                [OK] Synchronized (22s, x1)
      â”‚   â”œâ”€â”€ endpoint-manager
      â”‚   â”‚   â”œâ”€â”€ cilium-endpoint-1519 (/)
      â”‚   â”‚   â”‚   â”œâ”€â”€ datapath-regenerate                         [OK] Endpoint regeneration successful (14s, x3)
      â”‚   â”‚   â”‚   â””â”€â”€ policymap-sync                              [OK] sync-policymap-1519 (18s, x1)
      â”‚   â”‚   â”œâ”€â”€ cilium-endpoint-2104 (/)
      â”‚   â”‚   â”‚   â”œâ”€â”€ datapath-regenerate                         [OK] Endpoint regeneration successful (12s, x2)
      â”‚   â”‚   â”‚   â””â”€â”€ policymap-sync                              [OK] sync-policymap-2104 (13s, x1)
      â”‚   â”‚   â””â”€â”€ endpoint-gc                                     [OK] endpoint-gc (23s, x1)
      â”‚   â”œâ”€â”€ envoy-proxy
      â”‚   â”‚   â””â”€â”€ timer-job-version-check                         [OK] Primed (22s, x1)
      â”‚   â”œâ”€â”€ l2-announcer
      â”‚   â”‚   â””â”€â”€ job-l2-announcer lease-gc                       [OK] Running (23s, x1)
      â”‚   â”œâ”€â”€ nat-stats
      â”‚   â”‚   â””â”€â”€ timer-job-nat-stats                             [OK] OK (1.799164ms) (22s, x1)
      â”‚   â”œâ”€â”€ node-manager
      â”‚   â”‚   â”œâ”€â”€ neighbor-link-updater
      â”‚   â”‚   â”‚   â”œâ”€â”€ k8s-w1                                      [OK] Node neighbor link update successful (12s, x1)
      â”‚   â”‚   â”‚   â””â”€â”€ k8s-w2                                      [OK] Node neighbor link update successful (12s, x1)
      â”‚   â”‚   â”œâ”€â”€ node-checkpoint-writer                          [OK] node checkpoint written (23s, x1)
      â”‚   â”‚   â””â”€â”€ nodes-add                                       [OK] Node adds successful (20s, x3)
      â”‚   â”œâ”€â”€ service-manager
      â”‚   â”‚   â””â”€â”€ job-ServiceReconciler                           [OK] 1 NodePort frontend addresses (22s, x1)
      â”‚   â”œâ”€â”€ service-resolver
      â”‚   â”‚   â””â”€â”€ job-service-reloader-initializer                [OK] Running (23s, x1)
      â”‚   â”œâ”€â”€ stale-endpoint-cleanup
      â”‚   â”‚   â””â”€â”€ job-endpoint-cleanup                            [OK] Running (22s, x1)
      â”‚   â””â”€â”€ timer-job-device-reloader                           [OK] OK (8.458Âµs) (12s, x1)
      â”œâ”€â”€ datapath
      â”‚   â”œâ”€â”€ agent-liveness-updater
      â”‚   â”‚   â””â”€â”€ timer-job-agent-liveness-updater                [OK] OK (34.252Âµs) (0s, x1)
      â”‚   â”œâ”€â”€ iptables
      â”‚   â”‚   â”œâ”€â”€ ipset
      â”‚   â”‚   â”‚   â”œâ”€â”€ job-ipset-init-finalizer                    [OK] Running (23s, x1)
      â”‚   â”‚   â”‚   â”œâ”€â”€ job-reconcile                               [OK] OK, 0 object(s) (23s, x1)
      â”‚   â”‚   â”‚   â””â”€â”€ job-refresh                                 [OK] Next refresh in 30m0s (23s, x1)
      â”‚   â”‚   â””â”€â”€ job-iptables-reconciliation-loop                [OK] iptables rules full reconciliation completed (22s, x1)
      â”‚   â”œâ”€â”€ l2-responder
      â”‚   â”‚   â””â”€â”€ job-l2-responder-reconciler                     [OK] Running (22s, x1)
      â”‚   â”œâ”€â”€ maps
      â”‚   â”‚   â””â”€â”€ bwmap
      â”‚   â”‚       â””â”€â”€ timer-job-pressure-metric-throttle          [OK] Primed (22s, x1)
      â”‚   â”œâ”€â”€ node-address
      â”‚   â”‚   â””â”€â”€ job-node-address-update                         [OK] 172.16.0.186 (primary), fe80::90fa:55ff:fefe:af7a (primary) (22s, x1)
      â”‚   â””â”€â”€ sysctl
      â”‚       â”œâ”€â”€ job-reconcile                                   [OK] OK, 16 object(s) (18s, x9)
      â”‚       â””â”€â”€ job-refresh                                     [OK] Next refresh in 10m0s (23s, x1)
      â””â”€â”€ infra
          â””â”€â”€ k8s-synced-crdsync
              â””â”€â”€ job-sync-crds                                   [OK] Running (23s, x1)

```


#### IPAM í™•ì¸


í•œë²ˆ Pod CIDRì„ ë¶™ì—¬ë³´ë ¤ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìœ¼ë‚˜, ì˜ì•ˆë˜ì„œ í™•ì¸í•´ë³´ë‹ˆ v1.70ë¶€í„° Multi-Poolì„ ì§€ì›í•œë‹¤ê³  í•œë‹¤. ì´ë•ŒëŠ” ipam.modeë¥¼ K8sê°€ ì•„ë‹Œ  `--set ipam.mode=cluster-pool`ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.


```bash
kubectl get ciliumnodes -o json | jq '.items[].spec.ipam.podCIDRs'
[
  "172.16.0.0/24"
]
[
  "172.16.2.0/24"
]
[
  "172.16.1.0/24"
]
```


CiliumNodeì—ì„œ ê° ë…¸ë“œì— ëŒ€í•œ IPAMì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
kubectl get ciliumnodes.cilium.io k8s-w1 -o yaml
apiVersion: cilium.io/v2
kind: CiliumNode
metadata:
  creationTimestamp: "2024-10-27T00:25:18Z"
  generation: 1
  labels:
    beta.kubernetes.io/arch: amd64
    beta.kubernetes.io/os: linux
    kubernetes.io/arch: amd64
    kubernetes.io/hostname: k8s-w1
    kubernetes.io/os: linux
  name: k8s-w1
  ownerReferences:
  - apiVersion: v1
    kind: Node
    name: k8s-w1
    uid: 3efc368e-0df3-4f1d-b14a-2670f0e56518
  resourceVersion: "1291"
  uid: cdbc6c64-5835-48ee-b953-d2d124af8952
spec:
  addresses:
  - ip: 192.168.10.101
    type: InternalIP
  - ip: 172.16.2.77
    type: CiliumInternalIP
  alibaba-cloud: {}
  azure: {}
  bootid: 805b50be-1596-49b4-909c-6e1def95f2bc
  encryption: {}
  eni: {}
  health:
    ipv4: 172.16.2.122
  ingress: {}
  ipam:
    podCIDRs:
    - 172.16.2.0/24
    pools: {}
```


# Cilium Packet Flow


ì²«ë²ˆì§¸ë¡œ Ciliumì´ ì–´ë–»ê²Œ íŒŒë“œ í†µì‹ ì„ ì§€ì›í•˜ëŠ”ì§€ ì•Œì•„ë³´ê³ , kube-proxy ì—†ì´ ì–´ë–»ê²Œ ì„œë¹„ìŠ¤ í†µì‹ ì„ ì§€ì›í•˜ëŠ”ì§€ ì‚´í´ë³¸ë‹¤.


ìš°ì„ , íŒŒë“œ í†µì‹ ì— ëŒ€í•œ Flowë¥¼ ì•Œì•„ë³´ê¸° ìœ„í•´ íŒŒë“œë¥¼ ë°°í¬í•œë‹¤.


## íŒŒë“œ í†µì‹  í™•ì¸í•˜ê¸°


### íŒŒë“œ ë°°í¬


```bash
cat <<EOF | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod
  labels:
    app: netpod
spec:
  nodeName: k8s-s
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: k8s-w1
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: k8s-w2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
EOF
```


í¸ì˜ë¥¼ ìœ„í•´ íŒŒë“œ ë‹¨ì¶•í‚¤ë¥¼ ì§€ì •í•œë‹¤.


```bash
# í…ŒìŠ¤íŠ¸ íŒŒë“œë“¤ IP
NETPODIP=$(kubectl get pods netpod -o jsonpath='{.status.podIP}')
WEBPOD1IP=$(kubectl get pods webpod1 -o jsonpath='{.status.podIP}')
WEBPOD2IP=$(kubectl get pods webpod2 -o jsonpath='{.status.podIP}')

# ë‹¨ì¶•í‚¤(alias) ì§€ì •
alias p0="kubectl exec -it netpod  -- "
alias p1="kubectl exec -it webpod1 -- "
alias p2="kubectl exec -it webpod2 -- "
```


### ë„¤íŠ¸ì›Œí¬ í™˜ê²½ í™•ì¸


ì•„ë˜ì˜ ì‚¬ì§„ì€ Cilium ë°°í¬ì‹œ í˜¸ìŠ¤íŠ¸ì— ì„¤ì •ë˜ëŠ” ê¸°ë³¸ ìš”ì†Œì´ë‹¤. 

- Host ì˜ì—­: cilium_host, cilium_net, cilium_vlxlan(ì˜¤ë²„ë ˆì´ ë¼ìš°íŒ… ì„ íƒì‹œ) ì¸í„°í˜ì´ìŠ¤ ìƒì„±
- íŒŒë“œ ê´€ë ¨: lxc~ë¡œ ì‹œì‘í•˜ëŠ” íŒŒë“œì™€ ë§µí•‘ë˜ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ìƒì„±ëœë‹¤.

![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/5.png)


ì¶œì²˜: [https://arthurchiao.art/blog/cilium-life-of-a-packet-pod-to-service/](https://arthurchiao.art/blog/cilium-life-of-a-packet-pod-to-service/)


íŒŒë“œ ìƒì„± í›„ **k8s-s** í˜¸ìŠ¤íŠ¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¸í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ ë§ˆì§€ë§‰ì— lxc ì¸í„°í˜ì´ìŠ¤ê°€ í•˜ë‚˜ ìƒì„±ëœë‹¤.


```bash
ip -c addr
...
10: lxce880e1eecb7a@if9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether 3e:6a:d8:a6:93:05 brd ff:ff:ff:ff:ff:ff link-netns cni-829ecafa-430f-17ba-f69a-08f0bf5930b5
    inet6 fe80::3c6a:d8ff:fea6:9305/64 scope link
       valid_lft forever preferred_lft forever
```


`lxce880e1eecb7a@if9` ëŠ” `lxce880e1eecb7a` ì¸í„°í˜ì´ìŠ¤ì™€ `if9`ê°€ peerë¡œ ì—°ê²°ë˜ì—ˆë‹¨ ì˜ë¯¸ì´ë‹¤. if9ì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” `cni-829ecafa-430f-17ba-f69a-08f0bf5930b5` ë¼ê³  ë‚˜ì™€ìˆë‹¤.


netnsë¥¼ ê·¸ëŒ€ë¡œ ì°¾ì•„ì„œ í™•ì¸í•´ë³¸ë‹¤. ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ê°€ íŒŒë“œì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¼ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

- í˜¸ìŠ¤íŠ¸ì—ì„œ network namespaceë¡œ í™•ì¸

```bash
ip netns exec cni-829ecafa-430f-17ba-f69a-08f0bf5930b5 ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
9: eth0@if10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether ce:4f:33:14:59:b3 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.16.0.124/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::cc4f:33ff:fe14:59b3/64 scope link
       valid_lft forever preferred_lft forever
```

- íŒŒë“œì— ì ‘ì†í•˜ì—¬ í™•ì¸

```bash
p0 ip -c addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host proto kernel_lo
       valid_lft forever preferred_lft forever
9: eth0@if10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether ce:4f:33:14:59:b3 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.16.0.124/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::cc4f:33ff:fe14:59b3/64 scope link proto kernel_ll
       valid_lft forever preferred_lft forever
```



ì¦‰ lxce880e1eecb7aëŠ” if9, ì¦‰ íŒŒë“œì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ **eth0**ê³¼ peerë¡œ ì—°ê²°ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 


ì§€ê¸ˆê¹Œì§€ íŒŒì•…í•œ ë‚´ìš©ì„ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

- lxc~ ì¸í„°í˜ì´ìŠ¤ëŠ” íŒŒë“œì™€ ì—°ê²°ëœ ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.
- cilium_host, cilium_netì€ ì„œë¡œ peerë¡œ ì—°ê²°ë˜ì–´ìˆìœ¼ë©°, í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ì— ì¡´ì¬í•˜ì—¬ í˜¸ìŠ¤íŠ¸ ìˆ˜ì¤€ì˜ ì²˜ë¦¬ë¥¼ ì§„í–‰í•œë‹¤

![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/6.png)


ì¶œì²˜: [https://addozhang.medium.com/kubernetes-network-learning-with-cilium-and-ebpf-aafbf3163840](https://addozhang.medium.com/kubernetes-network-learning-with-cilium-and-ebpf-aafbf3163840)


### ê°™ì€ ë…¸ë“œ ë‚´ì˜ íŒŒë“œ í†µì‹  í™•ì¸


k8s-s ë…¸ë“œì— í•˜ë‚˜ì˜ íŒŒë“œë¥¼ ë” ë°°í¬í•œë‹¤.


```bash
cat <<EOF | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: netpod2
  labels:
    app: netpod2
spec:
  nodeName: k8s-s
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
EOF
pod/netpod2 created
```


ë‹¨ì¶•í‚¤ ì„¤ì •ë„ ë˜‘ê°™ì´ ì§„í–‰í•œë‹¤. netpod2ëŠ” p3ì´ë‹¤.


ê° íŒŒë“œì˜ ê²Œì´íŠ¸ì›¨ì´ë¥¼ í™•ì¸í•œë‹¤. cilium_host ì¸í„°í˜ì´ìŠ¤ì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/7.png)


ì´ì œ ping í…ŒìŠ¤íŠ¸ë¥¼ ê° íŒŒë“œì—ì„œ í•œë²ˆì”© ì§„í–‰í•œë‹¤. ì •ìƒ í†µì‹ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 


```bash
p3 ping -c 1 $NETPODIP
p0 ping -c 1 $NETPODIP2
```


ì´ì œ ê° íŒŒë“œì˜ **ip neigh**ë¥¼ í™•ì¸í•œë‹¤. ì´ ëª…ë ¹ì–´ëŠ” ARP í…Œì´ë¸”ì„ ì¡°íšŒí•˜ì—¬ ipì— ëŒ€í•œ MAC ì£¼ì†Œë¥¼ ì•Œë ¤ì¤€ë‹¤. ê²Œì´íŠ¸ì›¨ì´ì— ëŒ€í•œ ì •ë³´ë§Œ ìˆë‹¤.


```bash
p3 ip -c neigh
172.16.0.40 dev eth0 lladdr b2:34:10:43:81:c6 REACHABLE
p0 ip -c neigh
172.16.0.40 dev eth0 lladdr 3e:6a:d8:a6:93:05 REACHABLE
```


ì •ìƒì ìœ¼ë¡œ í†µì‹ ì´ ì´ë¤„ì§€ë ¤ë©´, íŒŒë“œê°€ ì„œë¡œì˜ MACì£¼ì†Œ í˜¹ì€ IPë¥¼ í†µí•´ í†µì‹ í•´ì•¼ í•œë‹¤. í•˜ì§€ë§Œ íŒŒë“œì™€ ì—°ê²°ëœ lxcì¸í„°í˜ì´ìŠ¤ì—ëŠ” **IPê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.** ê·¸ë ‡ë‹¤ë©´ MACì£¼ì†Œë¡œ í†µì‹ í•´ì•¼ í•˜ëŠ”ë°, ìœ„ì˜ ARP í…Œì´ë¸”ì„ ë³´ë©´ ì—†ë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  ì´ë¥¼ í†µí•´ cilium_hostê°€ ebpfë¥¼ í†µí•´ ARPì„ ì¤‘ê°„ì— ê°€ë¡œì±„ì„œ í†µì‹ ì„ ì§„í–‰í•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.


ê²°êµ­ ìš°ë¦¬ì˜ í†µì‹  ì‹œë‚˜ë¦¬ì˜¤ì˜ FlowëŠ” ì•„ë˜ì™€ ê°™ì´ ì§„í–‰ëœë‹¤.


**p3ì—ì„œ p0ì— ëŒ€í•œ ARPë¥¼ ìš”ì²­ > cilium_hostì—ì„œ ìì‹ ì˜ IPë¡œ ì‘ë‹µ > p3ì´ cilium_hostë¡œ íŒ¨í‚· ì „ì†¡ > ciliu_hostì—ì„œ í•´ë‹¹ Podì™€ ì—°ê²°ëœ lxc interfaceë¡œ ë¼ìš°íŒ…**


ì´ì œ Cilium CLIë¥¼ í†µí•´ ebpfì™€ ê°’ì„ í™•ì¸í•˜ì—¬, ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•´ë³´ì.


#### Cilium CLIë¥¼ í†µí•´ ì •ë³´ í™•ì¸


netpodì˜ interfaceë¥¼ LXCì— ì €ì¥í•´ë‘”ë‹¤. c0bpfë¥¼ í†µí•´ cilium_agentì—ì„œ ê´€ë ¨ ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¸í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ tc ë‹¨ì—ì„œ ingressì™€ egressë¥¼ í†µì œí•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì´ë¡ í¸ì—ì„œ ì‚´í´ë³¸ ê²ƒê³¼ ê°™ì´ L3,4 ì •ì±…ì´ ìˆìœ¼ë©´ **ë¦¬ëˆ…ìŠ¤ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒ ì¤‘ tcì—ì„œ packetì„ dropí•  ìˆ˜ ìˆë‹¤.**


```bash
c0bpf net show | grep $LXC
lxc8b470d2428ec(14) tcx/ingress cil_from_container prog_id 1402 link_id 27
lxc8b470d2428ec(14) tcx/egress cil_to_container prog_id 1396 link_id 28
```


ìœ„ì—ì„œ ë‚˜ì˜¨ IDë¥¼ ì¡°íšŒí•œë‹¤. í•´ë‹¹ ebpfì—ì„œ ì‚¬ìš©í•˜ëŠ” map ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.


```bash
c0bpf prog show id 1402
1402: sched_cls  name cil_from_container  tag 53dfab9415326465  gpl
	loaded_at 2024-10-28T13:50:16+0000  uid 0
	xlated 728B  jited 545B  memlock 4096B  map_ids 198,66
	btf_id 435
c0bpf prog show id 1396
1396: sched_cls  name cil_to_container  tag 06896e9e3562f5c2  gpl
	loaded_at 2024-10-28T13:50:16+0000  uid 0
	xlated 1712B  jited 1015B  memlock 4096B  map_ids 66,198
	btf_id 429
```


cilium_calls_00ì´ íŒŒë“œë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ëŠ” mapì´ê³  ë‹¤ë¥¸ mapì€ ì§€í‘œ ìˆ˜ì§‘ì„ ìœ„í•œ mapì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash

c0bpf map list | grep 66
66: percpu_hash  name cilium_metrics  flags 0x1
	key 8B  value 8B  max_entries 4096  memlock 66560B
		
c0bpf map list | grep 198 -A2
198: prog_array  name cilium_calls_00  flags 0x0
	key 4B  value 4B  max_entries 50  memlock 720B
	owner_prog_type sched_cls  owner jited
```


### ë…¸ë“œ ê°„ íŒŒë“œ í†µì‹  í™•ì¸


ì´ì œ ë…¸ë“œ ê°„ì˜ íŒŒë“œ í†µì‹ ì„ ì‹¤ì œë¡œ ì§„í–‰í•´ë³´ë©´ì„œ, Packet Flowë¥¼ ìì„¸íˆ í™•ì¸í•´ë³¸ë‹¤.


#### ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤


netpodëŠ” k8s-s ë…¸ë“œì— ìœ„ì¹˜í•˜ë©°, webpodëŠ” ê°ê° k8s-w1, k8s-w2ì— ìœ„ì¹˜í•œë‹¤. ìš°ë¦¬ëŠ” ì—¬ê¸°ì„œ netpodì—ì„œ ê° webpodë¡œ ì ‘ì†ì„ ì‹œë„í•´ë³´ë©´ì„œ ë‹¤ë¥¸ ë…¸ë“œì— ìœ„ì¹˜í•œ íŒŒë“œë¼ë¦¬ì˜ í†µì‹  flowë¥¼ ì•Œì•„ë³¸ë‹¤.

- íŒŒë“œ IP ì •ë³´ í™•ì¸

![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/8.png)

- ë…¸ë“œ IP ì •ë³´ í™•ì¸

![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/9.png)


#### í†µì‹  ì§„í–‰(netpod > webpodë¡œ ping -c 1 í†µì‹ )

- hubble

![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/10.png)

- hubble clië¥¼ í†µí•´ í™•ì¸ ê°€ëŠ¥

```bash
hubble observe --pod netpod
...
Nov  1 14:01:20.633: default/netpod (ID:504) -> default/webpod1 (ID:3470) to-network FORWARDED (ICMPv4 EchoRequest)
Nov  1 14:01:20.633: default/netpod (ID:504) -> default/webpod1 (ID:3470) to-endpoint FORWARDED (ICMPv4 EchoRequest)
Nov  1 14:01:20.633: default/netpod (ID:504) <- default/webpod1 (ID:3470) to-endpoint FORWARDED (ICMPv4 EchoReply)
Nov  1 14:01:20.633: default/netpod (ID:504) <- default/webpod1 (ID:3470) to-network FORWARDED (ICMPv4 EchoReply)
```


ë…¸ë“œì˜ ì¸í„°í˜ì´ìŠ¤ë¡œ tcpdumpë¥¼ ì§„í–‰í•˜ë©´, ì•„ë˜ì™€ ê°™ì€ ì •ë³´ê°€ ì¶œë ¥ëœë‹¤. ì´ê²ƒì™¸ì—ëŠ” ë™ì‹œê°„ëŒ€ì— ì¶œë ¥ë˜ëŠ” ê²ƒì€ ì—†ë‹¤. ì´ê²ƒ ë˜í•œ ebpfë¥¼ í†µí•´ ì»¤ë„ë‹¨ì—ì„œ ì•Œì•„ì„œ ì²˜ë¦¬í•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. **ê·¸ë ‡ê¸°ì— ë³´ì•ˆ í”„ë¡œê·¸ë¨ì´ ê¹”ë ¤ìˆìœ¼ë©´, ì´ê²ƒì„ ìš°íšŒí•  ê°€ëŠ¥ì„±ë„ í¬ë‹¤.**


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/11.png)

- cilium map í™•ì¸

cilium mapì„ í†µí•´ ipcacheë¥¼ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì–´ëŠ ë…¸ë“œë¡œ ë³´ë‚´ì•¼í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
c0 map get cilium_ipcache | grep $WEBPOD1IP
172.16.2.176/32     identity=3470 encryptkey=0 tunnelendpoint=192.168.10.101, flags=<none>    sync
```


#### NAT


##### MASQUERADE


MASQUERADEë€ Iptablesì—ì„œ ì‚¬ìš©í•˜ëŠ” Target ì¤‘ í•˜ë‚˜ë¡œ ì™¸ë¶€ì™€ì˜ í†µì‹ ì„ ìœ„í•´ ë…¸ë“œì˜ IPë¡œ NAT ë³€í™˜ì„ ìˆ˜í–‰í•  ë•Œ ì‚¬ìš©ëœë‹¤.


##### ip-masq-agent


kube-proxyê°€ ì›ë˜ ê¸°ë³¸ì ìœ¼ë¡œ ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ì— ëŒ€í•´ SNATì„ ì œê³µí•œë‹¤. ciliumì—ì„œë„ ebpfë¡œ ì œê³µí•˜ë‚˜ ip-masq-agentë¥¼ í†µí•´ ë§ˆìŠ¤ì»¤ë ˆì´ë“œ ì˜ˆì™¸ ì„¤ì •ìœ¼ë¡œ ë” ì„¸ë¶„í™”ëœ ê´€ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— í•œí•´ì„œëŠ” SNATì„ ì ìš©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤. ê´€ë ¨ëœ ê²ƒì€ í•´ë‹¹ [ë¬¸ì„œ](https://github.com/kubernetes-sigs/ip-masq-agent)ì—ì„œ í™•ì¸ê°€ëŠ¥í•˜ë‹¤.


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/12.png)


##### ip-masq-agent ì„¤ì •


```bash
helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values --set ipMasqAgent.enabled=true
```


```bash
cilium config view | grep -i mascilium config view | grep -i masq
enable-bpf-masquerade                             true
enable-ip-masq-agent                              true
enable-ipv4-masquerade                            true
enable-ipv6-masquerade                            true
enable-masquerade-to-route-source                 false
```


```bash
kubectl get cm -n kube-system cilium-config -o yaml  | grep ip-masq
  enable-ip-masq-agent: "true"
```


ë§Œì•½, enable-ipv4-masqueradeë¥¼ falseë¡œ ì„¤ì •í•˜ë©´ ë…¸ë“œì˜ IPë¡œ ë°”ë€Œì§€ ì•Šì•„ íŒŒë“œì˜ IPê°€ ë…¸ì¶œë˜ë©° ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ì´ë¼ë©´ ì •ìƒì ìœ¼ë¡œ í†µì‹ í•  ìˆ˜ ì—†ë‹¤.


#### NAT í™•ì¸


íŒŒë“œì—ì„œ ë…¸ë“œë¡œ ë‚˜ê°€ê¸° ìœ„í•œ ìœ„í•œ NAT ë¦¬ìŠ¤íŠ¸ë¥¼ ì•„ë˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```c
c0 bpf nat list
UDP IN 169.254.169.123:123 -> 192.168.10.10:54229 XLATE_DST 192.168.10.10:54229 Created=690sec ago NeedsCT=1
UDP OUT 192.168.10.10:49847 -> 169.254.169.123:123 XLATE_SRC 192.168.10.10:49847 Created=222sec ago NeedsCT=1
UDP OUT 192.168.10.10:37607 -> 169.254.169.123:123 XLATE_SRC 192.168.10.10:37607 Created=723sec ago NeedsCT=1
UDP IN 169.254.169.123:123 -> 192.168.10.10:34464 XLATE_DST 192.168.10.10:34464 Created=44sec ago NeedsCT=1
TCP IN 172.16.2.65:8081 -> 192.168.10.10:64431 XLATE_DST 221.142.255.113:64431 Created=275sec ago NeedsCT=0
UDP IN 3.39.176.65:123 -> 192.168.10.10:41170 XLATE_DST 192.168.10.10:41170 Created=213sec ago NeedsCT=1
ICMP OUT 192.168.10.10:62264 -> 192.168.10.102:0 XLATE_SRC 192.168.10.10:62264 Created=438sec ago NeedsCT=1
TCP OUT 221.142.255.113:63744 -> 172.16.2.65:8081 XLATE_SRC 192.168.10.10:63744 Created=2664sec ago NeedsCT=0
TCP OUT 221.142.255.113:64491 -> 172.16.2.65:8081 XLATE_SRC 192.168.10.10:64491 Created=21sec ago NeedsCT=0
UDP IN 169.254.169.123:123 -> 192.168.10.10:37667 XLATE_DST 192.168.10.10:37667 Created=335sec ago NeedsCT=1
UDP OUT 192.168.10.10:57668 -> 169.254.169.123:123 XLATE_SRC 192.168.10.10:57668 Created=788sec ago NeedsCT=1
UDP IN 169.254.169.123:123 -> 192.168.10.10:55335 XLATE_DST 192.168.10.10:55335 Created=255sec ago NeedsCT=1
UDP IN 169.254.169.123:123 -> 192.168.10.10:37169 XLATE_DST 192.168.10.10:37169 Created=771sec ago NeedsCT=1
UDP OUT 192.168.10.10:48469 -> 169.254.169.123:123 XLATE_SRC 192.168.10.10:48469 Created=125sec ago NeedsCT=1
ICMP OUT 192.168.10.10:58599 -> 192.168.10.102:0 XLATE_SRC 192.168.10.10:58599 Created=258sec ago NeedsCT=1
ICMP IN 192.168.10.101:0 -> 192.168.10.10:36878 XLATE_DST 192.168.10.10:36878 Created=678sec ago NeedsCT=1
```


## ì„œë¹„ìŠ¤ í†µì‹  í™•ì¸


ê¸°ì¡´ì—ëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì—ì„œ ì„œë¹„ìŠ¤ì— ë¡œë“œë°¸ëŸ°ì‹±ê³¼ í†µì‹ ì´ ì´ë¤„ì¡Œë‹¤. (ex. Iptables) í•˜ì§€ë§Œ **Ciliumì—ì„œëŠ” ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±**ì„ ì§„í–‰í•œë‹¤. ì¦‰, ebpfê°€ ì†Œì¼“ì„ ìƒì„±í•  ë•Œ target IPë¥¼ ì„œë¹„ìŠ¤ì˜ IPì—ì„œ ì ì ˆí•œ íŒŒë“œì˜ IPë¡œ ë³€ê²½í•œë‹¤. ë§Œì•½, ì„œë¹„ìŠ¤ì˜ ClusterIPë¡œ ì„¤ì •í•˜ë©´ DNAT ê³¼ì •ì´ ìˆì–´ì•¼í•˜ì§€ë§Œ **íŒŒë“œì˜ IPë¡œ ì†Œì¼“ ì—°ê²°ì„ ì§„í–‰í•˜ê¸°ì— DNAT ê³¼ì •ì´ ìƒëµë˜ì–´ ë„¤íŠ¸ì›Œí¬ hopì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.**


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/13.png)


ì¶œì²˜: [https://cilium.io/blog/2019/08/20/cilium-16/](https://cilium.io/blog/2019/08/20/cilium-16/)


### ì„œë¹„ìŠ¤ ë°°í¬


```c
cat <<EOF | kubectl create -f -
apiVersion: v1
kind: Service
metadata:
  name: svc
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: ClusterIP
EOF
service/svc created
```


```c
kubectl get svc,ep svc
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/svc   ClusterIP   10.10.252.131   <none>        80/TCP    4s

NAME            ENDPOINTS                         AGE
endpoints/svc   172.16.1.235:80,172.16.2.253:80   4s
```


#### ì ‘ì† í™•ì¸


```c
kubectl exec netpod -- curl -s $SVCIP
Hostname: webpod2
IP: 127.0.0.1
IP: ::1
IP: 172.16.2.253
IP: fe80::80c4:5bff:fe4b:6e3f
RemoteAddr: 172.16.0.79:33320
GET / HTTP/1.1
Host: 10.10.252.131
User-Agent: curl/8.7.1
Accept: */*
```


### Flow ë¶„ì„


#### netpod(Client) íŒŒë“œì—ì„œ tcpdump ì‹¤í–‰


ì„œë¹„ìŠ¤ IP(10.10.252.131)ëŠ” ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. SNAT ê³¼ì •ì€ ì—†ê³ , DNAT ëœ ê²ƒì„ íŒŒë“œì—ì„œ ë³¼ ìˆ˜ ìˆë‹¤. ê²°êµ­ íŒŒë“œì—ì„œ ë°”ë¡œ ì„œë¹„ìŠ¤ì— ëŒ€í•œ DNAT ì²˜ë¦¬ë¥¼ ì§„í–‰í•œë‹¤ëŠ” ê²ƒì´ë‹¤.


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/14.png)


#### strace ë¶„ì„


straceë¥¼ í†µí•´ kernel ì˜ì—­ì— ëŒ€í•œ ëª¨ë‹ˆí„°ë§ ë¶„ì„í•´ë³´ì.


socket ì‹œìŠ¤í…œ ì½œì´ ë‚˜ì˜¤ê³ , connectê¹Œì§€ëŠ” Service IPë¡œ ì—°ê²°ì„ ì‹œë„í•˜ì§€ë§Œ, ë°”ë¡œ ì•„ë˜ì˜ ì‹œìŠ¤í…œ ì½œë¶€í„° íŒŒë“œì˜ IPë¡œ ë°”ë€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ë¥¼ í†µí•´ ebpfë¥¼ í†µí•´ ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±ì„ ì§„í–‰í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
kubectl exec netpod -- strace -s 65535 -f -tt curl -s $SVCIP
15:09:36.427597 execve("/usr/bin/curl", ["curl", "-s", "10.10.252.131"], 0x7ffda01c0eb0 /* 11 vars */) = 0
15:09:36.430429 close(3)                = 0
...
15:09:36.499211 socket(AF_INET, SOCK_STREAM, IPPROTO_TCP) = 5
15:09:36.499341 setsockopt(5, SOL_TCP, TCP_NODELAY, [1], 4) = 0
15:09:36.499442 setsockopt(5, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0
15:09:36.499595 setsockopt(5, SOL_TCP, TCP_KEEPIDLE, [60], 4) = 0
15:09:36.499759 setsockopt(5, SOL_TCP, TCP_KEEPINTVL, [60], 4) = 0
15:09:36.499924 fcntl(5, F_GETFL)       = 0x2 (flags O_RDWR)
15:09:36.500077 fcntl(5, F_SETFL, O_RDWR|O_NONBLOCK|O_LARGEFILE) = 0
15:09:36.500128 connect(5, {sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("10.10.252.131")}, 16) = -1 EINPROGRESS (Operation in progress)
15:09:36.500580 getsockname(5, {sa_family=AF_INET, sin_port=htons(43654), sin_addr=inet_addr("172.16.0.79")}, [128 => 16]) = 0
15:09:36.501053 rt_sigaction(SIGPIPE, {sa_handler=SIG_IGN, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7ee48f40afd0}, NULL, 8) = 0
15:09:36.501199 poll([{fd=5, events=POLLOUT}, {fd=3, events=POLLIN}], 2, 1000) = 1 ([{fd=5, revents=POLLOUT}])
15:09:36.501315 rt_sigaction(SIGPIPE, NULL, {sa_handler=SIG_IGN, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7ee48f40afd0}, 8) = 0
15:09:36.501596 rt_sigaction(SIGPIPE, {sa_handler=SIG_IGN, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7ee48f40afd0}, NULL, 8) = 0
15:09:36.502077 poll([{fd=5, events=POLLPRI|POLLOUT|POLLWRNORM}], 1, 0) = 1 ([{fd=5, revents=POLLOUT|POLLWRNORM}])
15:09:36.502555 getsockopt(5, SOL_SOCKET, SO_ERROR, [0], [4]) = 0
15:09:36.502720 getsockname(5, {sa_family=AF_INET, sin_port=htons(43654), sin_addr=inet_addr("172.16.0.79")}, [128 => 16]) = 0
15:09:36.503023 getsockname(5, {sa_family=AF_INET, sin_port=htons(43654), sin_addr=inet_addr("172.16.0.79")}, [128 => 16]) = 0
15:09:36.503493 getsockname(5, {sa_family=AF_INET, sin_port=htons(43654), sin_addr=inet_addr("172.16.0.79")}, [128 => 16]) = 0
15:09:36.503838 sendto(5, "GET / HTTP/1.1\r\nHost: 10.10.252.131\r\nUser-Agent: curl/8.7.1\r\nAccept: */*\r\n\r\n", 76, MSG_NOSIGNAL, NULL, 0) = 76
...
15:09:36.505368 recvfrom(5, "HTTP/1.1 200 OK\r\nDate: Mon, 28 Oct 2024 15:09:36 GMT\r\nContent-Length: 193\r\nContent-Type: text/plain; charset=utf-8\r\n\r\nHostname: webpod2\nIP: 127.0.0.1\nIP: ::1\nIP: 172.16.2.253\nIP: fe80::80c4:5bff:fe4b:6e3f\nRemoteAddr: 172.16.0.79:43654\nGET / HTTP/1.1\r\nHost: 10.10.252.131\r\nUser-Agent: curl/8.7.1\r\nAccept: */*\r\n\r\n", 102400, 0, NULL, NULL) = 311
15:09:36.505864 ioctl(1, TIOCGWINSZ, 0x7ffda7d10c68) = -1 ENOTTY (Not a tty)
15:09:36.505972 writev(1, [{iov_base="", iov_len=0}, {iov_base="Hostname: webpod2\nIP: 127.0.0.1\nIP: ::1\nIP: 172.16.2.253\nIP: fe80::80c4:5bff:fe4b:6e3f\nRemoteAddr: 172.16.0.79:43654\nGET / HTTP/1.1\r\nHost: 10.10.252.131\r\nUser-Agent: curl/8.7.1\r\nAccept: */*\r\n\r\n", iov_len=193}], 2) = 193
Hostname: webpod2
IP: 127.0.0.1
IP: ::1
IP: 172.16.2.253
IP: fe80::80c4:5bff:fe4b:6e3f
RemoteAddr: 172.16.0.79:43654
GET / HTTP/1.1
Host: 10.10.252.131
User-Agent: curl/8.7.1
Accept: */*

...
```


### Ciliumì—ì„œ í™•ì¸


ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì„¤ì •ê°’ì„ í™•ì¸í•´ë³¸ë‹¤.


```bash
c0 service list | grep 10.10.252.131 -A2
9    10.10.252.131:80      ClusterIP      1 => 172.16.1.235:80 (active)
                                          2 => 172.16.2.253:80 (active)
c0 bpf lb list | grep 10.10.252.131
10.10.252.131:80 (2)      172.16.2.253:80 (9) (2)
10.10.252.131:80 (1)      172.16.1.235:80 (9) (1)
10.10.252.131:80 (0)      0.0.0.0:0 (9) (0) [ClusterIP, non-routable]

c0 bpf lb list --revnat
ID   BACKEND ADDRESS (REVNAT_ID) (SLOT)
1    10.10.0.1:443
4    10.10.25.166:80
6    10.10.0.10:9153
7    192.168.10.10:32283
2    10.10.152.163:443
9    10.10.252.131:80
5    10.10.0.10:53
8    0.0.0.0:32283
3    10.10.15.144:80
```


ì•„ë˜ì™€ ê°’ì´ ì„œë¹„ìŠ¤ IPê°€ ë“¤ì–´ì˜¬ ë•Œ ì‚¬ìš©í•˜ëŠ” map ë°ì´í„°êµ¬ì¡°ì˜ ì €ì¥ëœ Keyê°’ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.


```c
c0 map get cilium_lb4_services_vc0 map get cilium_lb4_services_v2 | grep 10.10.252.131
10.10.252.131:80 (2)      12 0 (9) [0x0 0x0]   sync
10.10.252.131:80 (1)      11 0 (9) [0x0 0x0]   sync
10.10.252.131:80 (0)      0 2 (9) [0x0 0x0]    sync
```


í‚¤ ê°’ì„ ë”°ë¼ê°€ë³´ë©´, íŒŒë“œì˜ IPê°€ ë‚˜ì˜¨ë‹¤.


```c
c0 map get cilium_lb4_backends_v3 | grep -E '11|12'
11    ANY://172.16.1.235    sync
12    ANY://172.16.2.253    sync
```


IPì— ëŒ€í•œ ìºì‹œê°’ìœ¼ë¡œ, í•´ë‹¹ ê°’ì´ ìˆìœ¼ë©´ ë¼ìš°íŒ…ëœë‹¤. ì—¬ê¸°ì„  tunnel í¬ì¸íŠ¸ëŠ” í•´ë‹¹ IPê°€ ìœ„ì¹˜í•˜ê³  ìˆëŠ” ë…¸ë“œë¥¼ ì˜ë¯¸í•œë‹¤.


```c
c0 map get cilium_ipcache
Key                 Value                                                                     State   Error
192.168.10.102/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>              sync
0.0.0.0/0           identity=2 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>              sync
172.16.1.235/32     identity=10037 encryptkey=0 tunnelendpoint=192.168.10.101, flags=<none>   sync
172.16.0.79/32      identity=26332 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>          sync
172.16.2.253/32     identity=10037 encryptkey=0 tunnelendpoint=192.168.10.102, flags=<none>   sync
172.16.0.144/32     identity=40127 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>          sync
192.168.10.101/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>              sync
172.16.1.180/32     identity=4 encryptkey=0 tunnelendpoint=192.168.10.101, flags=<none>       sync
172.16.2.144/32     identity=4 encryptkey=0 tunnelendpoint=192.168.10.102, flags=<none>       sync
172.16.2.65/32      identity=46309 encryptkey=0 tunnelendpoint=192.168.10.102, flags=<none>   sync
172.16.0.189/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>              sync
192.168.10.10/32    identity=1 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>              sync
172.16.2.206/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.102, flags=<none>       sync
172.16.0.43/32      identity=4 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>              sync
172.16.0.193/32     identity=40127 encryptkey=0 tunnelendpoint=0.0.0.0, flags=<none>          sync
172.16.2.82/32      identity=2396 encryptkey=0 tunnelendpoint=192.168.10.102, flags=<none>    sync
172.16.1.1/32       identity=6 encryptkey=0 tunnelendpoint=192.168.10.101, flags=<none>       sync
```


IPë¥¼ í™•ì¸í•˜ë©´ keyê°’ì€ webpod IPì´ë‹¤. (1.235, 2.253) Value ê°’ì€ ì„œë¹„ìŠ¤ IPì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```c
c0 map get cilium_lb4_reverse_sk
Key                           Value                         State   Error
[172.16.1.235]:20480, 41965   [10.10.252.131]:20480, 2304
[172.16.2.253]:20480, 45863   [10.10.252.131]:20480, 2304
[172.16.1.235]:20480, 46010   [10.10.252.131]:20480, 2304
[172.16.1.235]:20480, 42061   [10.10.252.131]:20480, 2304
[172.16.2.253]:20480, 37682   [10.10.252.131]:20480, 2304
[172.16.2.253]:20480, 45865   [10.10.252.131]:20480, 2304
[172.16.1.235]:20480, 45687   [10.10.252.131]:20480, 2304
[172.16.2.253]:20480, 33634   [10.10.252.131]:20480, 2304
[172.16.2.253]:20480, 37663   [10.10.252.131]:20480, 2304
[172.16.1.235]:20480, 33627   [10.10.252.131]:20480, 2304
[172.16.2.253]:20480, 42120   [10.10.252.131]:20480, 2304
[172.16.2.253]:20480, 38044   [10.10.252.131]:20480, 2304
[172.16.1.235]:20480, 34037   [10.10.252.131]:20480, 2304
[192.168.10.10]:11033, 8207   [10.10.0.1]:-17663, 256
[172.16.2.253]:20480, 37628   [10.10.252.131]:20480, 2304
[172.16.1.235]:20480, 38184   [10.10.252.131]:20480, 2304
...

```


## cilium connectivity test with hubble


ciliumì—ì„œëŠ” connectivity testë¥¼ ì§€ì›í•œë‹¤. `cilium connectivity test` ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œë‹¤. ingress, egress, ì™¸ë¶€ í†µì‹ , ë‹¤ë¥¸ ë…¸ë“œ ë‚´ì˜ í†µì‹ , ê°™ì€ ë…¸ë“œ ë‚´ì˜ í†µì‹  ì •ë§ ë‹¤ì–‘í•˜ê²Œ ì§„í–‰í•œë‹¤. ì´ë¥¼ í†µí•´ ì„¸ë¶„í™”ëœ ì¼€ì´ìŠ¤ì— ëŒ€í•œ ê²°ê³¼ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/15.png)


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/16.png)


![image.png](/assets/img/post/Cilium%20ì‹¤ìŠµí¸/17.png)


```bash
[=] [cilium-test-1] Test [echo-ingress-l7] [63/102]
.......
  â„¹ï¸  curl stdout:
  :0 -> :0 = 000
  â„¹ï¸  curl stderr:
  curl: (28) Failed to connect to 172.16.1.54 port 8080 after 2002 ms: Timeout was reached

  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-2-private: cilium-test-1/client2-57cf4468f-77vcg (172.16.2.185) -> curl-ipv4-2-private (172.16.1.54:8080)]
  â„¹ï¸  ğŸ“œ Applying CiliumNetworkPolicy 'echo-ingress-l7-http' to namespace 'cilium-test-1'..
  [-] Scenario [echo-ingress-l7/pod-to-pod-with-endpoints]
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-0-public: cilium-test-1/client-974f6c69d-gwvfp (172.16.2.79) -> curl-ipv4-0-public (172.16.2.162:8080)]
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-0-private: cilium-test-1/client-974f6c69d-gwvfp (172.16.2.79) -> curl-ipv4-0-private (172.16.2.162:8080)]
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-0-privatewith-header: cilium-test-1/client-974f6c69d-gwvfp (172.16.2.79) -> curl-ipv4-0-privatewith-header (172.16.2.162:8080)]
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-1-public: cilium-test-1/client-974f6c69d-gwvfp (172.16.2.79) -> curl-ipv4-1-public (172.16.1.54:8080)]
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-1-private: cilium-test-1/client-974f6c69d-gwvfp (172.16.2.79) -> curl-ipv4-1-private (172.16.1.54:8080)]
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-1-privatewith-header: cilium-test-1/client-974f6c69d-gwvfp (172.16.2.79) -> curl-ipv4-1-privatewith-header (172.16.1.54:8080)]
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-2-public: cilium-test-1/client2-57cf4468f-77vcg (172.16.2.185) -> curl-ipv4-2-public (172.16.1.54:8080)]
  âŒ command "curl -w %{local_ip}:%{local_port} -> %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 http://172.16.1.54:8080/public" failed: error with exec request (pod=cilium-test-1/client2-57cf4468f-77vcg, container=client2): command terminated with exit code 28
.  âŒ command "curl -w %{local_ip}:%{local_port} -> %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 http://172.16.1.54:8080/private" failed with unexpected exit code: error with exec request (pod=cilium-test-1/client2-57cf4468f-77vcg, container=client2): command terminated with exit code 28 (expected 22, found 28)
  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-2-privatewith-header: cilium-test-1/client2-57cf4468f-77vcg (172.16.2.185) -> curl-ipv4-2-privatewith-header (172.16.1.54:8080)]
.  âŒ command "curl -w %{local_ip}:%{local_port} -> %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 -H X-Very-Secret-Token: 42 http://172.16.1.54:8080/private" failed: error with exec request (pod=cilium-test-1/client2-57cf4468f-77vcg, container=client2): command terminated with exit code 28
  â„¹ï¸  curl stdout:
  :0 -> :0 = 000
  â„¹ï¸  curl stderr:
  curl: (28) Failed to connect to 172.16.1.54 port 8080 after 2002 ms: Timeout was reached

  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-3-public: cilium-test-1/client2-57cf4468f-77vcg (172.16.2.185) -> curl-ipv4-3-public (172.16.2.162:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-3-private: cilium-test-1/client2-57cf4468f-77vcg (172.16.2.185) -> curl-ipv4-3-private (172.16.2.162:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-3-privatewith-header: cilium-test-1/client2-57cf4468f-77vcg (172.16.2.185) -> curl-ipv4-3-privatewith-header (172.16.2.162:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-4-public: cilium-test-1/client3-67f959dd9b-czshf (172.16.1.91) -> curl-ipv4-4-public (172.16.1.54:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-4-private: cilium-test-1/client3-67f959dd9b-czshf (172.16.1.91) -> curl-ipv4-4-private (172.16.1.54:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-4-privatewith-header: cilium-test-1/client3-67f959dd9b-czshf (172.16.1.91) -> curl-ipv4-4-privatewith-header (172.16.1.54:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-5-public: cilium-test-1/client3-67f959dd9b-czshf (172.16.1.91) -> curl-ipv4-5-public (172.16.2.162:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-5-private: cilium-test-1/client3-67f959dd9b-czshf (172.16.1.91) -> curl-ipv4-5-private (172.16.2.162:8080)]
.  [.] Action [echo-ingress-l7/pod-to-pod-with-endpoints/curl-ipv4-5-privatewith-header: cilium-test-1/client3-67f959dd9b-czshf (172.16.1.91) -> curl-ipv4-5-privatewith-header (172.16.2.162:8080)]
.  â„¹ï¸  ğŸ“œ Deleting CiliumNetworkPolicy 'echo-ingress-l7-http' from namespace 'cilium-test-1'..
```


## ë§ˆì¹˜ë©°


Ciliumì—ì„œ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì— ëŒ€í•´ ì•Œì•„ë´¤ë‹¤. ê°„ë‹¨í•˜ê²Œ ì—¬ê¸°ì„œ ì •ë¦¬í•˜ë©´ Ciliumì€ íŒŒë“œì˜ ê¸°ë³¸ ê²Œì´íŠ¸ì›¨ì´ê°€ cilium_host ì¸í„°í˜ì´ìŠ¤ë¥¼ í–¥í•˜ê²Œ ë‘ë©° ê° íŒŒë“œì™€ ì—°ê²°ë˜ëŠ” lxcë¡œ ì‹œì‘í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ì¡´ì¬í•œë‹¤.

- íŒŒë“œ í†µì‹ ì€ í˜¸ìŠ¤íŠ¸ ì˜ì—­ì—ì„œ ebpfë¥¼ í†µí•´ ì²˜ë¦¬í•œë‹¤. ê°™ì€ ë…¸ë“œ ë‚´ì˜ íŒŒë“œëŠ” cilium_hostì—ì„œ ì•Œë§ëŠ” íŒŒë“œë¡œ ë¼ìš°íŒ…í•˜ë©°, ë‹¤ë¥¸ ë…¸ë“œë‚´ì˜ íŒŒë“œë„ ebpfë¥¼ í†µí•´ NATì²˜ë¦¬í•˜ì—¬ ë³´ë‚¸ë‹¤. kernelì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë…¸ë“œì˜ ì¸í„°í˜ì´ìŠ¤ ìˆ˜ì¤€ì—ì„œ ì´ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ë‹¤.
- ì„œë¹„ìŠ¤ í†µì‹ ì€ íŒŒë“œì—ì„œ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í†µì‹ ì„ ì§„í–‰í•˜ë©° ì†Œì¼“ í˜¸ì¶œì´ ì¼ì–´ë‚  ë•Œ, ebpfë¥¼ í†µí•´ ì„œë¹„ìŠ¤ì˜ IPë¥¼ ì ì ˆí•œ íŒŒë“œì˜ IPë¡œ ë³€ê²½í•œë‹¤. ë•ë¶„ì— DNAT ê³¼ì •ì„ ì—†ì•¨ ìˆ˜ ìˆë‹¤.
