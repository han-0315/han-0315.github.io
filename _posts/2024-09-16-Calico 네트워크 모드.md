---
layout: post
title: Calico ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ ì•Œì•„ë³´ê¸°
date: 2024-09-15 09:02 +0900 
description: Calico ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ ì•Œì•„ë³´ê¸°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#3] 
pin: false
math: true
mermaid: true
---
Calico ë„¤íŠ¸ì›Œí¬ ëª¨ë“œ ì•Œì•„ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


### ìš”ì•½


Calicoì—ì„œ ì§€ì›í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ ëª¨ë“œê°€ ìˆë‹¤. (ë‹¤ë¥¸ ë…¸ë“œì— ìœ„ì¹˜í•œ íŒŒë“œ í†µì‹ ì—ì„œ ì‚¬ìš©)

1. IPIP: ê¸°ë³¸ê°’(ip íŒ¨í‚·ì„ í•˜ë‚˜ ë” ìŒ“ì•„ í„°ë„ë§)
2. Direct: í„°ë„ë§ ì—†ì´ ì „ì†¡
3. VXLAN: Flannelì—ì„œ defaultë¡œ ì‚¬ìš©í•˜ë©°, IPìœ„ì— VXLANì„ ìŒ“ì•„ í„°ë„ë§

ì—¬ê¸°ì„œëŠ” Direct ë°©ë²•ì— ëŒ€í•´ ìì„¸íˆ ì‚´í´ë³¸ë‹¤.


![image.png](/assets/img/post/Calico%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë“œ/1.png)


### Direct ëª¨ë“œ

- ì¥ì : í„°ë„ë§ì´ ì—†ë‹¤. ì˜¤ë²„í—¤ë“œê°€ ì—†ìœ¼ë‹ˆ ë¹ ë¥´ë‹¤.
- ë‹¨ì : ë¼ìš°í„°ì™€ ì—°ë™ì´ í•„ìš”í•˜ë‹¤ (ê¸°ì—…ì˜ ê²½ìš° ë„¤íŠ¸ì›Œí¬ íŒ€ê³¼ í˜‘ì—… í•„ìš”)

![image.png](/assets/img/post/Calico%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë“œ/2.png)


Direct ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´, NIC SRC/DST check ëª¨ë“œë¥¼ í•´ì œ(disables)í•´ì•¼ í•œë‹¤. ìš°ë¦¬ëŠ” CloudFormationìœ¼ë¡œ ë°°í¬í•  ë•Œ ì„¤ì •ë˜ì–´ìˆì–´ ë³„ë„ì˜ ì‘ì—…ì´ í•„ìš”ì—†ë‹¤. 


í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•œë‹¤. IPIP ëª¨ë“œì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë“œ/3.png)


ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ipipëª¨ë“œë¥¼ ëˆë‹¤. (direct mode)


```bash
root@k8s-m:~# calicoctl get ippool default-ipv4-ippool -o yaml | sed -e "s/ipipMode: Always/ipipMode: Never/" | calicoctl apply -f -
Successfully applied 1 'IPPool' resource(s)
```


ë¼ìš°íŒ… í…Œì´ë¸” ì •ë³´ê°€ ë‹¬ë¼ì§„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 


ìœ„ì— ì‚¬ì§„ì—ì„œëŠ” ë‹¤ë¥¸ ë…¸ë“œì— ìœ„ì¹˜í•œ íŒŒë“œ ëŒ€ì—­ì´ë©´ tunl0 ì¸í„°í˜ì´ìŠ¤ë¡œ ë¼ìš°íŒ…ëì§€ë§Œ, ì§€ê¸ˆì€ í˜¸ìŠ¤íŠ¸ ì´ë”ë„· ì¸í„°í˜ì´ìŠ¤ë¡œ ë¼ìš°íŒ…ëœë‹¤.


![image.png](/assets/img/post/Calico%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë“œ/4.png)


** í•˜ì§€ë§Œ, í†µì‹ ì„ ì§„í–‰í•˜ë©´ ê°™ì€ ì„œë¸Œë„·ì— ìœ„ì¹˜í•œ íŒŒë“œë¼ë¦¬ëŠ” (ì •í™•íˆëŠ” ê°™ì€ ì„œë¸Œë„·ì— ìœ„ì¹˜í•œ ë…¸ë“œì— ìˆëŠ” íŒŒë“œ)í†µì‹ ì´ ê°€ëŠ¥í•˜ë‚˜ ë‹¤ë¥¸ ì„œë¸Œë„·ì— ìœ„ì¹˜í•œ íŒŒë“œëŠ” í†µì‹ ì´ ì•ˆëœë‹¤. Direct ëª¨ë“œë¥¼ ì§€ì›í•˜ì§€ìœ„í•´ì„  Router ì—°ë™ì´ í•„ìš”í•˜ë‚˜, AWSëŠ” ë‚´ë¶€ ë¼ìš°í„°ë¥¼ ì‚¬ìš©í•˜ê¸°ì— ì´ë¥¼ í˜„ì¬ í…ŒìŠ¤íŠ¸í•  ìˆœ ì—†ë‹¤. ì•„ì‰¬ìš´ëŒ€ë¡œ ì•„ë˜ì˜ Cross Subnet ë°©ì‹ì„ ì‚¬ìš©í•´ë³¸ë‹¤.


### Cross Subnet


BPG(Router) ì—°ë™ì„ í•˜ì§€ ì•Šìœ¼ë©´, ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ìˆëŠ” ë…¸ë“œì™€ í†µì‹ í•˜ê¸° ì–´ë µë‹¤. ì´ëŸ´ë• CrossSubnet ëª¨ë“œë¥¼ ì‚¬ìš©í•œë‹¤. ì´ë•ŒëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ì¡´ì¬í•˜ëŠ” ë…¸ë“œëŠ” Direct, ì•„ë‹Œ ë…¸ë“œëŠ” IPIP í„°ë„ë§ìœ¼ë¡œ í†µì‹ ëœë‹¤.


ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì„¤ì •ì„ ì§„í–‰í•œë‹¤.


```bash
calicoctl patch ippool default-ipv4-ippool -p '{"spec":{"ipipMode":"CrossSubnet"}}'
```

- ì„¤ì • í™•ì¸

```bash
calicoctl get ippool -o wide
NAME                  CIDR            NAT    IPIPMODE      VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR
default-ipv4-ippool   172.16.0.0/16   true   CrossSubnet   Never       false      false              all()
```


ë¼ìš°íŒ… ì •ë³´ë¥¼ í™•ì¸í•˜ë©´ ë‹¤ë¥¸ ì„œë¸Œë„·ì˜ ê²½ìš° tunl0ìœ¼ë¡œ, ê°™ì€ ì„œë¸Œë„·ì˜ ê²½ìš° ì´ë”ë„·ìœ¼ë¡œ ë¼ìš°íŒ…ëœë‹¤.


![image.png](/assets/img/post/Calico%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë“œ/5.png)


#### ì‹¤ìŠµ ì§„í–‰


ì•„ë˜ì˜ íŒŒë“œë¥¼ ë°°í¬í•˜ê³ , ì •ìƒì ìœ¼ë¡œ í†µì‹ ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.


```bash
cat node3-pod3.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: k8s-w1
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  nodeName: k8s-w2
  containers:
  - name: pod2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod3
spec:
  nodeName: k8s-w0
  containers:
  - name: pod3
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```


ë‹¤ë¥¸ ì„œë¸Œë„·ì— ìœ„ì¹˜í•œ íŒŒë“œë¼ë¦¬ í†µì‹ ì„ ì§„í–‰í•œë‹¤. (pod1 â†” pod3)


```bash
(âˆ|HomeLab:N/A) root@k8s-m:~# k get pods -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES
pod1   1/1     Running   0          45s   172.16.158.3   k8s-w1   <none>           <none>
pod2   1/1     Running   0          45s   172.16.184.4   k8s-w2   <none>           <none>
pod3   1/1     Running   0          44s   172.16.34.1    k8s-w0   <none>           <none>
```


ì•„ë˜ì™€ ê°™ì´ ì •ìƒì ìœ¼ë¡œ í†µì‹ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë“œ/6.png)


ì›Œì»¤ë…¸ë“œ1ì—ì„œ tunl0 ì¸í„°í˜ì´ìŠ¤ë¥¼ tcpdumpí•œ ëª¨ìŠµì´ë‹¤. tunl0 ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì„ ëˆˆìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë“œ/7.png)

