---
layout: post
title: μ„λΉ„μ¤ λ„¤νΈμ›ν¬ session μµμ… μ‚΄ν΄λ³΄κΈ°
date: 2024-09-29 09:00 +0900 
description: μ„λΉ„μ¤ λ„¤νΈμ›ν¬ session μµμ… μ‚΄ν΄λ³΄κΈ°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#4] 
pin: false
math: true
mermaid: true
---


μ„λΉ„μ¤ λ„¤νΈμ›ν¬ session μµμ… μ‚΄ν΄λ³΄κΈ°

<!--more-->


> π’΅ **KANS μ¤ν„°λ””**  
> CloudNetμ—μ„ μ£Όκ΄€ν•λ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)μΌλ΅ μΏ λ²„λ„¤ν‹°μ¤ λ„¤νΈμ›ν‚Ή μ¤ν„°λ””μ…λ‹λ‹¤. μ•„λμ κΈ€μ€ μ¤ν„°λ””μ λ‚΄μ©μ„ κΈ°λ°μΌλ΅ μ‘μ„±ν–μµλ‹λ‹¤.  
>   
> μ¤ν„°λ””μ— κ΄€μ‹¬μ΄ μμΌμ‹  λ¶„μ€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)λ¥Ό μ°Έκ³ ν•΄μ£Όμ„Έμ”.



### λ“¤μ–΄κ°€λ©°


μ—¬κΈ°μ„λ” μ„λΉ„μ¤μ μ„Έλ¶€ μµμ…μ— λ€ν•΄ μ‚΄ν΄λ΄…λ‹λ‹¤.


#### λ¦¬μ†μ¤ YAML

- ν…μ¤νΈ νλ“

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod3
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker3
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0

```

- ν΄λΌμ΄μ–ΈνΈ νλ“

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: net-pod
spec:
  nodeName: myk8s-control-plane
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```

- μ„λΉ„μ¤

```yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-clusterip
spec:
  ports:
    - name: svc-webport
      port: 9000        # μ„λΉ„μ¤ IP μ— μ ‘μ† μ‹ μ‚¬μ©ν•λ” ν¬νΈ port λ¥Ό μλ―Έ
      targetPort: 80    # νƒ€ν‚· targetPort λ” μ„λΉ„μ¤λ¥Ό ν†µν•΄μ„ λ©μ μ§€ νλ“λ΅ μ ‘μ† μ‹ ν•΄λ‹Ή νλ“λ΅ μ ‘μ†ν•λ” ν¬νΈλ¥Ό μλ―Έ
  selector:
    app: webpod         # μ…€λ ‰ν„° μ•„λ app:webpod λ μ΄λΈ”μ΄ μ„¤μ •λμ–΄ μλ” νλ“λ“¤μ€ ν•΄λ‹Ή μ„λΉ„μ¤μ— μ—°λ™λ¨
  type: ClusterIP       # μ„λΉ„μ¤ νƒ€μ…
```


λ°°ν¬μƒνƒλ¥Ό ν™•μΈν•λ‹¤.


![image.png](/assets/img/post/μ„λΉ„μ¤%20λ„¤νΈμ›ν¬%20session%20μµμ…%20μ‚΄ν΄λ³΄κΈ°/1.png)


### **sessionAffinity: ClientIP**


ν΄λΌμ΄μ–ΈνΈμ™€ ν†µμ‹ ν•  λ•, ν†µμ‹ μ΄ λκΈ°λ©΄ μ¬μ ‘μ†ν•λ©΄ μ„λΉ„μ¤λ” λ‹¤μ‹ λλ¤ν•κ² λΌμ°ν…ν•λ‹¤. μ΄λ΄ κ²½μ° κΈ°μ΅΄μ μ •λ³΄κ°€ λ‚ λΌκ°€κΈ°μ— μ„Έμ…μ„ μ μ§€ν•λ” κ²ƒμ€ μ¤‘μ”ν•λ‹¤. κ°λ°ν•  λ•λ” Redisμ™€ κ°™μ€ μΊμ‹μ„λ²„λ¥Ό μ„Έμ…μΌλ΅ μ €μ¥ν•λ”λ°, μ„λΉ„μ¤μ—μ„λ„ μ„Έμ…μ„ μ μ§€ν•λ” μµμ…μ΄ μλ‹¤.


μ•„λ λ…λ Ήμ–΄λ¥Ό ν†µν•΄ ν„μ¬ μ„Έμ… μ„¤μ •μ„ ν™•μΈν•λ©΄, Noneμ„ λ³Ό μ μλ‹¤.


```bash
kubectl get svc svc-clusterip -o yaml | grep sessionAffinity
  sessionAffinity: None
```


μ•„λ λ…λ Ήμ–΄λ΅ sessionAffinityλ¥Ό ν™μ„±ν™”ν•λ‹¤.


```bash
kubectl get svc svc-clusterip -o yaml | sed -e "s/sessionAffinity: None/sessionAffinity: ClientIP/" | kubectl apply -f -
```


ν™μ„±ν™”ν•κ³ , KUBE-SVC μ²΄μΈμ„ ν™•μΈν•΄λ³Έλ‹¤. μ„λΉ„μ¤ ClusterIPλ¥Ό ν†µν•΄ μ²΄μΈμ„ μ°Ύλ”λ‹¤.


```bash
iptables -t nat -S | grep 10.200.1.201
-A KUBE-SERVICES -d 10.200.1.201/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF
-A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.201/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ
```


μ°Ύμ€ KUBE-SVC μ²΄μΈμΌλ΅ ν•„ν„°λ§ν•λ©΄, μ•„λμ™€ κ°™μ΄ `recent β€”rcheck` μ²΄μΈμ΄ μ¶”κ°€λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. 


`-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.1.2:80" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-TBW2IYJKUCAC7GB3 --mask 255.255.255.255 --rsource -j KUBE-SEP-TBW2IYJKUCAC7GB3`


```bash
iptables -t nat -S | grep KUBE-SVC-KBDEBIL6IU6WL7RF
-N KUBE-SVC-KBDEBIL6IU6WL7RF
-A KUBE-SERVICES -d 10.200.1.201/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF
-A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.201/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.1.2:80" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-TBW2IYJKUCAC7GB3 --mask 255.255.255.255 --rsource -j KUBE-SEP-TBW2IYJKUCAC7GB3
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.2.2:80" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-DOIEFYKPESCDTYCH --mask 255.255.255.255 --rsource -j KUBE-SEP-DOIEFYKPESCDTYCH
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.3.3:80" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-K7ALM6KJRBAYOHKX --mask 255.255.255.255 --rsource -j KUBE-SEP-K7ALM6KJRBAYOHKX
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.1.2:80" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-TBW2IYJKUCAC7GB3
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.2.2:80" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-DOIEFYKPESCDTYCH
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.3.3:80" -j KUBE-SEP-K7ALM6KJRBAYOHKX
```


ν•΄λ‹Ή μ²΄μΈμ΄ λ¬΄μ—‡μΈμ§€ μ‚΄ν΄λ³΄μ.


[https://ipset.netfilter.org/iptables-extensions.man.html](https://ipset.netfilter.org/iptables-extensions.man.html) μ—μ„ recent λ¨λ“μ— λ€ν• μ„¤λ…μ€ 


β€Allows you to dynamically create a list of IP addresses and then match against that list in a few different ways.β€™ λΌκ³  λ‚μ™€μλ‹¤. IP λ©λ΅μ„ μƒμ„±ν•μ—¬ λΉ„κµν•λ” λ¨λ“μ΄λ‹¤.


`--rcheck` μµμ…μ€ IP λ©λ΅κ³Ό ν„μ¬ ν¨ν‚·μ SRC μ£Όμ†κ°€ κ°™μ€μ§€ ν™•μΈν•λ” μµμ…μ΄λ‹¤


μ¦‰, νΉμ • ν΄λΌμ΄μ–ΈνΈκ°€ μ„λΉ„μ¤λ¥Ό ν†µν•΄ νλ“1λ΅ μ ‘μ†ν•λ©΄, iptablesμ— ν΄λΌμ΄μ–ΈνΈ IPλ¥Ό `10800` s λ™μ• λ³΄κ΄€ν•λ‹¤. κ°™μ€ ν΄λΌμ΄μ–ΈνΈμ—μ„ μ¬μ ‘μ†ν•λ©΄ IP List λ©λ΅κ³Ό μΌμΉν•μ—¬, κ°™μ€ νλ“λ΅ λΌμ°ν…ν•λ‹¤.


control-plane(ν΄λΌμ΄μ–ΈνΈ νλ“κ°€ μ„μΉν•λ” λ…Έλ“)μ— μ ‘μ†ν•μ—¬, conntrackμ„ ν™•μΈν•μ—¬ ν΄λΌμ΄μ–ΈνΈ IPμ— λ€ν• λΌμ°ν…μ΄ μλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


```bash
conntrack -L --dst-nat | grep 10.10.0.6
conntrack v1.4.7 (conntrack-tools): 5 flow entries have been shown.
tcp      6 62 TIME_WAIT src=10.10.0.6 dst=10.200.1.201 sport=35002 dport=9000 src=10.10.2.2 dst=10.10.0.6 sport=80 dport=35002 [ASSURED] mark=0 use=1
```


λ, `/proc/net/xt_recent/KUBE-SEP-{μ•λ§μ€ νλ“ μ²΄μΈ}` λ¥Ό ν™•μΈν•λ©΄, IP List λ©λ΅μ—λ„ ν΄λΌμ΄μ–ΈνΈ IPκ°€ μ €μ¥λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


![image.png](/assets/img/post/μ„λΉ„μ¤%20λ„¤νΈμ›ν¬%20session%20μµμ…%20μ‚΄ν΄λ³΄κΈ°/2.png)


#### ν…μ¤νΈ μ§„ν–‰


μ•„λμ λ…λ Ήμ–΄λ¥Ό ν†µν•΄ ν…μ¤νΈλ¥Ό μ§„ν–‰ν•λ©΄, μ„Έμ…μ΄ μ μ§€λλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


```bash
kubectl exec -it net-pod -- zsh -c "for i in {1..100};  do curl -s $SVC1:9000 | grep Hostname; done | sort | uniq -c | sort -nr"
    100 Hostname: webpod2
```


#### timeout λ³€κ²½


timeout μ„¤μ •μ„ μ§„ν–‰ν•  μ μλ‹¤. κΈ°λ³Έκ°’μ€ 10800(3μ‹κ°„)μ΄μ§€λ§, μ—¬κΈ°μ„  ν…μ¤νΈλ¥Ό μ„ν•΄ 30μ΄λ΅ μ„¤μ •ν•΄λ³Έλ‹¤.


```bash
kubectl patch svc svc-clusterip -p '{"spec":{"sessionAffinityConfig":{"clientIP":{"timeoutSeconds":30}}}}'
```


iptablesλ¥Ό ν™•μΈν•΄λ³΄λ©΄ 30μ΄λ΅ secondκ°€ λ°”λ€ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


```bash
ptables -t nat -S | grep KUBE-SVC-KBDEBIL6IU6WL7RF
-N KUBE-SVC-KBDEBIL6IU6WL7RF
-A KUBE-SERVICES -d 10.200.1.201/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-SVC-KBDEBIL6IU6WL7RF
-A KUBE-SVC-KBDEBIL6IU6WL7RF ! -s 10.10.0.0/16 -d 10.200.1.201/32 -p tcp -m comment --comment "default/svc-clusterip:svc-webport cluster IP" -m tcp --dport 9000 -j KUBE-MARK-MASQ
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.1.2:80" -m recent --rcheck --seconds 30 --reap --name KUBE-SEP-TBW2IYJKUCAC7GB3 --mask 255.255.255.255 --rsource -j KUBE-SEP-TBW2IYJKUCAC7GB3
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.2.2:80" -m recent --rcheck --seconds 30 --reap --name KUBE-SEP-DOIEFYKPESCDTYCH --mask 255.255.255.255 --rsource -j KUBE-SEP-DOIEFYKPESCDTYCH
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.3.3:80" -m recent --rcheck --seconds 30 --reap --name KUBE-SEP-K7ALM6KJRBAYOHKX --mask 255.255.255.255 --rsource -j KUBE-SEP-K7ALM6KJRBAYOHKX
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.1.2:80" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-TBW2IYJKUCAC7GB3
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.2.2:80" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-DOIEFYKPESCDTYCH
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.3.3:80" -j KUBE-SEP-K7ALM6KJRBAYOHKX
```


μ΄μ  λ³€κ²½λ μ„¤μ •μ„ ν™•μΈν•΄λ³΄κΈ° μ„ν•΄, ν΄λΌμ΄μ–ΈνΈ νλ“μ— μ ‘μ†ν•μ—¬ λ‹¤μ‹ μ„λΉ„μ¤λ΅ μ ‘μ†μ„ μ‹λ„ν•λ‹¤. ν•λ² μ ‘μ†ν•κ³ , 30μ΄λ’¤μ— μ ‘μ†ν•λ©΄ λ‹¤λ¥Έ νλ“λ΅ λΌμ°ν…λλ‹¤. (30μ΄μ΄λ‚΄λΌλ©΄ κ°™μ€ νλ“λ΅ λΌμ°ν…λλ‹¤.)


![image.png](/assets/img/post/μ„λΉ„μ¤%20λ„¤νΈμ›ν¬%20session%20μµμ…%20μ‚΄ν΄λ³΄κΈ°/3.png)

