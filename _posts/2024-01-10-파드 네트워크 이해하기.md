---
layout: post
title: Memento Pattern
date: 2023-12-14 21:10 +0900 
description: Memento Pattern
category: [λ””μμΈν¨ν„΄, ν–‰λ™ν¨ν„΄] 
tags: [ν–‰λ™ν¨ν„΄, λ””μμΈν¨ν„΄, λ©”λ©ν† ν¨ν„΄] 
pin: false
math: true
mermaid: true
---
μ‚½μ§μ„ ν†µν•΄ νλ“ λ„¤νΈμ›ν¬ μ΄ν•΄ν•κΈ°
<!--more-->


## Pod Network


νλ“μ—μ„ μ‚¬μ©λλ” λ„¤νΈμ›ν¬ λ¨λΈμ— λ€ν•΄ μ•μ•„λ³Έλ‹¤. νλ“ λ„¤νΈμ›ν¬λ¥Ό λ‹΄λ‹Ήν•λ” κ²ƒμ€ μ£Όλ΅ CNIμ΄λ‹¤. κ·Έλ ‡κΈ°μ— CNIμ— λ”°λΌ λ„¤νΈμ›ν¬ λ™μ‘λ°©μ‹μ΄ λ‹¤λ¥΄λ‹¤. k3sλ¥Ό ν†µν•΄ μ‹¤μµμ„ μ§„ν–‰ν–κΈ°μ— Flannelμ„ κΈ°μ¤€μΌλ΅ μ§„ν–‰ν•λ‹¤.(k3s μ΄κΈ°μ— μ„Έλ¶€μ μΈ λ‚΄μ©μ€ λ‹¤λ¥Ό μ μμµλ‹λ‹¤.) μ•μΌλ΅  ν•λ‚μ νλ“μ•μ— μλ” μ»¨ν…μ΄λ„ ν†µμ‹ , κ°™μ€ λ…Έλ“ λ‚΄μ νλ“ ν†µμ‹ , λ‹¤λ¥Έ λ…Έλ“μ— μ„μΉν•λ” νλ“ κ°„ ν†µμ‹ μ— λ€ν•΄ μ•μ•„λ³Έλ‹¤.


## νλ“ λ‚΄λ¶€ ν†µμ‹ (Container λ‚΄λ¶€ λ„¤νΈμ›ν¬ ν™•μΈ)


CNIμ— μν•΄ κ° νλ“μ— κ³ μ ν• IP μ£Όμ†κ°€ ν• λ‹Ήλλ‹¤. λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤λ„ μƒμ„±λλ‹¤. Dockerμ™€ λ‹¤λ¥΄κ² νλ“λ” λ‚΄λ¶€μ **λ¨λ“  μ»¨ν…μ΄λ„λ” IP μ£Όμ†μ™€ λ„¤νΈμ›ν¬ ν¬νΈλ¥Ό ν¬ν•¨ν• λ¨λ“  λ„¤νΈμ›ν¬ μ¤νƒμ„ κ³µμ ν•λ‹¤.** μ¦‰, νλ“ λ‚΄λ¶€μ μ»¨ν…μ΄λ„λ” λ΅μ»¬νΈμ¤νΈλ¥Ό ν†µν•΄ μ„λ΅ ν†µμ‹ ν•  μ μλ‹¤. κ·Έλ ‡κΈ°μ— λ§μ•½ κ°™μ€ ν¬νΈλ¥Ό μ‚¬μ©ν•λ” μ»¨ν…μ΄λ„λ¥Ό μ¤‘λ³µ μƒμ„±ν•λ©΄ μ¤λ¥κ°€ λ°μƒν•λ‹¤.


νλ“ λ‚΄μ μ»¨ν…μ΄λ„λ¥Ό μ™Έλ¶€λ΅ λ…Έμ¶ν•κΈ° μ„ν•΄μ„ Container Portλ¥Ό μ‚¬μ©ν•©λ‹λ‹¤. ν•΄λ‹Ή ν¬νΈλ¥Ό ν†µν•΄ μ™Έλ¶€μ™€ ν†µμ‹ ν•  μ μλ‹¤. 


### νλ“ μƒμ„±


#### 1. network.yml νμΌμ„ μƒμ„±ν•λ‹¤.


```bash
vi network.yml
```


#### 2. μ•„λμ λ‚΄μ©μ„ λ³µμ‚¬ν• λ’¤ μ €μ¥ν•λ‹¤.


```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test
spec:
  containers:
  - name: debug
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  - name: web
    image: nginx:1.14.2
    ports:
    - containerPort: 80
```


#### 3. νμΌμ„ μ΄μ©ν•μ—¬ νλ“λ¥Ό μƒμ„±ν•λ‹¤.


```bash
$ kubectl create -f test.yml
pod/test created
```


#### 4. λ…λ Ήμ–΄λ¥Ό ν†µν•΄ μƒμ„±λ νλ“λ¥Ό ν™•μΈν•λ‹¤.


```bash
$ kubectl get pods -o wide
NAME   READY   STATUS    RESTARTS      AGE   IP           NODE                                             NOMINATED NODE   READINESS GATES
test   2/2     Running   0             16s   10.42.1.36   ip-10-32-7-224.ap-northeast-2.compute.internal   <none>           <none>
```


### ν…μ¤νΈ


μ΄μ  debug μ»¨ν…μ΄λ„μ— μ ‘μ†ν•μ—¬, μ»¨ν…μ΄λ„λΌλ¦¬ μ •λ§ λ„¤νΈμ›ν¬λ¥Ό κ³µμ ν•κ³  μλ” μ§€ ν™•μΈν•λ‹¤.


#### 1. debug μ»¨ν…μ΄λ„μ— μ ‘μ†ν•λ‹¤.


```bash
$ kubectl exec test -it -c debug -- zsh
                    dP            dP                           dP
                    88            88                           88
88d888b. .d8888b. d8888P .d8888b. 88d888b. .d8888b. .d8888b. d8888P
88'  `88 88ooood8   88   Y8ooooo. 88'  `88 88'  `88 88'  `88   88
88    88 88.  ...   88         88 88    88 88.  .88 88.  .88   88
dP    dP `88888P'   dP   `88888P' dP    dP `88888P' `88888P'   dP

Welcome to Netshoot! (github.com/nicolaka/netshoot)
Version: 0.11
```


#### 2. `netstat` λ…λ Ήμ–΄λ¥Ό ν†µν•΄ ν¬νΈλ¥Ό ν™•μΈν•λ‹¤.


```bash
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:56286         127.0.0.1:80            TIME_WAIT   -
```


Nginxκ°€ μ‚¬μ©ν•λ” **port::80**λ¥Ό ν™•μΈν•  μ μμµλ‹λ‹¤.


#### 3. Web μ»¨ν…μ΄λ„μ— μ ‘μ†ν•μ—¬ ν¬νΈλ¥Ό μ¶”κ°€λ΅ ν™•μ¥ν•λ‹¤. 


```bash
kubectl exec test -it -c web -- /bin/bash
```


μ•„λμ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤. μ¶”κ°€μ μΌλ΅ 8080ν¬νΈλ„ κ°λ°©ν•λ‹¤.


```bash
echo 'server { listen 8080; }' > /etc/nginx/conf.d/default.conf && nginx
```


#### 4. debug μ»¨ν…μ΄λ„λ΅ λμ•„μ™€μ„, λ„¤νΈμ›ν¬ κµ¬μ„±μ„ ν™•μΈν•λ‹¤.


web μ»¨ν…μ΄λ„μ λ³€κ²½μ‚¬ν•­μ΄ κ°™μ΄ μ μ©λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. 


```bash
$ kubectl exec test -it -c debug -- netstat -anp
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -
```


μ¶”κ°€μ μΌλ΅ localhostλ¥Ό ν†µν•΄ Nginxλ¥Ό νΈμ¶ν•λ©΄ μ •μƒμ μΌλ΅ ν†µμ‹ λλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


```bash
$ curl localhost:80
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
...

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```


μ΄μ™€ κ°™μ΄ νλ“λ‚΄μ μ»¨ν…μ΄λ„λ“¤μ€ λ„¤νΈμ›ν¬ μ¤νƒμ„ κ³µμ ν•λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. μ΄μ  ν…μ¤νΈκ°€ λλ‚¬μΌλ‹, νλ“λ¥Ό μ‚­μ ν•λ‹¤.


```bash
$ kubectl delete -f test.yml
pod "test" deleted
```


## κ°™μ€ λ…Έλ“ νλ“ ν†µμ‹ 


κ°™μ€ λ…Έλ“ λ‚΄μ νλ“λ” λΈλ¦Ώμ§€ ν•νƒλ΅ μ—°κ²°λμ–΄μλ‹¤. μ•„λμ κ·Έλ¦Όκ³Ό κ°™μ΄ κ° νλ“μ—λ” veth0μ΄ ν•λ‚μ”© λ¶™μ–΄μμΌλ©° ν•΄λ‹Ή μ΄λ”λ„·μ€ cni0μ„ ν†µν•΄ λΈλ¦Ώμ§€ ν•νƒλ΅ μ—°κ²°λμ–΄μλ‹¤. (Calicoλ” λΈλ¦Ώμ§€ ν•νƒκ°€ μ•„λ‹ ν„°λ―Έλ„ ν•νƒλ΅ ν†µμ‹ μ„ μ§€μ›ν•λ‹¤.)


![1_KVGeracu3qupNkoDERUR0A.webp](https://prod-files-secure.s3.us-west-2.amazonaws.com/3b953ad7-a4bc-4b8b-877c-db94279d5db4/405fb34e-791e-4312-a27e-29a5654554c0/1_KVGeracu3qupNkoDERUR0A.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240110%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240110T133220Z&X-Amz-Expires=3600&X-Amz-Signature=2d93d8f993415007b038c32938b23cf7d44f6307d4889777032ace195bd03714&X-Amz-SignedHeaders=host&x-id=GetObject)


[μ¶μ²: [https://medium.com/finda-tech/kubernetes-λ„¤νΈμ›ν¬-μ •λ¦¬-fccd4fd0ae6](https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6)]


### λ„¤νΈμ›ν¬ κµ¬μ„± ν™•μΈ


μ°μ„  μ›μ»¤λ…Έλ“μ— μ ‘μ†ν•μ—¬ λ„¤νΈμ›ν¬ κµ¬μ„±μ„ μ‚΄ν΄λ³Έλ‹¤.


```bash
$ ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:97:bb:b7:70:10 brd ff:ff:ff:ff:ff:ff
    inet 10.32.7.224/20 brd 10.32.15.255 scope global dynamic eth0
       valid_lft 2443sec preferred_lft 2443sec
    inet6 fe80::97:bbff:feb7:7010/64 scope link
       valid_lft forever preferred_lft forever
3: flannel.1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 8951 qdisc noqueue state UNKNOWN group default
    link/ether 2e:98:28:11:0b:8e brd ff:ff:ff:ff:ff:ff
    inet 10.42.1.0/32 scope global flannel.1
       valid_lft forever preferred_lft forever
    inet6 fe80::2c98:28ff:fe11:b8e/64 scope link
       valid_lft forever preferred_lft forever
4: cni0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 8951 qdisc noqueue state UP group default qlen 1000
    link/ether 22:dd:de:d2:ec:55 brd ff:ff:ff:ff:ff:ff
    inet 10.42.1.1/24 brd 10.42.1.255 scope global cni0
       valid_lft forever preferred_lft forever
    inet6 fe80::20dd:deff:fed2:ec55/64 scope link
       valid_lft forever preferred_lft forever
5: vetha2194963@if2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 8951 qdisc noqueue master cni0 state UP group default
    link/ether a2:d8:d0:e5:8e:59 brd ff:ff:ff:ff:ff:ff link-netns cni-3cb42f8b-53d8-58ac-1f0a-b379faa755c5
    inet6 fe80::a0d8:d0ff:fee5:8e59/64 scope link
       valid_lft forever preferred_lft forever
```


μ°λ¦¬κ°€ μ—¬κΈ°μ„ ν™•μΈν•  λ¶€λ¶„μ€ 3λ²λ¶€ν„° 5λ²μ΄λ‹¤. 1λ²κ³Ό 2λ²μ€ λ¨λ“  μ»΄ν“¨ν„°μ— μλ” κΈ°λ³Έμ μΈ μΈν„°νμ΄μ¤μ΄λ©°, κ° μ”μ†μ— λ€ν•΄ μ„¤λ…μ€ λ‹¤μκ³Ό κ°™λ‹¤.


> π’΅ **With ChatGPT-4**  
> 1. `lo`: λ£¨ν”„λ°± μΈν„°νμ΄μ¤μ…λ‹λ‹¤. λ£¨ν”„λ°± μΈν„°νμ΄μ¤λ” μ»΄ν“¨ν„°κ°€ μκΈ° μμ‹ κ³Ό ν†µμ‹ ν•λ” λ° μ‚¬μ©λλ©°, μ£Όλ΅ λ„¤νΈμ›ν¬ μ†ν”„νΈμ›¨μ–΄ ν…μ¤νΈμ— μ‚¬μ©λ©λ‹λ‹¤.  
>   
> 2. `eth0`: μ²« λ²μ§Έ μ΄λ”λ„· μΈν„°νμ΄μ¤λ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤. μ΄ μΈν„°νμ΄μ¤λ” μΌλ°μ μΌλ΅ λ¬Όλ¦¬μ  λ„¤νΈμ›ν¬ μ—°κ²°μ— μ‚¬μ©λ©λ‹λ‹¤.  
>   
> 3. `flannel.1`: flannel λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤μ…λ‹λ‹¤. μ¤λ²„λ μ΄ λ„¤νΈμ›ν¬ μ†”λ£¨μ… μ¤‘ ν•λ‚λ΅, λ‹¤λ¥Έ λ…Έλ“μ νλ“μ™€ ν†µμ‹ ν•  μ μκ² ν•©λ‹λ‹¤.  
>   
> 4. `cni0`: Container Network Interface (CNI) λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤μ…λ‹λ‹¤.  
>   
> 5. `vetha2194963@if2`: μ΄κ²ƒμ€ κ°€μƒ μ΄λ”λ„· (veth) νμ–΄ μ¤‘ ν•λ‚μ…λ‹λ‹¤. veth νμ–΄λ” λ‘ κ°μ κ°€μƒ λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤λ΅ κµ¬μ„±λλ©°, ν•λ‚λ” μ»¨ν…μ΄λ„ λ‚΄λ¶€μ—, λ‹¤λ¥Έ ν•λ‚λ” μ»¨ν…μ΄λ„ μ™Έλ¶€μ— μ„μΉν•©λ‹λ‹¤. μ΄λ“¤μ€ μ„λ΅μ—κ² ν¨ν‚·μ„ μ „λ‹¬ν•μ—¬ μ»¨ν…μ΄λ„μ™€ μ™Έλ¶€ μ„Έκ³„ μ‚¬μ΄μ λ„¤νΈμ›ν¬ ν†µμ‹ μ„ κ°€λ¥ν•κ² ν•©λ‹λ‹¤. μ΄ μΈν„°νμ΄μ¤λ” `cni0`μ— μ—°κ²°λμ–΄ μμµλ‹λ‹¤.

	1. `lo`: λ£¨ν”„λ°± μΈν„°νμ΄μ¤μ…λ‹λ‹¤. λ£¨ν”„λ°± μΈν„°νμ΄μ¤λ” μ»΄ν“¨ν„°κ°€ μκΈ° μμ‹ κ³Ό ν†µμ‹ ν•λ” λ° μ‚¬μ©λλ©°, μ£Όλ΅ λ„¤νΈμ›ν¬ μ†ν”„νΈμ›¨μ–΄ ν…μ¤νΈμ— μ‚¬μ©λ©λ‹λ‹¤.
	2. `eth0`: μ²« λ²μ§Έ μ΄λ”λ„· μΈν„°νμ΄μ¤λ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤. μ΄ μΈν„°νμ΄μ¤λ” μΌλ°μ μΌλ΅ λ¬Όλ¦¬μ  λ„¤νΈμ›ν¬ μ—°κ²°μ— μ‚¬μ©λ©λ‹λ‹¤.
	3. `flannel.1`: flannel λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤μ…λ‹λ‹¤. μ¤λ²„λ μ΄ λ„¤νΈμ›ν¬ μ†”λ£¨μ… μ¤‘ ν•λ‚λ΅, λ‹¤λ¥Έ λ…Έλ“μ νλ“μ™€ ν†µμ‹ ν•  μ μκ² ν•©λ‹λ‹¤.
	4. `cni0`: Container Network Interface (CNI) λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤μ…λ‹λ‹¤.
	5. `vetha2194963@if2`: μ΄κ²ƒμ€ κ°€μƒ μ΄λ”λ„· (veth) νμ–΄ μ¤‘ ν•λ‚μ…λ‹λ‹¤. veth νμ–΄λ” λ‘ κ°μ κ°€μƒ λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤λ΅ κµ¬μ„±λλ©°, ν•λ‚λ” μ»¨ν…μ΄λ„ λ‚΄λ¶€μ—, λ‹¤λ¥Έ ν•λ‚λ” μ»¨ν…μ΄λ„ μ™Έλ¶€μ— μ„μΉν•©λ‹λ‹¤. μ΄λ“¤μ€ μ„λ΅μ—κ² ν¨ν‚·μ„ μ „λ‹¬ν•μ—¬ μ»¨ν…μ΄λ„μ™€ μ™Έλ¶€ μ„Έκ³„ μ‚¬μ΄μ λ„¤νΈμ›ν¬ ν†µμ‹ μ„ κ°€λ¥ν•κ² ν•©λ‹λ‹¤. μ΄ μΈν„°νμ΄μ¤λ” `cni0`μ— μ—°κ²°λμ–΄ μμµλ‹λ‹¤.

μ„μ κ·Έλ¦Όμ—μ„ ν™•μΈν• vethκ³Ό cni0μ„ ν™•μΈν•  μ μλ‹¤. 5λ²μ—μ„ μμ„Έν ν™•μΈν•λ©΄ β€master cni0β€λ¥Ό λ³Ό μ μλ‹¤. μ΄λ” μΌλ°μ μΌλ΅ cni0κ³Ό μ—°κ²°λμ–΄ μκ³  λ„¤νΈμ›ν¬ λΈλ¦Ώμ§€λ¥Ό λ‚νƒ€λ‚Έλ‹¤. λ¦¬λ…μ¤ λΈλ¦Ώμ§€ VLAN κµ¬μ„±μ„ μ¶λ ¥ν•λ” `bridge vlan` λ…λ Ήμ–΄λ¥Ό ν†µν•΄ ν™•μΈν•λ©΄ λ‘ μΈν„°νμ΄μ¤κ°€ λΈλ¦Ώμ§€ ν•νƒλ΅ μ—°κ²°λ κ²ƒμ„ λ³Ό μ μλ‹¤.


```bash
$ bridge vlan
port              vlan-id
cni0              1 PVID Egress Untagged
vetha2194963      1 PVID Egress Untagged
```


vethμ€ κ° νλ“μ— μ„μΉν•λ©°, cniλ¥Ό ν†µν•΄ κ° vethμ€ λΈλ¦Ώμ§€ ν•νƒλ΅ μ—°κ²°λμ–΄μλ‹¤. μ„μ vethλ„ μ–΄λ–¤ νλ“μ— μ—°κ²°λμ–΄μμµλ‹λ‹¤. μ–΄λ–¤ νλ“μΈμ§€ ν™•μΈν•λ‹¤. μ•„λμ™€ κ°™μ΄ μ›μ»¤λ…Έλ“μ— λ°°ν¬λ νλ“λ¥Ό ν™•μΈν•  μ μλ‹¤. μ΄λ” λ¨λ“  λ…Έλ“μ— λ°°ν¬λλ” ν”„λ΅μ‹ μ„λ²„μ—­ν• μ„ ν•λ” νλ“μ΄λ‹¤. 


```bash
$ k get pods -A -o wide
NAMESPACE     NAME                                     READY   STATUS      RESTARTS      AGE   IP           NODE                                             NOMINATED NODE   READINESS GATES
kube-system   svclb-traefik-549b62e4-dqvvz             2/2     Running     6 (97m ago)   18h   10.42.1.34   ip-10-32-7-224.ap-northeast-2.compute.internal   <none>           <none>

```


### ν†µμ‹  ν™•μΈ


μ΄μ  μ‹¤μ λ΅ νλ“λ¥Ό λ°°ν¬ν•κ³ , ν†µμ‹ μ„ ν…μ¤νΈν•λ‹¤.


#### νμΌμ„ μƒμ„±ν•κ³  λ‚΄μ©μ„ λ³µμ‚¬ν• λ’¤ μ €μ¥ν•λ‹¤.


```bash
$ vi network-pod.yml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  containers:
  - name: test1
    image: nicolaka/netshoot  
    command: ["tail"]
    args: ["-f", "/dev/null"]
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  containers:
  - name: test2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
```


#### νλ“λ¥Ό μƒμ„±ν•λ‹¤.


```bash
$ kubectl network-pod.yml
pod/pod1 created
pod/pod2 created
```


νλ“μ μƒμ„±μ λ¬΄λ¥Ό ν™•μΈν•λ‹¤.


```bash
$ kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
pod2   1/1     Running   0          94s
pod1   1/1     Running   0          94s
```


`tcpdump`λ¥Ό ν†µν•΄ μ›μ»¤λ…Έλ“μ veth λ‘κ°μ™€ cni0μ λ‚΄μ©μ„ ν™•μΈν•λ‹¤.


λ¨Όμ €, ν•λ‚μ νλ“μ— μ ‘μ†ν•μ—¬ λ‹¤λ¥Έ νλ“λ΅ ping ν†µμ‹ μ„ μ‹λ„ν•λ‹¤.


```bash
$ ping -c 4 10.42.1.38
PING 10.42.1.38 (10.42.1.38) 56(84) bytes of data.
64 bytes from 10.42.1.38: icmp_seq=1 ttl=64 time=0.102 ms
64 bytes from 10.42.1.38: icmp_seq=2 ttl=64 time=0.080 ms
64 bytes from 10.42.1.38: icmp_seq=3 ttl=64 time=0.087 ms
64 bytes from 10.42.1.38: icmp_seq=4 ttl=64 time=0.088 ms
```


pingμ„ λ³΄λ‚΄λ” λ™μ•, μ›μ»¤λ…Έλ“μ cniμ—μ„ ν™•μΈλλ” ν¨ν‚·μ„ ν™•μΈν•λ©΄ μ•„λμ™€ κ°™μ΄ Ping ν†µμ‹ μ΄ μ΄λ¤„μ§€λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. μ΄λ¥Ό ν†µν•΄ **cni0μ„ ν†µν•΄ κ° vethκ°€ ν†µμ‹ μ΄ μ΄λ¤„μ§„λ‹¤λ” κ²ƒμ„ λ‹¤μ‹ν•λ² μ• μ μλ‹¤.**


```bash
$ tcpdump -i cni0
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on cni0, link-type EN10MB (Ethernet), capture size 262144 bytes
02:54:42.086081 ARP, Request who-has ip-10-42-1-38.ap-northeast-2.compute.internal tell ip-10-42-1-37.ap-northeast-2.compute.internal, length 28
02:54:42.086099 ARP, Reply ip-10-42-1-38.ap-northeast-2.compute.internal is-at 6a:74:6a:77:30:3a (oui Unknown), length 28
02:54:42.086127 IP ip-10-42-1-37.ap-northeast-2.compute.internal > ip-10-42-1-38.ap-northeast-2.compute.internal: ICMP echo request, id 5, seq 1, length 64
02:54:42.086138 IP ip-10-42-1-38.ap-northeast-2.compute.internal > ip-10-42-1-37.ap-northeast-2.compute.internal: ICMP echo reply, id 5, seq 1, length 64
02:54:43.097596 IP ip-10-42-1-37.ap-northeast-2.compute.internal > ip-10-42-1-38.ap-northeast-2.compute.internal: ICMP echo request, id 5, seq 2, length 64
02:54:43.097650 IP ip-10-42-1-38.ap-northeast-2.compute.internal > ip-10-42-1-37.ap-northeast-2.compute.internal: ICMP echo reply, id 5, seq 2, length 64
```


ν…μ¤νΈκ°€ λλ‚¬μΌλ‹ νλ“λ¥Ό μ‚­μ ν•λ‹¤.


```bash
$ kubectl delete -f network-pod.yml
pod "pod1" deleted
pod "pod2" deleted
```


## λ‹¤λ¥Έ λ…Έλ“μ— μ„μΉν•λ” νλ“ κ°„ ν†µμ‹ 


νλ“λ” Private IPλ΅ λ…Έλ“μ IP λ„¤νΈμ›ν¬μ™€ λ‹¤λ¥΄λ‹¤. μ¦‰, λ‹¤λ¥Έ λ…Έλ“μ— μ΅΄μ¬ν• νλ“μ™€ ν†µμ‹ ν•λ ¤λ©΄ λ…Έλ“μ λ€μ—­ν­μ„ ν•λ² κ±°μ³κ°€μ•Ό ν•λ‹¤. κ·Έλ ‡κΈ°μ— κ°™μ€ λ…Έλ“ μƒμ νλ“μ™€ ν†µμ‹ ν•λ” κ±΄ λ¬Έμ κ°€ μ—†μ–΄λ„, λ‹¤λ¥Έ λ…Έλ“ μƒμ νλ“μ™€ ν†µμ‹ ν•λ” κ±΄ λ¬Έμ κ°€ λλ‹¤. μ΄λ¥Ό μ„ν•΄ ν„°λ„λ§ κΈ°μ μ„ μ‚¬μ©ν•λ‹¤. λ‹¤λ¥Έ λ…Έλ“μ— μ„μΉν• νλ“μ—κ² νΈλν”½μ„ μ „μ†΅ν•  λ•λ” ν„°λ„λ§μ„ ν†µν•΄ κΈ°μ΅΄μ src/dstλ¥Ό μ¨κΈ°κ³  ν„°λ„λ§μ„ μ„ν• λ…Έλ“μ IPλ¥Ό src/dstλ΅ νΈλν”½μ„ κ°μ‹Όλ‹¤. νλ“λ” κ³ μ ν• IPλ¥Ό κ°€μ§„λ‹¤. μ¦‰, CNIλ¥Ό ν†µν•΄ λ©μ μ§€ λ„¤νΈμ›ν¬λ¥Ό νλ“κ°€ μ•„λ‹, νλ“κ°€ μ„μΉν• νΈμ¤νΈλ΅ μ„¤μ •ν•΄μ•Ό ν•λ‹¤. μ΄λ¥Ό μ„ν•΄ ν•λ‚μ μΈµμ„ μ“μ•„ μΊ΅μν™”λ¥Ό μ§„ν–‰ν•λ‹¤.


![1_JqSLd3cPv14BWDtE7YEcRA.webp](https://prod-files-secure.s3.us-west-2.amazonaws.com/3b953ad7-a4bc-4b8b-877c-db94279d5db4/2af9332a-a67e-412e-b3eb-88e7554969ea/1_JqSLd3cPv14BWDtE7YEcRA.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240110%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240110T133220Z&X-Amz-Expires=3600&X-Amz-Signature=42eb32b996685276dfbca9a0bd3866292db32ecd2dd35becb44c3ab82ef2712b&X-Amz-SignedHeaders=host&x-id=GetObject)


μ΄μ  μ‹¤μµμ„ ν†µν•΄, μ„μ λ‚΄μ©μ„ ν™•μΈν•λ‹¤.


### νλ“λ¥Ό λ°°ν¬ν•λ‹¤.


κ° νλ“λ” μ„λ΅ λ‹¤λ¥Έ λ…Έλ“(μ»¨νΈλ΅¤ ν”λ μΈ, μ›μ»¤λ…Έλ“)μ— μ„μΉν•΄μ•Ό ν•λ‹¤. nodeNameμ„ ν†µν•΄ κ° νλ“μ λ…Έλ“λ¥Ό μ§€μ •ν•΄μ¤€λ‹¤. μ•„λμ—μ„ β€nodeNameβ€™μ— ν•΄λ‹Ήν•λ” λ¶€λ¶„μ„ ν™κ²½μ— λ§κ² μμ •ν•λ‹¤.


```bash
$ vi network-node.yml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: ip-10-32-7-224.ap-northeast-2.compute.internal
  containers:
  - name: test1
    image: nicolaka/netshoot  
    command: ["tail"]
    args: ["-f", "/dev/null"]
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  nodeName: ip-10-32-11-62.ap-northeast-2.compute.internal
  containers:
  - name: test2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
```


νμΌμ„ μ΄μ©ν•μ—¬ νλ“λ¥Ό μƒμ„±ν•λ‹¤.


```bash
$ kubectl create -f network-node.yml
pod/pod1 created
pod/pod2 created
```


νλ“μ μ •λ³΄λ¥Ό ν™•μΈν•λ‹¤.


```bash
$ kubectl get pods -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP           NODE                                             NOMINATED NODE   READINESS GATES
pod2   1/1     Running   0          5s    10.42.0.37   ip-10-32-11-62.ap-northeast-2.compute.internal   <none>           <none>
pod1   1/1     Running   0          5s    10.42.1.39   ip-10-32-7-224.ap-northeast-2.compute.internal   <none>           <none>
```


### λ„¤νΈμ›ν¬ κµ¬μ„±μ„ ν™•μΈν•λ‹¤.


λ„¤νΈμ›ν¬ κµ¬μ„± μ¤‘ flannel.1 μΈν„°νμ΄μ¤μ μ •λ³΄λ¥Ό λ‹¤μ‹ ν•λ² ν™•μΈν•λ‹¤.


```bash
$ ip addr show
3: flannel.1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 8951 qdisc noqueue state UNKNOWN group default
    link/ether 2e:98:28:11:0b:8e brd ff:ff:ff:ff:ff:ff
    inet 10.42.1.0/32 scope global flannel.1
       valid_lft forever preferred_lft forever
    inet6 fe80::2c98:28ff:fe11:b8e/64 scope link
       valid_lft forever preferred_lft forever
```


μ»¨νΈλ΅¤ ν”λ μΈμ λΌμ°ν… ν…μ΄λΈ”μ„ ν™•μΈν•λ‹¤. `10.42.1.0/24`, μ›μ»¤λ…Έλ“μ— μ„μΉν• νλ“ λ„¤νΈμ›ν¬ λ€μ—­μ€ flannel.1 μΈν„°νμ΄μ¤λ΅ λΌμ°ν…ν•λ‹¤.


```bash
$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.32.0.1       0.0.0.0         UG    0      0        0 eth0
10.32.0.0       0.0.0.0         255.255.240.0   U     0      0        0 eth0
10.42.0.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0
10.42.1.0       10.42.1.0       255.255.255.0   UG    0      0        0 flannel.1
169.254.169.254 0.0.0.0         255.255.255.255 UH    0      0        0 eth0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
```


μ›μ»¤λ…Έλ“μ λΌμ°ν… ν…μ΄λΈ”μ„ ν™•μΈν•λ‹¤. μ μ‚¬ν•κ² `10.42.0.0/24` μ»¨νΈλ΅¤ ν”λ μΈμ νλ“ λ„¤νΈμ›ν¬ λ€μ—­μ€ flannel.1 μΈν„°νμ΄μ¤λ΅ λΌμ°ν…ν•λ‹¤.


```bash
$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.32.0.1       0.0.0.0         UG    0      0        0 eth0
10.32.0.0       0.0.0.0         255.255.240.0   U     0      0        0 eth0
10.42.0.0       10.42.0.0       255.255.255.0   UG    0      0        0 flannel.1
10.42.1.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0
169.254.169.254 0.0.0.0         255.255.255.255 UH    0      0        0 eth0
```


### μ΄μ  νλ“λΌλ¦¬ ν†µμ‹ μ„ μ§„ν–‰ν•λ‹¤.


μ°μ„ , pod2(μ»¨νΈλ΅¤ ν”λ μΈμ— μ„μΉ)μ— μ ‘μ†ν•μ—¬ pod1μ ipλ΅ `ping`μ„ λ³΄λ‚Έλ‹¤.


```bash
kubectl exec pod2 -it -- zsh
ping -c 4 10.42.1.33
```


μ΄μ „κ³Όλ” λ‹¤λ¥΄κ², μ‘λ‹µμ΄ μ¤μ§€μ•κ³  ν¨ν‚·μ„ μƒλ”λ‹¤. flannelμ΄ ν¬μ¥ν•λ” κ³Όμ •μ—μ„ λ³„λ„μ ν¬νΈλ¥Ό μ‚¬μ©ν•κΈ° λ•λ¬ΈμΈλ°, ν¬νΈλ¥Ό ν™•μΈν•κ³  λ³΄μ•κ·Έλ£Ήμ—μ„ ν•΄λ‹Ή ν¬νΈλ¥Ό κ°λ°©ν•λ‹¤.


```bash
$ netstat -a | grep udp
udp        0      0 0.0.0.0:bootpc          0.0.0.0:*
udp        0      0 0.0.0.0:sunrpc          0.0.0.0:*
udp        0      0 0.0.0.0:otv             0.0.0.0:*
...
```


μ—¬κΈ°μ„ `otv(overlay Transport Virtualization)` μ„λΉ„μ¤μ μ •λ³΄λ¥Ό ν™•μΈν•λ©΄ 8472 UDP ν¬νΈλ¥Ό μ‚¬μ©ν•λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


```bash
$ grep 'otv' /etc/services
otv             8472/tcp                # Overlay Transport Virtualization (OTV)
otv             8472/udp                # Overlay Transport Virtualization (OTV)
```


AWS λ³΄μ•κ·Έλ£Ήμ—μ„, μ•„λμ™€ μ‚¬μ§„κ³Ό κ°™μ΄ ν¬νΈλ¥Ό κ°λ°©ν•λ‹¤.


![Untitled.png](/assets/img/post/νλ“%20λ„¤νΈμ›ν¬%20μ΄ν•΄ν•κΈ°/1.png)


μ„¤μ •μ„ μ™„λ£ν• ν›„, λ‹¤μ‹ Ping ν…μ¤νΈλ¥Ό μ§„ν–‰ν•©λ‹λ‹¤. μ •μƒμ μΌλ΅ μ‘λ™ν•λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


```bash
$ ping -c 4 10.42.1.39
PING 10.42.1.39 (10.42.1.39) 56(84) bytes of data.
64 bytes from 10.42.1.39: icmp_seq=1 ttl=62 time=0.655 ms
64 bytes from 10.42.1.39: icmp_seq=2 ttl=62 time=0.541 ms
64 bytes from 10.42.1.39: icmp_seq=3 ttl=62 time=0.629 ms
64 bytes from 10.42.1.39: icmp_seq=4 ttl=62 time=0.552 ms

--- 10.42.1.39 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3065ms
rtt min/avg/max/mdev = 0.541/0.594/0.655/0.048 ms
```


μ»¨νΈλ΅¤ λ…Έλ“μ eth0 μΈν„°νμ΄μ¤μ—μ„ UDP 8472λ΅ λΉ μ Έλ‚κ°€λ” ν¨ν‚·μ„ ν™•μΈν•΄λ³Έλ‹¤.


μ•„λμ™€ κ°™μ΄ μ»¨νΈλ΅¤ λ…Έλ“μ νλ“μ—μ„ μ›μ»¤ λ…Έλ“μ νλ“λ΅ ν¨ν‚·μ΄ μ „μ†΅λκ³  μλ‹¤. μ΄λ¥Ό ν†µν•΄ μ¤λ²„λ μ΄ κ°€μƒν™” κΈ°μ λ΅ μ„λ΅ λ‹¤λ¥Έ λ…Έλ“μ— μ„μΉν• νλ“λΌλ¦¬ ν†µμ‹ μ„ μ§„ν–‰ν•λ‹¤λ” κ²ƒμ„ ν•λ² λ” ν™•μΈν•  μ μλ‹¤.


```bash
$ tcpdump -i eth0 -nn udp port 8472
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
14:12:33.865018 IP 10.32.11.62.41373 > 10.32.7.224.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.0.37 > 10.42.1.39: ICMP echo request, id 4, seq 1, length 64
14:12:33.865543 IP 10.32.7.224.51951 > 10.32.11.62.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.1.39 > 10.42.0.37: ICMP echo reply, id 4, seq 1, length 64
14:12:34.881738 IP 10.32.11.62.41373 > 10.32.7.224.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.0.37 > 10.42.1.39: ICMP echo request, id 4, seq 2, length 64
14:12:34.882245 IP 10.32.7.224.51951 > 10.32.11.62.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.1.39 > 10.42.0.37: ICMP echo reply, id 4, seq 2, length 64
14:12:35.905774 IP 10.32.11.62.41373 > 10.32.7.224.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.0.37 > 10.42.1.39: ICMP echo request, id 4, seq 3, length 64
14:12:35.906901 IP 10.32.7.224.51951 > 10.32.11.62.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.1.39 > 10.42.0.37: ICMP echo reply, id 4, seq 3, length 64
14:12:36.907095 IP 10.32.11.62.41373 > 10.32.7.224.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.0.37 > 10.42.1.39: ICMP echo request, id 4, seq 4, length 64
14:12:36.907617 IP 10.32.7.224.51951 > 10.32.11.62.8472: OTV, flags [I] (0x08), overlay 0, instance 1
IP 10.42.1.39 > 10.42.0.37: ICMP echo reply, id 4, seq 4, length 64
```


### μ°Έκ³ 


[CloudNet](/c9dfa44a27ff431dafdd2edacc8a1863)


[https://medium.com/finda-tech/kubernetes-λ„¤νΈμ›ν¬-μ •λ¦¬-fccd4fd0ae6](https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6)


[https://docs.k3s.io/architecture](https://docs.k3s.io/architecture)

