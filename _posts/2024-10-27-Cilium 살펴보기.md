---
layout: post
title: Cilium ì‚´í´ë³´ê¸°
date: 2024-10-26 09:00 +0900 
description: Cilium ì‚´í´ë³´ê¸°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#8, Cilium ] 
pin: false
math: true
mermaid: true
---
Cilium ì‚´í´ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


### ë“¤ì–´ê°€ë©°


ì´ì „ í¬ìŠ¤íŒ…ì—ì„œ ebpfì— ëŒ€í•´ ì•Œì•„ë´¤ë‹¤. Ciliumì€ ebpfë¥¼ ì‚¬ìš©í•˜ëŠ” CNIì´ë‹¤. CNIëŠ” íŒŒë“œ í†µì‹ ê³¼ IPAMì— ëŒ€í•œ ì±…ì„ì„ ê°€ì§€ëŠ”ë° ì—¬ê¸°ì—ì„œëŠ” Ciliumì˜ ê¸°ë³¸ì ì¸ ì•„í‚¤í…ì²˜ êµ¬ì¡°ë¥¼ ì‚´í´ë³´ë©° ì–´ë–»ê²Œ íŒŒë“œ í†µì‹ ì„ ì§€ì›í•˜ëŠ”ì§€ ì•Œì•„ë³¸ë‹¤.


## Cilium


ê¸°ì¡´ì˜ ë¦¬ëˆ…ìŠ¤ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒë„ ë³µì¡í•˜ë©°, ì•ì„œ ebpfí¸ì—ì„œ ì‚´í´ë´¤ë“¯ì´ ê¸°ì¡´ì˜ iptablesëŠ” ì—¬ëŸ¬ ë‹¨ì ì´ ìˆë‹¤. íŠ¹íˆ í´ëŸ¬ìŠ¤í„°ì˜ ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ ë‹¨ì ì´ ë¶€ê°ëœë‹¤.


Ciliumì€ ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ ì ebpfë¥¼ ì‚¬ìš©í•˜ì—¬ Kernelì„ ì»¤ìŠ¤í…€í•˜ì—¬ ì„±ëŠ¥ê³¼ ë³´ì•ˆì„ ì¡ì€ CNI Pluginì´ë‹¤. iptablesì˜ ë‹¨ì ì„ í•´ê²°í•˜ê³ ì í•˜ë‹ˆ kube-proxyë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  Ciliumì—ì„œ ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ ì‘ì—…ë„ ì§„í–‰í•œë‹¤. (ì•„ì§ ì¼ë¶€ iptablesì— ì˜ì¡´í•˜ëŠ” ë™ì‘ë“¤ì€ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.)


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/1.png)


ì¶œì²˜: [https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/](https://isovalent.com/blog/post/migrating-from-metallb-to-cilium/)


### ì•„í‚¤í…ì²˜


Ciliumì„ ë°ëª¬ì…‹ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬, eBPF ì½”ë“œë¥¼ ê´€ë¦¬í•˜ì—¬ eBPFë¥¼ í†µí•´ ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬ ì •ì±…, ì„œë¹„ìŠ¤ ê´€ë ¨ ì •ì±…, ëª¨ë‹ˆí„°ë§ ë“±ì„ ì§„í–‰í•œë‹¤.


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/2.png)


ì¶œì²˜: [https://docs.cilium.io/en/stable/overview/component-overview/](https://docs.cilium.io/en/stable/overview/component-overview/)


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/3.png)


### êµ¬ì„±ìš”ì†Œ

- Cilium **Agent** : ë°ëª¬ì…‹ìœ¼ë¡œ ì‹¤í–‰, ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ì„¤ì • ë° ëª¨ë‹ˆí„°ë§ ë“±ì„ ìˆ˜í–‰í•˜ë©°, eBPF í”„ë¡œê·¸ë¨ì„ ê´€ë¦¬
- Cilium **Client** (CLI) : Cilium ì»¤ë©˜ë“œíˆ´, eBPF Data(Ring Buff, Maps)ì— ì ‘ì†í•  ìˆ˜ ìˆë‹¤.
- Cilium **Operator** : K8S í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ í•œ ë²ˆì”© ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‘ì—…ì„ ê´€ë¦¬, controlplane ì—­í• 
- **Hubble** : ë„¤íŠ¸ì›Œí¬ì™€ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í”Œë«í¼ ì—­í• ì„ í•˜ì—¬, 'Server, Relay, Client, Graphical UI' ë¡œ êµ¬ì„±
- **Data Store** : Cilium Agent ê°„ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ì „íŒŒí•˜ëŠ” ë°ì´í„° ì €ì¥ì†Œ, K8S CRDs, Key-Value Storeí˜•íƒœë¡œ ì €ì¥ëœë‹¤.

### Traffic Control

- TC(Traffic Control) Ingres/Egress: **Network Interface** ì— **tc** ingress hook ì—ì„œ BPF programs ì‹¤í–‰ëœë‹¤.
	- XDPë¡œ íŠ¸ë˜í”½ì„ ì œì–´í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤. [ì°¸ê³ ìë£Œ](https://docs.cilium.io/en/stable/bpf/)
- Endpoint Policy: ì •ì±…ì— ë”°ë¼ íŒ¨í‚·ì„ ì°¨ë‹¨/ì „ë‹¬í•˜ê±°ë‚˜, ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•˜ê±°ë‚˜, L7 ì •ì±… ì „ë‹¬ í•  ìˆ˜ ìˆë‹¤.
- Service ê´€ë ¨: ëª¨ë“  íŒ¨í‚·ì˜ ëª©ì ì§€ IP/Port ì˜ map ì¡°íšŒ ì‹œ ì¼ì¹˜í•˜ë©´ L3/L4 endpoint ë¡œ ì „ë‹¬í•˜ë©°, Service block ëŠ” ëª¨ë“  ì¸í„°í˜ì´ìŠ¤ì˜ TC ingress hook ì—ì„œ ë™ì‘í•  ìˆ˜ ìˆë‹¤.
- L7: L7ë„ ì§€ì›í•˜ë©°, L7 ì •ì±… ì²˜ë¦¬ë¥¼ ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œëŠ” envoyë¥¼ ì‚¬ìš©í•œë‹¤. ê·¸ë ‡ê¸°ì— ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒ ì•„ë«ë‹¨ì—ì„œ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ê³  userspaceì—ì„œ ì²˜ë¦¬í•œë‹¤

![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/4.png)


ì¶œì²˜: [https://static.sched.com/hosted_files/kccncna19/1a/Liberating k8s from kube-proxy and iptables.pdf](https://static.sched.com/hosted_files/kccncna19/1a/Liberating%20k8s%20from%20kube-proxy%20and%20iptables.pdf)


## í†µì‹ 


### íŒŒë“œ í†µì‹ 


L3/L4 ì •ì±…ì„ í†µí•´ íŠ¸ë˜í”½ì„ ì œì–´í•œë‹¤. ì´í›„ í—ˆìš©ë˜ë©´ TCP í•¸ë“œì‰ì´í¬ ê³¼ì •ì„ ì§„í–‰í•˜ëŠ”ë°, ì´ë•Œ ì†Œì¼“ ê³„ì¸µ ì •ì±…ì„ í†µí•´ ì—°ê²° ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤. ë•ë¶„ì— ì†Œì¼“ Layerì—ì„œ ì¶”ê°€ì ì¸ ì •ì±…ê²€ì‚¬ê°€ í•„ìš”í•˜ì§€ ì•ŠëŠ”ë‹¤. ë§Œì•½ TCP ì—°ê²°ì´ ì§„í–‰(ESTABLISHED)ë˜ë©´ L7 ì •ì±…ì„ í™•ì¸í•œë‹¤. í•œë²ˆ ì—°ê²°ì„ ë§ºê³ , L7 ì •ì±…ì´ ì—†ë‹¤ë©´ ë¹ ë¥´ê²Œ ë¼ìš°íŒ…ëœë‹¤. (TCP Accelerated Path)


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/5.png)


### Egress


Overlay ë„¤íŠ¸ì›Œí¬ì™€ L3 ì•”í˜¸í™”ëŠ” ì„ íƒì ì´ë©°, ì§„í–‰ì‹œ ì¶”ê°€ì ì¸ ì‘ì—…ì´ ì¼ì–´ë‚œë‹¤. Overlay ì¸í„°í˜ì´ìŠ¤ì˜ ê¸°ë³¸ê°’ì€ cilum_vxlanì´ë‹¤. ì†Œì¼“ ì •ì±…ê³¼ L7 í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ë©´ ì •ì±… ê²€ì‚¬ë¥¼ ì§„í–‰í•˜ì§€ ì•Šê³  ë°”ë¡œ ì™¸ë¶€ë¡œ ë‚˜ê°ˆ ìˆ˜ ìˆë‹¤.(L3 encryption off ì¼ë•Œ)


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/6.png)


### Ingress


ì™¸ë¶€ì—ì„œ íŠ¸ë˜í”½ì´ ë“¤ì–´ì˜¤ëŠ” ê²½ìš°ì—ë„ ìœ ì‚¬í•˜ë‹¤. Proxyì™€ Socket ì •ì±… ì ìš©ì„ í†µí•´ ì—¬ëŸ¬ ê³¼ì •ì„ ê±´ë„ˆë›°ê³  ë°”ë¡œ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¼ìš°íŒ…ì´ ê°€ëŠ¥í•˜ë‹¤.


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/7.png)


### Load Balancing


Ciliumì—ì„œ ì„œë¹„ìŠ¤(ClusterIP type)ì— ëŒ€í•´ í†µì‹ í•  ë•Œ ë¡œë“œë°¸ëŸ°ì‹±ì´ ì´ë¤„ì§€ëŠ” ë°©ì‹ì€ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±, ì†Œì¼“ ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹± 2ê°€ì§€ë¡œ ë‚˜ë‰œë‹¤. ì˜ ì •ë¦¬í•´ì£¼ì‹  ë¸”ë¡œê·¸ [í¬ìŠ¤íŒ…](https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95)


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/8.png)


ì¶œì²˜: [https://cilium.io/blog/2019/08/20/cilium-16/](https://cilium.io/blog/2019/08/20/cilium-16/)


ì•„ë˜ëŠ” í•´ë‹¹ ë¸”ë¡œê·¸ì˜ ê¸€ì´ë‹¤.


**â€œì†Œì¼“ ê¸°ë°˜ ë¡œë“œ ë°¸ëŸ°ì‹±**ì€ í´ë¼ì´ì–¸íŠ¸ì™€ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ë¡œë“œ ë°¸ëŸ°ì‹±ì˜ ì¥ì ì„ ê²°í•©í•˜ì—¬ **ì• í”Œë¦¬ì¼€ì´ì…˜ íˆ¬ëª…ì„±**ì„ ìœ ì§€í•˜ë©´ì„œ, ì—°ê²° ì„¤ì • ì‹œì ì—ë§Œ ì£¼ì†Œë¥¼ ë³€í™˜í•˜ì—¬ ë¡œë“œ ë°¸ëŸ°ì‹± ë¹„ìš©ì„ ì¤„ì¸ë‹¤. ì¦‰, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°±ì—”ë“œì™€ ì§ì ‘ í†µì‹ í•˜ëŠ” ê²ƒì²˜ëŸ¼ ì„±ëŠ¥ì´ ìœ ì§€ë˜ë©°, ì´í›„ ì¶”ê°€ ë³€í™˜ ì—†ì´ íš¨ìœ¨ì ì¸ ë°ì´í„° ì „ì†¡ì´ ê°€ëŠ¥í•¨.â€


### Observability


ì€ Ciliumì—ì„œ ë§Œë“  eBPF ê¸°ë°˜ ë„¤íŠ¸ì›Œí¬/ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í”Œë«í¼ì´ë‹¤. eBPF ê¸°ë°˜ì´ê¸°ì— ì´ì „ì—ëŠ” ë¶ˆê°€ëŠ¥í–ˆë˜ Kernel ë‹¨ê¹Œì§€ ì„¸ë°€í•˜ê²Œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë©° ì„±ëŠ¥ì—ë„ ì˜í–¥ì´ ì ë‹¤.


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/9.png)


ì¶œì²˜: [https://github.com/cilium/hubble](https://github.com/cilium/hubble)


ì•„ë˜ëŠ” Service MAP ì˜ˆì‹œ ì‚¬ì§„ì´ë©°, Hubble CLIë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ Flowì— ëŒ€í•œ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤. ê°€ë ¹, ë„¤íŠ¸ì›Œí¬ ì •ì±… ê±°ë¶€ í™•ì¸, ê°œë³„ TCP ì—°ê²°ì´ë‚˜ HTTP ìš”ì²­ í˜¹ì€ Kafka í†µì‹ ì— ëŒ€í•œ Connectionì´ë‚˜ ì§€ì—°ì‹œê°„ Responseë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.


ì˜ˆì‹œ) _Denied connection attempt_


```bash
starwars/enterprise-5775b56c4b-thtwl:37800   starwars/deathstar-695d8f7ddc-lvj84:80(http)   Policy denied (L3)   TCP Flags: SYN
starwars/enterprise-5775b56c4b-thtwl:37800   starwars/deathstar-695d8f7ddc-lvj84:80(http)   Policy denied (L3)   TCP Flags: SYN
starwars/enterprise-5775b56c4b-thtwl:37800   starwars/deathstar-695d8f7ddc-lvj84:80(http)   Policy denied (L3)   TCP Flags: SYN
```


ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ Metrics & ëª¨ë‹ˆí„°ë§ë„ ì œê³µí•œë‹¤.)


![image.png](/assets/img/post/Cilium%20ì‚´í´ë³´ê¸°/10.png)


ì¶œì²˜: [https://docs.cilium.io/en/stable/observability/hubble/hubble-ui/index.html](https://docs.cilium.io/en/stable/observability/hubble/hubble-ui/index.html)


ì°¸ê³ ìë£Œ: [https://cilium.io/blog/2019/11/19/announcing-hubble/](https://cilium.io/blog/2019/11/19/announcing-hubble/), [https://github.com/cilium/hubble?tab=readme-ov-file](https://github.com/cilium/hubble?tab=readme-ov-file)


### ë§ˆì¹˜ë©°


Ciliumì€ eBPFë¥¼ ì‚¬ìš©í•˜ì—¬ Kernelì„ ì»¤ìŠ¤í…€í•˜ì—¬ ë³´ì•ˆê³¼ ì„±ëŠ¥ì„ í™•ë³´í•œ CNIì´ë‹¤. Linux ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ ìš°íšŒí•˜ì—¬ ì„±ëŠ¥ì„ í™•ë³´í–ˆìœ¼ë©° ì—”ë“œí¬ì¸íŠ¸ ì—°ê²°ì‹œ TCP í•¸ë“œì‰ì´í¬ì‹œ Socket ê¸°ë°˜ ì •ì±…ì„ ì ìš©í•˜ë©°, L7 Proxyë¥¼ ì ìš©í•˜ë©´ TCP ê°€ì†ì´ ê°€ëŠ¥í•˜ë„ë¡ ì»¤ìŠ¤í…€í•˜ì˜€ë‹¤. ì´ì œ ë‹¤ìŒ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì•ì„œ ì•Œì•„ë³¸ Ciliumì˜ êµ¬ì¡°ë¥¼ ì‹¤ìŠµì„ í†µí•´ í™•ì¸í•´ë³¸ë‹¤.

