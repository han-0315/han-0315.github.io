---
layout: post
title: Pause ì»¨í…Œì´ë„ˆë€?
date: 2024-09-03 09:00 +0900 
description: KANS ìŠ¤í„°ë”” 2ì£¼ì°¨ PAUSE ì»¨í…Œì´ë„ˆ ì•Œì•„ë³´ê¸°
category: [Kubernetes, container] 
tags: [KANS, CloudNet, pause, pod, container, Kubernetes, Network, KANS#2 ] 
pin: false
math: true
mermaid: true
---
KANS ìŠ¤í„°ë”” 2ì£¼ì°¨ PAUSE ì»¨í…Œì´ë„ˆ ì•Œì•„ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.





## íŒŒë“œ & PAUSE ì»¨í…Œì´ë„ˆ


ì—¬ê¸°ì„œëŠ” íŒŒë“œ ìƒì„±ì‹œ Initìœ¼ë¡œ ìƒì„±ë˜ëŠ” PAUSE ì»¨í…Œì´ë„ˆì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.


### PAUSE ì»¨í…Œì´ë„ˆ ì—­í• 


ë¨¼ì € ì»¨í…Œì´ë„ˆì˜ ì—­í• ì„ ë¨¼ì € í™•ì¸í•˜ê³  ê°€ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤. ì¶”í›„ ì‹¤ìŠµì—ì„œ í•œë²ˆ ë” í™•ì¸í•©ë‹ˆë‹¤.

- íŒŒë“œì—ì„œ Linux **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ ì˜ ìœ ì§€** ì—­í• ì„ í•©ë‹ˆë‹¤.
  - ìƒì„±ì€ Containerd ê¸°ì¤€ìœ¼ë¡œ CRIì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤. ì°¸ê³  [ì•…ë¶„ë‹˜ ë¸”ë¡œê·¸](https://malwareanalysis.tistory.com/769)
- ê° íŒŒë“œì— ëŒ€í•œ **PID 1 ì—­í• **ì„ í•˜ë©° **ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì œê±°í•œë‹¤.**

#### ì½”ë“œ


```bash
/*
... Apache ë¼ì´ì„ ìŠ¤ ë‚´ìš©
*/

#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>

#define STRINGIFY(x) #x
#define VERSION_STRING(x) STRINGIFY(x)

#ifndef VERSION
#define VERSION HEAD
#endif

static void sigdown(int signo) {
  psignal(signo, "Shutting down, got signal");
  exit(0);
}

static void sigreap(int signo) {
  while (waitpid(-1, NULL, WNOHANG) > 0)
    ;
}

int main(int argc, char **argv) {
  int i;
  for (i = 1; i < argc; ++i) {
    if (!strcasecmp(argv[i], "-v")) {
      printf("pause.c %s\n", VERSION_STRING(VERSION));
      return 0;
    }
  }

  if (getpid() != 1)
    /* Not an error because pause sees use outside of infra containers. */
    fprintf(stderr, "Warning: pause should be the first process\n");

  if (sigaction(SIGINT, &(struct sigaction){.sa_handler = sigdown}, NULL) < 0)
    return 1;
  if (sigaction(SIGTERM, &(struct sigaction){.sa_handler = sigdown}, NULL) < 0)
    return 2;
  if (sigaction(SIGCHLD, &(struct sigaction){.sa_handler = sigreap,
                                             .sa_flags = SA_NOCLDSTOP},
                NULL) < 0)
    return 3;

  for (;;)
    pause();
  fprintf(stderr, "Error: infinite loop terminated\n");
  return 42;
}
```


> ğŸ’¡ ì½”ë“œ ì„¤ëª…(ìš”ì•½ë³¸)  
> - ì´ í”„ë¡œê·¸ë¨ì€ ì£¼ë¡œ ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ë©°, **ì‹ í˜¸(SIGINT, SIGTERM, SIGCHLD)ë¥¼ ì²˜ë¦¬**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.  
>   
> - ì»¨í…Œì´ë„ˆì—ì„œ **ì²« ë²ˆì§¸ í”„ë¡œì„¸ìŠ¤**ë¡œ ë™ì‘í•˜ë©°, ì ì ˆí•œ **ì‹ í˜¸ ì²˜ë¦¬**(í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ, ìì‹ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì²˜ë¦¬)ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.  
>   
> - `pause()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ **ì‹ í˜¸ê°€ ë°œìƒí•  ë•Œê¹Œì§€ ë¬´í•œ ëŒ€ê¸°**í•©ë‹ˆë‹¤.



## [ì‹¤ìŠµ] ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ  í™•ì¸


ì—¬ê¸°ì—ì„œëŠ” íŒŒë“œë¥¼ ë°°í¬í•˜ì—¬, ì‹¤ì œ pause containerì˜ ì¡´ì¬ë¥¼ í™•ì¸í•˜ê³ , ê°™ì€ íŒŒë“œë‚´ì—ì„œëŠ” ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ ê³µìœ í•¨ì„ í™•ì¸í•©ë‹ˆë‹¤.


### íŒŒë“œ ë°°í¬


ê°„ë‹¨í•˜ê²Œ nginx íŒŒë“œë¥¼ ë°°í¬í•©ë‹ˆë‹¤.


```bash
kubectl run web-app1 --image=nginx
```


workerë…¸ë“œì— ì ‘ì†í•˜ì—¬ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

1. í˜„ì¬ 3ê°œì˜ íŒŒë“œê°€ ë™ì‘ ì¤‘(kindnet, kube-proxy, web-app1)
2. ëª¨ë“  íŒŒë“œì— pause í”„ë¡œì„¸ìŠ¤ê°€ í™•ì¸ë¨

```bash
root@myk8s-worker:/# crictl ps
CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD
425023d6bf498       a9dfdba8b7190       13 seconds ago      Running             web-app1            0                   62300a8320ec7       web-app1
6c78d35736270       4740c1948d3fc       2 minutes ago       Running             kindnet-cni         0                   8cbc0152756f1       kindnet-ndvkp
07c51c7ffe9aa       d2d4e1917462f       2 minutes ago       Running             kube-proxy          0                   0c554532b5e25       kube-proxy-vtrnp
root@myk8s-worker:/# pstree -aln
systemd
  |-systemd-journal
  |-containerd
  |   `-14*[{containerd}]
  |-kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=172.18.0.3 --node-labels= --pod-infra-container-image=registry.k8s.io/pause:3.9 --provider-id=kind://docker/myk8s/myk8s-worker --runtime-cgroups=/system.slice/containerd.service
  |   `-12*[{kubelet}]
  |-containerd-shim -namespace k8s.io -id 8cbc0152756f1be78361e598b20fa2ed9e0d0d70d7e3167061c72ffb44ba26b7 -address /run/containerd/containerd.sock
  |   |-11*[{containerd-shim}]
  |   |-pause
  |   `-kindnetd
  |       `-8*[{kindnetd}]
  |-containerd-shim -namespace k8s.io -id 0c554532b5e2582948170afc3646c9e77291bf13fb86efe5b49d019b1053a518 -address /run/containerd/containerd.sock
  |   |-11*[{containerd-shim}]
  |   |-pause
  |   `-kube-proxy --config=/var/lib/kube-proxy/config.conf --hostname-override=myk8s-worker
  |       `-7*[{kube-proxy}]
  `-containerd-shim -namespace k8s.io -id 62300a8320ec795961fedb61238854616bed234a28405a7079f6ed4ecfb2f9da -address /run/containerd/containerd.sock
      |-11*[{containerd-shim}]
      |-pause
      `-nginx
          |-nginx
          |-nginx
          |-nginx
          |-nginx
          `-nginx
```


pause í”„ë¡œì„¸ìŠ¤ì˜ PIDë¥¼ í™•ì¸í•©ë‹ˆë‹¤. (ê°€ì¥ ë‚˜ì¤‘ì— ë„ìš´ íŒŒë“œì´ë¯€ë¡œ, PIDê°€ ê°€ì¥ í° pause í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ìœ¼ë©´ ë©ë‹ˆë‹¤.)


```bash
ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.2  0.1  21736 12360 ?        Ss   12:16   0:00 /sbin/init
...
65535        306  0.0  0.0    792     4 ?        Ss   12:16   0:00 /pause
65535        314  0.0  0.0    792     4 ?        Ss   12:16   0:00 /pause
root         364  0.0  0.6 1283236 50024 ?       Ssl  12:16   0:00 /usr/local/bin/kube-proxy --config=/var/lib/kub
root         447  0.0  0.3 740344 24628 ?        Ssl  12:16   0:00 /bin/kindnetd
root        1046  0.0  0.1 1238296 12476 ?       Sl   12:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespa
65535       1065  0.0  0.0    792     4 ?        Ss   12:18   0:00 /pause
root        1078  0.0  0.0   4052  3280 pts/1    Ss   12:18   0:00 bash
root        1129  0.0  0.0  11136  6900 ?        Ss   12:18   0:00 nginx: master process nginx -g daemon off;
statd       1166  0.0  0.0  11596  2952 ?        S    12:18   0:00 nginx: worker process
statd       1167  0.0  0.0  11596  2952 ?        S    12:18   0:00 nginx: worker process
...
```


nginxì™€ ìœ„ì—ì„œ ì°¾ì€ pause í”„ë¡œì„¸ìŠ¤ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

- net, uts, ipcê°€ ê°™ì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
root@myk8s-worker:/# lsns -p 1129
        NS TYPE   NPROCS   PID USER  COMMAND
4026531834 time       20     1 root  /sbin/init
4026531837 user       20     1 root  /sbin/init
4026533140 net         7  1065 65535 /pause
4026533255 uts         7  1065 65535 /pause
4026533256 ipc         7  1065 65535 /pause
4026533258 mnt         6  1129 root  nginx: master process nginx -g daemon off;
4026533259 pid         6  1129 root  nginx: master process nginx -g daemon off;
4026533260 cgroup      6  1129 root  nginx: master process nginx -g daemon off;
root@myk8s-worker:/# lsns -p 1065
        NS TYPE   NPROCS   PID USER  COMMAND
4026531834 time       20     1 root  /sbin/init
4026531837 user       20     1 root  /sbin/init
4026532731 cgroup     13     1 root  /sbin/init
4026533140 net         7  1065 65535 /pause
4026533254 mnt         1  1065 65535 /pause
4026533255 uts         7  1065 65535 /pause
4026533256 ipc         7  1065 65535 /pause
4026533257 pid         1  1065 65535 /pause
```


### ê°™ì€ íŒŒë“œë‚´ì˜ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë¼ë¦¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ  í™•ì¸


ì´ì œ ë‘ ê°œì˜ ì»¨í…Œì´ë„ˆë¥¼ ê°€ì§„ íŒŒë“œë¥¼ ë°°í¬í•˜ì—¬, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.


netshoot ì»¨í…Œì´ë„ˆëŠ” ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ë””ë²„ê¹… ì „ìš© ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [GitHub](https://github.com/nicolaka/netshoot)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: myweb2
spec:
  containers:
    - name: myweb2-nginx
      image: nginx
      ports:
        - containerPort: 80
          protocol: TCP

    - name: myweb2-netshoot
      image: nicolaka/netshoot
      command: ["/bin/bash"]
      args: ["-c", "while true; do sleep 5; curl localhost; done"]

  terminationGracePeriodSeconds: 0
EOF
```


ë°°í¬ê°€ ì™„ë£Œë˜ë©´, netshoot ì»¨í…Œì´ë„ˆì— ì ‘ì†í•©ë‹ˆë‹¤.


```bash
kubectl exec myweb2 -c myweb2-netshoot -it -- zsh
```


í˜„ì¬ ì ìœ í•˜ê³  ìˆëŠ” í¬íŠ¸ë¥¼ ì°¾ì•„ë³´ê³ , localhostë¡œ curlë¥¼ ë‚ ë¦½ë‹ˆë‹¤.


ê²°ê³¼ë¥¼ í™•ì¸í•˜ë©´, ë§ˆì¹˜ ì—¬ê¸°ê°€ nginx ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì¸ ê²ƒì²˜ëŸ¼ ì„¤ì •ë˜ì–´ìˆìŠµë‹ˆë‹¤.


![image.png](/assets/img/post/PAUSE%20ì»¨í…Œì´ë„ˆ(Pod)/1.png)


ìœ„ì—ì„œ ë´¤ë“¯ì´ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(ìŠ¤íƒ)ë¥¼ ê³µìœ í•œë‹¤ëŠ” ê²ƒì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```bash
ps -ef
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 12:16 ?        00:00:00 /sbin/init
...
65535        306     268  0 12:16 ?        00:00:00 /pause
65535        314     267  0 12:16 ?        00:00:00 /pause
root         364     268  0 12:16 ?        00:00:00 /usr/local/bin/kube-proxy --config=/var/lib/kube-proxy/config.
root         447     267  0 12:16 ?        00:00:00 /bin/kindnetd
root        1460       1  0 12:25 ?        00:00:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 0
65535       1479    1460  0 12:25 ?        00:00:00 /pause
root        1509    1460  0 12:26 ?        00:00:00 nginx: master process nginx -g daemon off;
statd       1547    1509  0 12:26 ?        00:00:00 nginx: worker process
statd       1548    1509  0 12:26 ?        00:00:00 nginx: worker process
statd       1549    1509  0 12:26 ?        00:00:00 nginx: worker process
statd       1550    1509  0 12:26 ?        00:00:00 nginx: worker process
statd       1551    1509  0 12:26 ?        00:00:00 nginx: worker process
root        1631    1460  0 12:26 ?        00:00:00 /bin/bash -c while true; do sleep 5; curl localhost; done
root        2088       0  0 12:30 pts/1    00:00:00 bash
root        4097    1631  0 12:31 ?        00:00:00 sleep 5
root        4110    2088  0 12:31 pts/1    00:00:00 ps -ef
```


ë‹¤ì‹œ í•œë²ˆ Pause ì»¨í…Œì´ë„ˆì˜ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. ìœ„ì— ê²°ê³¼ì—ì„œëŠ” nginx í”„ë¡œì„¸ìŠ¤ ë°”ë¡œ ìœ„ì— ìˆëŠ” 1479ë²ˆì¸ ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.


crictlì„ ì´ìš©í•´ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´ë¥¼ í™•ì¸í•˜ë©´ Pauseê°€ ìƒì„±í•œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê°–ëŠ”ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


![image.png](/assets/img/post/PAUSE%20ì»¨í…Œì´ë„ˆ(Pod)/2.png)


### ì •ë¦¬

1. Pause ì»¨í…Œì´ë„ˆê°€ net/ipc/uts ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ~~ìƒì„±í•˜ê³ ~~ ê³µìœ í•œë‹¤. 
	1. init í”„ë¡œì„¸ìŠ¤ì˜ ì—­í• ë„ ìˆ˜í–‰í•˜ì—¬, ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì œê±°í•œë‹¤.
	2. network ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” CRIì—ì„œ ìƒì„±í•œë‹¤ê³  í•œë‹¤. [ì•…ë¶„ë‹˜ ë¸”ë¡œê·¸](https://malwareanalysis.tistory.com/769) ì°¸ê³ .
2. ê°™ì€ íŒŒë“œ ë‚´ì˜ ì»¨í…Œì´ë„ˆëŠ” ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì´ ë™ì¼í•˜ë‹¤.
	1. ê·¸ë ‡ê¸°ì— container portë¥¼ ì¡°ì‹¬í•´ì„œ ì„¸íŒ…í•´ì•¼ í•œë‹¤. (ì¤‘ë³µë˜ë©´ ì•ˆëœë‹¤.)
	2. ì‚¬ì´ë“œì¹´ë¡œ ë¶™ì´ë©´, ì‰½ê²Œ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤.
