---
layout: post
title: ì„œë¹„ìŠ¤ ë§¤ì‹œë€
date: 2025-04-12 09:00 +0900 
description: ì„œë¹„ìŠ¤ ë§¤ì‹œ ì‚´í´ë³´ê¸°
category: [Kubernetes, Network] 
tags: [istio, CloudNet, Kubernetes, Network, istio#1, Service mesh] 
pin: false
math: true
mermaid: true
---
ì„œë¹„ìŠ¤ ë§¤ì‹œë€
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” istio(Istio Hands-on Study) 1ê¸° ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” istio(Istio Hands-on Study) 1ê¸° ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


### ë“¤ì–´ê°€ë©°


CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” Istio ìŠ¤í„°ë””ì— ì°¸ì—¬í•˜ê²Œ ë˜ì—ˆë‹¤. ì‚¬ì‹¤ istioì— ëŒ€í•´ì„œ ê°„ë‹¨í•œ í•¸ì¦ˆì˜¨ì€ í•´ë´¤ì§€ë§Œ, ì œëŒ€ë¡œ ê³µë¶€í•´ë³¸ ì ì€ ì—†ëŠ” ê²ƒ ê°™ë‹¤. í•˜ì§€ë§Œ ìµœê·¼ ì—…ë¬´ íŒŒíŠ¸ê°€ istio ìš´ì˜ë„ í¬í•¨ë  ì˜ˆì •ì´ë¼ í•„ìš”ì„±ì„ ë§ì´ ëŠê¼ˆëŠ”ë° ì‚¬ë‚´ì—ì„œëŠ” istioë¥¼ ì¡°ê¸ˆ ìƒ‰ë‹¤ë¥´ê²Œ ì‚¬ìš©í•˜ê³  ìˆì–´ì„œ ë” í•™ìŠµì— ëŒ€í•œ í•„ìš”ì„±ì´ ë“  ê²ƒ ê°™ë‹¤. istioê¶ê¸ˆí•œ ì ì€ ì•„ë˜ì™€ ê°™ì€ë°, ì´ë²ˆ ìŠ¤í„°ë””ë¥¼ í†µí•´ ê¶ê¸ˆì¦ì„ í•´ì†Œí•˜ê³  ì‹¶ë‹¤.

- Ciliumì—ì„œ ì œê³µí•˜ëŠ” L7 ê¸°ëŠ¥ê³¼ ë¹„êµë˜ëŠ” istioì˜ ì¥ë‹¨ì 
(Cilium Ingress, Egressë¥¼ ì‚¬ìš©í•  ë•Œ istioê¹Œì§€ ì“¸ë§Œí•œ ì´ìœ ê°€ ìˆì„ê¹Œ?)
- íŠ¹íˆ ì˜¨í”„ë ˜ì—ì„œëŠ” ì–´ë–¤ ì¥ë‹¨ì ì´ ìˆì„ê¹Œ?

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì„œë¹„ìŠ¤ ë§¤ì‹œì˜ í•„ìš”ì„±ê³¼ istioì— ëŒ€í•´ ê°„ë‹¨í•˜ê²Œ ì•Œì•„ë³¼ ì˜ˆì •ì´ë‹¤.


### Service Mesh


ì„œë¹„ìŠ¤ ë§¤ì‹œëŠ” ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ê°„ì˜ í†µì‹ ì„ ë„ì™€ì£¼ëŠ” ë³„ë„ì˜ ì¸í”„ë¼ ë ˆì´ì–´ë‹¤. ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ë¥¼ ë°˜ì˜í•˜ë©´ì„œ ì„œë¹„ìŠ¤ê°€ ë§ì•„ì§ì— ë”°ë¼ ë³„ë„ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì •ì—†ì´ íŠ¸ë˜í”½ì„ ê´€ë¦¬ê°€ í•„ìš”í–ˆë‹¤. ë§Œì•½, ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì´ë¥¼ êµ¬í˜„í•˜ê³  ê´€ë¦¬í•œë‹¤ë©´ ì–¸ì–´ë³„ë¡œ í”„ë ˆì„ì›Œí¬ ë³„ë¡œ ì´ë¥¼ ê°œë³„ êµ¬ì„±í•´ì•¼í•œë‹¤. ì˜¤ë²„í—¤ë“œê°€ í¬ê¸°ì—, ë³„ë„ì˜ ì¸í”„ë¼ ë ˆì´ì–´ë¥¼ í†µí•´ í•´ê²°í•˜ê³ ì í–ˆê³ , ì´ ë ˆì´ì–´ë¥¼ ì„œë¹„ìŠ¤ ë§¤ì‹œë¼ê³  ë¶€ë¥¸ë‹¤.


istio ê³µì‹ docsì—ì„œë„ í•´ë‹¹ ë¶€ë¶„ì„ ì–¸ê¸‰í•œë‹¤. â€œ**Istio addresses the challenges developers and operators face with a distributed or microservices architecture.â€**


ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ ë„ì…í•˜ë©´ ì „ì²´ì ì¸ ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§ì´ ê°€ëŠ¥í•˜ë©°, ë„¤íŠ¸ì›Œí¬ë¥¼ ì œì–´í•  ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ, ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ ë„ì…í•˜ë©´ ë„¤íŠ¸ì›Œí¬ í™‰ì´ í•˜ë‚˜ì´ìƒ ë” ì¶”ê°€ë˜ë¯€ë¡œ ë¬´ê²ë‹¤. (ì•„ë˜ì— ì‚¬ì§„ë§Œ ë´ë„..) ê·¸ë ‡ê¸°ì— ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ ë„ì…í•˜ê¸°ì „ì— í˜„ì¬ í™˜ê²½ì— ì •ë§ í•„ìš”í•œì§€ ê³ ë¯¼í•´ë´ì•¼ í•œë‹¤. 


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/1.png)


ì¶œì²˜: [https://www.redhat.com/ko/topics/microservices/what-is-a-service-mesh](https://www.redhat.com/ko/topics/microservices/what-is-a-service-mesh)


## Istio


IstioëŠ” ì„œë¹„ìŠ¤ ë§¤ì‹œ êµ¬í˜„ì²´ ì¤‘ í•˜ë‚˜ë¡œ, ì„œë¹„ìŠ¤ ë§¤ì‹œê°€ ë§ˆë•…íˆ ê°–ì¶°ì•¼í•  ê¸°ëŠ¥ì¸ â€œë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì „ë°˜ì˜ íŠ¸ë˜í”½ íë¦„ì„ ê´€ë¦¬, ì •ì±… ì„¤ì •, ë°ì´í„° ìˆ˜ì§‘â€ì´ ê°€ëŠ¥í•˜ë‹¤. 


â€œë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì „ë°˜ì˜ íŠ¸ë˜í”½ íë¦„ì„ ê´€ë¦¬â€ì—ëŠ” ë¬´ì—‡ì´ ìˆì„ê¹Œ? ì˜ˆë¥¼ ë“¤ì–´, ì„œí‚·ë¸Œë ˆì´ì»¤ì™€ retryê°™ì€ ê¸°ëŠ¥ì´ ìˆë‹¤. ì´ë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì„¤ì •í•˜ì§€ ì•Šì•„ë„, istioì—ì„œ êµ¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤. ë•ë¶„ì— ê°œë°œìëŠ” ì„œë¹„ìŠ¤ êµ¬í˜„ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë‹¤.


#### êµ¬ì¡°


êµ¬ì¡°ëŠ” ê° ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì œì–´í•  ìˆ˜ ìˆëŠ” **ì „ìš© í”„ë¡ì‹œ**ë¥¼ ë‘ê³ , í”„ë¡ì‹œì— ëŒ€í•œ **ì„¤ì •ì„ ì¤‘ì•™ ë°ëª¬ì—ì„œ ì œì–´**í•˜ëŠ” í˜•íƒœì´ë‹¤. ì—¬ê¸°ì„œ ê°„ëµí•˜ê²Œ ì–¸ê¸‰í•˜ë©´ Proxyì˜ ì„¤ì •ì€ API ë°©ì‹ìœ¼ë¡œ ì œì–´ ê°€ëŠ¥í•˜ë‹¤. ë³„ë„ì˜ restartê°€ í•„ìš”ì—†ë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/2.png)


ì¶œì²˜: [https://istio.io/latest/docs/ops/deployment/architecture/](https://istio.io/latest/docs/ops/deployment/architecture/)


#### ë™ì‘ ë°©ì‹


ë™ì‘ ë°©ì‹ì€ í”„ë¡ì‹œë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤. **íŒŒë“œ ë‹¹ í•˜ë‚˜ì˜ í”„ë¡ì‹œ**ë¥¼ ë‘ëŠ” Sidecarëª¨ë“œì™€ **ë…¸ë“œ ë‹¹ ì „ìš© í”„ë¡ì‹œ**ë¥¼ ë‘ëŠ” Ambientê°€ ìˆë‹¤. 


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/3.png)


ì¶œì²˜: [https://www.solo.io/blog/istio-more-for-less](https://www.solo.io/blog/istio-more-for-less)


### êµ¬ì„±


IstioëŠ” Control Planeê³¼ Data Planeìœ¼ë¡œ êµ¬ì„±ëœë‹¤. 

- **Control Plane:** Istiodë¡œ í”„ë¡ì‹œ ë¼ìš°íŒ… ê·œì¹™ì„ ê´€ë¦¬, ë³´ì•ˆ ë° ì•”í˜¸í™”, Kubernetesì™€ ìƒí˜¸ ì‘ìš©í•œë‹¤.
- **Data Plane:** ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°”ë¡œ ì•ì— ìˆëŠ” í”„ë¡ì‹œ ì§‘í•©ì„ ì˜ë¯¸í•˜ë©°, Sidecar ëª¨ë“œì—ì„œëŠ” ê° íŒŒë“œë§ˆë‹¤ sidecar proxy(envoy)ê°€ ì¡´ì¬í•œë‹¤.

#### Control Plane


IstiodëŠ” Golangìœ¼ë¡œ ì‘ì„±ë˜ì—ˆê³  Pilot, Galley, Citadel 3ê°œì˜ ìš”ì†Œê°€ ì¡´ì¬í•œë‹¤. Pilotì€ **í”„ë¡ì‹œ ë¼ìš°íŒ… ì„¤ì •**ì„ ê´€ë¦¬í•˜ë©°, GalleyëŠ” Endpoint ê°±ì‹  ë“± K8sì™€ ìƒí˜¸ì‘ìš©í•˜ë©°, Citadelì€ ë³´ì•ˆ ë° ì•”í˜¸í™” ê´€ë ¨ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•œë‹¤. 


ì•„ë˜ì˜ ê·¸ë¦¼ì„ í†µí•´ ê° êµ¬ì„±ìš”ì†Œì˜ ì—­í• ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/4.png)


#### Data Plane


Data Planeì€ í”„ë¡ì‹œ ì§‘í•©ì„ ì˜ë¯¸í•œë‹¤. í”„ë¡ì‹œë¡œëŠ” Envoyë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤. Envoyì— ëŒ€í•œ ì„¤ëª…ì€ ì¡°ê¸ˆ ë’¤ì—ì„œ ì‚´í´ë³¼ ì˜ˆì •ì´ë‹¤. ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì¤‘ì•™ì—ì„œ ì„¤ì •í•œ ê·œì¹™ìœ¼ë¡œ **ê° ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¶™ì–´ìˆëŠ” í”„ë¡ì‹œê°€ ë„¤íŠ¸ì›Œí¬ë¥¼ ì œì–´**í•œë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/2.png)


EnvoyëŠ” ë©€í‹° ìŠ¤ë ˆë”©ì„ ì‚¬ìš©í•˜ë©°, ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ Listenerë¥¼ í†µí•´ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ë©° ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸(Pod)ë¡œ ë¼ìš°íŒ…í•œë‹¤. 


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/6.png)


ì¶œì²˜: [https://www.envoyproxy.io/docs/envoy/latest/intro/life_of_a_request](https://www.envoyproxy.io/docs/envoy/latest/intro/life_of_a_request)


ì´ì œ í”„ë¡ì‹œë¡œ ì‚¬ìš©í•˜ëŠ” Envoyì— ëŒ€í•´ ì‚´í´ë³´ì.


### í”„ë¡ì‹œ


IstioëŠ” í”„ë¡ì‹œë¡œ Envoyë¥¼ ì‚¬ìš©í•œë‹¤. EnvoyëŠ” L7 í”„ë¡ì‹œë¡œ ì•„ë˜ì™€ ê°™ì€ ëª©ì ì„±ì„ ê°€ì§„ë‹¤. 


â€œ_The network should be transparent to applications. When network and application problems do occur it should be easy to determine the source of the problem.â€_


**Envoyì— ëŒ€í•´ì„œëŠ” 2ì£¼ì°¨ì— ìƒì„¸í•˜ê²Œ ë°°ìš¸ ì˜ˆì •ì´ë¼, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì‚´í´ë³¸ë‹¤.**


#### ë°©ì‹


EnvoyëŠ” ë©€í‹° ìŠ¤ë ˆë”©ì„ ì‚¬ìš©í•˜ë©°, ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ Listenerë¥¼ í†µí•´ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ë©° ì´í›„ HTTP Router Filerë¥¼ í†µí•´ ëŒ€ìƒ í´ëŸ¬ìŠ¤í„°ë¡œ ì˜®ê¸°ê³  í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸(Pod)ë¡œ ë¼ìš°íŒ…í•œë‹¤. 
â€œ**Listeners > Routes > Clusters > Endpointsâ€**


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/7.png)


#### ì„¤ì • ì œì–´


EnvoyëŠ” ì„¤ì • ë°©ì‹ìœ¼ë¡œ xDSë¥¼ ì‚¬ìš©í•œë‹¤. ë•ë¶„ì— ì™¸ë¶€ì—ì„œ Envoyì˜ ì„¤ì •ì„ ë™ì ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. ì´ ë•ë¶„ì— ì¤‘ì•™(istiod)ì—ì„œ ëª¨ë“  í”„ë¡ì‹œì˜ ì„¤ì •ì„ ë‹¤ìš´íƒ€ì„ì—†ì´ ì œì–´í•  ìˆ˜ ìˆë‹¤. ê´€ë ¨í•˜ì—¬ ìì„¸í•œ ë‚´ìš©ì€ [Envoy Docs](https://www.envoyproxy.io/docs/envoy/latest/api-docs/xds_protocol)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/8.png)


ì¶œì²˜: (ìŠ¤í„°ë””ì›) [https://kimdoky.github.io/devops/2025/04/10/study-istio-week1/](https://kimdoky.github.io/devops/2025/04/10/study-istio-week1/)


**xDS** Sync APIëŠ” ì•„ë˜ì™€ ê°™ì€ ì—¬ëŸ¬ ë°©ì‹ì´ ìˆë‹¤. 

- LDS - Listener Discovery Service
- RDS - Route Discovery Service
- CDS - Cluseter Discovery Service
- EDS - Endpoint Discovery Service

## ì‹¤ìŠµ


ì‹¤ìŠµ í™˜ê²½:  **docker** (**kind** - k8s 1.23.17 â€˜23.2.28 - [Link](https://kubernetes.io/releases/patch-releases/)) , **istio** 1.17.8(â€™23.10.11) - [Link](https://istio.io/latest/news/releases/1.17.x/)


í™˜ê²½ì€ ìµœì‹ ë²„ì „ì´ ì•„ë‹Œë°, ê·¸ ì´ìœ ëŠ” Istio in Actionì˜ ë²ˆì—­íŒì´ ê³¼ê±° ê°œì •íŒì˜ ë‚´ìš©ì„ ë‹´ê³  ìˆê³  ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•¨ì´ë‹¤.


### kind


ì‹¤ìŠµ í™˜ê²½ìœ¼ë¡œëŠ” kind(kubernetes in docker)ë¥¼ ì‚¬ìš©í•œë‹¤. kindë¥¼ í†µí•´ ë¡œì»¬ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ì™€ ê°€ì¥ ìœ ì‚¬í•œ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤. 


#### kind ì„¤ì¹˜(macOS)


ìœˆë„ìš° í™˜ê²½ì´ë¼ë©´, [ë¬¸ì„œ](https://kind.sigs.k8s.io/docs/user/quick-start/#installation)ë¥¼ ì°¸ê³ 


```bash
brew install kind
```


#### í´ëŸ¬ìŠ¤í„° êµ¬ì„±


ë‹¨ì¼ ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•œë‹¤. 


```bash
kind create cluster --name myk8s --image kindest/node:v1.32.2 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000 # Sample Application
    hostPort: 30000
  - containerPort: 30001 # Prometheus
    hostPort: 30001
  - containerPort: 30002 # Grafana
    hostPort: 30002
  - containerPort: 30003 # Kiali
    hostPort: 30003
  - containerPort: 30004 # Tracing
    hostPort: 30004
  - containerPort: 30005 # kube-ops-view
    hostPort: 30005
networking:
  podSubnet: 10.10.0.0/16
  serviceSubnet: 10.200.1.0/24
EOF

```


ë…¸ë“œ ì»¨í…Œì´ë„ˆì— ì‹¤ìŠµì— í•„ìš”í•œ ìœ í‹¸ë¦¬í‹°ë¥¼ ì„¤ì¹˜í•œë‹¤.


```bash
docker exec -it myk8s-control-plane sh -c 'apt update && apt install tree psmisc lsof wget bridge-utils net-tools dnsutils tcpdump ngrep iputils-ping git vim -y'
```


### istio


istioë¥¼ ì„¤ì¹˜í•˜ê¸° ì•ì„œ, ìš°ì„  ë…¸ë“œì— ì ‘ì†í•œë‹¤.


```bash
docker exec -it **myk8s****-control-plane bash**
```


#### istioctl ì„¤ì¹˜


```bash
export ISTIOV=1.17.8
echo 'export ISTIOV=1.17.8' >> /root/.bashrc
curl -s -L https://istio.io/downloadIstio | ISTIO_VERSION=$ISTIOV sh -
cp istio-$ISTIOV/bin/istioctl /usr/local/bin/istioctl
```


ì•„ë˜ì˜ ëª…ë ¹ì–´ë¡œ ì •ìƒ ì„¤ì¹˜ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
istioctl version --remote=false
1.17.8
```


#### istio ë°°í¬


```bash
istioctl install --set profile=default -y
```


#### ë°°í¬ í™•ì¸


PDBê¹Œì§€ ë“¤ì–´ê°€ìˆë‹¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆì—ˆë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/9.png)


#### ì„¤ì • ì§„í–‰


ìš°ë¦¬ê°€ ì‚¬ìš©í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—, istio-injection(sidecar ì£¼ì…) ë ˆì´ë¸”ì„ ë‹¬ì•„ë‘”ë‹¤.


```bash
kubectl get ns istioinaction --show-labels
NAME            STATUS   AGE   LABELS
istioinaction   Active   82s   istio-injection=enabled,kubernetes.io/metadata.name=istioinaction
```


ì•„ë˜ì™€ ê°™ì´ mutating configê°€ ì„¤ì •ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. (mutatingë¥¼ ëª¨ë¥¸ë‹¤ë©´, Admission Controller Docsë¥¼ í™•ì¸í•´ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.)


```bash
kubectl get mutatingwebhookconfiguration
NAME                         WEBHOOKS   AGE
istio-revision-tag-default   4          6m9s
istio-sidecar-injector       4          6m29s
```


### ì„œë¹„ìŠ¤ ë°°í¬


```bash
kubectl apply -f services/catalog/kubernetes/catalog.yaml -n istioinaction
kubectl apply -f services/webapp/kubernetes/webapp.yaml -n istioinaction
```


```bash
NAME                     READY   STATUS    RESTARTS   AGE
catalog-6cf4b97d-mt6q6   2/2     Running   0          4m39s
webapp-7685bcb84-6vcvg   2/2     Running   0          4m35s
```


ì‹¤ì œ yamlì„ í™•ì¸í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ í•˜ë‚˜ì˜ ì»¨í…Œì´ë„ˆë§Œ ì¡´ì¬í•œë‹¤. í•˜ì§€ë§Œ íŒŒë“œë§ˆë‹¤ ì»¨í…Œì´ë„ˆê°€ 1ê°œê°€ ì•„ë‹Œ 2ê°œì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
{
  "containers": [
    {
      "env": [
        {
          "name": "KUBERNETES_NAMESPACE",
          "valueFrom": {
            "fieldRef": {
              "apiVersion": "v1",
              "fieldPath": "metadata.namespace"
            }
          }
        }
      ],
      "image": "istioinaction/catalog:latest",
      "imagePullPolicy": "IfNotPresent",
      "name": "catalog",
      "ports": [
        {
          "containerPort": 3000,
          "name": "http",
          "protocol": "TCP"
        }
      ],
      "resources": {},
      "securityContext": {
        "privileged": false
      },
      "terminationMessagePath": "/dev/termination-log",
      "terminationMessagePolicy": "File"
    }
  ],
  "dnsPolicy": "ClusterFirst",
  "restartPolicy": "Always",
  "schedulerName": "default-scheduler",
  "securityContext": {},
  "serviceAccount": "catalog",
  "serviceAccountName": "catalog",
  "terminationGracePeriodSeconds": 30
}
```


istio proxyë¡œ ì¶”ê°€ëœ ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í•´ë³´ì.


```bash
docker exec -it myk8s-control-plane bash
# ì ‘ì† í›„
crictl ps
```


ì•„ë˜ì˜ ì‚¬ì§„ì²˜ëŸ¼ istio-proxy(envoy)ê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/10.png)


### Ingress gateway ë°°í¬


ì•„ë˜ì™€ ê°™ì´ webappìœ¼ë¡œ ë¼ìš°íŒ…ë˜ëŠ” Ingress gateway ê·œì¹™ì„ ì„¤ì •í•œë‹¤. ê·¸ëŸ¬ë©´ istio-Ingressë¡œ ì¸ì…ëœ íŠ¸ë˜í”½ ì¤‘ HTTP(:80)ìœ¼ë¡œ ë“¤ì–´ì˜¨ íŠ¸ë˜í”½ì€ webappìœ¼ë¡œ í–¥í•˜ê²Œ ëœë‹¤.


```bash
cat <<EOF | kubectl -n istioinaction apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: outfitters-gateway
  namespace: istioinaction
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: webapp-virtualservice
  namespace: istioinaction
spec:
  hosts:
  - "*"
  gateways:
  - outfitters-gateway
  http:
  - route:
    - destination:
        host: webapp
        port:
          number: 80
EOF

```


```bash
docker exec -it myk8s-control-plane istioctl proxy-status
```


ëª…ë ¹ì–´ë¡œ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ë©´ istio.ingressgatewayì˜ RDS(routing ê´€ë ¨) ê·œì¹™ì´ NOT SENT â†’ SYNCEDë¡œ ë°”ë€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/11.png)


ì´ì œ istioì˜ ingress gateway ì„œë¹„ìŠ¤ nodeportë¥¼ 30000ìœ¼ë¡œ ì§€ì •í•œë‹¤. 


```bash
kubectl patch svc -n istio-system istio-ingressgateway -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "targetPort": 8080, "nodePort": 30000}]}}'
```


`localhost:30000`ìœ¼ë¡œ ì ‘ê·¼í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ webapp ì„œë¹„ìŠ¤ì— ì ‘ì†í•  ìˆ˜ ìˆë‹¤. (ë³¸ì¸ì€ ec2ë¡œ ë‘ê³  ì‹¤ìŠµì„ ì§„í–‰í•˜ì˜€ê¸°ì—, ec2 public ipë¡œ ì ‘ê·¼í–ˆë‹¤.)


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/12.png)


### retry ì ìš©í•´ë³´ê¸°


ì´ì œ catelogì—ê²Œ 3ë²ˆê¹Œì§€ ì¬ì‹œë„ë¥¼ í•˜ëŠ” ì˜µì…˜ì„ ë„£ì–´ë³´ì.


```bash
cat <<EOF | kubectl -n istioinaction apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: catalog
spec:
  hosts:
  - catalog
  http:
  - route:
    - destination:
        host: catalog
    retries:
      attempts: 3
      retryOn: 5xx
      perTryTimeout: 2s
EOF
```


catelog ê´€ë ¨í•˜ì—¬ í™•ì¸ì„ ì§„í–‰í•œë‹¤.


```bash
kubectl get vs -n istioinaction
NAME                    GATEWAYS                 HOSTS         AGE
catalog                                          ["catalog"]   110s
webapp-virtualservice   ["outfitters-gateway"]   ["*"]         56m
```


retry ì˜µì…˜ì„ ë„£ê³  ë‚˜ì„œëŠ”, ëŒ€ë¶€ë¶„ ì„±ê³µí•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/13.png)


ë‹¤ë§Œ, retryë¥¼ ì§„í–‰í•¨ì— ë”°ë¼ ì‘ë‹µì†ë„ëŠ” ê¸°ì¡´ë³´ë‹¤ ëŠ¦ì–´ì§€ëŠ” ê²ƒë„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë§¤ì‹œì™€%20istio/14.png)

