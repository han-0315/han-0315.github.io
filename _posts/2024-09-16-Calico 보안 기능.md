---
layout: post
title: Calico ë³´ì•ˆ ê¸°ëŠ¥(wireguard)
date: 2024-09-15 09:03 +0900 
description: Calico ë³´ì•ˆ ê¸°ëŠ¥(Wireguard) ì•Œì•„ë³´ê¸°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#3, Security, wireguard] 
pin: false
math: true
mermaid: true
---
Calico ë³´ì•ˆ ê¸°ëŠ¥(Wireguard) ì•Œì•„ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.



### WireGuardë€


íŒŒë“œë§ˆë‹¤ íŒ¨í‚·ì„ ì•”í˜¸í™”í•˜ë©´ ë¹„íš¨ìœ¨ì ì´ê² ì§€ë§Œ, ìµœê·¼ì˜ ë³´ì•ˆì´ ëŒ€ë‘ë˜ê³  ìˆëŠ” ë§Œí¼ Zero Trust ë“± ë³´ì•ˆìƒìœ¼ë¡œ ì¤‘ìš”í•œ í™˜ê²½ì—ì„œëŠ” í•„ìš”í•  ê²ƒ ê°™ë‹¤. ì´ë•Œ Wireguardë¥¼ ì´ìš©í•  ìˆ˜ ìˆë‹¤.


WireGuardëŠ” ì˜¤í”ˆì†ŒìŠ¤ VPN í”„ë¡œì íŠ¸ì´ë‹¤. â€œ[WireGuard](https://www.wireguard.com/)ëŠ” êµ¬ë‹¥ë‹¤ë¦¬ IPsec ë° OpenVPNì˜ ëŒ€í•­ë§ˆë¡œ ë“±ì¥í•œ open source VPN project ì´ë©° ì‘ë…„,Â [Linux 5.6 ì»¤ë„ì— WireGuard 1.0.0 ê¸°ë³¸ íŒ¨í‚¤ì§€ë¡œ íƒ‘ì¬](https://lore.kernel.org/wireguard/CAHmME9qOpDeraWo5rM31EWQW574KEduRBTL-+0A2ZyqBNDeYkg@mail.gmail.com/T/#u)ë˜ì—ˆë‹¤.â€ ë¼ê³  ì„¤ëª…í•´ì£¼ì…¨ë‹¤. ì½”ë“œë„ ê°„ê²°í•˜ê³ , ì„±ëŠ¥ë„ ì˜ë‚˜ì˜¨ë‹¤ê³  í•œë‹¤. *ì•„ë˜ ê·¸ë¦¼ ì°¸ê³ 


![image.png](/assets/img/post/Calico%20ë³´ì•ˆ%20ê¸°ëŠ¥/1.png)


ì‚¬ì§„ì¶œì²˜: [https://www.wireguard.com/papers/wireguard.pdf](https://www.wireguard.com/papers/wireguard.pdf)


### íŒŒë“œ íŒ¨í‚· ì•”í˜¸í™”


Ciliumì—ì„œë„ WireGuardë¥¼ ì§€ì›í•œë‹¤ê³  í•œë‹¤. ê°„ë‹¨í•œ ì„¸íŒ…ì„ í†µí•´ ë³´ì•ˆì„ ë†’ì¼ ìˆ˜ ìˆë‹¤. í†µì‹ ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì•”í˜¸í™” í‚¤ëŠ” ì²˜ìŒì— ìƒì„±í•´ë‘”ë‹¤ê³  í•œë‹¤.


### ì‹¤ìŠµ ì§„í–‰


WireGuardëŠ” CloudFormationì„ í†µí•´ ë°°í¬í•  ë•Œ, ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ìˆë‹¤. ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì„¤ì •ì„ í™•ì¸í•´ë³¸ë‹¤.

- ë²„ì „ í™•ì¸

```bash
wg version
wireguard-tools v1.0.20210914 - https://git.zx2c4.com/wireguard-tools/
```

- calico wireguard ì„¤ì • ì§„í–‰

```bash
calicoctl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":true}}'
Successfully patched 1 'FelixConfiguration' resource
```

- ì„¤ì • í™•ì¸

```bash
calicoctl get felixconfiguration default -o yaml | grep wireguardEnabled
  wireguardEnabled: true
```


#### ì•”í˜¸í™” í‚¤ í™•ì¸


ëª…ë ¹ì–´ë¥¼ í†µí•´ wireguard í‚¤ë¥¼ í™•ì¸í•œë‹¤.

- í¼ë¸”ë¦­ í‚¤ë¥¼ í™•ì¸

```bash
calicoctl get node -o yaml | grep wireguardPublicKey
    wireguardPublicKey: F1CNZ1aM8BmjssQrwymkj1XYONOD6OEEOBh1NLYy+Xw=
    wireguardPublicKey: rzxlh1ayqHU14f7YK3UOGvW1tS/okOXBv0Yhw9Reyzg=
    wireguardPublicKey: K6EBHlSJwrj0lDtGCE7jDtSRwaiIYOaazhWSK5yodEE=
    wireguardPublicKey: /OPVSG6BUxiQ7Q9CnV5Cj0WEav7zpAYo7dwEQON8k2Q=
```

- ê° ë…¸ë“œì˜ private key í™•ì¸

```bash
wg showconf wireguard.cali
[Interface]
ListenPort = 51820
FwMark = 0x100000
PrivateKey = GCnqtCks8LkZJNas/RB/8Xtgk7e2KLHehcSmkTKf8kQ=

[Peer]
PublicKey = /OPVSG6BUxiQ7Q9CnV5Cj0WEav7zpAYo7dwEQON8k2Q=
AllowedIPs = 172.16.184.0/24, 172.16.184.2/32, 172.16.184.3/32
Endpoint = 192.168.10.102:51820

[Peer]
PublicKey = K6EBHlSJwrj0lDtGCE7jDtSRwaiIYOaazhWSK5yodEE=
AllowedIPs = 172.16.158.0/24, 172.16.158.6/32, 172.16.158.7/32
Endpoint = 192.168.10.101:51820

[Peer]
PublicKey = rzxlh1ayqHU14f7YK3UOGvW1tS/okOXBv0Yhw9Reyzg=
AllowedIPs = 172.16.34.0/24, 172.16.34.1/32, 172.16.34.2/32
Endpoint = 192.168.20.100:51820
```


#### í¬íŠ¸ í™•ì¸


wireguardëŠ” **51820 í¬íŠ¸**ë¥¼ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.


ê´€ë ¨í•´ì„œ ë…¸ë“œì˜ í¬íŠ¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. íŒŒë“œ 1 ê¸°ì¤€(worker node1ì— ìœ„ì¹˜)


```bash
ss -unlp
State    Recv-Q   Send-Q           Local Address:Port      Peer Address:Port  Process
UNCONN   0        0                127.0.0.53%lo:53             0.0.0.0:*      users:(("systemd-resolve",pid=344,fd=13))
UNCONN   0        0          192.168.10.101%ens5:68             0.0.0.0:*      users:(("systemd-network",pid=341,fd=15))
UNCONN   0        0                    127.0.0.1:323            0.0.0.0:*      users:(("chronyd",pid=485,fd=5))
UNCONN   0        0                      0.0.0.0:51820          0.0.0.0:*
UNCONN   0        0                        [::1]:323               [::]:*      users:(("chronyd",pid=485,fd=6))
UNCONN   0        0                         [::]:51820             [::]:*
```


#### í†µì‹  ì§„í–‰


íŒŒë“œ ping í†µì‹ ì„ ì§„í–‰í•œë‹¤.


```bash
kubectl exec pod1 -it -- zsh
ping {pod ip}
```


í†µì‹ ì„ ë¤í”„ëœ¬ë‹¤.


```bash
tcpdump -i {ë…¸ë“œ ì´ë”ë„·} udp port 51820 -w /tmp/calico-wireguard.pcap
```


#### Wireshark


ì™€ì´ì–´ìƒ¤í¬ë¡œ ë¤í”„ë¥¼ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ íŒ¨í‚·ì´ ì•”í˜¸í™”ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20ë³´ì•ˆ%20ê¸°ëŠ¥/2.png)


#### ë³µí˜¸í™” ì‹œë„


í•œë²ˆ ìœ„ì—ì„œ í™•ì¸í•œ private keyë¥¼ í†µí•´ íŒ¨í‚·ì„ ë³µí˜¸í™”ì‹œë„ë¥¼ ì§„í–‰í–ˆë‹¤. ì§„í–‰ í”„ë¡œì„¸ìŠ¤ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

1. tcpdumpë¥¼ ì§„í–‰í•  ë…¸ë“œì˜ private key í™•ì¸
2. íŒ¨í‚· ë¤í”„(tcpdump -i {ë…¸ë“œ ì´ë”ë„·} udp 51820 -w {íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê²½ë¡œ}
3. wireshark ì„¤ì • ì§„í–‰
	1. Protocols > WireGuard > Private Key ì¶”ê°€

ê´€ë ¨í•´ì„œ [ë¸”ë¡œê·¸](https://blog.salrashid.dev/articles/2022/wireguard_wireshark/)ì— ìœ ì‚¬í•œ ì‹œë„ê°€ ë‚˜ì™€ìˆìœ¼ë‚˜, ì—¬ê¸°ì„  ë³„ë„ì˜ Log File ì¶”ì¶œê¸°ë¥¼ í†µí•´ì„œ ì§„í–‰í–ˆë‹¤. í•´ë‹¹ ì¶”ì¶œê¸°ì™€ ìœ ì‚¬í•˜ê²Œ Public key, ì„ì‹œí‚¤ë¥¼ ë„£ì—ˆëŠ”ë° ì—¬ì „íˆ ë™ì‘í•˜ì§€ ì•Šì•˜ë‹¤. ì¶”í›„ í•œë²ˆ ë” ì°¾ì•„ë´ì•¼ê² ë‹¤. tcpdumpë¥¼ ì§„í–‰í•˜ë©´ ì²˜ìŒì— í•¸ë“œì‰ì´í¬í•˜ëŠ” íŒ¨í‚·ë„ ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20ë³´ì•ˆ%20ê¸°ëŠ¥/3.png)

