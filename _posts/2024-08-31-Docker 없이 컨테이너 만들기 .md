---
layout: post
title: Docker ì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° #ê²©ë¦¬
date: 2024-08-31 09:00 +0900 
description: KANS ìŠ¤í„°ë”” 1ì£¼ì°¨ Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° #ê²©ë¦¬
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#1] 
pin: false
math: true
mermaid: true
---
KANS ìŠ¤í„°ë”” 1ì£¼ì°¨ Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° #ê²©ë¦¬
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


ì•„ë˜ì˜ ë‚´ìš©ì€ [Kakao](https://netpple.github.io/docs/make-container-without-docker/ifkakao2022-handson) ë°œí‘œìë£Œì™€ ì˜ìƒì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


[video](https://www.youtube.com/watch?v=mSD88FuST80)


ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ ì— ëŒ€í•´ ë°°ìš°ë©´ì„œ, Container ê¸°ìˆ ì„ ì´í•´í•©ë‹ˆë‹¤.


ì£¼ìš” ê²©ë¦¬ ê¸°ìˆ ë¡œëŠ” ìµœìƒìœ„ ë””ë ‰í„°ë¦¬ ê²©ë¦¬, ë„¤ì„ìŠ¤í˜ì´ìŠ¤, ìì› í• ë‹¹ëŸ‰ ì œí•œì´ ìˆë‹¤. ì•„ë˜ì—ì„œ í•˜ë‚˜ì”© ì‚´í´ë³¸ë‹¤.


ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.


---

1. ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ê²©ë¦¬
	1. chroot ê²©ë¦¬ ê¸°ìˆ 
		1. íƒˆì˜¥ ì§„í–‰
	2. pivot_root + mount namespace ê²©ë¦¬
		1. íƒˆì˜¥ ì‹¤íŒ¨ í™•ì¸
2. ë„¤ì„ìŠ¤í˜ì´ìŠ¤
	1. Process
	2. User
	3. etc
3. ìì› ê²©ë¦¬
	1. cgroup
	2. docker ì˜µì…˜

---


## ê²©ë¦¬ ê¸°ìˆ  History


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/1.png)


ì¶œì²˜: [https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=200](https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=200)


## ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ê²©ë¦¬


ë””ë ‰í„°ë¦¬ë¥¼ ê²©ë¦¬í•˜ëŠ” ë°©ë²•ì€ chrootê°€ ìˆë‹¤. ìœ„ì˜ historyë¥¼ í™•ì¸í•´ë³´ë©´ 1979ë…„ì— ë‚˜ì˜¨ ì˜¤ë˜ëœ ê¸°ëŠ¥ì´ë‹¤. í•˜ì§€ë§Œ, íƒˆì˜¥ ì´ìŠˆê°€ ìˆì–´ í˜„ì¬ëŠ” pivot_rootì™€ Mount namespace ê¸°ìˆ ì„ ì´ìš©í•´ ì‘ì—… í™˜ê²½ì„ ê²©ë¦¬í•œë‹¤ê³  í•œë‹¤.


### chroot


ì•„ë˜ì—ì„œ chrootë¥¼ ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ë©° ìì„¸íˆ ì•Œì•„ë³¸ë‹¤.


#### ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ê²©ë¦¬ í™•ì¸

- ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±(bin/sh, bin/ls ë“± í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ì „ì— ê°€ì ¸ì˜¨ë‹¤.)

```bash
cd /tmp
# í•„ìš”í•œ ì‹¤í–‰íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
mkdir -p myroot/bin
cp /usr/bin/sh myroot/bin/
cp /usr/bin/ls myroot/bin/
# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
mkdir -p myroot/{lib64,lib/x86_64-linux-gnu}
cp /lib/x86_64-linux-gnu/{libselinux.so.1,libc.so.6,libpcre2-8.so.0} myroot/lib/x86_64-linux-gnu/
cp /lib64/ld-linux-x86-64.so.2 myroot/lib64

```

- ì‹¤ìŠµ í™˜ê²½ í™•ì¸(`ls`, `sh` ì‹¤í–‰íŒŒì¼ì´ ë“¤ì–´ì™€ìˆë‹¤.)

```bash
root@MyServer:/tmp# tree myroot/
myroot/
â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ ls
â”‚Â Â  â””â”€â”€ sh
â”œâ”€â”€ lib
â”‚Â Â  â””â”€â”€ x86_64-linux-gnu
â”‚Â Â      â”œâ”€â”€ libc.so.6
â”‚Â Â      â”œâ”€â”€ libpcre2-8.so.0
â”‚Â Â      â””â”€â”€ libselinux.so.1
â””â”€â”€ lib64
    â””â”€â”€ ld-linux-x86-64.so.2

4 directories, 6 files
```

- chroot ì§„í–‰. ë£¨íŠ¸ë””ë ‰í„°ë¦¬ ê²©ë¦¬ í™•ì¸

```bash
root@MyServer:/tmp# chroot myroot /bin/sh
# ls
bin  lib  lib64
# cd ../../../
# ls
bin  lib  lib64
```


ìœ„ì˜ ì‹¤ìŠµì„ í†µí•´ í˜¸ìŠ¤íŠ¸ì˜ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¡œ ë¹ ì ¸ë‚˜ê°€ì§€ ëª»í•˜ê³  /tmp/myrootë¡œ ê²©ë¦¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


ì´ì œ **íƒˆì˜¥ ì‹¤ìŠµ**ì— í•„ìš”í•œ ì •ë³´ë¥¼ ë„£ì–´ë‘”ë‹¤.


```bash
root@MyServer:/tmp# tree myroot
myroot
â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ ls
â”‚Â Â  â”œâ”€â”€ mkdir
â”‚Â Â  â”œâ”€â”€ mount
â”‚Â Â  â”œâ”€â”€ ps
â”‚Â Â  â””â”€â”€ sh
â”œâ”€â”€ lib
â”‚Â Â  â””â”€â”€ x86_64-linux-gnu
â”‚Â Â      â”œâ”€â”€ libblkid.so.1
â”‚Â Â      â”œâ”€â”€ libc.so.6
â”‚Â Â      â”œâ”€â”€ libcap.so.2
â”‚Â Â      â”œâ”€â”€ libgcrypt.so.20
â”‚Â Â      â”œâ”€â”€ libgpg-error.so.0
â”‚Â Â      â”œâ”€â”€ liblzma.so.5
â”‚Â Â      â”œâ”€â”€ libmount.so.1
â”‚Â Â      â”œâ”€â”€ libpcre2-8.so.0
â”‚Â Â      â”œâ”€â”€ libprocps.so.8
â”‚Â Â      â”œâ”€â”€ libselinux.so.1
â”‚Â Â      â”œâ”€â”€ libsystemd.so.0
â”‚Â Â      â””â”€â”€ libzstd.so.1
â”œâ”€â”€ lib64
â”‚Â Â  â””â”€â”€ ld-linux-x86-64.so.2
â””â”€â”€ usr
    â””â”€â”€ lib
        â””â”€â”€ x86_64-linux-gnu
            â””â”€â”€ liblz4.so.1

7 directories, 19 files
```


```bash
root@MyServer:/tmp# chroot myroot /bin/sh
# ps
Error, do this: mount -t proc proc /proc

```

- ë§ˆìš´íŠ¸ë¥¼ ì§„í–‰í•œë‹¤.

```bash
# mount -t proc proc /proc
mount: /proc: mount point does not exist.
# mkdir /proc
# mount -t proc proc /proc
# ps
    PID TTY          TIME CMD
   6263 ?        00:00:00 sudo
   6264 ?        00:00:00 su
   6265 ?        00:00:00 bash
   6360 ?        00:00:00 sh
   6365 ?        00:00:00 ps
# ps auf
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
1000        6054  0.0  0.3   9924  5888 ?        Ss   16:11   0:00 bash --rcfile /dev/fd/63
0           6262  0.0  0.2  11904  5632 ?        S+   16:12   0:00  \_ sudo su -
0           6263  0.0  0.1  11904  2428 ?        Ss   16:12   0:00      \_ sudo su -
0           6264  0.0  0.2  10636  4736 ?        S    16:12   0:00          \_ su -
0           6265  0.0  0.2   9228  5376 ?        S    16:12   0:00              \_ -bash
0           6360  0.0  0.0   2892  1664 ?        S    16:17   0:00                  \_ /bin/sh
0           6366  0.0  0.1   7064  3072 ?        R+   16:17   0:00                      \_ ps auf
1000        5859  0.0  0.3   9924  5888 ?        Ss+  16:11   0:00 bash --rcfile /dev/fd/63
0            571  0.0  0.1   6176  2048 ?        Ss+  15:34   0:00 /sbin/agetty -o -p -- \u --noclear tty1 linux
0            557  0.0  0.1   6220  2304 ?        Ss+  15:34   0:00 /sbin/agetty -o -p -- \u --keep-baud 115200,576
```


#### íƒˆì˜¥ í™•ì¸


ì—¬ê¸°ì—ì„œëŠ” íƒˆì˜¥ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í™•ì¸í•œë‹¤.

- íƒˆì˜¥ ì½”ë“œ

ì½”ë“œì— ëŒ€í•´ ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•˜ë©´, â€œ.outâ€ ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ê³ , í•´ë‹¹ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ chrootë¥¼ ì‹¤í–‰í•œë‹¤.


ê²½ë¡œë¥¼ ìµœìƒìœ„(`../../../../../`)ë¡œ ë°”ê¾¸ê³ , í•´ë‹¹ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ chrootë¥¼ ì‹¤í–‰í•œë‹¤.


```c++
#include <sys/stat.h>
#include <unistd.h>

int main(void)
{
  mkdir(".out", 0755);
  chroot(".out");
  chdir("../../../../../");
  chroot(".");

  return execl("/bin/sh", "-i", NULL);
}
```

- ì»´íŒŒì¼

```bash
gcc -o myroot/escape_chroot escape_chroot.c
```

- íƒˆì˜¥ì½”ë“œê°€ ìˆëŠ” ìƒíƒœì—ì„œ chrootë¥¼ ì‹¤í–‰í•œë‹¤.

```bash
tree -L 1 myroot
myroot
â”œâ”€â”€ bin
â”œâ”€â”€ escape_chroot
â”œâ”€â”€ lib
â”œâ”€â”€ lib64
â”œâ”€â”€ proc
â””â”€â”€ usr
```

- ì•„ë˜ì™€ ê°™ì´ íƒˆì˜¥ì´ ê°€ëŠ¥í•˜ë‹¤. (íƒˆì˜¥ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¨ ë’¤ lsë¥¼ ë³´ë©´ í˜¸ìŠ¤íŠ¸ì˜ ìµœìƒìœ„ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.)

```bash
sudo chroot myroot /bin/sh
# ls
bin  escape_chroot  lib  lib64	proc  usr
# cd ../../../
# ls
bin  escape_chroot  lib  lib64	proc  usr
# ./escape_chroot
# ls
bin   dev  home  lib32	libx32	    media  opt	 root  sbin  srv  tmp  var
boot  etc  lib	 lib64	lost+found  mnt    proc  run   snap  sys  usr
```


ì´ë ‡ë“¯ íƒˆì˜¥ ì´ìŠˆë¡œ ì¸í•´ ì»¨í…Œì´ë„ˆì—ì„œëŠ” chrootë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì•„ë˜ì˜ pivot_root + mount namespace ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤.


### **Pivot_root + mount namespace(host ì˜í–¥ ê²©ë¦¬)**


Pivot_root ëª…ë ¹ì–´ë¥¼ í†µí•´, ë£¨íŠ¸ íŒŒì¼ì‹œìŠ¤í…œê³¼ ë§ˆìš´íŠ¸ íŒŒì¼ì‹œìŠ¤í…œì˜ ë…¼ë¦¬ì ì¸ ìœ„ì¹˜ë¥¼ ë°”ê¿€ ìˆ˜ ìˆë‹¤. (ë§ˆìš´íŠ¸ íŒŒì¼ì‹œìŠ¤í…œ â†” ë£¨íŠ¸ íŒŒì¼ì‹œìŠ¤í…œ)


pivot rootëŠ” ì •ë§ rootì™€ mount íŒŒì¼ì‹œìŠ¤í…œì˜ ìœ„ì¹˜ë¥¼ ë°”ê¾¼ë‹¤. chrootëŠ” ê°€ìƒìœ¼ë¡œë§Œ ì‘ë™í•œ ê²ƒê³¼ ë¹„êµëœë‹¤. ê·¸ë ‡ê¸°ì— ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë©´ í˜¸ìŠ¤íŠ¸ì—ë„ ì˜í–¥ì´ ê°„ë‹¤.


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/2.png)


ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í†µí•´ ë§ˆìš´íŠ¸ í™˜ê²½ì„ ê²©ë¦¬í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì— ì˜í–¥ë„ë¥¼ ì—†ì•¨ ìˆ˜ ìˆë‹¤.

1. ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì§„í–‰í•˜ì—¬, ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì˜ ë§ˆìš´íŠ¸ ë‚´ìš©ì„ ë³µì‚¬í•´ì˜¨ë‹¤.
2. ìì‹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì—ì„œ ì»¨í…Œì´ë„ˆ íŒŒì¼ì‹œìŠ¤í…œì„ ë§ˆìš´íŠ¸í•œë‹¤.
3. ìì‹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì—ì„œ pivot_rootë¥¼ ì§„í–‰í•˜ë©´, ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ê°€ ë³€ê²½ëœë‹¤. (pivot rootëŠ” ê°€ìƒìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²Œ ì•„ë‹ˆê¸°ì— íƒˆì˜¥ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.)

`unshare` ëª…ë ¹ì–´ë¥¼ í†µí•´ ê²©ë¦¬ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤.


unshare --mount /bin/sh


> ğŸ’¡ **pivot_root**  
> ex) pivot_root [new-root] [old-root]   
>   
> new-rootì™€ old-rootê°€ pivotëœë‹¤.


	ex) pivot_root [new-root] [old-root] 


	new-rootì™€ old-rootê°€ pivotëœë‹¤.

- ë³„ë„ì˜ mountë¥¼ í•˜ë‚˜ ìƒì„±í•œë‹¤.
- new_root/put_oldë¥¼ ìƒì„±í•œ ë’¤, í”¼ë´‡ì„ ì§„í–‰í•œë‹¤.

```bash
$ pivot_root . put_old
```


íŒŒì¼ì‹œìŠ¤í…œì´ í”¼ë´‡ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
# cd /
# ls
bin  escape_chroot  lib  lib64	proc  put_old
# ls put_old
bin   dev  home  lib32	libx32	    media  new_root  proc  run	 snap  sys  usr
boot  etc  lib	 lib64	lost+found  mnt    opt	     root  sbin  srv   tmp  var
```

- íƒˆì˜¥ì„ ì§„í–‰í•´ë³¸ë‹¤. (ê°€ìƒì´ ì•„ë‹Œ ì‹¤ì œ pivotì´ ëœ ê²ƒì´ê¸°ì—, íƒˆì˜¥ì— ì‹¤íŒ¨í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.)

```bash
# ./escape_chroot
# cd ../../../
# ls /
bin  escape_chroot  lib  lib64	proc  put_old
# exit
```


## ë„¤ì„ìŠ¤í˜ì´ìŠ¤


í”„ë¡œì„¸ìŠ¤ë³„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´ í™•ì¸


```bash
# /proc ê²½ë¡œë¥¼ í†µí•´ í™•ì¸
ls -al /proc/{pid}/ns
# ëª…ë ¹ì–´ë¥¼ í†µí•´ í™•ì¸ (ì¶œë ¥ì´ ê¹”ë”)
lsns -p {pid}
```


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/3.png)


### PID


ì»¨í…Œì´ë„ˆ ì‹¤í–‰í•  ë•Œ ëª…ë ¹ì–´ ëë‚˜ê³  ì£½ëŠ”ë° ê·¸ê²ƒì€ í”„ë¡œì„¸ìŠ¤ê°€ ê²©ë¦¬ë˜ì–´ì„œ Init í”„ë¡œì„¸ìŠ¤ ìì²´ê°€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ì‹œ ì§„í–‰ë˜ëŠ” ëª…ë ¹ì–´ë§Œ ìˆ˜í–‰í•˜ê³  ì£½ì–´, ì»¨í…Œì´ë„ˆì˜ ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ì£½ê¸° ë•Œë¬¸ì´ë‹¤.

- ìì‹ PID ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ IDì™€ ìì‹ ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ID ê°’ì„ ê°€ì§„ë‹¤.

![Untitled.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/4.png)

- unshare í•  ë•Œ fork í•˜ì—¬, ìì‹ PID ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ pid 1ë¡œ ì‹¤í–‰

pid 1 (init) ì´ ì¢…ë£Œë˜ë©´ pid namespace ë„ ì¢…ë£Œëœë‹¤. Container ì‹¤í–‰ ì‹œ ë°”ë¡œ ì¢…ë£Œë˜ëŠ” ëª…ë ¹ì–´ë§Œ ì‹¤í–‰í•˜ë©´ ì»¨í…Œì´ë„ˆê°€ ëë‚˜ëŠ” ì´ìœ ë„ ë™ì¼í•˜ë‹¤. (init processê°€ echoì™€ ê°™ì€ ëª…ë ¹ì–´ë¼ë©´, ì‹¤í–‰ í›„ ì¢…ë£Œë˜ë¯€ë¡œ Init í”„ë¡œì„¸ìŠ¤ê°€ ì£½ì–´ ì»¨í…Œì´ë„ˆ ìì²´ë„ ëë‚œë‹¤.)


```bash
sudo unshare -fp --mount-proc /bin/sh
# echo $$
1
# ps -ef
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 12:09 pts/2    00:00:00 /bin/sh
root           2       1  0 12:10 pts/2    00:00:00 ps -ef
# ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0   2892  1664 pts/2    S    12:09   0:00 /bin/sh
root           3  0.0  0.1  10464  3328 pts/2    R+   12:10   0:00 ps aux
# lsns -t pid -p 1
        NS TYPE NPROCS PID USER COMMAND
4026532207 pid       2   1 root /bin/sh
# sleep 10000
```


**[í„°ë¯¸ë„ 2ëŠ” í˜¸ìŠ¤íŠ¸ë¡œ, ì‹¤ì œ í„°ë¯¸ë„1ì—ì„œ ê²©ë¦¬ëœ í”„ë¡œì„¸ìŠ¤ë¥¼ ì£½ì—¬ë³¸ë‹¤.]**


```bash
echo $$
12566
```

- í”„ë¡œì„¸ìŠ¤ í™•ì¸

```bash
ps aux | grep '/bin/sh'
root       14092  0.0  0.2  11904  5632 pts/0    S+   12:09   0:00 sudo unshare -fp --mount-proc /bin/sh
root       14093  0.0  0.1  11904  2300 pts/2    Ss   12:09   0:00 sudo unshare -fp --mount-proc /bin/sh
root       14094  0.0  0.0   6192  1792 pts/2    S    12:09   0:00 unshare -fp --mount-proc /bin/sh
root       14095  0.0  0.0   2892  1664 pts/2    S+   12:09   0:00 /bin/sh
ubuntu     14314  0.0  0.1   7008  2432 pts/1    S+   12:10   0:00 grep --color=auto /bin/sh
```

- ê²©ë¦¬ëœ í”„ë¡œì„¸ìŠ¤ í™•ì¸(ì•„ë˜ì˜ ì¶œë ¥ ì¤‘ NSë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ë‹¤ë¥¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.)

```bash
sudo lsns -t pid -p 14095
        NS TYPE NPROCS   PID USER COMMAND
4026532207 pid       1 14095 root /bin/sh
```

- sleep í”„ë¡œì„¸ìŠ¤ë¥¼ ì£½ì—¬ë³¸ë‹¤. (ê²©ë¦¬ëœ í”„ë¡œì„¸ìŠ¤ í™˜ê²½ ì†ì— ìˆëŠ”)

```bash
sudo kill -SIGKILL $(pgrep sleep)
```


ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´, í„°ë¯¸ë„1ì—ì„œ â€œkilledâ€ë¡œ í‘œì‹œë˜ë©° ê²©ë¦¬ í™˜ê²½ì´ exitë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë”°.


### mount


pivot_rootì—ì„œ ì„¤ëª…í•œ ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‹¤ìŠµí•œë‹¤.

- í„°ë¯¸ë„1

```bash
sudo unshare -m
# ê²©ë¦¬ëœ í™˜ê²½ì—ì„œ ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œë‹¤.
lsns -p $$

```

- í„°ë¯¸ë„2

```bash
sudo lsns -p 1 | grep mnt
```


ì•„ë˜ì˜ ì‚¬ì§„ì„ í™•ì¸í•´ë³´ë©´ mntì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ê°’ì´ ë‹¤ë¥¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/5.png)


### **UTS ë„¤ì„ìŠ¤í˜ì´ìŠ¤**


**U**nix **T**ime **S**haring (ì—¬ëŸ¬ ì‚¬ìš©ì ì‘ì—… í™˜ê²½ ì œê³µí•˜ê³ ì ì„œë²„ ì‹œë¶„í•  ë‚˜ëˆ ì“°ê¸°)


í˜¸ìŠ¤íŠ¸ëª…, ë„ë©”ì¸ëª…ì„ ê²©ë¦¬í•  ìˆ˜ ìˆë‹¤.

- í„°ë¯¸ë„1: unshare -u ì˜µì…˜ì„ í†µí•´ ê²©ë¦¬í•œë‹¤.

```bash
sudo unshare -u
root@MyServer:/tmp# lsns -p $$
        NS TYPE   NPROCS   PID USER COMMAND
4026531834 time      106     1 root /sbin/init
4026531835 cgroup    106     1 root /sbin/init
4026531836 pid       106     1 root /sbin/init
4026531837 user      106     1 root /sbin/init
4026531839 ipc       106     1 root /sbin/init
4026531840 net       106     1 root /sbin/init
4026531841 mnt        98     1 root /sbin/init
4026532206 uts         2 10048 root -bash
root@MyServer:/tmp# hostname
MyServer
root@MyServer:/tmp# hostname KANS
root@MyServer:/tmp# hostname
KANS
root@MyServer:/tmp#
```

- í„°ë¯¸ë„2: í˜¸ìŠ¤íŠ¸ì—ì„œ ë³€ê²½ëœ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.(í˜¸ìŠ¤íŠ¸ëª…ì˜ ë³€í™”ê°€ ì—†ìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.)

```bash
hostname
MyServer

sudo lsns -p 1 | grep uts
4026531838 uts       104   1 root /sbin/init
```


### USER


**USER ë„¤ì„ìŠ¤í˜ì´ìŠ¤** : 2012ë…„, UID/GID ë„˜ë²„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬í•œë‹¤. User ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ë¹„êµì  ìµœê·¼ì— ë‚˜ì˜¨ ê¸°ìˆ ì´ë‹¤. ì´ë¥¼ í†µí•´ **ì»¨í…Œì´ë„ˆì˜ root ê¶Œí•œ ë¬¸ì œë¥¼ í•´ê²°**í•  ìˆ˜ ìˆë‹¤


ìš°ì„  ì»¨í…Œì´ë„ˆì˜ root ê¶Œí•œì„ ì•„ë˜ì˜ ì‹¤ìŠµì„ í†µí•´ í™•ì¸í•´ë³´ì.

- ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•œë‹¤.

```bash
docker run -it ubuntu /bin/sh
```


**[docker ë‚´ë¶€ í™˜ê²½]**


```bash
lsns -p $$ -t user
        NS TYPE  NPROCS PID USER COMMAND
4026531837 user       2   1 root /bin/sh
```


**[Host í™˜ê²½]**


```bash
ps -ef |grep "/bin/sh"
ubuntu     16140   15353  0 12:17 pts/0    00:00:00 docker run -it ubuntu /bin/sh
root       16286   16242  0 12:18 pts/0    00:00:00 /bin/sh
ubuntu     16584   12566  0 12:21 pts/1    00:00:00 grep --color=auto /bin/sh
```


ë„¤ì„ìŠ¤í˜ì´ê°€ ê°™ì€ì§€ í˜¸ìŠ¤íŠ¸ì—ì„œ í™•ì¸í•´ë³´ì


```bash
lsns -p $$ -t user
        NS TYPE  NPROCS   PID USER   COMMAND
**4026531837** user       5 12285 ubuntu /lib/systemd/systemd --user
```


â€œ4026531837â€ = â€œ4026531837â€ìœ¼ë¡œ ìœ ì € ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ê°™ë‹¤.


**â€œì»¨í…Œì´ë„ˆëŠ” í˜¸ìŠ¤íŠ¸ì™€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë„ ê°™ê³ , ê¶Œí•œë„ Rootë¥¼ ê°€ì ¸ê°„ë‹¤.â€** ì´ëŠ” ë³´ì•ˆìƒ ì·¨ì•½í•˜ë‹¤.


ìš°ë¦¬ëŠ” ì•„ë˜ì—ì„œ User ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í†µí•´ ê²©ë¦¬í•˜ëŠ” ë°©ì‹ì„ ì§„í–‰í•´ë³¸ë‹¤.


(dockerë„ ìœ ì € ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì§€ì›í•˜ë‚˜, ê¸°ë³¸ê°’ì€ ì•„ë‹ˆë‹¤.)

- ê²©ë¦¬ëœ ìƒíƒœ

```bash
unshare -U --map-root-user /bin/sh
# whoami
root
#
# id
uid=0(root) gid=0(root) groups=0(root),65534(nogroup)
# lsns -p $$
        NS TYPE   NPROCS   PID USER COMMAND
4026531834 time        2 16856 root /bin/sh
4026531835 cgroup      2 16856 root /bin/sh
4026531836 pid         2 16856 root /bin/sh
4026531838 uts         2 16856 root /bin/sh
4026531839 ipc         2 16856 root /bin/sh
4026531840 net         2 16856 root /bin/sh
4026531841 mnt         2 16856 root /bin/sh
4026532206 user        2 16856 root /bin/sh
```

- í˜¸ìŠ¤íŠ¸

```bash
ps -ef |grep "/bin/sh"
ubuntu      6874    5348  0 15:42 pts/0    00:00:00 /bin/sh
ubuntu     16909   15353  0 12:24 pts/0    00:00:00 /bin/sh
ubuntu     16927   12566  0 12:24 pts/1    00:00:00 grep --color=auto /bin/sh
```


í˜¸ìŠ¤íŠ¸ì—ì„œ í™•ì¸í–ˆì„ ë•Œ, **rootê¶Œí•œì´ ì•„ë‹Œ ubuntu ìœ ì €**ë¡œ í™•ì¸ëœë‹¤.


> ğŸ’¡ **k8s, docker í™˜ê²½ì—ì„œ**  
> k8s, dockerì—ì„œëŠ” usernamespaceê°€ ê¸°ë³¸ê°’ì´ ì•„ë‹˜.  
> - dockerê°€ User Namespaceë¥¼ ì§€ì›. root ê¶Œí•œì— ëŒ€í•œ ì·¨ì•½ì ì„ í•´ê²°í•˜ê¸° ìœ„í•´  
>   
> - Podì—ì„œë„ User Namespaceë¥¼ ì§€ì›í•¨. (v1.30 beta)

	- dockerê°€ User Namespaceë¥¼ ì§€ì›. root ê¶Œí•œì— ëŒ€í•œ ì·¨ì•½ì ì„ í•´ê²°í•˜ê¸° ìœ„í•´
		- dockerì˜ ë£¨íŠ¸ ì‚¬ìš©ì´ìœ . package install, ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì´ìš©ì— ì œì•½ì´ ì—†ì–´ í¸í•˜ë‹¤.
	- Podì—ì„œë„ User Namespaceë¥¼ ì§€ì›í•¨. (v1.30 beta)

### Time


í”„ë¡œì„¸ìŠ¤ê°€ ë³¼ ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œ ì‹œê°„ì„ ê²©ë¦¬í•˜ì—¬, íŠ¹ì • í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•´ ë‹¤ë¥¸ ì‹œê°„ëŒ€ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.


## ìì›ì œí•œ


### Cgroup 


cgroupì€ í”„ë¡œì„¸ìŠ¤ì˜ ìì› ì‚¬ìš©ì„ ì œí•œí•˜ê³  ê²©ë¦¬ì‹œí‚¤ëŠ” ê¸°ëŠ¥ì´ë‹¤.


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/6.png)


ì¶œì²˜: [https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=189](https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=189)


> ğŸ’¡ **cgroups**ì¸ê°€? cgroup ì¸ê°€?  
> ì—¬ëŸ¬ ê°œì˜ control groupì„ ëª…ì‹œì ìœ¼ë¡œ ì–¸ê¸‰í•  ë•ŒëŠ” ë³µìˆ˜í˜•ì¸ "cgroups"ì„ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.  
>   
> ê·¸ë¦¬ê³  ì•ì— cëŠ” ëŒ€ë¬¸ìë¡œ ì“°ì´ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.  
>   
> **(ìŠ¤í„°ë””ì› ë¶„ì´ ìš©ì–´ì— ëŒ€í•´ ì •ë¦¬í•´ì£¼ì…¨ë‹¤.)**


	ì—¬ëŸ¬ ê°œì˜ control groupì„ ëª…ì‹œì ìœ¼ë¡œ ì–¸ê¸‰í•  ë•ŒëŠ” ë³µìˆ˜í˜•ì¸ "cgroups"ì„ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.


	ê·¸ë¦¬ê³  ì•ì— cëŠ” ëŒ€ë¬¸ìë¡œ ì“°ì´ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.


	**(ìŠ¤í„°ë””ì› ë¶„ì´ ìš©ì–´ì— ëŒ€í•´ ì •ë¦¬í•´ì£¼ì…¨ë‹¤.)**


#### í”„ë¡œì„¸ìŠ¤ ìì› ì œí•œ

- ë¶€í•˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
apt install cgroup-tools stress -y
```

- ë¶€í•˜ ìƒì„±

```bash
stress -c 1
```


#### ë¶€í•˜ ë°œìƒ í™•ì¸


ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ htop ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¶€í•˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. `stree -c 1` ëª…ë ¹ì–´ë¡œ ì¸í•´ CPUë¥¼ ê±°ì˜ 90% ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/7.png)


#### ì˜µì…˜ ì¶”ê°€

- cgroupì´ ì§€ì›í•˜ëŠ” ë¦¬ì†ŒìŠ¤ í™•ì¸

```bash
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# cat cgroup.controllers
cpuset cpu io memory hugetlb pids rdma misc
```

- sub controlì— cpu ì¶”ê°€

```bash
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# cat cgroup.subtree_control
cpu
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# echo "+cpu" >> /sys/fs/cgroup/test_cgroup_parent/cgroup.subtree_control


```

- cpu.max ì œí•œ ì„¤ì • : ì²« ë²ˆì¨° ê°’ì€ í—ˆìš©ëœ ì‹œê°„(ë§ˆì´í¬ë¡œì´ˆ) ë‘ ë²ˆì§¸ ê°’ì€ ì´ ê¸°ê°„ ê¸¸ì´ > 1/10 ì‹¤í–‰ ì„¤ì •

```bash
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# echo 100000 1000000 > /sys/fs/cgroup/test_cgroup_parent/cpu.max
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# mkdir test_cgroup_child && cd test_cgroup_child

root@MyServer:/sys/fs/cgroup/test_cgroup_parent/test_cgroup_child# cat /proc/$$/cgroup
0::/test_cgroup_parent/test_cgroup_child
root@MyServer:/sys/fs/cgroup/test_cgroup_parent/test_cgroup_child# stress -c 1
stress: info: [18875] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd
```


ì˜µì…˜ì„ ì£¼ê³  ë‚˜ì„œëŠ” CPUë¥¼ ë§ì´ ì‘ì•„ë¨¹ì§€ ëª»í•˜ëŠ” ëª¨ìŠµì´ë‹¤.

- CPU í™œìš©ëŸ‰ì´ ì§€ì†ì ìœ¼ë¡œ 6.5%ì™€ 13.9%ë¥¼ ì™”ë‹¤ê°”ë‹¤í•œë‹¤.

![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/8.png)


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/9.png)


#### Docker ì˜µì…˜ì„ ì´ìš©í•œ ì»¨í…Œì´ë„ˆ ìì› ì œí•œ


docker update ëª…ë ¹ì–´ë¥¼ í™•ì¸í•´ë³´ë©´, cpu ë° ë©”ëª¨ë¦¬ë¥¼ ì œí•œí•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/10.png)

- cpu ì œí•œ í…ŒìŠ¤íŠ¸

```bash
docker run -it --rm --name cpu vish/stress -cpus "1"
Unable to find image 'vish/stress:latest' locally
latest: Pulling from vish/stress
2ce2382a5646: Pull complete
Digest: sha256:b6456a3df6db5e063e1783153627947484a3db387be99e49708c70a9a15e7177
Status: Downloaded newer image for vish/stress:latest
I0831 05:44:08.118939       1 main.go:26] Allocating "0" memory, in "4Ki" chunks, with a 1ms sleep between allocations
I0831 05:44:08.119009       1 main.go:39] Spawning a thread to consume CPU
I0831 05:44:08.119023       1 main.go:29] Allocated "0" memory
```

- ë¶€í•˜ë¥¼ ê±°ì˜ 100í”„ë¡œ ì¡ì•„ë¨¹ëŠ”ë‹¤.

![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/11.png)

- ì´ì œ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚¤ê³ , ì ìœ ë¥¼ í™•ì¸í•´ë³¸ë‹¤.
	- cpu ì ìœ ìœ¨ì€ $\frac{\text{cpu-quota}}{\text{cpu-period}}$ x 100ìœ¼ë¡œ ê³„ì‚°ëœë‹¤.

```bash
docker run -d --cpu-period=100000 --cpu-quota=100000 --name cpu1 vish/stress -cpus "1"
docker run -d --cpu-period=100000 --cpu-quota=25000  --name cpu2 vish/stress -cpus "1"
docker run -d --cpu-period=200000 --cpu-quota=25000  --name cpu3 vish/stress -cpus "1"
docker run -d --cpu-period=50000  --cpu-quota=25000  --name cpu4 vish/stress -cpus "1"
105d0b7129dbb5dbb80b7eec5b30180e6612c596e4a9676a983cbc92ae31f44e
1b30b1e45a8b3feb2a106d6d7946dccd9af3dac0be50031302394e002019d7c6
a7e42052522f1752ef6bff51f877351444876834fbb0b55f4f4a9f9fdd0283af
4c61e45e85463a10650a3691282384a9e750e4a05c78dc0ab85e05f181b4f34b
```


ì•„ë˜ì˜ ì‚¬ì§„ê³¼ ê°™ì´, cpu-quota/cpu-period ê°’ê³¼ ìœ ì‚¬í•˜ê²Œ ì ìœ ë¥¼ ê°€ì ¸ê°„ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.


**cpu1 ~= 100, cpu2 ~= 25, cpu3 ~= 8, cpu4 ~= 50**


![image.png](/assets/img/post/Docker%20ì—†ì´%20ì»¨í…Œì´ë„ˆ%20ë§Œë“¤ê¸°%20/12.png)


cpu3ì˜ ê²½ìš° 40%ì´ìƒ ì°¨ì´ê°€ ë‚œë‹¤. í•˜ì§€ë§Œ ê·¸ë˜ë„ ê°’ê³¼ ì–¼ì¶” ìˆ˜ë ´í•˜ëŠ” ëª¨ìŠµì´ë‹¤.

