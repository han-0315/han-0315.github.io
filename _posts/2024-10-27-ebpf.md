---
layout: post
title: ebpf ì•Œì•„ë³´ê¸°
date: 2024-10-26 09:00 +0900 
description: ebpf ì•Œì•„ë³´ê¸°
category: [Linux, Kernel] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#8, Cilium, ebpf, Kernel] 
pin: false
math: true
mermaid: true
---

ë¦¬ëˆ…ìŠ¤ì—ì„œ í˜ì‹ ì ì¸ ê¸°ìˆ ë¡œ ë¶ˆë¦¬ëŠ” ebpf ì•Œì•„ë³´ê¸°

<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.




## kernel ìˆ˜ì • ë°©ì‹


ê¸°ì¡´ì˜ ì»¤ë„ì—ì„œ ì‚¬ìš©ì ì½”ë“œë¥¼ ë„£ëŠ” ë°©ì‹ì€ ì•„ë˜ì™€ ê°™ë‹¤.

- kernel module: kernelìœ„ì— ë¶™ì´ëŠ” ê²ƒìœ¼ë¡œ  ì»¤ë„ì˜ ì»´íŒŒì¼ì—†ì´ ë¡œë“œí•  ìˆ˜ ìˆë‹¤. ì¥ì¹˜ ë“œë¼ì´ë²„ ë˜í•œ ëª¨ë“ˆ í˜•íƒœë¡œ ì¡´ì¬í•œë‹¤. í•˜ì§€ë§Œ ëª¨ë“ˆì´ ì•ˆì •ì ì¼ì§€ ëª¨ë¥¸ë‹¤.
- kernel source code ìˆ˜ì •: ì»¤ë„ ì»´íŒŒì¼ì´ í•„ìš”í•˜ë‹¤. ê³¼ê±° ê´€ë ¨ëœ í”„ë¡œì íŠ¸ ì§„í–‰í•  ë•Œ ê°€ë²¼ìš´ ì»¤ë„ì´ì—ˆì–´ë„ 2~3ì‹œê°„ ê±¸ë ¸ìœ¼ë©°, ìˆ˜ì •í•œ ì½”ë“œê°€ ì•ˆì •ì ì¼ì§€ ëª¨ë¦„
- kernel hooks: kernelì˜ ì¼ë¶€ë¶„ì—ì„œ hooksì„ ì œê³µí•œë‹¤. í›…ì€ í†µí•´ custom logicì„ ë¶™ì¼ ìˆ˜ ìˆìœ¼ë©° kernel ë‚´ë¶€ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤. ex) netfilter
	- ê¸°ë³¸ì ì¸ í•œê³„ ì¡´ì¬(ëŒ€ë¶€ë¶„ì˜ ì˜ì—­ì—ì„œ hookì„ ì œê³µí•˜ëŠ” ê±´ ì•„ë‹˜)

ìœ„ì— í•´ë‹¹ í•˜ëŠ” ë°©ì‹ì€ ì—¬ëŸ¬ ë‹¨ì ì´ ì¡´ì¬í•œë‹¤. eBPFëŠ” ì•ˆì „í•˜ê²Œ ì»¤ë„ ë‚´ë¶€ì— í”„ë¡œê·¸ë¨ì„ ë„£ì„ ìˆ˜ ìˆëŠ” ë°©ì‹ìœ¼ë¡œ kernel ì†ŒìŠ¤ë¥¼ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ”ë‹¤. 


### ebpfë€


ebpf(extended berkeley packet fillter)ìœ¼ë¡œ BPFë¥¼ í™•ì¥í•œ ëª¨ë¸ì´ë‹¤. BPFëŠ” ì´ë²¤íŠ¸ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©° ì´ë²¤íŠ¸ ë°œìƒì‹œ í•´ë‹¹ kernelì„ í•´í‚¹í•œë‹¤. ì»¤ë„ ë‚´ë¶€ ì†ŒìŠ¤ì½”ë“œë¥¼ ê±´ë“œë¦¬ëŠ” ê²ƒì´ ì•„ë‹Œ sandboxed ëœ í™˜ê²½ìœ¼ë¡œ ì»¤ë„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤. BPFëŠ” ì–´ë–»ê²Œ kernelì„ í•´í‚¹í•˜ê³ , ìƒŒë“œë°•ìŠ¤ëœ í™˜ê²½ì„ ì œê³µí•  ìˆ˜ ìˆì„ê¹Œ?


ì´ì œ ebpfì˜ ë™ì‘ ë°©ì‹ì„ í™•ì¸í•˜ì—¬ ì´ìœ ë¥¼ ì•Œì•„ë³¸ë‹¤.


### ebpf ë™ì‘ ë°©ì‹


![image.png](/assets/img/post/ebpf/1.png)


ì¶œì²˜: [https://ebpf.io/ko-kr/what-is-ebpf/](https://ebpf.io/ko-kr/what-is-ebpf/)

- `bpf()` ì‹œìŠ¤í…œ ì½œì„ í†µí•´ ì½”ë“œë¥¼ ì»¤ë„ ê³µê°„ì—ì„œ ë„£ëŠ”ë‹¤. [ì°¸ê³  ìë£Œ](https://docs.kernel.org/userspace-api/ebpf/syscall.html)
	- ì§ì ‘ ì»¤ë„ í˜¸ì¶œì´ë‚˜ ë©”ëª¨ë¦¬ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•˜ë©°, kernel helperë¥¼ í†µí•´ **ì œí•œëœ ë™ì‘ë§Œ ì§„í–‰**í•˜ì—¬ ì•ˆì „í•˜ë‹¤.
- ê²€ì¦ê¸°ì™€ JIT ì»´íŒŒì¼ëŸ¬ë¥¼ í†µí•´ ì½”ë“œë¥¼ ê²€ì‚¬í•˜ê³  JIT ì»´íŒŒì¼ëŸ¬ë¥¼ í†µí•´ ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤.
	- ê²€ì¦ê¸° ê²€ì‚¬ë¥¼ í†µí•´ **ì•ˆì „**í•˜ë©° ë„¤ì´í‹°ë¸Œ ì»´íŒŒì¼ëŸ¬ì²˜ëŸ¼ **ë¹ ë¥¸ ì‹¤í–‰**ì´ ê°€ëŠ¥í•˜ë‹¤.(vs ì¸í„°í”„ë¦¬í„°)
- BPFì˜ ì½”ë“œëŠ” ì»¤ë„ì˜ ê° í•¨ìˆ˜ì— ì¡´ì¬í•˜ëŠ” **í›…ê³¼ ì—°ê²°ë˜ê±°ë‚˜ probeë¥¼ í†µí•´ ì»¤ë„ ì´ë²¤íŠ¸ì™€ ì—°ê²°**ëœë‹¤. íŠ¹ì • ì´ë²¤íŠ¸ ë°œìƒì‹œ í›… í˜¹ì€ í”„ë¡œë¸Œë¥¼ í†µí•´ í•´ë‹¹ ì½”ë“œê°€ ì‹¤í–‰ëœë‹¤.
	- ë§Œì•½, í›…ì´ ì—†ì„ì‹œ kprobeì™€ ê°™ì€ ë™ì í”„ë¡œë¸Œë¥¼ í™œìš©í•˜ì—¬ íŠ¹ì • ì»¤ë„ í•¨ìˆ˜ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ì»¤ë„í•¨ìˆ˜ê°€ ì‹¤í–‰ë ë•Œ í”„ë¡œë¸Œë¥¼ í†µí•´ ì›í•˜ëŠ” ì½”ë“œê°€ ì‹¤í–‰ë  ìˆ˜ ìˆë‹¤.
- Dataë¡œëŠ” BPF maps, Ring Buffersë¥¼ ì‚¬ìš©í•œë‹¤.

ì´ì œ ì—¬ê¸°ì„œ ë‚˜ì˜¤ëŠ” ì£¼ìš” ìš”ì†Œì— ëŒ€í•´ ìì„¸íˆ ì‚´í´ë³¸ë‹¤.


#### ë™ì í”„ë¡œë¸Œ(kprobe, kretprobe)


kprobeëŠ” ì»¤ë„ ì½”ë“œ ëŒ€ë¶€ë¶„ì— ë„£ì„ ìˆ˜ ìˆê³ , í”„ë¡œë¸Œê°€ ì¡´ì¬í•˜ë©´ ì»¤ë„ ì‹¤í–‰ì„ ë©ˆì¶”ê³  í”„ë¡œë¸Œë¡œ ì œì–´ê¶Œì´ ë„˜ì–´ê°„ë‹¤. kretprobeëŠ” ì»¤ë„ í•¨ìˆ˜ê°€ ì¢…ë£Œë  ë•Œ ì‹¤í–‰ë˜ëŠ” í”„ë¡œë¸Œì´ë‹¤.


â€œA kprobe can be inserted on virtually any instruction in the kernel. A return probe fires when a specified function returns.â€ 


ì°¸ê³ : [https://docs.kernel.org/trace/kprobes.html](https://docs.kernel.org/trace/kprobes.html)


#### ì»´íŒŒì¼ëŸ¬


JIT (Just-In-Time) ì»´íŒŒì¼ëŸ¬ëŠ” ë°”ì´íŠ¸ì½”ë“œë¥¼ ì‹¤í–‰ì‹œì ì— ë¨¸ì‹ ì½”ë“œë¡œ ë³€í™˜í•œë‹¤. ì´ëŸ° ê³¼ì • ë•ë¶„ì— eBPF í”„ë¡œê·¸ë¨ë„ ê¸°ì¡´ì˜ ì»´íŒŒì¼ëŸ¬ë¥¼ í†µí•´ ì»´íŒŒì¼ëœ í”„ë¡œê·¸ë¨ê³¼ ìœ ì‚¬í•œ ì†ë„ë¡œ ì‹¤í–‰ê°€ëŠ¥í•˜ë‹¤.


#### helper function


ë¯¸ë¦¬ ì»¤ë„ì— ì‘ì„±ëœ bpf helperë¥¼ í†µí•´ ë‹¤ì–‘í•œ ë™ì‘ì´ ê°€ëŠ¥í•˜ë‹¤.

- mapê³¼ ê´€ë ¨ëœ ë™ì‘(read, update, delete)
	- `bpf_map_lookup_percpu_elem`, `bpf_map_update_percpu_elem`: cpuë³„ ë°ì´í„° ì¡°ì‘ ê°€ëŠ¥
- packet ê´€ë ¨ë™ì‘(íŒ¨í‚· ë°ì´í„° ì½ì–´ì˜¤ê¸°, ì €ì¥, ë¦¬ë‹¤ì´ë ‰íŠ¸ ë“±)
- tracing, logging
	- `trace_printk`: ë¡œê·¸ ì¶œë ¥ ê°€ëŠ¥í•˜ë‚˜ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ
		- For passing values to user space, perf events should be preferred.
	- `stackid`, `bpf_ktime_get_ns` ë“±
- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
	- `bpf_perf_event_output`
- cgroup ê´€ë ¨
	- `bpf_get_current_cgroup_id`, `bpf_skb_cgroup_id`
- í”„ë¡œì„¸ìŠ¤ ê´€ë ¨
	- `bpf_get_smp_processor_id`: Get the SMP (symmetric multiprocessing) processor id.
	- `bpf_get_current_pid_tgid`: í˜„ì¬í”„ë¡œì„¸ìŠ¤ì˜ PID + TGID ë°˜í™˜, ì´í›„ ì‹¤ìŠµì—ì„œ ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜ì´ë‹¤.
	- `bpf_send_signal`: íŠ¹ì • í”„ë¡œì„¸ìŠ¤ì—ê²Œ signal
- ë„¤íŠ¸ì›Œí¬ ê´€ë ¨
	- `bpf_sk_lookup_tcp`: ì†Œì¼“ê²€ìƒ‰
	- `bpf_msg_redirect_hash`: ë‹¤ë¥¸ ì†Œì¼“ìœ¼ë¡œ redirect
	- `bpf_ntohs`, `bpf_ntohl`, `bpf_htons`, `bpf_htonl` : ë„¤íŠ¸ìš°ì»¤ã…¡ ë°”ì´íŠ¸ ìˆœì„œ, í˜¸ìŠ¤íŠ¸ ë°”ì´íŠ¸ ìˆœì„œ ê°„ì˜ ë³€í™˜ ì§„í–‰
	- `bpf_csum_diff`: ì²´í¬ì¸ì˜ ì°¨ì´ ê³„ì‚°
- memory
	- `bpf_ringbuf_output`: ë§ ë²„í¼ë¥¼ í†µí•´ ì‚¬ìš©ì ê³µê°„ìœ¼ë¡œ ë°ì´í„° ì „ì†¡

ì°¸ê³ : [https://man7.org/linux/man-pages/man7/bpf-helpers.7.html](https://man7.org/linux/man-pages/man7/bpf-helpers.7.html)


ì •ë¦¬í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì€ ì´ìœ ë¡œ ì»¤ë„ì˜ ìˆ˜ì •ì—†ì´ ì•ˆì „í•˜ê²Œ ì»¤ë„ì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ ìˆë‹¤.

- **í›…ê³¼ ë™ì í”„ë¡œë¸Œ**ë¥¼ í†µí•´ ì»¤ë„ ì†ŒìŠ¤ì½”ë“œ ë³€ê²½ì—†ì´ ì‚¬ìš©ì ë¡œì§ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.
- **ê²€ì¦ê¸°**ì™€ ì‚¬ì „ì— ì»¤ë„ì— ì‘ì„±ëœ **helper í•¨ìˆ˜**ë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì‹¤í–‰ê°€ëŠ¥í•˜ë‹¤.

### ì‹¤ìŠµ


golangìœ¼ë¡œ ì§„í–‰í•œë‹¤. pythonìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” bpf ê´€ë ¨ ìƒ˜í”Œ ì½”ë“œëŠ” [https://github.com/iovisor/bcc](https://github.com/iovisor/bcc)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


í™˜ê²½ì€ `ubuntu 22.04`ë¡œ ì§„í–‰, `go version 1.21`ë¡œ ì§„í–‰í•œë‹¤.


ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì‹œìŠ¤í…œ ì½œ í˜¸ì¶œì„ ë¡œê¹…í•˜ì—¬ eBPFë¥¼ ë§›ë³¸ë‹¤. 


#### í™˜ê²½ êµ¬ì„±

- ì»´íŒŒì¼ ë„êµ¬ ë° linux í—¤ë” ì„¤ì¹˜

```bash
sudo apt update
sudo apt install -y \
    build-essential \
    clang \
    llvm \
    libbpf-dev \
    libelf-dev \
    linux-headers-$(uname -r) \
    git \
    pkg-config
```

- Golang ì„¤ì¹˜

```bash
sudo apt-get update
wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
sudo tar -xvf go1.21.0.linux-amd64.tar.gz
sudo mv go /usr/local
export GOROOT=/usr/local/go
export GOPATH=$HOME/go
export PATH=$GOPATH/bin:$GOROOT/bin:$PATH
source ~/.profile
```

- ìƒ˜í”Œ ì½”ë“œë¥¼ ë‹¤ìš´ë°›ëŠ”ë‹¤. ì°¸ê³ í•œ í¬ìŠ¤íŒ…ì€ [ì—¬ê¸°](https://sazak.io/articles/an-applied-introduction-to-ebpf-with-go-2024-06-06)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
vi ~/.bashrc
export PATH=$PATH:/usr/local/go/bin
source ~/.bashrc
git clone https://github.com/ozansz/intro-ebpf-with-go.git
cd intro-ebpf-with-go/0x01-helloworld
```


#### ì½”ë“œ í™•ì¸(cì–¸ì–´ bpf ì„¤ì •)


**ê°„ë‹¨í•œ ì„¤ëª…:** í•´ë‹¹ ì½”ë“œëŠ” **sys_execve** ì‹œìŠ¤í…œ ì½œì´ ë°œìƒí•  ë•Œë§ˆë‹¤ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ IDì™€ ì´ë¦„ì„ ê°€ì ¸ì˜¤ëŠ” ì½”ë“œì´ë‹¤. 


ì´ì œ ìì„¸í•˜ê²Œ ë‚´ìš©ì„ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

- ì»¤ë„ì— ì½”ë“œ ì‚½ì…

**kprobe**ë¥¼ í†µí•´ **sys_execve** ì‹œìŠ¤í…œ ì½œì´ ë°œìƒí•  ë•Œë§ˆë‹¤ í•´ë‹¹ ì•„ë˜ì˜ **hello_execve** í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë„ë¡ í•œë‹¤. 


```c
SEC("kprobe/sys_execve")
int hello_execve(struct pt_regs *ctx) {
    u64 id = bpf_get_current_pid_tgid();
    pid_t pid = id >> 32;
    pid_t tid = (u32)id;

    if (pid != tid)
        return 0;
```

- ë§ ë²„í¼ ì „ì†¡

BPFì—ì„œ í”„ë¡œì„¸ìŠ¤ IDì™€ Nameì„ ë°›ì•„ ì´ë¥¼ event êµ¬ì¡°ì²´ì— ì‘ì„±í•œ í›„ ë§ ë²„í¼ë¡œ ì „ì†¡í•œë‹¤.


```c
  struct event *e;
  e = bpf_ringbuf_reserve(&events, sizeof(struct event), 0);
  if (!e) {
      return 0;
  }

  e->pid = pid;
  bpf_get_current_comm(&e->comm, TASK_COMM_SIZE);
  bpf_ringbuf_submit(e, 0);
```


> ğŸ’¡ **ì„¸ë¶€ ë‚´ìš©**  
> - **`execve`**`()`  
>   
> ê²½ë¡œëª…ì„ ì°¸ì¡°í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì´ë‹¤. ê´€ë ¨ [ë¬¸ì„œ](https://man7.org/linux/man-pages/man2/execve.2.html)  
>   
> - `bpf_get_current_comm`ì˜ ìì„¸í•œ ë‚´ìš©ì€  [bcc](https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md#6-bpf_get_current_comm)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  
>   
> Syntax:Â `bpf_get_current_comm(char *buf, int size_of_buf)`  
>   
> â€œPopulates the first argument address with the current process name. It should be a pointer to a char array of at least size TASK_COMM_LEN, which is defined in linux/sched.h.â€


- **ì „ì²´ì½”ë“œ**

```c
// +build ignore

#include "vmlinux.h"
#include <bpf/bpf_helpers.h>

#define TASK_COMM_SIZE 100

char __license[] SEC("license") = "Dual MIT/GPL";

struct event {
    u32 pid;
    u8  comm[TASK_COMM_SIZE];
};

struct {
	__uint(type, BPF_MAP_TYPE_RINGBUF);
	__uint(max_entries, 1 << 24);
} events SEC(".maps");

// Force emitting struct event into the ELF.
const struct event *unused __attribute__((unused));

SEC("kprobe/sys_execve")
int hello_execve(struct pt_regs *ctx) {
    u64 id = bpf_get_current_pid_tgid();
    pid_t pid = id >> 32;
    pid_t tid = (u32)id;

    if (pid != tid)
        return 0;

    struct event *e;

	e = bpf_ringbuf_reserve(&events, sizeof(struct event), 0);
	if (!e) {
		return 0;
	}

	e->pid = pid;
	bpf_get_current_comm(&e->comm, TASK_COMM_SIZE);

	bpf_ringbuf_submit(e, 0);

	return 0;
}
```


#### ì½”ë“œ í™•ì¸(golang)


ìœ„ì—ì„œ cë¡œ ì‘ì„±í•œ eBPF í”„ë¡œê·¸ë¨ì„ ì—°ê²°í•œë‹¤.


```go
objs := ebpfObjects{}
if err := loadEbpfObjects(&objs, nil); err != nil {
    log.Fatalf("loading objects: %v", err)
}
defer objs.Close()
```


kprobeë¥¼ í†µí•´ `sys_execve` ì‹œìŠ¤í…œ ì½œì´ ë°œìƒí•˜ëŠ” ìœ„ì¹˜ì— eBPF í”„ë¡œê·¸ë¨(`HelloExecve`)ì´ ì‹¤í–‰ë˜ë„ë¡ í•œë‹¤.


```go
kp, err := link.Kprobe(kprobeFunc, objs.HelloExecve, nil)
if err != nil {
    log.Fatalf("opening kprobe: %s", err)
}
defer kp.Close()
```


ë§ ë²„í¼ë¥¼ ì„¤ì •í•œë‹¤. ë²„í¼ë¥¼ í†µí•´ ì»¤ë„ì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ë¥¼ UserSpaceì—ì„œ ì½ì„ ìˆ˜ ìˆë‹¤.


```go
rd, err := ringbuf.NewReader(objs.Events)
if err != nil {
    log.Fatalf("opening ringbuf reader: %s", err)
}
defer rd.Close()
```


ë²„í¼ì—ì„œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ê³ , ì´ë¥¼ ì´ë²¤íŠ¸ êµ¬ì¡°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë¡œê·¸ë¥¼ ì¶œë ¥í•œë‹¤. (PID, Process Name)


```go
var event ebpfEvent
	for {
		record, err := rd.Read()
		if err != nil {
			...
		}
		...

		log.Printf("pid: %d\tcomm: %s\n", event.Pid, unix.ByteSliceToString(event.Comm[:]))
	}
```

- **ì „ì²´ ì½”ë“œ**

```go
package main

import (
	"bytes"
	"encoding/binary"
	"errors"
	"log"
	"os"
	"os/signal"
	"syscall"

	"github.com/cilium/ebpf/link"
	"github.com/cilium/ebpf/ringbuf"
	"github.com/cilium/ebpf/rlimit"
	"golang.org/x/sys/unix"
)

//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -type event ebpf hello_ebpf.c

const (
	kprobeFunc = "sys_execve"
)

func main() {
	log.SetPrefix("hello_ebpf: ")
	log.SetFlags(log.Ltime)

	// Subscribe to signals for terminating the program.
	stopper := make(chan os.Signal, 1)
	signal.Notify(stopper, os.Interrupt, syscall.SIGTERM)

	// Allow the current process to lock memory for eBPF resources.
	if err := rlimit.RemoveMemlock(); err != nil {
		log.Fatal(err)
	}

	// Load pre-compiled programs and maps into the kernel.
	objs := ebpfObjects{}
	if err := loadEbpfObjects(&objs, nil); err != nil {
		log.Fatalf("loading objects: %v", err)
	}
	defer objs.Close()

	// Open a Kprobe at the entry point of the kernel function and attach the
	// pre-compiled program. Each time the kernel function enters, the program
	// will emit an event containing pid and command of the execved task.
	kp, err := link.Kprobe(kprobeFunc, objs.HelloExecve, nil)
	if err != nil {
		log.Fatalf("opening kprobe: %s", err)
	}
	defer kp.Close()

	// Open a ringbuf reader from userspace RINGBUF map described in the
	// eBPF C program.
	rd, err := ringbuf.NewReader(objs.Events)
	if err != nil {
		log.Fatalf("opening ringbuf reader: %s", err)
	}
	defer rd.Close()

	// Close the reader when the process receives a signal, which will exit
	// the read loop.
	go func() {
		<-stopper

		if err := rd.Close(); err != nil {
			log.Fatalf("closing ringbuf reader: %s", err)
		}
	}()

	log.Println("Waiting for events..")

	// bpfEvent is generated by bpf2go.
	var event ebpfEvent
	for {
		record, err := rd.Read()
		if err != nil {
			if errors.Is(err, ringbuf.ErrClosed) {
				log.Println("Received signal, exiting..")
				return
			}
			log.Printf("reading from reader: %s", err)
			continue
		}

		// Parse the ringbuf event entry into a bpfEvent structure.
		if err := binary.Read(bytes.NewBuffer(record.RawSample), binary.LittleEndian, &event); err != nil {
			log.Printf("parsing ringbuf event: %s", err)
			continue
		}

		log.Printf("pid: %d\tcomm: %s\n", event.Pid, unix.ByteSliceToString(event.Comm[:]))
	}
}
```


#### ë¹Œë“œ


ì´ì œ ì½”ë“œë¥¼ ë¹Œë“œí•œë‹¤.


```bash
go generate
go build -o hello_ebpf
```


#### ì‹¤í–‰


ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œë‹¤. (ì¶”ê°€ í„°ë¯¸ë„ í•„ìš”)


```bash
sudo ./hello_ebpf
```


ì‹¤í—˜ì„ ìœ„í•´ sudo su - ë° ì—¬ëŸ¬ ëª…ë ì–´ë¥¼ ì…ë ¥í–ˆë‹¤. 


```bash
sudo su -
cd ~
go version
```


bash ê¸°ë°˜ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ê±´ bashë¡œ ë‚˜ì˜¤ê³ , suì™€ goë„ ë³´ì´ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ebpf/2.png)


### ebpf for Cilium


ê·¸ë ‡ë‹¤ë©´ Ciliumì€ ebpfë¥¼ ì‚¬ìš©í•˜ëŠ” CNIì´ë‹¤. CIliumì—ì„œëŠ” ebpfë¥¼ ì–´ë–»ê²Œ ì‚¬ìš©í• ê¹Œ?


ê¸°ì¡´ì˜ iptablesëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ ì—¬ëŸ¬ ë‹¨ì ì´ ì¡´ì¬í•œë‹¤. ê´€ë ¨ëœ ë‚´ìš©ì€ [ë¸”ë¡œê·¸](https://blog.naver.com/kangdorr/222593265958)ì— ì˜ì •ë¦¬ë˜ì–´ìˆë‹¤.

1. íŒ¨í‚·ë§ˆë‹¤ iptablesì˜ ê·œì¹™ì— ì¼ì¹˜í•  ë•Œê¹Œì§€ ëª¨ë“  ê·œì¹™ì„ í‰ê°€í•œë‹¤.
2. incremental updateë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. (ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ê°€ ìƒì„±ë˜ë©´, ì „ì²´ë¥¼ êµì²´í•´ì•¼ í•œë‹¤.)

ìœ„ì™€ ê°™ì€ ë‹¨ì ì„ í•´ê²°í•˜ê¸°ìœ„í•´ eBPFëŠ” ìµœëŒ€í•œ ë¦¬ëˆ…ìŠ¤ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ íƒ€ì§€ ì•Šê³  íŒ¨í‚·ì„ ì²˜ë¦¬í•˜ë ¤ê³  í•œë‹¤.


ì•„ë˜ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ íŒ¨í‚·ì€ NICì„ í†µí•´ ë“¤ì–´ì˜¤ê³  XDP > TC > Routing Rule > .. > User Spaceë¡œ í–¥í•œë‹¤.


ebpfë¥¼ í†µí•´ XDPì—ì„œ ë°”ë¡œ ì²˜ë¦¬í•œë‹¤ë©´ ì„±ëŠ¥ì€ ë§¤ìš° í–¥ìƒë  ê²ƒì´ë‹¤.


![image.png](/assets/img/post/ebpf/3.png)


NICì—ì„œ ë§Œì•½ XDPë¥¼ ì§€ì›í•œë‹¤ë©´ ë” ìµœì í™”í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ebpf/4.png)


ê²°ê³¼ë¥¼ ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤. Iptables ë°©ì‹ì€ ê¸°ì¡´ ì´ë”ë„·ì˜ ì†ë„ì˜ 10%ì˜ ì„±ëŠ¥ë§Œ ë³´ì˜€ì§€ë§Œ xdpì™€ xdp-offloadëŠ” ì„±ëŠ¥ì €í•˜ê°€ ë¯¸ì„¸í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ebpf/5.png)


ê°„ë‹¨í•˜ê²Œ Packet Dropê³¼ ê´€ë ¨ëœ ì˜ˆì‹œë¥¼ ë´¤ë‹¤. Ciliumì€ eBPFë¥¼ í†µí•´ ì»¤ë„ì„ ì»¤ìŠ¤í…€í•˜ì—¬ ì„±ëŠ¥ê³¼ ë³´ì•ˆ ê·¸ë¦¬ê³  ì»¤ë„ ìˆ˜ì¤€ì—ì„œ ëª¨ë‹ˆí„°ë§ì„ í™•ë³´í–ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ Cilium í¸ì—ì„œ ë‹¤ë£° ì˜ˆì •ì´ë‹¤.


![image.png](/assets/img/post/ebpf/6.png)


### ì°¸ê³ ìë£Œ


ebpf: [https://ebpf.io/ko-kr/what-is-ebpf/](https://ebpf.io/ko-kr/what-is-ebpf/)


bpg helpers: [https://man7.org/linux/man-pages/man7/bpf-helpers.7.html](https://man7.org/linux/man-pages/man7/bpf-helpers.7.html)


bpf header: 


go ebpf example: [https://github.com/cilium/ebpf/tree/main/examples](https://github.com/cilium/ebpf/tree/main/examples)


bcc(bpf sample): [https://github.com/iovisor/bcc](https://github.com/iovisor/bcc) 


bpf ì‹¤ìŠµì½”ë“œ: [https://royzsec.medium.com/install-go-1-21-0-in-ubuntu-22-04-2-in-5-minutes-468a5330c64e](https://royzsec.medium.com/install-go-1-21-0-in-ubuntu-22-04-2-in-5-minutes-468a5330c64e)


datadog ebpf: [https://www.datadoghq.com/knowledge-center/ebpf/](https://www.datadoghq.com/knowledge-center/ebpf/)

