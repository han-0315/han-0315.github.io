---
layout: post
title: Calico νλ“ ν†µμ‹  μ•μ•„λ³΄κΈ°
date: 2024-09-15 09:01 +0900 
description: Calico νλ“ ν†µμ‹  μ•μ•„λ³΄κΈ°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#3] 
pin: false
math: true
mermaid: true
---
Calico νλ“ ν†µμ‹  μ•μ•„λ³΄κΈ°
<!--more-->


> π’΅ **KANS μ¤ν„°λ””**  
> CloudNetμ—μ„ μ£Όκ΄€ν•λ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)μΌλ΅ μΏ λ²„λ„¤ν‹°μ¤ λ„¤νΈμ›ν‚Ή μ¤ν„°λ””μ…λ‹λ‹¤. μ•„λμ κΈ€μ€ μ¤ν„°λ””μ λ‚΄μ©μ„ κΈ°λ°μΌλ΅ μ‘μ„±ν–μµλ‹λ‹¤.  
>   
> μ¤ν„°λ””μ— κ΄€μ‹¬μ΄ μμΌμ‹  λ¶„μ€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)λ¥Ό μ°Έκ³ ν•΄μ£Όμ„Έμ”.


## Calico ν†µμ‹  λ°©μ‹


Calico μ΄ν•΄ν•κΈ° ν¬μ¤ν…μ—μ„λ” Calicoμ μ•„ν‚¤ν…μ²μ™€ Componentμ— λ€ν•΄ μ•μ•„λ³Ό μ μμ—λ‹¤. μ—¬κΈ°μ„λ” κµ¬μ²΄μ μΌλ΅ μ–΄λ–»κ² νλ“ ν†µμ‹ μ„ μ§€μ›ν•λ”μ§€ μ•μ•„λ³Έλ‹¤.


### κ°™μ€ λ…Έλ“μ— μ„μΉν• νλ“ ν†µμ‹ 


νλ“μ™€ λ„¤νΈμ›ν¬ ν†µμ‹  νλ¦„μ€ μ•„λμ™€ κ°™λ‹¤.

1. νλ“μ—μ„ κ²μ΄νΈμ›¨μ΄λ΅ ν¨ν‚· μ „μ†΅ μ‹λ„
2. calico# μΈν„°νμ΄μ¤μ—μ„ proxy arpλ΅ μμ‹ μ MAC μ •λ³΄λ¥Ό μ¤
3. νΈμ¤νΈλ΅ ν¨ν‚·μ΄ μ®κ²¨μ§€κ³  iptablesλ¥Ό ν†µν•΄ μ•λ§μ€ νλ“μ—κ² λΌμ°ν…

![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /1.png)


#### μ‹¤μµ μ§„ν–‰


κ°™μ€ λ…Έλ“μ— νλ“ 2κ° λ°°ν¬


```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: k8s-w1
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  nodeName: k8s-w1
  containers:
  - name: pod2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```

- νλ“ μ •λ³΄ ν™•μΈ

```bash
(β|HomeLab:N/A) root@k8s-m:~# k get pods -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES
pod1   1/1     Running   0          33s   172.16.158.3   k8s-w1   <none>           <none>
pod2   1/1     Running   0          33s   172.16.158.2   k8s-w1   <none>           <none>
(β|HomeLab:N/A) root@k8s-m:~# calicoctl get workloadendpoints
WORKLOAD   NODE     NETWORKS          INTERFACE
pod1       k8s-w1   172.16.158.3/32   calice0906292e2
pod2       k8s-w1   172.16.158.2/32   calibd2348b4f67
```

- ARP μ •λ³΄ ν™•μΈ

```bash
ip -c -s neigh
192.168.10.101 dev eth0 lladdr ee:ee:ee:ee:ee:ee  used 451/511/451probes 0 STALE
169.254.1.1 dev eth0 lladdr ee:ee:ee:ee:ee:ee  used 159/159/131probes 1 STALE
```


μ΄μ  νλ“1μ— μ ‘μ†ν•μ—¬, νλ“2μ—κ² ping ν†µμ‹ μ„ μ‹λ„ν•λ‹¤.


```bash
kubectl exec pod1 -it -- zsh
ping {pod2 IP}
```

- pingμ„ μ§„ν–‰ν•λ©΄μ„ tcpdumpλ¥Ό ν†µν•΄ μ„μ—μ„ ν™•μΈ calico# μΈν„°νμ΄μ¤ ν™•μΈ
	- calico# μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ ν†µμ‹ μ΄ μ§„ν–‰λλ” κ²ƒ ν™•μΈ

![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /2.png)


ν•΄λ‹Ή dumpλ¥Ό ν†µν•΄ μ™€μ΄μ–΄μƒ¤ν¬ λ‚΄μ©μ„ λ³΄λ©΄, POD2κ°€ κ²μ΄νΈμ›¨μ΄ μ ‘μ†μ •λ³΄λ¥Ό λ¬Όμ–΄λ³΄κ³ , calico interfaceκ°€ ee:ee:ee:ee:ee:eeλΌκ³  μ•λ ¤μ£Όλ” λ¨μµμ„ ν™•μΈν•  μ μλ‹¤.

- μ•„λλ” VETH2μ— λ¤ν”„λ¥Ό λ¬ λ¨μµμ΄λ‹¤.
1. κ²μ΄νΈμ›¨μ΄ μ •λ³΄(169.254.1.1)μ— λ€ν• μ§μλ¥Ό cali# MACμ£Όμ†λ΅ μ‘λ‹µ
2. pod2κ°€ μμ‹ μ arp μ •λ³΄ μ§μμ— μμ‹ μ MAC μ£Όμ†λ΅ μ‘λ‹µ

![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /3.png)


μ΄μ  ARP ν…μ΄λΈ”μ„ ν™•μΈν•λ©΄ μ•„λμ™€ κ°™μ΄ μ¶”κ°€λλ‹¤.


![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /4.png)


λν• ip link showλ¥Ό ν†µν•΄ ν™•μΈν•λ©΄ μ•„λμ™€ κ°™μ΄ cali# μΈν„°νμ΄μ¤λ” λ™μΌν• λ§¥ μ£Όμ† ee:ee:ee:ee:ee:ee λ¥Ό μ‚¬μ©ν•λ” κ²ƒμ„ λ³Ό μ μλ”λ°


![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /5.png)


μ¤ν„°λ””μ—μ„ μ•„λμ™€ κ°™μ΄ μ„¤λ…ν•΄μ£Όμ…¨λ‹¤.


**μΌλ¶€ μ»¤λ„μ΄ κ³ μ • λ§¥ μ£Όμ† μƒμ„±μ΄ μ•λμ„, μΉΌλ¦¬μ½”κ°€ μμ²΄ λ§¥μ„ μƒμ„±ν•λ‹¤. λν• νλ“μ™€ cali#(veth pair) λ” **point-to-point routed interfaces** λ¥Ό μ‚¬μ©ν•κΈ° λ•λ¬Έμ— **νΈμ¤νΈμ λ°μ΄ν„°λ§ν¬ λ μ΄μ–΄(L2 Layer) μ— λ„λ‹¬ν•μ§€ μ•μ•„μ„**, λ¨λ“  cali# κ°€ **λ™μΌν• λ§¥ μ£Όμ†λ¥Ό μ‚¬μ©ν•΄λ„ λ¬Έμ κ°€ μ—†λ‹¤**


### λ‹¤λ¥Έ λ…Έλ“μ— μ„μΉν• νλ“ ν†µμ‹ 


λ‹¤λ¥Έ λ…Έλ“μ— μ„μΉν• νλ“ ν†µμ‹ μ„ μ„ν•΄μ„  ν„°λ„λ§μ΄ ν•„μ”ν•λ‹¤. calicoλ” IPIP λ¨λ“λ¥Ό ν†µν•΄ μ΄λ¤„μ§„λ‹¤.

1. ν•΄λ‹Ή νλ“κ°€ λ‹¤λ¥Έ λ…Έλ“μ— μ„μΉν• κ²ƒμ€ Birdμ κ΄‘κ³ λ¥Ό ν†µν•΄ νμ•…ν•λ‹¤.
2. tunl0 μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ IPIP ν„°λ„λ§μ΄ μ§„ν–‰λλ‹¤.

#### νλ“ λ°°ν¬


```bash
cat node2-pod2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: k8s-w1
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  nodeName: k8s-w2
  containers:
  - name: pod2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```


#### interface ν™•μΈ


```bash
root@k8s-m:~# calicoctl get workloadendpoints
WORKLOAD   NODE     NETWORKS          INTERFACE
pod1       k8s-w1   172.16.158.5/32   calice0906292e2
pod2       k8s-w2   172.16.184.1/32   calibd2348b4f67
```


```bash
k get po -o wide
NAME   READY   STATUS    RESTARTS   AGE     IP             NODE     NOMINATED NODE   READINESS GATES
pod1   1/1     Running   0          2m39s   172.16.158.5   k8s-w1   <none>           <none>
pod2   1/1     Running   0          2m39s   172.16.184.1   k8s-w2   <none>           <none>
```


#### νΈμ¤νΈ λΌμ°ν… μ •λ³΄ ν™•μΈ


κ° λ…Έλ“μ— ν•΄λ‹Ήν•λ” λ€μ—­μ€ tunl0 μΈν„°νμ΄μ¤μ™€ μ—°κ²°λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.


```bash
route -n | head -2 ; route -n | grep 172.16.
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.16.34.0     192.168.20.100  255.255.255.0   UG    0      0        0 tunl0
172.16.116.0    0.0.0.0         255.255.255.0   U     0      0        0 *
172.16.116.1    0.0.0.0         255.255.255.255 UH    0      0        0 calic04819f12a9
172.16.116.2    0.0.0.0         255.255.255.255 UH    0      0        0 cali357b53e100c
172.16.116.3    0.0.0.0         255.255.255.255 UH    0      0        0 cali76abd27fd49
172.16.158.0    192.168.10.101  255.255.255.0   UG    0      0        0 tunl0
172.16.184.0    192.168.10.102  255.255.255.0   UG    0      0        0 tunl0
```


#### ping ν†µμ‹  μ§„ν–‰


```bash
kubectl exec pod1 -it -- zsh
ping {pod2 ip}
```


ν†µμ‹ λ ν•‘μ„ tcpdumpλ¥Ό ν†µν•΄ μΊ΅μ²ν•μ—¬ wiresharkλ¥Ό ν†µν•΄ ν™•μΈν–λ‹¤.

- Ipv4 Layerκ°€ 2κ° μλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.
- λ°”κΉ¥μ½μ΄ Node IP λ€μ—­, μ•μ½μ΄ νλ“ IP λ€μ—­μ„ ν™•μΈν•  μ μλ‹¤.

![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /6.png)


ν¨ν‚·μ„ λλ¬ μμ„Έν•κ² μ‚΄ν΄λ³΄λ©΄ IPIP ν”„λ΅ν† μ½λ„ ν™•μΈν•  μ μλ‹¤.


![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /7.png)


### μ™Έλ¶€ ν†µμ‹ 


Iptablesλ¥Ό ν†µν•΄ ν•΄λ‹Ή λ…Έλ“μ IP μ£Όμ†λ΅ NATλμ–΄ μ—°κ²°λλ‹¤. μ΄λ• μ‚¬μ©ν•λ” `MASQUERADE`λ” iptablesμ—μ„ μ‚¬μ©ν•λ” NAT(Network Address Translation)μ ν• ν•νƒλΌκ³  ν•λ‹¤.


#### ν…μ¤νΈ νλ“ λ°°ν¬


```bash
cat node1-pod1.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: k8s-w1
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```


#### μΈν„°νμ΄μ¤ μ •λ³΄ ν™•μΈ


```bash
root@k8s-m:~# calicoctl get workloadEndpoint
WORKLOAD   NODE     NETWORKS          INTERFACE
pod1       k8s-w1   172.16.158.4/32   calice0906292e2
```


#### NAT μ •λ³΄ ν™•μΈ β€MASQUERADEβ€ Rule


```bash
iptables -n -t nat --list cali-nat-outgoing
Chain cali-nat-outgoing (1 references)
target     prot opt source               destination
MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* cali:flqWnvo8yq4ULQLa */ match-set cali40masq-ipam-pools src ! match-set cali40all-ipam-pools dst random-fully
```


#### ipset μ •λ³΄ ν™•μΈ


pod CIDR λ€μ—­μ„μ„ ν™•μΈν•  μ μλ‹¤.


```bash
ipset list cali40masq-ipam-pools
Name: cali40masq-ipam-pools
Type: hash:net
Revision: 7
Header: family inet hashsize 1024 maxelem 1048576 bucketsize 12 initval 0x65107aa4
Size in memory: 504
References: 1
Number of entries: 1
Members:
172.16.0.0/16
```


#### ping ν†µμ‹  μ§„ν–‰


```bash
k exec pod1 -it -- zsh
ping {pod2 ip}
```

- cali# μΈν„°νμ΄μ¤ μ‚¬μ©μ λ¬΄ ν™•μΈ

![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /8.png)

- νΈμ¤νΈ eth μΈν„°νμ΄μ¤ μ‚¬μ©μ λ¬΄ ν™•μΈ

![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /9.png)


calico μ„¤μ •μ„ natOutgoing: false λ΅ λ³€κ²½ν•λ©΄ μ™Έλ¶€μ™€μ ν†µμ‹ μ΄ λ§‰νλ‹¤. μ•„λμ μ½”λ“λ¥Ό ν†µν•΄ ν™•μΈν•΄λ³Ό μ μλ‹¤.


```bash
calicoctl get ippool default-ipv4-ippool -o yaml | sed -e "s/natOutgoing: true/natOutgoing: false/" | calicoctl apply -f -
```


λ³€κ²½ ν›„ NAT Ruleμ΄ μ—†μ–΄μ§„ κ²ƒ ν™•μΈ


![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /10.png)


pingμ„ ν†µν•΄ μ™Έλ¶€μ™€ ν†µμ‹ μ΄ λ¶κ°€λ¥ν• κ²ƒμ„ μ•„λμ™€ κ°™μ΄ ν™•μΈν•  μ μλ‹¤.


![image.png](/assets/img/post/Calico%20νλ“%20ν†µμ‹ /11.png)

