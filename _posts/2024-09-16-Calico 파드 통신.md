---
layout: post
title: Calico íŒŒë“œ í†µì‹  ì•Œì•„ë³´ê¸°
date: 2024-09-15 09:01 +0900 
description: Calico íŒŒë“œ í†µì‹  ì•Œì•„ë³´ê¸°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#3] 
pin: false
math: true
mermaid: true
---
Calico íŒŒë“œ í†µì‹  ì•Œì•„ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


## Calico í†µì‹  ë°©ì‹


Calico ì´í•´í•˜ê¸° í¬ìŠ¤íŒ…ì—ì„œëŠ” Calicoì˜ ì•„í‚¤í…ì²˜ì™€ Componentì— ëŒ€í•´ ì•Œì•„ë³¼ ìˆ˜ ìˆì—ˆë‹¤. ì—¬ê¸°ì„œëŠ” êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–»ê²Œ íŒŒë“œ í†µì‹ ì„ ì§€ì›í•˜ëŠ”ì§€ ì•Œì•„ë³¸ë‹¤.


### ê°™ì€ ë…¸ë“œì— ìœ„ì¹˜í•œ íŒŒë“œ í†µì‹ 


íŒŒë“œì™€ ë„¤íŠ¸ì›Œí¬ í†µì‹  íë¦„ì€ ì•„ë˜ì™€ ê°™ë‹¤.

1. íŒŒë“œì—ì„œ ê²Œì´íŠ¸ì›¨ì´ë¡œ íŒ¨í‚· ì „ì†¡ ì‹œë„
2. calico# ì¸í„°í˜ì´ìŠ¤ì—ì„œ proxy arpë¡œ ìì‹ ì˜ MAC ì •ë³´ë¥¼ ì¤Œ
3. í˜¸ìŠ¤íŠ¸ë¡œ íŒ¨í‚·ì´ ì˜®ê²¨ì§€ê³  iptablesë¥¼ í†µí•´ ì•Œë§ì€ íŒŒë“œì—ê²Œ ë¼ìš°íŒ…

![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /1.png)


#### ì‹¤ìŠµ ì§„í–‰


ê°™ì€ ë…¸ë“œì— íŒŒë“œ 2ê°œ ë°°í¬


```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: k8s-w1
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  nodeName: k8s-w1
  containers:
  - name: pod2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```

- íŒŒë“œ ì •ë³´ í™•ì¸

```bash
(âˆ|HomeLab:N/A) root@k8s-m:~# k get pods -o wide
NAME   READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES
pod1   1/1     Running   0          33s   172.16.158.3   k8s-w1   <none>           <none>
pod2   1/1     Running   0          33s   172.16.158.2   k8s-w1   <none>           <none>
(âˆ|HomeLab:N/A) root@k8s-m:~# calicoctl get workloadendpoints
WORKLOAD   NODE     NETWORKS          INTERFACE
pod1       k8s-w1   172.16.158.3/32   calice0906292e2
pod2       k8s-w1   172.16.158.2/32   calibd2348b4f67
```

- ARP ì •ë³´ í™•ì¸

```bash
ip -c -s neigh
192.168.10.101 dev eth0 lladdr ee:ee:ee:ee:ee:ee  used 451/511/451probes 0 STALE
169.254.1.1 dev eth0 lladdr ee:ee:ee:ee:ee:ee  used 159/159/131probes 1 STALE
```


ì´ì œ íŒŒë“œ1ì— ì ‘ì†í•˜ì—¬, íŒŒë“œ2ì—ê²Œ ping í†µì‹ ì„ ì‹œë„í•œë‹¤.


```bash
kubectl exec pod1 -it -- zsh
ping {pod2 IP}
```

- pingì„ ì§„í–‰í•˜ë©´ì„œ tcpdumpë¥¼ í†µí•´ ìœ„ì—ì„œ í™•ì¸ calico# ì¸í„°í˜ì´ìŠ¤ í™•ì¸
	- calico# ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ í†µì‹ ì´ ì§„í–‰ë˜ëŠ” ê²ƒ í™•ì¸

![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /2.png)


í•´ë‹¹ dumpë¥¼ í†µí•´ ì™€ì´ì–´ìƒ¤í¬ ë‚´ìš©ì„ ë³´ë©´, POD2ê°€ ê²Œì´íŠ¸ì›¨ì´ ì ‘ì†ì •ë³´ë¥¼ ë¬¼ì–´ë³´ê³ , calico interfaceê°€ ee:ee:ee:ee:ee:eeë¼ê³  ì•Œë ¤ì£¼ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

- ì•„ë˜ëŠ” VETH2ì— ë¤í”„ë¥¼ ëœ¬ ëª¨ìŠµì´ë‹¤.
1. ê²Œì´íŠ¸ì›¨ì´ ì •ë³´(169.254.1.1)ì— ëŒ€í•œ ì§ˆì˜ë¥¼ cali# MACì£¼ì†Œë¡œ ì‘ë‹µ
2. pod2ê°€ ìì‹ ì˜ arp ì •ë³´ ì§ˆì˜ì— ìì‹ ì˜ MAC ì£¼ì†Œë¡œ ì‘ë‹µ

![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /3.png)


ì´ì œ ARP í…Œì´ë¸”ì„ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€ëë‹¤.


![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /4.png)


ë˜í•œ ip link showë¥¼ í†µí•´ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ cali# ì¸í„°í˜ì´ìŠ¤ëŠ” ë™ì¼í•œ ë§¥ ì£¼ì†Œ ee:ee:ee:ee:ee:ee ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆëŠ”ë°


![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /5.png)


ìŠ¤í„°ë””ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ì„¤ëª…í•´ì£¼ì…¨ë‹¤.


**ì¼ë¶€ ì»¤ë„ì´ ê³ ì • ë§¥ ì£¼ì†Œ ìƒì„±ì´ ì•ˆë˜ì„œ, ì¹¼ë¦¬ì½”ê°€ ìì²´ ë§¥ì„ ìƒì„±í•œë‹¤. ë˜í•œ íŒŒë“œì™€ cali#(veth pair) ëŠ” **point-to-point routed interfaces** ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— **í˜¸ìŠ¤íŠ¸ì˜ ë°ì´í„°ë§í¬ ë ˆì´ì–´(L2 Layer) ì— ë„ë‹¬í•˜ì§€ ì•Šì•„ì„œ**, ëª¨ë“  cali# ê°€ **ë™ì¼í•œ ë§¥ ì£¼ì†Œë¥¼ ì‚¬ìš©í•´ë„ ë¬¸ì œê°€ ì—†ë‹¤**


### ë‹¤ë¥¸ ë…¸ë“œì— ìœ„ì¹˜í•œ íŒŒë“œ í†µì‹ 


ë‹¤ë¥¸ ë…¸ë“œì— ìœ„ì¹˜í•œ íŒŒë“œ í†µì‹ ì„ ìœ„í•´ì„  í„°ë„ë§ì´ í•„ìš”í•˜ë‹¤. calicoëŠ” IPIP ëª¨ë“œë¥¼ í†µí•´ ì´ë¤„ì§„ë‹¤.

1. í•´ë‹¹ íŒŒë“œê°€ ë‹¤ë¥¸ ë…¸ë“œì— ìœ„ì¹˜í•œ ê²ƒì€ Birdì˜ ê´‘ê³ ë¥¼ í†µí•´ íŒŒì•…í•œë‹¤.
2. tunl0 ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ IPIP í„°ë„ë§ì´ ì§„í–‰ëœë‹¤.

#### íŒŒë“œ ë°°í¬


```bash
cat node2-pod2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: k8s-w1
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  nodeName: k8s-w2
  containers:
  - name: pod2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```


#### interface í™•ì¸


```bash
root@k8s-m:~# calicoctl get workloadendpoints
WORKLOAD   NODE     NETWORKS          INTERFACE
pod1       k8s-w1   172.16.158.5/32   calice0906292e2
pod2       k8s-w2   172.16.184.1/32   calibd2348b4f67
```


```bash
k get po -o wide
NAME   READY   STATUS    RESTARTS   AGE     IP             NODE     NOMINATED NODE   READINESS GATES
pod1   1/1     Running   0          2m39s   172.16.158.5   k8s-w1   <none>           <none>
pod2   1/1     Running   0          2m39s   172.16.184.1   k8s-w2   <none>           <none>
```


#### í˜¸ìŠ¤íŠ¸ ë¼ìš°íŒ… ì •ë³´ í™•ì¸


ê° ë…¸ë“œì— í•´ë‹¹í•˜ëŠ” ëŒ€ì—­ì€ tunl0 ì¸í„°í˜ì´ìŠ¤ì™€ ì—°ê²°ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
route -n | head -2 ; route -n | grep 172.16.
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.16.34.0     192.168.20.100  255.255.255.0   UG    0      0        0 tunl0
172.16.116.0    0.0.0.0         255.255.255.0   U     0      0        0 *
172.16.116.1    0.0.0.0         255.255.255.255 UH    0      0        0 calic04819f12a9
172.16.116.2    0.0.0.0         255.255.255.255 UH    0      0        0 cali357b53e100c
172.16.116.3    0.0.0.0         255.255.255.255 UH    0      0        0 cali76abd27fd49
172.16.158.0    192.168.10.101  255.255.255.0   UG    0      0        0 tunl0
172.16.184.0    192.168.10.102  255.255.255.0   UG    0      0        0 tunl0
```


#### ping í†µì‹  ì§„í–‰


```bash
kubectl exec pod1 -it -- zsh
ping {pod2 ip}
```


í†µì‹ ëœ í•‘ì„ tcpdumpë¥¼ í†µí•´ ìº¡ì²˜í•˜ì—¬ wiresharkë¥¼ í†µí•´ í™•ì¸í–ˆë‹¤.

- Ipv4 Layerê°€ 2ê°œ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- ë°”ê¹¥ìª½ì´ Node IP ëŒ€ì—­, ì•ˆìª½ì´ íŒŒë“œ IP ëŒ€ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /6.png)


íŒ¨í‚·ì„ ëˆŒëŸ¬ ìì„¸í•˜ê²Œ ì‚´í´ë³´ë©´ IPIP í”„ë¡œí† ì½œë„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /7.png)


### ì™¸ë¶€ í†µì‹ 


Iptablesë¥¼ í†µí•´ í•´ë‹¹ ë…¸ë“œì˜ IP ì£¼ì†Œë¡œ NATë˜ì–´ ì—°ê²°ëœë‹¤. ì´ë•Œ ì‚¬ìš©í•˜ëŠ” `MASQUERADE`ëŠ” iptablesì—ì„œ ì‚¬ìš©í•˜ëŠ” NAT(Network Address Translation)ì˜ í•œ í˜•íƒœë¼ê³  í•œë‹¤.


#### í…ŒìŠ¤íŠ¸ íŒŒë“œ ë°°í¬


```bash
cat node1-pod1.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  nodeName: k8s-w1
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
```


#### ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸


```bash
root@k8s-m:~# calicoctl get workloadEndpoint
WORKLOAD   NODE     NETWORKS          INTERFACE
pod1       k8s-w1   172.16.158.4/32   calice0906292e2
```


#### NAT ì •ë³´ í™•ì¸ â€œMASQUERADEâ€ Rule


```bash
iptables -n -t nat --list cali-nat-outgoing
Chain cali-nat-outgoing (1 references)
target     prot opt source               destination
MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* cali:flqWnvo8yq4ULQLa */ match-set cali40masq-ipam-pools src ! match-set cali40all-ipam-pools dst random-fully
```


#### ipset ì •ë³´ í™•ì¸


pod CIDR ëŒ€ì—­ì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
ipset list cali40masq-ipam-pools
Name: cali40masq-ipam-pools
Type: hash:net
Revision: 7
Header: family inet hashsize 1024 maxelem 1048576 bucketsize 12 initval 0x65107aa4
Size in memory: 504
References: 1
Number of entries: 1
Members:
172.16.0.0/16
```


#### ping í†µì‹  ì§„í–‰


```bash
k exec pod1 -it -- zsh
ping {pod2 ip}
```

- cali# ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©ìœ ë¬´ í™•ì¸

![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /8.png)

- í˜¸ìŠ¤íŠ¸ eth ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©ìœ ë¬´ í™•ì¸

![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /9.png)


calico ì„¤ì •ì„ natOutgoing: false ë¡œ ë³€ê²½í•˜ë©´ ì™¸ë¶€ì™€ì˜ í†µì‹ ì´ ë§‰íŒë‹¤. ì•„ë˜ì˜ ì½”ë“œë¥¼ í†µí•´ í™•ì¸í•´ë³¼ ìˆ˜ ìˆë‹¤.


```bash
calicoctl get ippool default-ipv4-ippool -o yaml | sed -e "s/natOutgoing: true/natOutgoing: false/" | calicoctl apply -f -
```


ë³€ê²½ í›„ NAT Ruleì´ ì—†ì–´ì§„ ê²ƒ í™•ì¸


![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /10.png)


pingì„ í†µí•´ ì™¸ë¶€ì™€ í†µì‹ ì´ ë¶ˆê°€ëŠ¥í•œ ê²ƒì„ ì•„ë˜ì™€ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Calico%20íŒŒë“œ%20í†µì‹ /11.png)

