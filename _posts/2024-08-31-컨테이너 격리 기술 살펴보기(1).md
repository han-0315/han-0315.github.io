---
layout: post
title: Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° Part1
date: 2024-08-31 09:00 +0900 
description: Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° Part1
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#1] 
pin: false
math: true
mermaid: true
---
Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° Part 1: ë””ë ‰í„°ë¦¬ ê²©ë¦¬
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.




ì•„ë˜ì˜ ë‚´ìš©ì€ [Kakao](https://netpple.github.io/docs/make-container-without-docker/ifkakao2022-handson) ë°œí‘œìë£Œì™€ [ì˜ìƒ](https://www.youtube.com/watch?v=mSD88FuST80)ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


### ë“¤ì–´ê°€ë©°


**ì»¨í…Œì´ë„ˆëŠ” ë…¼ë¦¬ì ìœ¼ë¡œ ì˜ ê²©ë¦¬ëœ í”„ë¡œì„¸ìŠ¤**ì´ë‹¤. ì´ë²ˆ ì‹œë¦¬ì¦ˆì—ì„œëŠ” ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ ë§Œë“¤ê¸° ìœ„í•´ í•„ìš”í•œ í•„ìš”í•œ **í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ **ì„ í•˜ë‚˜ì”© ì•Œì•„ë³´ê³  ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ë©° ì»¨í…Œì´ë„ˆë¥¼ ì´í•´í•œë‹¤. 


ìš°ì„  ì»¨í…Œì´ë„ˆê°€ ë˜ê¸° ìœ„í•´ì„œëŠ” **ë””ë ‰í„°ë¦¬ ê²©ë¦¬, ìì› í• ë‹¹ëŸ‰ ì œí•œ, í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬**ê°€ í•„ìˆ˜ì ìœ¼ë¡œ í•„ìš”í•˜ë‹¤. ìˆœì„œëŒ€ë¡œ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ê²©ë¦¬í•˜ëŠ” ë°©ë²•, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í†µí•´ í”„ë¡œì„¸ìŠ¤ë¥¼ ê²©ë¦¬í•˜ëŠ” ë°©ë²•, ìì›í• ë‹¹ëŸ‰ì„ ì¡°ì ˆí•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³¼ ì˜ˆì •ì´ë‹¤.


ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.


---

- ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ê²©ë¦¬
	- chroot ê²©ë¦¬ ê¸°ìˆ 
		- íƒˆì˜¥ ê°€ëŠ¥ì—¬ë¶€ í™•ì¸
	- pivot_root + mount namespaceë¥¼ í†µí•œ ê²©ë¦¬
		- íƒˆì˜¥ ê°€ëŠ¥ì—¬ë¶€ í™•ì¸
- ë„¤ì„ìŠ¤í˜ì´ìŠ¤
	- Process
	- User
	- etc
- ìì› ê²©ë¦¬
	- cgroup
	- docker ì˜µì…˜

---


## ê²©ë¦¬ ê¸°ìˆ  History


![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(1)/1.png)


ì¶œì²˜: [https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=200](https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=200)


## ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ê²©ë¦¬


ë””ë ‰í„°ë¦¬ë¥¼ ê²©ë¦¬í•˜ëŠ” ë°©ë²•ì€ chrootê°€ ìˆë‹¤. ìœ„ì˜ historyë¥¼ í™•ì¸í•´ë³´ë©´ 1979ë…„ì— ë‚˜ì˜¨ ì˜¤ë˜ëœ ê¸°ëŠ¥ì´ë‹¤. í•˜ì§€ë§Œ, íƒˆì˜¥ ì´ìŠˆê°€ ìˆì–´ í˜„ì¬ëŠ” pivot_rootì™€ Mount namespace ê¸°ìˆ ì„ ì´ìš©í•´ ì‘ì—… í™˜ê²½ì„ ê²©ë¦¬í•œë‹¤ê³  í•œë‹¤.


### chroot


ì•„ë˜ì—ì„œ chrootë¥¼ ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ë©° ìì„¸íˆ ì•Œì•„ë³¸ë‹¤.


#### ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ê²©ë¦¬ í™•ì¸

- ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±(bin/sh, bin/ls ë“± í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ì „ì— ê°€ì ¸ì˜¨ë‹¤.)

```bash
cd /tmp
# í•„ìš”í•œ ì‹¤í–‰íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
mkdir -p myroot/bin
cp /usr/bin/sh myroot/bin/
cp /usr/bin/ls myroot/bin/
# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
mkdir -p myroot/{lib64,lib/x86_64-linux-gnu}
cp /lib/x86_64-linux-gnu/{libselinux.so.1,libc.so.6,libpcre2-8.so.0} myroot/lib/x86_64-linux-gnu/
cp /lib64/ld-linux-x86-64.so.2 myroot/lib64

```

- ì‹¤ìŠµ í™˜ê²½ í™•ì¸(`ls`, `sh` ì‹¤í–‰íŒŒì¼ì´ ë“¤ì–´ì™€ìˆë‹¤.)

```bash
root@MyServer:/tmp# tree myroot/
myroot/
â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ ls
â”‚Â Â  â””â”€â”€ sh
â”œâ”€â”€ lib
â”‚Â Â  â””â”€â”€ x86_64-linux-gnu
â”‚Â Â      â”œâ”€â”€ libc.so.6
â”‚Â Â      â”œâ”€â”€ libpcre2-8.so.0
â”‚Â Â      â””â”€â”€ libselinux.so.1
â””â”€â”€ lib64
    â””â”€â”€ ld-linux-x86-64.so.2

4 directories, 6 files
```

- chroot ì§„í–‰. ë£¨íŠ¸ë””ë ‰í„°ë¦¬ ê²©ë¦¬ í™•ì¸

```bash
root@MyServer:/tmp# chroot myroot /bin/sh
# ls
bin  lib  lib64
# cd ../../../
# ls
bin  lib  lib64
```


ìœ„ì˜ ì‹¤ìŠµì„ í†µí•´ í˜¸ìŠ¤íŠ¸ì˜ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¡œ ë¹ ì ¸ë‚˜ê°€ì§€ ëª»í•˜ê³  /tmp/myrootë¡œ ê²©ë¦¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


ì´ì œ **íƒˆì˜¥ ì‹¤ìŠµ**ì— í•„ìš”í•œ ì •ë³´ë¥¼ ë„£ì–´ë‘”ë‹¤.


```bash
root@MyServer:/tmp# tree myroot
myroot
â”œâ”€â”€ bin
â”‚Â Â  â”œâ”€â”€ ls
â”‚Â Â  â”œâ”€â”€ mkdir
â”‚Â Â  â”œâ”€â”€ mount
â”‚Â Â  â”œâ”€â”€ ps
â”‚Â Â  â””â”€â”€ sh
â”œâ”€â”€ lib
â”‚Â Â  â””â”€â”€ x86_64-linux-gnu
â”‚Â Â      â”œâ”€â”€ libblkid.so.1
â”‚Â Â      â”œâ”€â”€ libc.so.6
â”‚Â Â      â”œâ”€â”€ libcap.so.2
â”‚Â Â      â”œâ”€â”€ libgcrypt.so.20
â”‚Â Â      â”œâ”€â”€ libgpg-error.so.0
â”‚Â Â      â”œâ”€â”€ liblzma.so.5
â”‚Â Â      â”œâ”€â”€ libmount.so.1
â”‚Â Â      â”œâ”€â”€ libpcre2-8.so.0
â”‚Â Â      â”œâ”€â”€ libprocps.so.8
â”‚Â Â      â”œâ”€â”€ libselinux.so.1
â”‚Â Â      â”œâ”€â”€ libsystemd.so.0
â”‚Â Â      â””â”€â”€ libzstd.so.1
â”œâ”€â”€ lib64
â”‚Â Â  â””â”€â”€ ld-linux-x86-64.so.2
â””â”€â”€ usr
    â””â”€â”€ lib
        â””â”€â”€ x86_64-linux-gnu
            â””â”€â”€ liblz4.so.1

7 directories, 19 files
```

- ps ëª…ë ¹ì–´ëŠ” /proc ê°€ ë§ˆìš´íŠ¸ë˜ì–´ì•¼ í•œë‹¤.(ìœ„ì—ì„œ `/proc` ë””ë ‰í„°ë¦¬ë¥¼ í†µí•´ ì»¤ë„ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•œë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.)

```bash
root@MyServer:/tmp# chroot myroot /bin/sh
# ps
Error, do this: mount -t proc proc /proc

```

- ë§ˆìš´íŠ¸ë¥¼ ì§„í–‰í•œë‹¤.

```bash
# mount -t proc proc /proc
mount: /proc: mount point does not exist.
# mkdir /proc
# mount -t proc proc /proc
# ps
    PID TTY          TIME CMD
   6263 ?        00:00:00 sudo
   6264 ?        00:00:00 su
   6265 ?        00:00:00 bash
   6360 ?        00:00:00 sh
   6365 ?        00:00:00 ps
# ps auf
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
1000        6054  0.0  0.3   9924  5888 ?        Ss   16:11   0:00 bash --rcfile /dev/fd/63
0           6262  0.0  0.2  11904  5632 ?        S+   16:12   0:00  \_ sudo su -
0           6263  0.0  0.1  11904  2428 ?        Ss   16:12   0:00      \_ sudo su -
0           6264  0.0  0.2  10636  4736 ?        S    16:12   0:00          \_ su -
0           6265  0.0  0.2   9228  5376 ?        S    16:12   0:00              \_ -bash
0           6360  0.0  0.0   2892  1664 ?        S    16:17   0:00                  \_ /bin/sh
0           6366  0.0  0.1   7064  3072 ?        R+   16:17   0:00                      \_ ps auf
1000        5859  0.0  0.3   9924  5888 ?        Ss+  16:11   0:00 bash --rcfile /dev/fd/63
0            571  0.0  0.1   6176  2048 ?        Ss+  15:34   0:00 /sbin/agetty -o -p -- \u --noclear tty1 linux
0            557  0.0  0.1   6220  2304 ?        Ss+  15:34   0:00 /sbin/agetty -o -p -- \u --keep-baud 115200,576
```


#### íƒˆì˜¥ í™•ì¸


íƒˆì˜¥ ì½”ë“œë¥¼ í†µí•´ íƒˆì˜¥ì„ ì§„í–‰í•œë‹¤.

- íƒˆì˜¥ ì½”ë“œ

ì½”ë“œì— ëŒ€í•´ ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•˜ë©´, â€œ.outâ€ ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ê³ , í•´ë‹¹ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ chrootë¥¼ ì‹¤í–‰í•œë‹¤.


ê²½ë¡œë¥¼ ìµœìƒìœ„(`../../../../../`)ë¡œ ë°”ê¾¸ê³ , í•´ë‹¹ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ chrootë¥¼ ì‹¤í–‰í•œë‹¤.


```c++
#include <sys/stat.h>
#include <unistd.h>

int main(void)
{
  mkdir(".out", 0755);
  chroot(".out");
  chdir("../../../../../");
  chroot(".");

  return execl("/bin/sh", "-i", NULL);
}
```

- ì»´íŒŒì¼

```bash
gcc -o myroot/escape_chroot escape_chroot.c
```

- íƒˆì˜¥ì½”ë“œê°€ ìˆëŠ” ìƒíƒœì—ì„œ chrootë¥¼ ì‹¤í–‰í•œë‹¤.

```bash
tree -L 1 myroot
myroot
â”œâ”€â”€ bin
â”œâ”€â”€ escape_chroot
â”œâ”€â”€ lib
â”œâ”€â”€ lib64
â”œâ”€â”€ proc
â””â”€â”€ usr
```

- ì•„ë˜ì™€ ê°™ì´ íƒˆì˜¥ì´ ê°€ëŠ¥í•˜ë‹¤.

íƒˆì˜¥ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¨ ë’¤ lsë¥¼ ë³´ë©´ í˜¸ìŠ¤íŠ¸ì˜ ìµœìƒìœ„ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
sudo chroot myroot /bin/sh
# ls
bin  escape_chroot  lib  lib64	proc  usr
# cd ../../../
# ls
bin  escape_chroot  lib  lib64	proc  usr
# ./escape_chroot
# ls
bin   dev  home  lib32	libx32	    media  opt	 root  sbin  srv  tmp  var
boot  etc  lib	 lib64	lost+found  mnt    proc  run   snap  sys  usr
```


ì´ë ‡ë“¯ íƒˆì˜¥ ì´ìŠˆë¡œ ì¸í•´ ì»¨í…Œì´ë„ˆì—ì„œëŠ” chrootë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì•„ë˜ì˜ `pivot_root + mount namespace` ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤.


### **Pivot_root + mount namespace(host ì˜í–¥ ê²©ë¦¬)**


Pivot_root ëª…ë ¹ì–´ë¥¼ í†µí•´, ë£¨íŠ¸ íŒŒì¼ì‹œìŠ¤í…œê³¼ ë§ˆìš´íŠ¸ íŒŒì¼ì‹œìŠ¤í…œì˜ ë…¼ë¦¬ì ì¸ ìœ„ì¹˜ë¥¼ ë°”ê¿€ ìˆ˜ ìˆë‹¤. 


Pivot_rootëŠ” ì‹¤ì œë¡œ rootì™€ mount íŒŒì¼ì‹œìŠ¤í…œì˜ ìœ„ì¹˜ë¥¼ ë°”ê¾¸ëŠ” ê°œë…ìœ¼ë¡œ ê°€ìƒìœ¼ë¡œë§Œ ì‘ë™í•˜ëŠ” chrootì™€ ë¹„êµëœë‹¤. ë‹¹ì—°í•˜ê² ì§€ë§Œ, ì‹¤ì œ íŒŒì¼ì‹œìŠ¤í…œ ìœ„ì¹˜ë¥¼ ë³€ê²½í•˜ë¯€ë¡œ í˜¸ìŠ¤íŠ¸ì—ë„ ì˜í–¥ì´ ê°„ë‹¤.


![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(1)/2.png)


**ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ë¥¼ í†µí•´ **ë§ˆìš´íŠ¸ í™˜ê²½ì„ ê²©ë¦¬**í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì— **ì˜í–¥ë„ë¥¼ ì œê±°í•  ìˆ˜ ìˆë‹¤.**

1. ë§ˆìš´íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì§„í–‰í•˜ì—¬, ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì˜ ë§ˆìš´íŠ¸ ë‚´ìš©ì„ ë³µì‚¬í•œë‹¤.
2. ìì‹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì—ì„œ ì»¨í…Œì´ë„ˆ íŒŒì¼ì‹œìŠ¤í…œì„ ë§ˆìš´íŠ¸í•œë‹¤.
3. ìì‹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì—ì„œ pivot_rootë¥¼ ì§„í–‰í•˜ë©´, ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ê°€ ë³€ê²½ëœë‹¤.
4. pivot rootëŠ” ê°€ìƒìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²Œ ì•„ë‹ˆê¸°ì— íƒˆì˜¥ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

ì´ì œ ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ì. ì‹¤ìŠµì— ì‚¬ìš©í•  ëª…ë ¹ì–´ë¥¼ ë¯¸ë¦¬ ì‚´í´ë³´ì.

- `unshare` ëª…ë ¹ì–´ë¥¼ í†µí•´ ê²©ë¦¬ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤. ex) `unshare --mount /bin/sh`
- `pivot_root` new-rootì™€ old-rootê°€ pivotëœë‹¤. ex) pivot_root [new-root] [old-root]

#### ì‹¤ìŠµ

- ë³„ë„ì˜ mountë¥¼ í•˜ë‚˜ ìƒì„±í•œë‹¤.

```bash
mkdir new_root
mount -t tmpfs none new_root

df -h
Filesystem       Size  Used Avail Use% Mounted on
/dev/root         29G  3.1G   26G  11% /
tmpfs            951M     0  951M   0% /dev/shm
efivarfs         128K  3.6K  120K   3% /sys/firmware/efi/efivars
tmpfs            381M  884K  380M   1% /run
tmpfs            5.0M     0  5.0M   0% /run/lock
tmpfs            191M  4.0K  191M   1% /run/user/1000
/dev/nvme0n1p15  105M  6.1M   99M   6% /boot/efi
none             951M     0  951M   0% /new_root
```

- new_root/put_oldë¥¼ ìƒì„±í•œ ë’¤, pivotì„ ì§„í–‰í•œë‹¤.

```bash
$ pivot_root . put_old
```


íŒŒì¼ì‹œìŠ¤í…œì´ pivotëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
# cd /
# ls
bin  escape_chroot  lib  lib64	proc  put_old
# ls put_old
bin   dev  home  lib32	libx32	    media  new_root  proc  run	 snap  sys  usr
boot  etc  lib	 lib64	lost+found  mnt    opt	     root  sbin  srv   tmp  var
```

- íƒˆì˜¥ í…ŒìŠ¤íŠ¸

ê°€ìƒì´ ì•„ë‹Œ ì‹¤ì œ íŒŒì¼ì‹œìŠ¤í…œì´ pivotì´ ëœ ê²ƒì´ê¸°ì—, íƒˆì˜¥ì— ì‹¤íŒ¨í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
# ./escape_chroot
# cd ../../../
# ls /
bin  escape_chroot  lib  lib64	proc  put_old
# exit
```


### ë§ˆì¹˜ë©°


ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ê²©ë¦¬í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì‚¬ìš©ëœ ë°©ë²•ì„ ì•Œì•„ë´¤ë‹¤. ì™œ chrootëŠ” ê²©ë¦¬ê¸°ìˆ ë¡œ ì í•©í•˜ì§€ ì•Šì€ì§€ íƒˆì˜¥ ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ë©° ì•Œ ìˆ˜ ìˆì—ˆë‹¤. ì´ì œ ë‹¤ìŒ í¸ì—ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‚´í´ë³¼ ì˜ˆì •ì´ë‹¤.

