---
layout: post
title: ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬ ì´í•´í•˜ê¸°
date: 2024-01-12 15:00 +0900 
description: ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬ ì´í•´í•˜ê¸°
category: [Kubernetes, Network] 
tags: [Kubernetes, Services, Network, CNI, Flannel] 
pin: true
math: true
mermaid: true
---
ì‚½ì§ˆì„ í†µí•´ ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬ ì´í•´í•˜ê¸°
<!--more-->


## Services


íŒŒë“œì—ì„œ ì¥ì• ê°€ ë°œìƒí•˜ë©´, DeploymentëŠ” í•´ë‹¹ íŒŒë“œë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œìš´ íŒŒë“œë¥¼ ìƒì„±í•œë‹¤. ì´ì²˜ëŸ¼ íŒŒë“œëŠ” ì‰½ê²Œ ëŒ€ì²´ë  ìˆ˜ ìˆëŠ” ì¡´ì¬ì´ë‹¤. Pod to Pod ë„¤íŠ¸ì›Œí¬ë§Œìœ¼ë¡œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ì‹œìŠ¤í…œì´ ë‚´êµ¬ì„±ì´ ìˆë‹¤ê³  ë§í•  ìˆ˜ ì—†ê³  í•œë‹¤. ê°€ì¥ í° ë¬¸ì œëŠ” íŒŒë“œì˜ IPë¡œ ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì„±í•  ê²½ìš°, íŒŒë“œê°€ ì¬ìƒì„±ë˜ë©´ IPê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆê¸°ì— ë¬¸ì œê°€ ë°œìƒí•œë‹¤. ê·¸ë ‡ê¸°ì— Serviceë¼ëŠ” í”„ë¡ì‹œì„œë²„ë¥¼ ë‘ì–´, í˜„ì¬ ë™ì‘ ì¤‘ì¸ íŒŒë“œì— ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.


í”„ë¡ì‹œ ì„œë²„ëŠ” ì¦‰, ì„œë¹„ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•´ì•¼ í•œë‹¤.

1. ìŠ¤ìŠ¤ë¡œ ë‚´êµ¬ì„±ì´ ìˆì–´ì•¼ í•˜ë©°, ì¥ì• ì— ëŒ€ì‘í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.(ê°€ìš©ì„±)
2. íŠ¸ë˜í”½ì„ ì „ë‹¬í•  ì„œë²„ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•œë‹¤.(EndPoint)
3. ì„œë²„ ë¦¬ìŠ¤íŠ¸ ë‚´ ì„œë²„ë“¤ì´ ì •ìƒì ì¸ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì•Œì•„ì•¼ í•œë‹¤.(Health Check)

í˜„ì¬ì˜ ì„œë¹„ìŠ¤ëŠ” ìœ„ì˜ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•œë‹¤. ì–´ë–¤ ë¶„ì€ ì•„ë˜ì™€ ê°™ì€ ë§ì„ í•œë‹¤.


> ì¿ ë²„ë„¤í‹°ìŠ¤ ê°œë°œìë“¤ì€ Serviceë¼ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í†µí•´ ì´ ë¬¸ì œë¥¼ ìš°ì•„í•˜ê²Œ í•´ê²°í–ˆë‹¤.


ê·¸ë ‡ë‹¤ë©´ ì„œë¹„ìŠ¤ëŠ” ì–´ë–»ê²Œ ë™ì‘í• ê¹Œ? 


ì„œë¹„ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì„¤ëª…í•˜ë©´, ì„œë¹„ìŠ¤ ìœ í˜•ì€ ClusterIP, NodePort, LBê°€ ìˆìœ¼ë©° ëª¨ë‘ íŠ¸ë˜í”½ì„ íŒŒë“œì—ê²Œ ì „ë‹¬í•´ì¤€ë‹¤. ì„œë¹„ìŠ¤ëŠ” íŒŒë“œ ë„¤íŠ¸ì›Œí¬ì™€ëŠ” ë‹¤ë¥´ê²Œ vethê³¼ ê°™ì€ ì‹¤ì§ˆì ì¸ ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ë‹¤. ëŒ€ì‹  ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê¸°ëŠ¥ì¸ netfilterë¥¼ í†µí•´ í•´ê²°í•œë‹¤. 


ìš°ì„  netfilterì— ëŒ€í•´ ì•Œì•„ë³¸ë‹¤.


### netfilter


ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê¸°ëŠ¥ ì¤‘ í•˜ë‚˜ì¸Â [netfilter](https://en.wikipedia.org/wiki/Netfilter)ì™€ user spaceì— ì¡´ì¬í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì¸Â [iptables](https://en.wikipedia.org/wiki/Iptables)ë¼ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ì´ìš©í•˜ì—¬ íŒ¨í‚· íë¦„ì„ ì œì–´í•œë‹¤. [netfilter](https://en.wikipedia.org/wiki/Netfilter)ë€ ê·œì¹™ê¸°ë°˜ íŒ¨í‚· ì²˜ë¦¬ ì—”ì§„ì´ë©°, kernel spaceì— ìœ„ì¹˜í•˜ì—¬ ëª¨ë“  ì˜¤ê³  ê°€ëŠ” íŒ¨í‚·ì„ ê´€ì°°í•œë‹¤. ê·¸ë¦¬ê³  ê·œì¹™ì— ë§¤ì¹­ë˜ëŠ” íŒ¨í‚·ì„ ë°œê²¬í•˜ë©´, SRC/DSTë“±ì„ ë°”ê¾¸ëŠ” ë“± ë¯¸ë¦¬ ì •ì˜ëœ í–‰ë™ì„ ìˆ˜í–‰í•œë‹¤.


![1_Pz-NixxBDbSnuPGyp8UWHQ.webp](/assets/img/post/ì„œë¹„ìŠ¤%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë¸%20ì´í•´í•˜ê¸°/1.webp)


[ì¶œì²˜: [https://en.m.wikipedia.org/wiki/File:Netfilter-packet-flow.svg](https://en.m.wikipedia.org/wiki/File:Netfilter-packet-flow.svg)]


ì´ì œ ì•ìœ¼ë¡œ ë¶„ì„í•  ë‚´ìš©ì„ ì œëŒ€ë¡œ íŒŒì•…í•˜ë ¤ë©´, Iptablesì„ ìì„¸íˆ ì•Œì•„ì•¼ í•œë‹¤.


### **iptables**


iptablesëŠ” ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì—ì„œ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì œì–´í•˜ëŠ” ë°©í™”ë²½ ë„êµ¬ì´ë‹¤. ì°¸ê³ í•œ ìë£Œì™€ GPT-4ë¥¼ í†µí•´ ì–»ì€ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.


> ğŸ’¡ **ê´€ë ¨ ì˜µì…˜ ë° ëª…ë ¹ì–´**  
> - **`S`**: í˜„ì¬ ì„¤ì •ëœ iptables ê·œì¹™ì„ ì¶œë ¥í•©ë‹ˆë‹¤.  
>   
> - **`t nat`**: 'nat' í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. NAT(Network Address Translation)ì€ IP íŒ¨í‚·ì˜ TCP/UDP í¬íŠ¸ ë²ˆí˜¸ì™€ ì†ŒìŠ¤ ë° ëª©ì ì§€ IP ì£¼ì†Œë¥¼ ì¬ì‘ì„±í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.  
>   
> - **`N`**: ìƒˆë¡œìš´ ì²´ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`N KUBE-SVC-ERIFXISQEP7F7OF4`**ëŠ” 'KUBE-SVC-ERIFXISQEP7F7OF4'ë¼ëŠ” ì´ë¦„ì˜ ìƒˆ ì²´ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤.  
>   
> - **`A`**: ê·œì¹™ì„ ì²´ì¸ì˜ ëì— ì¶”ê°€í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`A KUBE-EXT-CVG3OEGEH7H5P3HQ -j KUBE-SVC-CVG3OEGEH7H5P3HQ`**ëŠ” 'KUBE-EXT-CVG3OEGEH7H5P3HQ' ì²´ì¸ì˜ ëì— ê·œì¹™ì„ ì¶”ê°€í•˜ë©°, ì´ ê·œì¹™ì€ íŒ¨í‚·ì„ 'KUBE-SVC-CVG3OEGEH7H5P3HQ' ì²´ì¸ìœ¼ë¡œ ì í”„ì‹œí‚µë‹ˆë‹¤.  
>   
> - **`d`**: ëª©ì ì§€ ì£¼ì†Œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`d 10.43.239.29/32`**ëŠ” ëª©ì ì§€ IP ì£¼ì†Œê°€ '10.43.239.29/32'ì¸ íŒ¨í‚·ì— ê·œì¹™ì„ ì ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.  
>   
> - **`-s`** ì˜µì…˜ì€ ì†ŒìŠ¤ IP ì£¼ì†Œë¥¼ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`-s 10.42.0.0/16`**ì€ '10.42.0.0/16' ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‹œì‘í•˜ëŠ” íŒ¨í‚·ì— ê·œì¹™ì´ ì ìš©ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.  
>   
> - **`p`**: í”„ë¡œí† ì½œì„ ì§€ì •í•©ë‹ˆë‹¤. **`p tcp`**ëŠ” TCP í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚·ì— ê·œì¹™ì„ ì ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.  
>   
> - **`m comment`**: comment ëª¨ë“ˆì„ ì‚¬ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. ì´ ëª¨ë“ˆì€ iptables ê·œì¹™ì— ì£¼ì„ì„ ì¶”ê°€í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.  
>   
> - **`-comment`**: comment ëª¨ë“ˆì— ëŒ€í•œ ì˜µì…˜ìœ¼ë¡œ, ì£¼ì„ì„ ì§€ì •í•©ë‹ˆë‹¤.  
>   
> - **`-dport`**: ëŒ€ìƒ í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`-dport 80`**ëŠ” ëŒ€ìƒ í¬íŠ¸ê°€ 80ì¸ íŒ¨í‚·ì— ê·œì¹™ì„ ì ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.  
>   
> - **`j`**: íŒ¨í‚·ì´ ê·œì¹™ì— ì¼ì¹˜í•  ê²½ìš° ìˆ˜í–‰í•  ì‘ì—…ì„ ì§€ì •í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`j KUBE-SVC-UQMCRMJZLI3FTLDP`**ëŠ” íŒ¨í‚·ì„ 'KUBE-SVC-UQMCRMJZLI3FTLDP' ì²´ì¸ìœ¼ë¡œ ì í”„ì‹œí‚¤ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.  
>   
> - **`!`** ê¸°í˜¸ëŠ” ê·¸ ë’¤ì— ì˜¤ëŠ” ì¡°ê±´ì„ ë¶€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,  **`! -s 10.42.0.0/16`**ì€ '10.42.0.0/16' ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” íŒ¨í‚·ì— ê·œì¹™ì´ ì ìš©ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

	- **`S`**: í˜„ì¬ ì„¤ì •ëœ iptables ê·œì¹™ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
	- **`t nat`**: 'nat' í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. NAT(Network Address Translation)ì€ IP íŒ¨í‚·ì˜ TCP/UDP í¬íŠ¸ ë²ˆí˜¸ì™€ ì†ŒìŠ¤ ë° ëª©ì ì§€ IP ì£¼ì†Œë¥¼ ì¬ì‘ì„±í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
	- **`N`**: ìƒˆë¡œìš´ ì²´ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`N KUBE-SVC-ERIFXISQEP7F7OF4`**ëŠ” 'KUBE-SVC-ERIFXISQEP7F7OF4'ë¼ëŠ” ì´ë¦„ì˜ ìƒˆ ì²´ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
	- **`A`**: ê·œì¹™ì„ ì²´ì¸ì˜ ëì— ì¶”ê°€í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`A KUBE-EXT-CVG3OEGEH7H5P3HQ -j KUBE-SVC-CVG3OEGEH7H5P3HQ`**ëŠ” 'KUBE-EXT-CVG3OEGEH7H5P3HQ' ì²´ì¸ì˜ ëì— ê·œì¹™ì„ ì¶”ê°€í•˜ë©°, ì´ ê·œì¹™ì€ íŒ¨í‚·ì„ 'KUBE-SVC-CVG3OEGEH7H5P3HQ' ì²´ì¸ìœ¼ë¡œ ì í”„ì‹œí‚µë‹ˆë‹¤.
	- **`d`**: ëª©ì ì§€ ì£¼ì†Œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`d 10.43.239.29/32`**ëŠ” ëª©ì ì§€ IP ì£¼ì†Œê°€ '10.43.239.29/32'ì¸ íŒ¨í‚·ì— ê·œì¹™ì„ ì ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
	- **`-s`** ì˜µì…˜ì€ ì†ŒìŠ¤ IP ì£¼ì†Œë¥¼ ì§€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`-s 10.42.0.0/16`**ì€ '10.42.0.0/16' ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‹œì‘í•˜ëŠ” íŒ¨í‚·ì— ê·œì¹™ì´ ì ìš©ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
	- **`p`**: í”„ë¡œí† ì½œì„ ì§€ì •í•©ë‹ˆë‹¤. **`p tcp`**ëŠ” TCP í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚·ì— ê·œì¹™ì„ ì ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
	- **`m comment`**: comment ëª¨ë“ˆì„ ì‚¬ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. ì´ ëª¨ë“ˆì€ iptables ê·œì¹™ì— ì£¼ì„ì„ ì¶”ê°€í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
	- **`-comment`**: comment ëª¨ë“ˆì— ëŒ€í•œ ì˜µì…˜ìœ¼ë¡œ, ì£¼ì„ì„ ì§€ì •í•©ë‹ˆë‹¤.
	- **`-dport`**: ëŒ€ìƒ í¬íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`-dport 80`**ëŠ” ëŒ€ìƒ í¬íŠ¸ê°€ 80ì¸ íŒ¨í‚·ì— ê·œì¹™ì„ ì ìš©í•˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
	- **`j`**: íŒ¨í‚·ì´ ê·œì¹™ì— ì¼ì¹˜í•  ê²½ìš° ìˆ˜í–‰í•  ì‘ì—…ì„ ì§€ì •í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, **`j KUBE-SVC-UQMCRMJZLI3FTLDP`**ëŠ” íŒ¨í‚·ì„ 'KUBE-SVC-UQMCRMJZLI3FTLDP' ì²´ì¸ìœ¼ë¡œ ì í”„ì‹œí‚¤ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
	- **`!`** ê¸°í˜¸ëŠ” ê·¸ ë’¤ì— ì˜¤ëŠ” ì¡°ê±´ì„ ë¶€ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,  **`! -s 10.42.0.0/16`**ì€ '10.42.0.0/16' ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” íŒ¨í‚·ì— ê·œì¹™ì´ ì ìš©ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

### ClusterIP


ClusterIPëŠ” í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ì‚¬ìš©ë˜ëŠ” ê³ ì • IPì´ë‹¤. ClusterIPì™€ íŒŒë“œë¥¼ ì—°ê²°í•˜ë©´, í´ëŸ¬ìŠ¤í„° ì–´ë””ì„œë“  í•´ë‹¹ IPë¡œ ì•Œë§ëŠ” íŒŒë“œì— ì ‘ì†í•  ìˆ˜ ìˆë‹¤. 


ì‹¤ìŠµ í™˜ê²½ì€ ë‹¤ìŒê³¼ ê°™ë‹¤. íŒŒë“œëŠ” ë””í”Œë¡œì´ë¨¼íŠ¸ë¡œ ë°°í¬ê°€ ëœ 4ê°œì˜ íŒŒë“œì´ë©°, ì„œë¹„ìŠ¤ëŠ” 4ê°œì˜ íŒŒë“œ ëª©ë¡ì„ ê°€ì§€ê³  ìˆë‹¤. (ì‚¬ì§„ìœ¼ë¡œ í•˜ë ¤ë‹¤ ì‹¤ìŠµì„ ë‹¤ì‹œ í•˜ëŠ” ê²½ìš°ë¥¼ ê³ ë ¤í•˜ì—¬, CodeBlockìœ¼ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.)


![Untitled.png](/assets/img/post/ì„œë¹„ìŠ¤%20ë„¤íŠ¸ì›Œí¬%20ëª¨ë¸%20ì´í•´í•˜ê¸°/2.png)


```bash
$ k get pods -o wide
NAME                           READY   STATUS    RESTARTS   AGE     IP           NODE                                             NOMINATED NODE   READINESS GATES
service-test-cd79b78bd-wtc49   1/1     Running   0          4m49s   10.42.0.44   ip-10-32-11-62.ap-northeast-2.compute.internal   <none>           <none>
service-test-cd79b78bd-pq8bz   1/1     Running   0          4m49s   10.42.0.43   ip-10-32-11-62.ap-northeast-2.compute.internal   <none>           <none>
service-test-cd79b78bd-bkr52   1/1     Running   0          4m49s   10.42.1.42   ip-10-32-7-224.ap-northeast-2.compute.internal   <none>           <none>
service-test-cd79b78bd-82rpx   1/1     Running   0          4m49s   10.42.1.41   ip-10-32-7-224.ap-northeast-2.compute.internal   <none>           <none>
$ k get svc
NAME           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
kubernetes     ClusterIP   10.43.0.1      <none>        443/TCP   41h
service-test   ClusterIP   10.43.62.130   <none>        80/TCP    4m51s
$ k get nodes -o wide
NAME                                             STATUS   ROLES                  AGE    VERSION        INTERNAL-IP   EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME
ip-10-32-7-224.ap-northeast-2.compute.internal   Ready    <none>                 2d     v1.27.3+k3s1   10.32.7.224   <none>        Amazon Linux 2   5.10.184-175.731.amzn2.x86_64   containerd://1.7.1-k3s1
ip-10-32-11-62.ap-northeast-2.compute.internal   Ready    control-plane,master   2d2h   v1.27.3+k3s1   10.32.11.62   <none>        Amazon Linux 2   5.10.184-175.731.amzn2.x86_64   containerd://1.7.1-k3s1
```


ì´ì œ iptablesì˜ ê·œì¹™ì„ í™•ì¸í•œë‹¤. ì•„ë˜ì˜ ëª…ë ¹ì–´ ê²°ê³¼ë¥¼ ë³´ë©´, í•´ë‹¹ IPë¡œ ë“¤ì–´ì˜¤ëŠ” íŒ¨í‚·ì€ ëª¨ë‘ `KUBE-SVC-GBTMB5ZTD56ECL5F`ìœ¼ë¡œ 80portë¡œ ë³´ë‚´ì§„ë‹¤.


```bash
$ iptables -S -t nat | grep 10.43.62.130
-A KUBE-SERVICES -d 10.43.62.130/32 -p tcp -m comment --comment "default/service-test cluster IP" -m tcp --dport 80 -j KUBE-SVC-GBTMB5ZTD56ECL5F
-A KUBE-SVC-GBTMB5ZTD56ECL5F ! -s 10.42.0.0/16 -d 10.43.62.130/32 -p tcp -m comment --comment "default/service-test cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
```


ì´ì œ â€œ`KUBE-SVC-GBTMB5ZTD56ECL5F`â€ì— ëŒ€í•œ ì •ë³´ë¥¼ ì–»ìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤. ì•½ 1/4 í™•ë¥ ë¡œ 4ê°œì˜ ê²½ë¡œë¡œ ë‚˜ëˆ ì§„ë‹¤. 


```bash
$ iptables -S -t nat | grep KUBE-SVC-GBTMB5ZTD56ECL5F
-N KUBE-SVC-GBTMB5ZTD56ECL5F
-A KUBE-SERVICES -d 10.43.62.130/32 -p tcp -m comment --comment "default/service-test cluster IP" -m tcp --dport 80 -j KUBE-SVC-GBTMB5ZTD56ECL5F
-A KUBE-SVC-GBTMB5ZTD56ECL5F ! -s 10.42.0.0/16 -d 10.43.62.130/32 -p tcp -m comment --comment "default/service-test cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.0.43:8080" -m statistic --mode random --probability 0.25000000000 -j KUBE-SEP-CLPYGNZNNY3PRNQC
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.0.44:8080" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-54OS7XC6LLUCYZJF
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.1.41:8080" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-SU625FHCSXBPEYVL
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.1.42:8080" -j KUBE-SEP-KYPXHCLNNXAPFHUW
```


ê·¸ ì¤‘ í•˜ë‚˜ì— ì ‘ê·¼í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤. `DNAT --to-destination 10.42.1.42:8080` íŠ¸ë˜í”½ì„ íŒŒë“œë¡œ ì „ë‹¬í•˜ëŠ” ê·œì¹™ì´ë‹¤. `service-test-cd79b78bd-bkr52` ì´ë¦„ì˜ íŒŒë“œë¡œ ì „ë‹¬í•œë‹¤.


```bash
iptables -S -t nat | grep KUBE-SEP-KYPXHCLNNXAPFHUW
-N KUBE-SEP-KYPXHCLNNXAPFHUW
-A KUBE-SEP-KYPXHCLNNXAPFHUW -s 10.42.1.42/32 -m comment --comment "default/service-test" -j KUBE-MARK-MASQ
-A KUBE-SEP-KYPXHCLNNXAPFHUW -p tcp -m comment --comment "default/service-test" -m tcp -j DNAT --to-destination 10.42.1.42:8080
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.1.42:8080" -j KUBE-SEP-KYPXHCLNNXAPFHUW
```


ë‚˜ë¨¸ì§€ ì²´ì¸ì— ëŒ€í•´ì„œ ê²€ìƒ‰í•´ë³´ë©´ ìœ„ì™€ ê°™ì´ í˜„ì¬ ë™ì‘ì¤‘ì¸ ê° íŒŒë“œë¡œ ì „ë‹¬í•˜ëŠ” ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. [medium](https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6)ì— ìˆëŠ” í¬ìŠ¤íŒ…ì—ì„œ ë³´ê¸° ì¢‹ê²Œ í‘œí˜„í•œ ê·¸ë¦¼ë„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


### NodePort


NodePortëŠ” í´ëŸ¬ìŠ¤í„°ì— ì ‘ê·¼í•œ íŠ¸ë˜í”½ ì¤‘, ì„¤ì •í•œ â€œí¬íŠ¸â€ì— ë§ëŠ” íŠ¸ë˜í”½ì„ **ëª¨ë‘ ì„œë¹„ìŠ¤ì˜ ClusterIP**ë¡œ ë„˜ê¸°ëŠ” ë°©ì‹ì´ë‹¤. NodePort ë°©ì‹ ë˜í•œ ë˜‘ê°™ì´ `Netfilter`ë¥¼ ì´ìš©í•˜ë©°, ìœ„ì˜ ClusterIPë¥¼ ì´ìš©í•œë‹¤. ë…¸ë“œ ë‹¨ìœ„ì—ì„œ íŠ¹ì • í¬íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ë°›ì•„ ClusterIPë¡œ ë„˜ê²¨ì¤€ë‹¤. ClusterIPë¡œ ë„˜ê²¨ì§€ë©´ ì•Œë§ì€ íŒŒë“œë¡œ ì „ë‹¬ëœë‹¤.


í¬íŠ¸ì˜ ë²”ìœ„ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `30000-32767` ì‚¬ì´ë¡œ í• ë‹¹í•  ìˆ˜ ìˆë‹¤.


> **â€œexternalTrafficPolicyâ€ ì˜µì…˜ì„ Localë¡œ ì„¤ì •í•˜ë©´ í•´ë‹¹ ë…¸ë“œì— ë°°ì¹˜ëœ íŒŒë“œë¡œë§Œ ì ‘ì†ëœë‹¤ê³  í•œë‹¤.   
> ì´ëŸ¬ë©´ SNATì´ í•„ìš”í•˜ì§€ ì•Šì•„, í´ë¼ì´ì–¸íŠ¸ IPê°€ ë³´ì¡´ëœë‹¤.**


ì´ì œ ì‹¤ìŠµì„ ì§„í–‰í•´ ë³´ë©°, ë‚´ìš©ì„ í™•ì¸í•´ë³¸ë‹¤.

1. íŒŒì¼ì„ ìƒì„±

	```bash
	vi nodeport.yml
	```

2. ì•„ë˜ì˜ ë‚´ìš©ì„ ë³µì‚¬ ë¶™ì—¬ ë„£ì€ í›„ ì €ì¥

	```bash
	kind: Deployment
	apiVersion: apps/v1
	metadata:
	  name: deployment-test-nodeport
	spec:
	  replicas: 4
	  selector:
	    matchLabels:
	      app: service_test_pod_nodeport
	  template:
	    metadata:
	      labels:
	        app: service_test_pod_nodeport
	    spec:
	      containers:
	      - name: simple-http
	        image: python:2.7
	        imagePullPolicy: IfNotPresent
	        command: ["/bin/bash"]
	        args: ["-c", "echo 'Pod IP:' $POD_IP > index.html; python -m SimpleHTTPServer 8080"]
	        env:
	        - name: POD_IP
	          valueFrom:
	            fieldRef:
	              fieldPath: status.podIP
	        ports:
	        - name: http
	          containerPort: 8080
	---
	apiVersion: v1
	kind: Service
	metadata:
	  name: service-test-nodeport
	spec:
	  type: NodePort
	  selector:
	    app: service_test_pod_nodeport
	  ports:
	    - protocol: TCP
	      port: 80
	      targetPort: http
	      nodePort: 30080
	```

3. ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬, ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬

	```bash
	$ kubectl apply -f nodeport.yml
	deployment.apps/deployment-test-nodeport created
	service/service-test-nodeport created
	```

4. ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤. ì•ìœ¼ë¡œ ì„œë¹„ìŠ¤ì˜ IPì£¼ì†ŒëŠ” ìì£¼ ì‚¬ìš©í•˜ë‹ˆ ë³µì‚¬í•˜ë©´ í¸í•˜ë‹¤.

	```bash
	$ kubectl get pod,svc
	NAME                                           READY   STATUS    RESTARTS   AGE
	pod/deployment-test-nodeport-8b69cf8bd-djx5c   1/1     Running   0          3m39s
	pod/deployment-test-nodeport-8b69cf8bd-qhvjt   1/1     Running   0          3m39s
	pod/deployment-test-nodeport-8b69cf8bd-4g4rj   1/1     Running   0          3m39s
	pod/deployment-test-nodeport-8b69cf8bd-jqxj6   1/1     Running   0          3m39s
	
	NAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
	service/kubernetes              ClusterIP   10.43.0.1       <none>        443/TCP        9d
	service/service-test-nodeport   NodePort    10.43.250.102   <none>        80:30080/TCP   3m39s
	```


ì´ì œ, ì‹¤ì œ íŠ¸ë˜í”½ì´ í•´ë‹¹ ë…¸ë“œë¡œ ì ‘ì†í–ˆì„ ë•Œ ì–´ë–¤ ì‹ìœ¼ë¡œ ë³€ê²½í•˜ëŠ”ì§€ ì•Œì•„ë³¸ë‹¤. `iptables`ì—ì„œ ì„œë¹„ìŠ¤ì˜ ë…¸ë“œí¬íŠ¸ë¥¼ ê²€ìƒ‰í•˜ë©´ ì•„ë˜ì˜ ì²´ì¸ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë‚´ìš©ì„ ê°„ë‹¨íˆ í•´ì„í•˜ë©´, â€œ`KUBE-NODEPORTS` ì²´ì¸ì˜ ê·œì¹™ ì¤‘ í•˜ë‚˜ëŠ” íŠ¸ë˜í”½ì´ `30080` í¬íŠ¸ë¡œ í†µì‹ í•œë‹¤ë©´ `KUBE-EXT-5N7WIXIG6FFV5MSL` ì²´ì¸ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë¼â€ ì´ë‹¤.


```bash
$ iptables -S -t nat | grep 30080
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/service-test-nodeport" -m tcp --dport 30080 -j KUBE-EXT-5N7WIXIG6FFV5MSL
```


ì´ì œ, `KUBE-EXT-5N7WIXIG6FFV5MSL` ì²´ì¸ì˜ ê·œì¹™ì„ í™•ì¸í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.


```bash
$ iptables -S -t nat | grep KUBE-EXT-5N7WIXIG6FFV5MSL
-N KUBE-EXT-5N7WIXIG6FFV5MSL
-A KUBE-EXT-5N7WIXIG6FFV5MSL -m comment --comment "masquerade traffic for default/service-test-nodeport external destinations" -j KUBE-MARK-MASQ
-A KUBE-EXT-5N7WIXIG6FFV5MSL -j KUBE-SVC-5N7WIXIG6FFV5MSL
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/service-test-nodeport" -m tcp --dport 30080 -j KUBE-EXT-5N7WIXIG6FFV5MSL
```


ì„¸ë²ˆì§¸ë¡œ ì¶œë ¥ëœ `-A KUBE-EXT-5N7WIXIG6FFV5MSL -j KUBE-SVC-5N7WIXIG6FFV5MSL` ë‚´ìš©ì„ íŒŒì•…í•˜ë©´, `KUBE-SVC-5N7WIXIG6FFV5MSL` ë¡œ ë‹¤ì‹œ íŠ¸ë˜í”½ì„ ì „ë‹¬í•˜ë©° `KUBE-SVC-5N7WIXIG6FFV5MSL` ì´ ì²´ì¸ì˜ ì´ë¦„ì€ ìœ„ì—ì„œ ClusterIPì— ëŒ€í•œ ì´ë¦„ ê·œì¹™ê³¼ ë§¤ìš° ìœ ì‚¬í•˜ë‹¤.


í•œë²ˆ ì²´ì¸ì„ í™•ì¸í•´ë³´ì


```bash
$ iptables -S -t nat | grep KUBE-SVC-5N7WIXIG6FFV5MSL
-N KUBE-SVC-5N7WIXIG6FFV5MSL
-A KUBE-EXT-5N7WIXIG6FFV5MSL -j KUBE-SVC-5N7WIXIG6FFV5MSL
-A KUBE-SERVICES -d 10.43.250.102/32 -p tcp -m comment --comment "default/service-test-nodeport cluster IP" -m tcp --dport 80 -j KUBE-SVC-5N7WIXIG6FFV5MSL
-A KUBE-SVC-5N7WIXIG6FFV5MSL ! -s 10.42.0.0/16 -d 10.43.250.102/32 -p tcp -m comment --comment "default/service-test-nodeport cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SVC-5N7WIXIG6FFV5MSL -m comment --comment "default/service-test-nodeport -> 10.42.0.69:8080" -m statistic --mode random --probability 0.25000000000 -j KUBE-SEP-DNUSDASCNPIACNTF
-A KUBE-SVC-5N7WIXIG6FFV5MSL -m comment --comment "default/service-test-nodeport -> 10.42.0.70:8080" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-SLL6CN4RH3ALGW6H
-A KUBE-SVC-5N7WIXIG6FFV5MSL -m comment --comment "default/service-test-nodeport -> 10.42.1.65:8080" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-GGAEDKHILSR44UAR
-A KUBE-SVC-5N7WIXIG6FFV5MSL -m comment --comment "default/service-test-nodeport -> 10.42.1.66:8080" -j KUBE-SEP-ST3ZKQ7TPT3XY23S
```


í•˜ë‹¨ì˜ 4ì¤„ì„ í™•ì¸í•´ ë³´ë©´ ìœ„ì˜ ClusterIPì—ì„œ ì‹¤ìŠµí–ˆë˜ ê²ƒê³¼ ê°™ì´,  íŠ¸ë˜í”½ì„ ê° íŒŒë“œë¡œ ì „ë‹¬í•˜ëŠ” ë‚´ìš©ì´ ë‹´ê²¨ ìˆë‹¤.


ì •ë¦¬í•´ ë³´ë©´, `iptables` ê·œì¹™ì— ì˜í•´ ê° ë…¸ë“œë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ ì¤‘ 30080í¬íŠ¸ë¥¼ ì´ìš©í•˜ë©´ NodePort ì²´ì¸ì˜ ê·œì¹™ì´ ì ìš©ë˜ë©°, NodePort ì²´ì¸ì€ ClusterIP ì²´ì¸ìœ¼ë¡œ ì „ë‹¬í•˜ë©° ê²°êµ­ íŒŒë“œì—ê²Œ íŠ¸ë˜í”½ì´ ì „ì†¡ëœë‹¤.


### Load Balancer


NodePortë¡œ ì„œë¹„ìŠ¤ë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ë©´ í´ëŸ¬ìŠ¤í„°ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ë…¸ë“œì—ì„œ íŠ¹ì • í¬íŠ¸(NodePort)ë¥¼ ì—´ì–´ë‘”ë‹¤. í•˜ë‚˜ì˜ ë…¸ë“œì˜ ì£¼ì†Œë§Œ ë…¸ì¶œí•˜ë©´, ë…¸ë“œì— ì¥ì• ê°€ ìƒê²¼ì„ ë•Œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤. ê·¸ë ‡ê¸°ì— ë…¸ë“œ ì•ë‹¨ì— ë¡œë“œë°¸ëŸ°ì„œë¥¼ ë‘ì–´ Health ìƒíƒœì¸ ë…¸ë“œë¡œë§Œ íŠ¸ë˜í”½ì„ ì „ë‹¬í•´ì•¼ í•œë‹¤. ì´ë¥¼ ìœ„í•´ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œëŠ” LoadBalancer Typeì„ ì§€ì›í•œë‹¤. (NodePort íƒ€ì…ì€ Load Balancer íƒ€ì…ì„ ìœ„í•œ ìš”ì†Œê°™ë‹¤ëŠ” ìƒê°ì´ ë“ ë‹¤.)


ë¡œë“œë°¸ëŸ°ì„œ íƒ€ì…ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ ìì²´ë¡œ êµ¬í˜„í•  ìˆ˜ ì—†ê³ , **ì™¸ë¶€ ë¡œë“œë°¸ëŸ°ì„œì™€ ì—°ë™ë˜ì–´ ì‘ë™í•œë‹¤.** ë¡œë“œë°¸ëŸ°ìŠ¤ íƒ€ì…ì€ ë³„ë„ì˜ **ì™¸ë¶€ IPê°€ ì¡´ì¬í•œë‹¤.** í´ë¼ì´ì–¸íŠ¸ê°€ ì™¸ë¶€ IPë¥¼ í†µí•´ ì ‘ê·¼í•˜ë©´, ì ì ˆí•œ ê·œì¹™ìœ¼ë¡œ ë…¸ë“œë¥¼ ë°°ì •í•´ì¤€ë‹¤. (ë¡œë“œë°¸ëŸ°ì„œì´ë‹ˆ, ë…¸ë“œëŠ” ëª¨ë‘ ê³µí‰í•œ ë¶€í•˜ë¥¼ ë°›ëŠ”ë‹¤.) ê·¸ëŸ¬ë©´ NodePortì—ì„œ ì§„í–‰í–ˆë˜ ê³¼ì •ì´ ì¼ì–´ë‚œë‹¤.(ë¡œë“œë°¸ëŸ°ì„œ íƒ€ì…ì€ ìë™ìœ¼ë¡œ ë…¸ë“œ í¬íŠ¸ë¥¼ í•˜ë‚˜ ì ìœ í•œë‹¤.)


**[vs NodePort]**


NodePortì™€ëŠ” ë‹¤ë¥´ê²Œ Load Balancer íƒ€ì…ì€ Port í• ë‹¹ì„ ë¹„í™œì„±í™” í•  ìˆ˜ ìˆë‹¤. ë…¸ë“œ í¬íŠ¸ê°€ ì•„ë‹Œ íŠ¸ë˜í”½ì„ íŒŒë“œë¡œ ì§ì ‘ ë¼ìš°íŒ…í•˜ëŠ”(ex. AWS EKS) ë¡œë“œë°¸ëŸ°ì„œì˜ ê²½ìš°ì—ë§Œ ê°€ëŠ¥í•˜ë‹¤.ì´ë•ŒëŠ” `spec.allocateLoadBalancerNodePorts = false`ë¡œ ì„¤ì •í•˜ë©´ ëœë‹¤. 


ë˜í•œ, ì™¸ë¶€ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ TLS, Draining ë“±ì´ ê°€ëŠ¥í•˜ë‹¤.


## ìš”ì•½


ì‹¤ìŠµí–ˆë˜ ë‚´ìš©ì„ ë‹¤ì‹œ í•œë²ˆ ìš”ì•½í•œë‹¤.


### **ì„œë¹„ìŠ¤ì˜ Cluster IPì— ëŒ€í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.**


ì„œë¹„ìŠ¤ì˜ ë™ì‘ì€ â€˜**kube-proxyâ€™**ê°€ ë‹´ë‹¹í•˜ë©°, ë³„ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ë¥¼ ì†Œëª¨í•˜ì§€ ì•Šê³ ,  iptables(netfilter)ë¥¼ ì´ìš©í•˜ì—¬ ì»¤ë„ì˜ì—­ì—ì„œ íŠ¹ì • íŒ¨í‚·ì´ ì˜¤ë©´ ì •í•´ë‘” í–‰ë™ì„ ì·¨í•œë‹¤. ì—¬ê¸°ì„œëŠ” ì£¼ë¡œ, Network Address Translation â€œ**NATâ€** ê¸°ëŠ¥ì„ ìˆ˜í–‰í•œë‹¤. ì´ë¥¼ í†µí•´, ì‹¤ì§ˆì ì¸ ì¸í„°í˜ì´ìŠ¤ ì—†ì´ **reverse-proxy** ì—­í• ì„ ì„œë¹„ìŠ¤ê°€ í•  ìˆ˜ ìˆê²Œ ëœë‹¤. 
ê·¸ë ‡ë‹¤ë©´, kube-proxyëŠ” ì–´ë–¤ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ”ê°€? kube-proxyëŠ” API ì„œë²„ë¡œ íŒŒë“œì˜ **Health check, í˜¹ì€ íŒŒë“œì˜ ë¶€í•˜ìƒíƒœë¥¼** í†µí•´ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ê´€ë¦¬í•œë‹¤. ë˜, í˜„ì¬ì˜ ì—”ë“œí¬ì¸íŠ¸ì— ë§ê²Œ Netfilterì˜ ê·œì¹™ì„ ìˆ˜ì •í•œë‹¤. ì¦‰, kube-proxyëŠ” ë¡œë“œë°¸ëŸ°ì„œì—ì„œì˜ manager serverì˜ ì—­í• ì„ ë‹´ë‹¹í•œë‹¤.


**Q. ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , ì´í›„ Selector ì¡°ê±´ì— ë§ëŠ” íŒŒë“œë¥¼ ìƒì„±í•˜ë©´, í•´ë‹¹ íŒŒë“œë„ ì—”ë“œí¬ì¸íŠ¸ì— ì¶”ê°€ë˜ëŠ”ê°€?**


Yes, ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ì§€ì†ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³ , ë°˜ì‘í•œë‹¤. kube-proxyê°€ ì´ë¥¼ ê°ì§€í•˜ê³  ì¶”ê°€í•œë‹¤.


**Q. ì„œë¹„ìŠ¤ê°€ íŒŒë“œ ëª©ë¡ ì¤‘ íŒŒë“œë¥¼ ì„ íƒí•˜ëŠ” ê¸°ì¤€ì€? ê³µí‰í•˜ê²Œ ì„ íƒí•˜ë ¤ê³  ë…¸ë ¥í•œë‹¤.**


ì•„ë˜ì™€ ê°™ì´ í™•ë¥ ì ìœ¼ë¡œ ê³µí‰í•¨ì„ ìœ ì§€í•˜ë ¤ í•œë‹¤. â€œrandom --probabilityâ€ ë¶€ë¶„ì„ ì£¼ëª©í•˜ë©´ ì•Œ ìˆ˜ ìˆë‹¤. ë‹¤ë§Œ, ì´ëŠ” ì™„ë²½í•˜ê²Œ ê³µí‰í•œ í™•ë¥ ì€ ì•„ë‹ˆë‹¤. (0.333 ì™€ ê°™ì€ ë¬´í•œì†Œìˆ˜ëŠ” í‘œí˜„ëª»í•¨)


```bash
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.0.43:8080" -m statistic --mode random --probability 0.25000000000 -j KUBE-SEP-CLPYGNZNNY3PRNQC
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.0.44:8080" -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-54OS7XC6LLUCYZJF
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.1.41:8080" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-SU625FHCSXBPEYVL
-A KUBE-SVC-GBTMB5ZTD56ECL5F -m comment --comment "default/service-test -> 10.42.1.42:8080" -j KUBE-SEP-KYPXHCLNNXAPFHUW
```


ì„œë¹„ìŠ¤ëŠ” ìì²´ì ìœ¼ë¡œ íŒŒë“œì˜ ë¦¬ìŠ¤íŠ¸ë“¤ì— ì˜í•´ ë¡œë“œë°¸ëŸ°ì‹±ì´ ì´ë¤„ì§„ë‹¤. ì•„ë˜ëŠ” ê´€ë ¨ ì‹¤í—˜ ê²°ê³¼


```bash
$ for i in {1..100}; do curl 10.43.232.207; done | tee results.txt
$ echo "Pod1 responses: $(grep -c '<p>Hello from pod1</p>' results.txt)"
Pod1 responses: 52
[root@ip-10-32-11-62 kubernetes]# echo "Pod2 responses: $(grep -c '<p>Hello from pod2</p>' results.txt)"
Pod2 responses: 48
```


### **ì™¸ë¶€ì™€ì˜ í†µì‹  ë°©ì‹**


ClusterIPëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ í†µì‹ í•  ìˆ˜ ìˆë‹¤. ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ë ¤ë©´, NodePort í˜¹ì€ Load Blancer íƒ€ì…ì˜ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤.

- **NodePort**

NodePortëŠ” ë…¸ë“œë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ ì¤‘ íŠ¹ì • í¬íŠ¸ë¥¼ ì—´ì–´ ì™¸ë¶€ì˜ ì ‘ê·¼ì„ í—ˆìš©í•œë‹¤. ClusterIP ìƒìœ„ Layerë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤. íŠ¹ì • í¬íŠ¸ë¡œ ë“¤ì–´ì˜¨ íŠ¸ë˜í”½ì€ ClusterIPì™€ ê°™ì´ ì‘ë™í•œë‹¤. ì¦‰, ClusterIPë¡œ ë„˜ê²¨ì§€ë©´ ìœ„ì—ì„œ ì„¤ëª…í•œ ì„œë¹„ìŠ¤ì˜ ë°©ì‹ëŒ€ë¡œ ì•Œë§ì€ íŒŒë“œë¡œ ì „ë‹¬ëœë‹¤.

- **Load Balancer**

ì™¸ë¶€ì—ëŠ” í•˜ë‚˜ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì£¼ë¡œ ì œê³µí•˜ë‹ˆ NodePort ë°©ì‹ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë°›ìœ¼ë©´ 1ê°œì˜ ë…¸ë“œë¡œ ëª¨ë“  íŠ¸ë˜í”½ì„ ë°›ê²Œëœë‹¤. ë…¸ë“œë¡œ íŠ¸ë˜í”½ì´ ë“¤ì–´ì™€ì„œ ClusterIP Typeê³¼ ê°™ì´ ë‹¤ì‹œ ë¡œë“œë°¸ëŸ°ì‹±ì´ ë˜ì–´ ì—¬ëŸ¬ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¶„ì‚°ë˜ê² ì§€ë§Œ, í•˜ë‚˜ì˜ ë…¸ë“œì— ëª¨ë“  íŠ¸ë˜í”½ì´ ì¶©ë¶„íˆ ë¶€ë‹´ëœë‹¤. ê·¸ë ‡ê¸°ì— LoadBlancer íƒ€ì…ì€ ë¶€í•˜ë¶„ì‚° ìì²´ë¥¼ ë…¸ë“œ scopeì—ì„œ ì§„í–‰í•œë‹¤. ì™¸ë¶€ ë¡œë“œë°¸ëŸ°ì„œì™€ ì—°ê²°ë˜ì–´, íŠ¸ë˜í”½ì´ ì—¬ëŸ¬ ë…¸ë“œë¡œ ë¶„ì‚°ëœë‹¤. ì—¬ê¸°ì— **`externalTrafficPolicy=local`**ë¡œ ì„¤ì •í•œë‹¤ë©´ ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤.


### ì°¸ê³ ìë£Œ


[https://kubernetes.io/ko/docs/concepts/services-networking/service/](https://kubernetes.io/ko/docs/concepts/services-networking/service/)


[https://www.eksworkshop.com/docs/networking/](https://www.eksworkshop.com/docs/networking/)


[https://coffeewhale.com/packet-network3](https://coffeewhale.com/packet-network3)


[https://gasidaseo.notion.site/K8S-Service-1-f095388c48a84841b09a13b582f374c8](https://gasidaseo.notion.site/K8S-Service-1-f095388c48a84841b09a13b582f374c8)


[https://coffeewhale.com/k8s/network/2019/04/19/k8s-network-01/](https://coffeewhale.com/k8s/network/2019/04/19/k8s-network-01/)


[https://coffeewhale.com/k8s/network/2019/05/11/k8s-network-02/](https://coffeewhale.com/k8s/network/2019/05/11/k8s-network-02/)


[https://medium.com/finda-tech/kubernetes-ë„¤íŠ¸ì›Œí¬-ì •ë¦¬-fccd4fd0ae6](https://medium.com/finda-tech/kubernetes-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A0%95%EB%A6%AC-fccd4fd0ae6)


[https://en.m.wikipedia.org/wiki/File:Netfilter-packet-flow.svg](https://en.m.wikipedia.org/wiki/File:Netfilter-packet-flow.svg)

