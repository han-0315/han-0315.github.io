---
layout: post
title: Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° Part3
date: 2024-08-31 09:00 +0900 
description: Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° Part3
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#1] 
pin: false
math: true
mermaid: true
---
Dockerì—†ì´ ì»¨í…Œì´ë„ˆ ë§Œë“¤ê¸° Part 3: ìì› ì œí•œ
<!--more-->


ì•„ë˜ì˜ ë‚´ìš©ì€ [Kakao](https://netpple.github.io/docs/make-container-without-docker/ifkakao2022-handson) ë°œí‘œìë£Œì™€ [ì˜ìƒ](https://www.youtube.com/watch?v=mSD88FuST80)ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


### ë“¤ì–´ê°€ë©°


**ì»¨í…Œì´ë„ˆëŠ” ë…¼ë¦¬ì ìœ¼ë¡œ ì˜ ê²©ë¦¬ëœ í”„ë¡œì„¸ìŠ¤**ì´ë‹¤. ì—¬ê¸°ì„œëŠ” ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ ë§Œë“¤ê¸° ìœ„í•´ í•„ìš”í•œ í•„ìš”í•œ **í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ **ì„ í•˜ë‚˜ì”© ì•Œì•„ë³´ê³  ì‹¤ìŠµì„ ì§„í–‰í•´ë³´ê³ ì í•œë‹¤. ì•ì„  í¬ìŠ¤íŒ…ì—ì„œ ë””ë ‰í„°ë¦¬ë¥¼ ê²©ë¦¬í•˜ëŠ” ë°©ë²•ê³¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•´ ì´ë²ˆí¸ì—ì„œëŠ” ì‹œë¦¬ì¦ˆì˜ ë§ˆì§€ë§‰ì¸ ìì› í• ë‹¹ì„ ê²©ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¸ë‹¤.


## ìì›ì œí•œ


### Cgroup 


cgroupì€ í”„ë¡œì„¸ìŠ¤ì˜ ìì› ì‚¬ìš©ì„ ì œí•œí•˜ê³  ê²©ë¦¬ì‹œí‚¤ëŠ” ê¸°ëŠ¥ì´ë‹¤.


![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(3)/1.png)


ì¶œì²˜: [https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=189](https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=189)


> ğŸ’¡ **cgroups**ì¸ê°€? cgroup ì¸ê°€?  
> ì—¬ëŸ¬ ê°œì˜ control groupì„ ëª…ì‹œì ìœ¼ë¡œ ì–¸ê¸‰í•  ë•ŒëŠ” ë³µìˆ˜í˜•ì¸ "cgroups"ì„ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.  
>   
> ê·¸ë¦¬ê³  ì•ì— cëŠ” ëŒ€ë¬¸ìë¡œ ì“°ì´ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.  
>   
> **(ìŠ¤í„°ë””ì› ë¶„ì´ ìš©ì–´ì— ëŒ€í•´ ì •ë¦¬í•´ì£¼ì…¨ë‹¤.)**


	ì—¬ëŸ¬ ê°œì˜ control groupì„ ëª…ì‹œì ìœ¼ë¡œ ì–¸ê¸‰í•  ë•ŒëŠ” ë³µìˆ˜í˜•ì¸ "cgroups"ì„ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.


	ê·¸ë¦¬ê³  ì•ì— cëŠ” ëŒ€ë¬¸ìë¡œ ì“°ì´ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.


	**(ìŠ¤í„°ë””ì› ë¶„ì´ ìš©ì–´ì— ëŒ€í•´ ì •ë¦¬í•´ì£¼ì…¨ë‹¤.)**


#### ì‹¤ìŠµ


í”„ë¡œì„¸ìŠ¤ ìì› ì œí•œì„ ì§„í–‰í•´ë³´ì. ê·¸ë¦¬ê³  ì´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ë¶€í•˜ ê´€ë ¨ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œë‹¤.

- ë¶€í•˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
apt install cgroup-tools stress -y
```

- ë¶€í•˜ ìƒì„±

```bash
stress -c 1
```


#### ë¶€í•˜ ë°œìƒ í™•ì¸


ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ htop ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¶€í•˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. `stree -c 1` ëª…ë ¹ì–´ë¡œ ì¸í•´ CPUë¥¼ ê±°ì˜ 90% ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(3)/2.png)


#### ì˜µì…˜ ì¶”ê°€

- cgroupì´ ì§€ì›í•˜ëŠ” ë¦¬ì†ŒìŠ¤ í™•ì¸

```bash
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# cat cgroup.controllers
cpuset cpu io memory hugetlb pids rdma misc
```

- sub controlì— cpu ì¶”ê°€

```bash
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# cat cgroup.subtree_control
cpu
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# echo "+cpu" >> /sys/fs/cgroup/test_cgroup_parent/cgroup.subtree_control


```

- cpu.max ì œí•œ ì„¤ì • : ì²« ë²ˆì¨° ê°’ì€ í—ˆìš©ëœ ì‹œê°„(ë§ˆì´í¬ë¡œì´ˆ) ë‘ ë²ˆì§¸ ê°’ì€ ì´ ê¸°ê°„ ê¸¸ì´ > 1/10 ì‹¤í–‰ ì„¤ì •

```bash
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# echo 100000 1000000 > /sys/fs/cgroup/test_cgroup_parent/cpu.max
root@MyServer:/sys/fs/cgroup/test_cgroup_parent# mkdir test_cgroup_child && cd test_cgroup_child

root@MyServer:/sys/fs/cgroup/test_cgroup_parent/test_cgroup_child# cat /proc/$$/cgroup
0::/test_cgroup_parent/test_cgroup_child
root@MyServer:/sys/fs/cgroup/test_cgroup_parent/test_cgroup_child# stress -c 1
stress: info: [18875] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd
```


ì˜µì…˜ì„ ì£¼ê³  ë‚˜ì„œëŠ” CPUë¥¼ ë§ì´ ì‘ì•„ë¨¹ì§€ ëª»í•˜ëŠ” ëª¨ìŠµì´ë‹¤.

- CPU í™œìš©ëŸ‰ì´ ì§€ì†ì ìœ¼ë¡œ 6.5%í˜¹ì€ 13.9% ìƒíƒœë¥¼ ë³´ì¸ë‹¤.

![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(3)/3.png)


![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(3)/4.png)


#### Docker ì˜µì…˜ì„ ì´ìš©í•œ ì»¨í…Œì´ë„ˆ ìì› ì œí•œ


docker update ëª…ë ¹ì–´ë¥¼ í™•ì¸í•´ë³´ë©´, cpu ë° ë©”ëª¨ë¦¬ë¥¼ ì œí•œí•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(3)/5.png)

- cpu ì œí•œ í…ŒìŠ¤íŠ¸

```bash
docker run -it --rm --name cpu vish/stress -cpus "1"
Unable to find image 'vish/stress:latest' locally
latest: Pulling from vish/stress
2ce2382a5646: Pull complete
Digest: sha256:b6456a3df6db5e063e1783153627947484a3db387be99e49708c70a9a15e7177
Status: Downloaded newer image for vish/stress:latest
I0831 05:44:08.118939       1 main.go:26] Allocating "0" memory, in "4Ki" chunks, with a 1ms sleep between allocations
I0831 05:44:08.119009       1 main.go:39] Spawning a thread to consume CPU
I0831 05:44:08.119023       1 main.go:29] Allocated "0" memory
```

- ë¶€í•˜ë¥¼ ê±°ì˜ 100í”„ë¡œ ì¡ì•„ë¨¹ëŠ”ë‹¤.

![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(3)/6.png)

- ì´ì œ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚¤ê³ , ì ìœ ë¥¼ í™•ì¸í•´ë³¸ë‹¤.
	- cpu ì ìœ ìœ¨ì€ $\frac{\text{cpu-quota}}{\text{cpu-period}}$ x 100ìœ¼ë¡œ ê³„ì‚°ëœë‹¤.

```bash
docker run -d --cpu-period=100000 --cpu-quota=100000 --name cpu1 vish/stress -cpus "1"
docker run -d --cpu-period=100000 --cpu-quota=25000  --name cpu2 vish/stress -cpus "1"
docker run -d --cpu-period=200000 --cpu-quota=25000  --name cpu3 vish/stress -cpus "1"
docker run -d --cpu-period=50000  --cpu-quota=25000  --name cpu4 vish/stress -cpus "1"
105d0b7129dbb5dbb80b7eec5b30180e6612c596e4a9676a983cbc92ae31f44e
1b30b1e45a8b3feb2a106d6d7946dccd9af3dac0be50031302394e002019d7c6
a7e42052522f1752ef6bff51f877351444876834fbb0b55f4f4a9f9fdd0283af
4c61e45e85463a10650a3691282384a9e750e4a05c78dc0ab85e05f181b4f34b
```


ì•„ë˜ì˜ ì‚¬ì§„ê³¼ ê°™ì´, cpu-quota/cpu-period ê°’ê³¼ ìœ ì‚¬í•˜ê²Œ ì ìœ ë¥¼ ê°€ì ¸ê°„ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.


**cpu1 ~= 100, cpu2 ~= 25, cpu3 ~= 8, cpu4 ~= 50**


![image.png](/assets/img/post/ì»¨í…Œì´ë„ˆ%20ê²©ë¦¬%20ê¸°ìˆ %20ì‚´í´ë³´ê¸°(3)/7.png)


cpu3ì˜ ê²½ìš° 40%ì´ìƒ ì°¨ì´ê°€ ë‚œë‹¤. í•˜ì§€ë§Œ ê·¸ë˜ë„ ê°’ê³¼ ì–¼ì¶” ìˆ˜ë ´í•˜ëŠ” ëª¨ìŠµì´ë‹¤.


## ë§ˆì¹˜ë©°


ì´ë²ˆ ì‹œë¦¬ì¦ˆë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì— í•„ìš”í•œ í•„ìš”í•œ í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬ ê¸°ìˆ ì„ ìì„¸í•˜ê²Œ ì•Œì•„ë³¼ ìˆ˜ ìˆì—ˆë‹¤. íŠ¹íˆ ë³„ë„ì˜ ì»¨í…Œì´ë„ˆ ì—”ì§„ì—†ì´ ë¦¬ëˆ…ìŠ¤ ê²©ë¦¬ê¸°ìˆ ì„ ì´ìš©í•´ ì‹¤ì œ ì»¨í…Œì´ë„ˆì™€ ìœ ì‚¬í•œ í”„ë¡œì„¸ìŠ¤ë¥¼ ë§Œë“¤ì–´ë³´ëŠ” ê³¼ì •ì´ ê½¤ ì¬ë°Œì—ˆë‹¤.

