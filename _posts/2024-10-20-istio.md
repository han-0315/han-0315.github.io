---
layout: post
title: Istio ì‚´í´ë³´ê¸°
date: 2024-10-19 09:00 +0900 
description: Istio ì‚´í´ë³´ê¸°
category: [Kubernetes, Network] 
tags: [KANS, CloudNet, Kubernetes, Network, KANS#7, Istio, Service mesh ] 
pin: false
math: true
mermaid: true
---
Istio ì‚´í´ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


	CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” KANS(**K**ubernetes **A**dvanced **N**etworking **S**tudy)ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.


	ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.


### ë“¤ì–´ê°€ë©°


ì´ë²ˆ ìŠ¤í„°ë”” ì£¼ì°¨ëŠ” ì„œë¹„ìŠ¤ ë§¤ì‹œì¸ Istioì´ë‹¤. ì•„ì§ ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ ë‹¤ë¤„ë³¸ì ì´ ì—†ëŠ”ë°, ì…ë¬¸ë¶€í„° ì¢‹ì€ ìë£Œë¡œ ì •ë¦¬í•˜ê²Œ ëë‹¤.


### Service Mesh


ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ê°„ì˜ í†µì‹ ì„ ë„ì™€ì£¼ëŠ” ë³„ë„ì˜ ì¸í”„ë¼ Layerì´ë‹¤. ì „ì²´ì ì¸ ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§ì´ ê°€ëŠ¥í•˜ë©°, ë„¤íŠ¸ì›Œí¬ë¥¼ ì œì–´í•  ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ, ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ ë„ì…í•˜ë©´ Layerê°€ í•˜ë‚˜ ë” ì¶”ê°€ë˜ë¯€ë¡œ ë¬´ê²ë‹¤. (ì•„ë˜ì— ì‚¬ì§„ë§Œ ë´ë„..) ê·¸ë ‡ê¸°ì— ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ ë„ì…í•˜ê¸°ì „ì— í˜„ì¬ í™˜ê²½ì— ì •ë§ í•„ìš”í•œì§€ ê³ ë¯¼í•´ë´ì•¼ í•œë‹¤. [ê´€ë ¨ SDS ë¸”ë¡œê·¸](https://www.samsungsds.com/kr/insights/service_mesh.html)


![image.png](/assets/img/post/istio/1.png)


ì¶œì²˜: [https://www.redhat.com/ko/topics/microservices/what-is-a-service-mesh](https://www.redhat.com/ko/topics/microservices/what-is-a-service-mesh)


## Istio


IstioëŠ” ì„œë¹„ìŠ¤ Mesh êµ¬í˜„ì²´ ì¤‘ í•˜ë‚˜ë¡œ, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì „ë°˜ì˜ íŠ¸ë˜í”½ íë¦„ì„ ê´€ë¦¬, ì •ì±… ì„¤ì •, ë°ì´í„° ìˆ˜ì§‘ì´ ê°€ëŠ¥í•˜ë‹¤. ëª¨ë“œë¡œëŠ” íŒŒë“œ ë‹¹ í•˜ë‚˜ì˜ í”„ë¡ì‹œë¥¼ ë‘ëŠ” sidecarëª¨ë“œì™€ ë…¸ë“œ ë‹¹ ì „ìš© ì»¤ë„ì„ ë‘ëŠ” Ambientê°€ ìˆë‹¤. ì—¬ê¸°ì„œëŠ” sidecar ëª¨ë“œì— ëŒ€í•´ì„œ ì£¼ë¡œ ì•Œì•„ë³¸ë‹¤.


### êµ¬ì„±


IstioëŠ” Control Planeê³¼ Data Planeìœ¼ë¡œ êµ¬ì„±ëœë‹¤. 


Control Planeì€ Istiodë¡œ í”„ë¡ì‹œ ë¼ìš°íŒ… ê·œì¹™ì„ ê´€ë¦¬, ë³´ì•ˆ ë° ì•”í˜¸í™”, Kubernetesì™€ ìƒí˜¸ ì‘ìš©í•œë‹¤. 


Data Planeì€ ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°”ë¡œ ì•ì— ìˆëŠ” í”„ë¡ì‹œ ì§‘í•©ì„ ì˜ë¯¸í•˜ë©°, Sidecar ëª¨ë“œì—ì„œëŠ” ê° íŒŒë“œë§ˆë‹¤ sidecar proxy(envoy)ê°€ ì¡´ì¬í•œë‹¤.


#### Control Plane


IstiodëŠ” Pilot, Galley, Citadel 3ê°œì˜ ìš”ì†Œê°€ ì¡´ì¬í•œë‹¤. Pilotì€ í”„ë¡ì‹œ ë¼ìš°íŒ… ê·œì¹™ì„ ê´€ë¦¬í•˜ë©°, GalleyëŠ” Endpoint ê°±ì‹  ë“± K8sì™€ ìƒí˜¸ì‘ìš©í•˜ë©°, Citadelì€ ë³´ì•ˆ ë° ì•”í˜¸í™” ê´€ë ¨ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•œë‹¤. â€œIstiodëŠ” golangìœ¼ë¡œ ì‘ì„±ë˜ì—ˆë‹¤.â€


ì•„ë˜ì˜ ê·¸ë¦¼ì„ í†µí•´ ê° êµ¬ì„±ìš”ì†Œì˜ ì—­í• ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![https://istio.io/latest/docs/concepts/security/](/assets/img/post/istio/2.svg)


![https://devlos.tistory.com/100](/assets/img/post/istio/3.png)


ìŠ¤í„°ë””ì›ì´ì‹  ë°ë¸Œë¡œìŠ¤ë‹˜ì´ ê° êµ¬ì„±ìš”ì†Œì— ëŒ€í•´ ë„ì‹í™”ë¥¼ í•´ì£¼ì…¨ë‹¤.


#### Data Plane


Data Planeì€ Envoy í”„ë¡ì‹œ ì§‘í•©ì„ ì˜ë¯¸í•œë‹¤. 


![https://istio.io/latest/docs/ops/deployment/architecture/](/assets/img/post/istio/4.svg)


EnvoyëŠ” ë©€í‹° ìŠ¤ë ˆë”©ì„ ì‚¬ìš©í•˜ë©°, ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ Listenerë¥¼ í†µí•´ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ë©° ì´í›„ HTTP Router Filerë¥¼ í†µí•´ ëŒ€ìƒ í´ëŸ¬ìŠ¤í„°ë¡œ ì˜®ê¸°ê³  í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸(Pod)ë¡œ ë¼ìš°íŒ…í•œë‹¤. â€œ**Listeners > Routes > Clusters > Endpointsâ€**


![https://www.envoyproxy.io/docs/envoy/latest/intro/life_of_a_request](/assets/img/post/istio/5.svg)


### í†µì‹ íë¦„


íŠ¹ì • íŒŒë“œë¡œ í–¥í•˜ëŠ” íŠ¸ë˜í”½ì„ ì–´ë–»ê²Œ envoyê°€ ì œì–´í•  ìˆ˜ ìˆì„ê¹Œ? istioëŠ” pod ìˆ˜ì¤€ì—ì„œ iptablesë¥¼ ì‚¬ìš©í•˜ì—¬, íŒŒë“œë¡œ í–¥í•˜ëŠ” íŠ¸ë˜í”½ì„ ê°€ë¡œì±ˆë‹¤. íŒŒë“œë‚´ì˜ ì»¨í…Œì´ë„ˆëŠ” ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ ê³µìœ í•˜ë¯€ë¡œ ì´ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤. í•˜ì§€ë§Œ ì´ë¯¸ í•´ë‹¹ íŒŒë“œì— ì˜¤ê¸°ê¹Œì§€ Iptables í˜¹ì€ CNIì— ë§ê²Œ ì—¬ëŸ¬ ë„¤íŠ¸ì›Œí¬ í™‰ì„ ê±°ì³ì™”ì§€ë§Œ, ë˜ ë‹¤ì‹œ Iptables ì§€ì˜¥ì— ë¹ ì§€ëŠ” ëŠë‚Œì´ ë“ ë‹¤.


![image.png](/assets/img/post/istio/6.png)


ìì„¸í•œ Kernel Spaceì˜ íë¦„ë„ëŠ” jimmysongë‹˜ì˜ [ë¸”ë¡œê·¸](https://jimmysong.io/en/blog/sidecar-injection-iptables-and-traffic-routing/)ì— ì˜ì •ë¦¬ë˜ì–´ìˆë‹¤.


### **Ambient mode** ëª¨ë“œ ì•„í‚¤í…ì²˜


Ambient ëª¨ë“œëŠ” ê° íŒŒë“œë§ˆë‹¤ ì „ìš© Proxy ì‚¬ì´ë“œì¹´ë¥¼ ë¶™ì´ëŠ” ë°©ì‹ì´ ì•„ë‹Œ, í•˜ë‚˜ì˜ ë…¸ë“œì— í•˜ë‚˜ì˜ ztunnelì„ ë‘ì–´ ì„œë¹„ìŠ¤ ë§¤ì‹œë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ì‹ì´ë‹¤. Ambient ëª¨ë“œì—ì„œëŠ” L4 Proxyì™€ L7 Proxy ê¸°ëŠ¥ì„ ë¶„ë¦¬í•œë‹¤.


![image.png](/assets/img/post/istio/7.png)


ì¶œì²˜: [https://istio.io/latest/docs/ambient/architecture/control-plane/](https://istio.io/latest/docs/ambient/architecture/control-plane/)


![image.png](/assets/img/post/istio/8.png)


ì¶œì²˜: [https://istio.io/latest/blog/2022/introducing-ambient-mesh/](https://istio.io/latest/blog/2022/introducing-ambient-mesh/)


ìœ„ì—ëŠ” Sidecar ë°©ì‹ìœ¼ë¡œ ì‚¬ì´ë“œ ì¹´ ë°©ì‹ê³¼ ë¹„êµí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ztunnelì„ í†µí•´ í†µì‹ í•˜ëŠ” ì°¨ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/istio/9.png)


ì¶œì²˜: [https://istio.io/latest/docs/ambient/architecture/data-plane/](https://istio.io/latest/docs/ambient/architecture/data-plane/)


HBONE(HTTP-Based Overlay Network)ì€ Istio êµ¬ì„± ìš”ì†Œ ê°„ì— ì‚¬ìš©ë˜ëŠ” ë³´ì•ˆ í„°ë„ë§ í”„ë¡œí† ì½œì´ë‹¤.


ë§Œì•½, ì•„ë˜ì™€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì´ ìˆì—ˆë”ë¼ë©´ Ambient ëª¨ë“œ ì ìš©ì‹œ ë‘ë²ˆì§¸ ë„¤íŠ¸ì›Œí¬ ì •ì±…ìœ¼ë¡œ ë³€ê²½ë˜ì–´ì•¼ í•œë‹¤. HBONEì´ê¸°ì— 8080 í¬íŠ¸ì™€ HBONE íŠ¸ë˜í”½ì´ ì§€ë‚˜ê°€ëŠ” í¬íŠ¸ë¥¼ ì—´ì–´ì¤˜ì•¼í•œë‹¤.


**(1) Before**


```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
spec:
  ingress:
  - ports:
    - port: 9090 # ê¸°ì¡´ì—ëŠ” 9090ë§Œ ì—´ì–´ì¤Œ
      protocol: TCP
  podSelector:
    matchLabels:
      app.kubernetes.io/name: my-app
```


**(2) After**


```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
spec:
  ingress:
  - ports:
    - port: 8080 # HTTP ê¸°ë°˜ì´ê¸°ì— 8080
      protocol: TCP
    - port: 15008 # HBONE íŠ¸ë˜í”½ì„ ì—´ì–´ì£¼ê¸° ìœ„í•œ í¬íŠ¸
      protocol: TCP
  podSelector:
    matchLabels:
      app.kubernetes.io/name: my-app
```


### ì‹¤ìŠµ


#### ì‹¤ìŠµ í™˜ê²½


ì‹¤ìŠµ í™˜ê²½ì€ Kind(controlplane 1ëŒ€) + istio-ingressgateway(NodePort)ë¡œ êµ¬ì„±ë˜ì—ˆìœ¼ë©° Istio ë²„ì „ì€ **v1.23.2**ì´ë‹¤.


#### ì„¤ì¹˜ ì§„í–‰

- Istioctlì„ í†µí•´ ì„¤ì¹˜ ì§„í–‰

```bash
export ISTIOV=1.23.2
curl -s -L https://istio.io/downloadIstio | ISTIO_VERSION=$ISTIOV sh -
cp istio-$ISTIOV/bin/istioctl /usr/local/bin/istioctl
istioctl install --set profile=default -y
```


```bash
istioctl profile list
Istio configuration profiles:
    **ambient**
    default
    demo
    empty
    minimal
    openshift
    openshift-ambient
    preview
    remote
    stable
```

- ìš°ë¦¬ê°€ ì‹¤ìŠµí•  default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— istio-proxy sidecarë¥¼ ì£¼ì…í•œë‹¤. (Label)

```bash
kubectl label namespace default istio-injection=enabled

namespace/default labeled
```


```bash
k get ns -L istio-injection
NAME                 STATUS   AGE     ISTIO-INJECTION
default              Active   5m29s   enabled
istio-system         Active   118s
kube-node-lease      Active   5m29s
kube-public          Active   5m29s
kube-system          Active   5m29s
local-path-storage   Active   5m25s
```


#### Ingress gateway í…ŒìŠ¤íŠ¸

- ì´ì œ Ingress gateway ì‹¤ìŠµì„ ìœ„í•´ í˜¸ìŠ¤íŠ¸ë¥¼ ì§€ì •í•œë‹¤.

```bash
export MYDOMAIN="dongmin.test"

echo "127.0.0.1 $MYDOMAIN" | sudo tee -a /etc/hosts

Password:
127.0.0.1 dongmin.test
```


```bash
docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' myk8s-control-plane

172.18.0.2
echo -e "172.18.0.2 dongmin.test" | tee -a /etc/hosts

172.18.0.2 dongmin.test
```

- ì„œë¹„ìŠ¤ ë°°í¬: IstioëŠ” K8sì—ì„œ **identity**ëŠ” Service Accountë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ê¸°ì— ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ë„ ê°™ì´ ë°°í¬í•œë‹¤.

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kans-nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-websrv
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      serviceAccountName: kans-nginx
      terminationGracePeriodSeconds: 0
      containers:
      - name: deploy-websrv
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: svc-clusterip
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
  selector:
    app: deploy-websrv
  type: ClusterIP
EOF
```

- Istio Gateway/VirtualService ìƒì„±

```bash
cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: test-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: nginx-service
spec:
  hosts:
  - "$MYDOMAIN"  
  gateways:
  - test-gateway
  http:
  - route:
    - destination:
        host: svc-clusterip
        port:
          number: 80
EOF
```


ingressgatewayë¥¼ ì‚´í´ë³´ë©´, ê´€ë ¨ ì„¤ì •ì„ Envoyì— ì™„ë£Œí•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/istio/10.png)


ì´ì œ ë„ë©”ì¸ìœ¼ë¡œ ì‹¤ì œ ì ‘ì†í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ ì •ìƒ í†µì‹ ëœë‹¤.


![image.png](/assets/img/post/istio/11.png)


#### Proxy-config í™•ì¸

- ì´ì œ proxy-configë¥¼ í™•ì¸í•´ë³¸ë‹¤.

```bash
docker exec -it myk8s-control-plane istioctl proxy-config all deploy-websrv-778ffd6947-mv2wj.default
Istio Version:       1.23.2
Istio Proxy Version: 6c72b2179f5a58988b920a55b0be8346de3f7b35
Envoy Version:       1.31.2-dev/Clean/RELEASE/BoringSSL

NAME                                                                            SERVICE FQDN                                            PORT      SUBSET     DIRECTION     TYPE             DESTINATION RULE
cluster/inbound|80||                                                                                                                    80        -          inbound       ORIGINAL_DST
cluster/BlackHoleCluster                                                        cluster/BlackHoleCluster                                -         -          -             STATIC
cluster/InboundPassthroughCluster                                               cluster/InboundPassthroughCluster                       -         -          -             ORIGINAL_DST
cluster/PassthroughCluster                                                      cluster/PassthroughCluster                              -         -          -             ORIGINAL_DST
cluster/agent                                                                   cluster/agent                                           -         -          -             STATIC
cluster/outbound|80||istio-ingressgateway.istio-system.svc.cluster.local        istio-ingressgateway.istio-system.svc.cluster.local     80        -          outbound      EDS
cluster/outbound|443||istio-ingressgateway.istio-system.svc.cluster.local       istio-ingressgateway.istio-system.svc.cluster.local     443       -          outbound      EDS
cluster/outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local     istio-ingressgateway.istio-system.svc.cluster.local     15021     -          outbound      EDS
cluster/outbound|443||istiod.istio-system.svc.cluster.local                     istiod.istio-system.svc.cluster.local                   443       -          outbound      EDS
cluster/outbound|15010||istiod.istio-system.svc.cluster.local                   istiod.istio-system.svc.cluster.local                   15010     -          outbound      EDS
cluster/outbound|15012||istiod.istio-system.svc.cluster.local                   istiod.istio-system.svc.cluster.local                   15012     -          outbound      EDS
cluster/outbound|15014||istiod.istio-system.svc.cluster.local                   istiod.istio-system.svc.cluster.local                   15014     -          outbound      EDS
cluster/outbound|53||kube-dns.kube-system.svc.cluster.local                     kube-dns.kube-system.svc.cluster.local                  53        -          outbound      EDS
cluster/outbound|9153||kube-dns.kube-system.svc.cluster.local                   kube-dns.kube-system.svc.cluster.local                  9153      -          outbound      EDS
cluster/outbound|443||kubernetes.default.svc.cluster.local                      kubernetes.default.svc.cluster.local                    443       -          outbound      EDS
cluster/prometheus_stats                                                        cluster/prometheus_stats                                -         -          -             STATIC
cluster/sds-grpc                                                                cluster/sds-grpc                                        -         -          -             STATIC
cluster/outbound|80||svc-clusterip.default.svc.cluster.local                    svc-clusterip.default.svc.cluster.local                 80        -          outbound      EDS
cluster/xds-grpc                                                                cluster/xds-grpc                                        -         -          -             STATIC

```


ListenerëŠ” ê° ì„œë¹„ìŠ¤ì— ëŒ€í•œ ìš”ì²­ì„ ë°›ëŠ” ê³³ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì´ ì‹¤ì œ ì„œë¹„ìŠ¤ IPì— ëŒ€í•œ ëª¨ë“  Listenerë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/istio/12.png)


```bash
NAME                       ADDRESSES   PORT  MATCH                                                               DESTINATION
listener/10.200.1.10_53    10.200.1.10 53    ALL                                                                 Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local
listener/0.0.0.0_80        0.0.0.0     80    Trans: raw_buffer; App: http/1.1,h2c                                Route: 80
listener/0.0.0.0_80        0.0.0.0     80    ALL                                                                 PassthroughCluster
listener/10.200.1.34_80    10.200.1.34 80    Trans: raw_buffer; App: http/1.1,h2c                                Route: svc-clusterip.default.svc.cluster.local:80
listener/10.200.1.34_80    10.200.1.34 80    ALL                                                                 Cluster: outbound|80||svc-clusterip.default.svc.cluster.local
listener/10.200.1.1_443    10.200.1.1  443   ALL                                                                 Cluster: outbound|443||kubernetes.default.svc.cluster.local
listener/10.200.1.59_443   10.200.1.59 443   ALL                                                                 Cluster: outbound|443||istiod.istio-system.svc.cluster.local
listener/10.200.1.73_443   10.200.1.73 443   ALL                                                                 Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local
listener/10.200.1.10_9153  10.200.1.10 9153  Trans: raw_buffer; App: http/1.1,h2c                                Route: kube-dns.kube-system.svc.cluster.local:9153
listener/10.200.1.10_9153  10.200.1.10 9153  ALL                                                                 Cluster: outbound|9153||kube-dns.kube-system.svc.cluster.local
listener/virtualOutbound   0.0.0.0     15001 ALL                                                                 PassthroughCluster
...
NAME                                                                VHOST NAME                                                    DOMAINS                                              MATCH                  VIRTUAL SERVICE
route/svc-clusterip.default.svc.cluster.local:80                    svc-clusterip.default.svc.cluster.local:80                    *                                                    /*
route/istio-ingressgateway.istio-system.svc.cluster.local:15021     istio-ingressgateway.istio-system.svc.cluster.local:15021     *                                                    /*
route/80                                                            istio-ingressgateway.istio-system.svc.cluster.local:80        istio-ingressgateway.istio-system, 10.200.1.73       /*
route/80                                                            svc-clusterip.default.svc.cluster.local:80                    svc-clusterip, svc-clusterip.default + 1 more...     /*
route/15010                                                         istiod.istio-system.svc.cluster.local:15010                   istiod.istio-system, 10.200.1.59                     /*
route/15014                                                         istiod.istio-system.svc.cluster.local:15014                   istiod.istio-system, 10.200.1.59                     /*
route/kube-dns.kube-system.svc.cluster.local:9153                   kube-dns.kube-system.svc.cluster.local:9153                   *                                                    /*
route/inbound|80||                                                  inbound|http|80                                               *                                                    /*
route/                                                              backend                                                       *                                                    /stats/prometheus*
route/                                                              backend                                                       *                                                    /healthz/ready*
route/InboundPassthroughCluster                                     inbound|http|0                                                *                                                    /*
route/InboundPassthroughCluster                                     inbound|http|0                                                *                                                    /*
route/inbound|80||                                                  inbound|http|80                                               *                                                    /*

```


ì—”ë“œí¬ì¸íŠ¸ ë¶€ë¶„ì„ ì‚´í´ë³´ë©´, ì‹¤ì œ íŒŒë“œ ì—”ë“œí¬ì¸íŠ¸(10.10.0.7)ì™€ istioì™€ ê´€ë ¨ëœ ì—”ë“œí¬ì¸íŠ¸ì™€ CoreDNS ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸(dns port 53ì‚¬ìš©)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/istio/13.png)


```bash
NAME                                                      STATUS      LOCALITY     CLUSTER
endpoint/10.10.0.7:80                                     HEALTHY                  inbound|80||
endpoint/127.0.0.1:15020                                  HEALTHY                  agent
endpoint/10.10.0.6:8080                                   HEALTHY                  outbound|80||istio-ingressgateway.istio-system.svc.cluster.local
endpoint/10.10.0.6:8443                                   HEALTHY                  outbound|443||istio-ingressgateway.istio-system.svc.cluster.local
endpoint/10.10.0.6:15021                                  HEALTHY                  outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local
endpoint/10.10.0.5:15017                                  HEALTHY                  outbound|443||istiod.istio-system.svc.cluster.local
endpoint/10.10.0.5:15010                                  HEALTHY                  outbound|15010||istiod.istio-system.svc.cluster.local
endpoint/10.10.0.5:15012                                  HEALTHY                  outbound|15012||istiod.istio-system.svc.cluster.local
endpoint/10.10.0.5:15014                                  HEALTHY                  outbound|15014||istiod.istio-system.svc.cluster.local
endpoint/10.10.0.3:53                                     HEALTHY                  outbound|53||kube-dns.kube-system.svc.cluster.local
endpoint/10.10.0.4:53                                     HEALTHY                  outbound|53||kube-dns.kube-system.svc.cluster.local
endpoint/10.10.0.3:9153                                   HEALTHY                  outbound|9153||kube-dns.kube-system.svc.cluster.local
endpoint/10.10.0.4:9153                                   HEALTHY                  outbound|9153||kube-dns.kube-system.svc.cluster.local
...
```

- ì‹¤ì œ kubectl í¬íŠ¸ í¬ì›Œë”©ì„ í†µí•´ envoy ì»¨í…Œì´ë„ˆ admin í˜ì´ì§€ì— ì ‘ì†í•  ìˆ˜ ìˆë‹¤.

```bash
kubectl port-forward deployment/deploy-websrv 15000:15000 &

[1] 16270

Forwarding from 127.0.0.1:15000 -> 15000
Forwarding from [::1]:15000 -> 15000

open http://localhost:15000
```


![image.png](/assets/img/post/istio/14.png)


#### Bookinfo(Sample Application) ë° istio Addon ì„¤ì¹˜


Istioctlì—ì„œ ìƒ˜í”Œë¡œ ì œê³µí•´ì£¼ëŠ” bookinfo ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì„¤ì¹˜í•´ë³¸ë‹¤.


```bash
kubectl apply -f /istio-$ISTIOV/samples/bookinfo/platform/kube/bookinfo.yaml
service/details created
serviceaccount/bookinfo-details created
deployment.apps/details-v1 created
service/ratings created
serviceaccount/bookinfo-ratings created
deployment.apps/ratings-v1 created
service/reviews created
serviceaccount/bookinfo-reviews created
deployment.apps/reviews-v1 created
deployment.apps/reviews-v2 created
deployment.apps/reviews-v3 created
service/productpage created
serviceaccount/bookinfo-productpage created
deployment.apps/productpage-v1 created
```


```bash

kubectl apply -f /istio-$ISTIOV/samples/bookinfo/networking/bookinfo-gateway.yaml
gateway.networking.istio.io/bookinfo-gateway created
virtualservice.networking.istio.io/bookinfo created
```


```bash
kubectl apply -f /istio-$ISTIOV/samples/addons 
kubectl rollout status deployment/kiali -n istio-system
```


ì‹¤ì œ 30000í¬íŠ¸ë¡œ ì ‘ì†í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì€ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ í˜ì´ì§€ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/istio/15.png)


#### kiali


kialië¥¼ í†µí•´ íŠ¸ë˜í”½ ê·¸ë˜í”„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 


í˜„ì¬ëŠ” 1000ê°œ ì •ë„ì˜ ìš”ì²­ì„ ë³´ë‚¸ ìƒíƒœì¸ë°, reviewë¥¼ ì˜ í™•ì¸í•˜ë©´ ì ì ˆí•˜ê²Œ ë¡œë“œë°¸ëŸ°ì‹±ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/istio/16.png)

