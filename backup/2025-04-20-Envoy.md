---
layout: post
title: Envoy
date: 2025-04-20 09:00 +0900 
description: Envoy ì‚´í´ë³´ê¸°
category: [Kubernetes, Network] 
tags: [istio, CloudNet, Kubernetes, Network, istio#2, Envoy] 
pin: false
math: true
mermaid: true
---
Envoy ì‚´í´ë³´ê¸°
<!--more-->


> ğŸ’¡ **KANS ìŠ¤í„°ë””**  
> CloudNetì—ì„œ ì£¼ê´€í•˜ëŠ” istio(Istio Hands-on Study) 1ê¸° ìŠ¤í„°ë””ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê¸€ì€ ìŠ¤í„°ë””ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
>   
> ìŠ¤í„°ë””ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹  ë¶„ì€ [CloudNet Blog](/c9dfa44a27ff431dafdd2edacc8a1863)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.



### ë“¤ì–´ê°€ë©°


ì´ë²ˆ ì£¼ì°¨ì—ëŠ” istioì—ì„œ í”„ë¡ì‹œë¡œ ì‚¬ìš©í•˜ëŠ” ì—”ë³´ì´ì˜ êµ¬ì„±ë°©ì‹ì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ê³  Istio Gatwayì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³¼ ì˜ˆì •ì´ë‹¤.


### Envoyë€


ì—”ë³´ì´ëŠ” ë¦¬í”„íŠ¸ê°€ ê°œë°œí•œ í”„ë¡ì‹œ í”„ë¡œì íŠ¸ë¡œ, 2017ë…„ 9ì›”ì— CNCFì— í•©ë¥˜í–ˆë‹¤. ì—”ë³´ì´ì˜ ì£¼ìš” ëª©í‘œ ì¤‘ì— í•˜ë‚˜ê°€ ì„±ëŠ¥ì´ì—ˆê¸°ì— C++ë¡œ ì‘ì„±ë˜ì—ˆê³  íŠ¹íˆ ë†’ì€ ë¶€í•˜ì—ì„œë„ ì•ˆì •ì ì¸ ì„±ëŠ¥ì„ ë§Œë“œëŠ” ê²ƒì´ ëª©í‘œì˜€ë‹¤ê³ í•œë‹¤.


### êµ¬ì„±

- ë¦¬ìŠ¤ë„ˆ(Listeners)
	- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—°ê²°í•  ìˆ˜ ìˆëŠ” ì™¸ë¶€ ì„¸ê³„ë¡œ í¬íŠ¸ë¥¼ ë…¸ì¶œí•œë‹¤. ex) 80í¬íŠ¸ë¡œ ë“¤ì–´ì˜¤ë©´ â†’ A ë¼ìš°íŒ… ì ìš©
- ë¼ìš°íŠ¸(Routes)
	- ë¦¬ìŠ¤ë„ˆë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ëŠ” ë¼ìš°íŒ… ê·œì¹™
	- ex) ìš”ì²­ì´ ë“¤ì–´ì˜¤ê³  `/catalog` ì— ì¼ì¹˜í•˜ë©´ ê·¸ íŠ¸ë˜í”½ì„ catalog í´ëŸ¬ìŠ¤í„°ë¡œ ë³´ë‚´ëŠ” ì‹ì´ë‹¤.
- í´ëŸ¬ìŠ¤í„°(Cluster)
	- ì—”ë³´ì´ê°€ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•  ìˆ˜ ìˆëŠ” íŠ¹ì • ì—…ìŠ¤íŠ¸ë¦¼ ì„œë¹„ìŠ¤, ì˜ˆë¥¼ ë“¤ì–´ catalog-v1 ê³¼ catalog-v2 ëŠ” ë³„ë„ í´ëŸ¬ìŠ¤í„°ì¼ ìˆ˜ ìˆê³ ,
	- ë£¨íŠ¸ëŠ” catalog ì„œë¹„ìŠ¤ì˜ v1ì´ë‚˜ v2ë¡œ íŠ¸ë˜í”½ì„ ë³´ë‚´ëŠ” ë°©ë²•ì— ëŒ€í•œ ê·œì¹™ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

### í•µì‹¬ ê¸°ëŠ¥


ì—”ë³´ì´ëŠ” ë¶„ì‚° ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ë•Œ ë°œìƒí•˜ëŠ” ì–´ë ¤ìš´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë„¤íŠ¸ì›Œí‚¹ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ **ì™¸ë¶€**ì—ì„œ ì•„ë˜ì™€ ê°™ì€ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

- ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬
	- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ì˜ ë™ì‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í”„ë¡ì‹œ
	- ëŸ°íƒ€ì„ ì œì–´ë¥¼ ìœ„í•´ ë™ì  API ì‚¬ìš©
- ë„¤íŠ¸ì›Œí¬ ë³µì›ë ¥
- Observability
- ê¸°ë³¸ì ì¸ í”„ë¡ì‹œ ê¸°ëŠ¥(ë¡œë“œ ë°¸ëŸ°ì‹±, íŠ¸ë˜í”½ ë° ë¼ìš°íŒ…, íŠ¸ë˜í”½ ì „í™˜ ë° ìƒˆë„ì‰ ê¸°ëŠ¥)

## Envoy in action


### í™˜ê²½ êµ¬ì„±


ì‹¤ìŠµì„ ìœ„í•´ì„  **Docker, Kind**(kubernetes in docker) ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.


#### setup


istio in actions ì½”ë“œ ë³µì‚¬


```bash
git clone https://github.com/AcornPublishing/istio-in-action
cd istio-in-action/book-source-code-master
```


envoy ë“± ì‹¤ìŠµì— í•„ìš”í•œ ì´ë¯¸ì§€ ì…‹ì—…


```bash
docker pull envoyproxy/envoy:v1.19.0
docker pull curlimages/curl # í´ë¼ì´ì–¸íŠ¸ ì—­í• 
docker pull mccutchen/go-httpbin # ì• í”Œë¦¬ì¼€ì´ì…˜ ì—­í• 
```


í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ê°€ì ¸ì˜¨ 3ê°œì˜ ì´ë¯¸ì§€ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.


```bash
docker image ls
REPOSITORY             TAG       IMAGE ID       CREATED       SIZE
curlimages/curl        latest    e507f3e43db3   13 days ago   21.9MB
mccutchen/go-httpbin   latest    18fc7a0469d6   2 weeks ago   38.1MB
envoyproxy/envoy       v1.19.0   f48f130ac643   3 years ago   134MB
```


#### ì„œë¹„ìŠ¤ ì‹¤í–‰


ì´ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—­í• ì„ ë‹´ë‹¹í•˜ëŠ” go-httpbin ì„œë¹„ìŠ¤ë¥¼ `8000`í¬íŠ¸ë¡œ ì‹¤í–‰í•œë‹¤. 


ì‹¤í–‰ í›„ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì™€ì•¼í•œë‹¤.


```bash
docker run -it --rm --link httpbin curlimages/curl curl -X GET http://httpbin:8000/headers
{
  "headers": {
    "Accept": [
      "*/*"
    ],
    "Host": [
      "httpbin:8000"
    ],
    "User-Agent": [
      "curl/8.13.0"
    ]
  }
}
```


#### envoy ë°°í¬


ê¸°ì¡´ istio in actionsì˜ ì½”ë“œ ì¤‘ ì„¤ì •íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ì¡°ê¸ˆ ìˆ˜ì •í•œë‹¤.(ch3/simple.yaml)


```bash
admin:
  address:
    socket_address: { address: 0.0.0.0, port_value: 15000 }

static_resources:
  listeners:
  - name: httpbin-demo
    address:
      socket_address: { address: 0.0.0.0, port_value: 15001 }
    filter_chains:
    - filters:
      - name:  envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          - name: envoy.filters.http.router
          route_config:
            name: httpbin_local_route
            virtual_hosts:
            - name: httpbin_local_service
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route:
                  auto_host_rewrite: true
                  cluster: httpbin_service
  clusters:
    - name: httpbin_service
      connect_timeout: 5s
      type: LOGICAL_DNS
      dns_lookup_family: V4_ONLY
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: httpbin
        endpoints:
        - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: httpbin
                  port_value: 8000

```


**ë°°í¬**: ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì—”ë³´ì´ë¥¼ ì‹¤í–‰í•œë‹¤.


```bash
docker run --name proxy --link httpbin envoyproxy/envoy:v1.19.0 --config-yaml "$(cat ch3/simple.yaml)"
```


ì»¨í…Œì´ë„ˆë¥¼ ì˜ì˜¬ë¼ì˜¨ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆê³ ,


```bash
[root@ip-172-31-7-43 istio-in-action]# docker ps
CONTAINER ID   IMAGE                      COMMAND                  CREATED          STATUS          PORTS       NAMES
5df6f9b5e6db   envoyproxy/envoy:v1.19.0   "/docker-entrypoint.â€¦"   5 minutes ago    Up 5 minutes    10000/tcp   proxy
37b25e0885d0   mccutchen/go-httpbin       "/bin/go-httpbin"        17 minutes ago   Up 17 minutes   8080/tcp    httpbin
```


curlë¡œ í”„ë¡ì‹œë¥¼ í˜¸ì¶œí•´ë„ httpbin ì„œë¹„ìŠ¤ë¡œ ì˜ ë¼ìš°íŒ…ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
docker run -it --rm --link proxy curlimages/curl curl -X GET http://proxy:15001/headers
```


![image.png](/assets/img/post/Envoy/1.png)


### envoy ê¸°ëŠ¥ ì‚¬ìš©í•´ë³´ê¸°


#### timout


ì•„ë˜ì˜ static_resources.listeners ìª½ route ê·œì¹™ì— íƒ€ì„ì•„ì›ƒì„ 1ì´ˆë¡œ ì„¤ì •í•œë‹¤.


```yaml
admin:
  address:
    socket_address: { address: 0.0.0.0, port_value: 15000 }

static_resources:
  listeners:
  - name: httpbin-demo
    address:
      socket_address: { address: 0.0.0.0, port_value: 15001 }
    filter_chains:
    - filters:
      - name:  envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          - name: envoy.filters.http.router
          route_config:
            name: httpbin_local_route
            virtual_hosts:
            - name: httpbin_local_service
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route:
                  auto_host_rewrite: true
                  cluster: httpbin_service
                  timeout: 1s
  clusters:
    - name: httpbin_service
      connect_timeout: 5s
      type: LOGICAL_DNS
      dns_lookup_family: V4_ONLY
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: httpbin
        endpoints:
        - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: httpbin
                  port_value: 8000
```


ì´ì œ í”„ë¡ì‹œì— ì ‘ê·¼í•˜ì—¬ í™•ì¸í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ `X-Envoy-Expected-Rq-Timeout-Ms` ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


```bash
[root@ip-172-31-7-43 istio-in-action]# docker run -it --rm --link proxy curlimages/curl curl -X GET http://proxy:15001/headers
{
  "headers": {
    "Accept": [
      "*/*"
    ],
    "Host": [
      "httpbin"
    ],
    "User-Agent": [
      "curl/8.13.0"
    ],
    "X-Envoy-Expected-Rq-Timeout-Ms": [
      "1000"
    ],
    "X-Forwarded-Proto": [
      "http"
    ],
    "X-Request-Id": [
      "7e634235-ba15-4ead-b708-864a55f3d66e"
    ]
  }
}
```


ì‹¤ì œ httpbin ì„œë¹„ìŠ¤ì˜ ì˜ë„ì ì¸ ë”œë ˆì´ëœ ìš”ì²­ì„ í˜¸ì¶œí•´ë³´ì


ì•„ë˜ì˜ ëª…ë ¹ì–´ì—ì„œ `delay/{ì‹œê°„(s)}` ë°©ì‹ìœ¼ë¡œ ë”œë ˆì´ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.


```bash
docker run -it --rm --link proxy curlimages/curl curl -X GET http://proxy:15001/delay/0.5
```


ê²°ê³¼ í™•ì¸í•˜ê¸°


0.5ì´ˆì¼ ë•ŒëŠ” ì •ìƒì ìœ¼ë¡œ ì‘ë‹µì„ ë°›ì§€ë§Œ, 1ì´ˆë¥¼ ë„˜ëŠ” ìˆœê°„ timeoutì´ ë°œìƒí•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.


![image.png](/assets/img/post/Envoy/2.png)


#### retry


ì•„ë˜ì˜ static_resources.listeners ìª½ route ê·œì¹™ì— retry ì •ì±…ì„ ì„¤ì •í•œë‹¤.


```yaml
admin:
  address:
    socket_address: { address: 0.0.0.0, port_value: 15000 }

static_resources:
  listeners:
  - name: httpbin-demo
    address:
      socket_address: { address: 0.0.0.0, port_value: 15001 }
    filter_chains:
    - filters:
      - name:  envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          - name: envoy.filters.http.router
          route_config:
            name: httpbin_local_route
            virtual_hosts:
            - name: httpbin_local_service
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route:
                  auto_host_rewrite: true
                  cluster: httpbin_service
                  retry_policy:
                    retry_on: 5xx  # 5xx ì¼ë•Œ ì¬ì‹œë„
                    num_retries: 3 # ì¬ì‹œë„ íšŸìˆ˜
  clusters:
    - name: httpbin_service
      connect_timeout: 5s
      type: LOGICAL_DNS
      dns_lookup_family: V4_ONLY
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: httpbin
        endpoints:
        - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: httpbin
                  port_value: 8000
```


ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ 500ì—ëŸ¬ ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” ì„œë¹„ìŠ¤ ê²½ë¡œë¡œ ìš”ì²­í•œë‹¤.


```bash
docker run -it --rm --link proxy curlimages/curl curl -X GET http://proxy:15001/status/500
```


ì—”ë³´ì´ëŠ” 5xx ì‘ë‹µì—ëŒ€í•´ ì¬ì‹œë„ë¥¼ 3ë²ˆ ì‹œë„í•œë‹¤.


í•„ìëŠ” ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ 3ë²ˆ ì‹¤í–‰(3ë²ˆì˜ ìš”ì²­)ì„ ì§„í–‰í–ˆê¸°ì— ì•„ë˜ì™€ ê°™ì´ ìƒíƒœë¥¼ í™•ì¸í•˜ë©´ retry íšŸìˆ˜ê°€ 9ë²ˆì„ì„ ë³¼ ìˆ˜ ìˆë‹¤.


```bash
[root@ip-172-31-7-43 book-source-code-master]# docker run -it --rm --link proxy curlimages/curl curl -X GET http://proxy:15000/stats | grep retry
cluster.httpbin_service.circuit_breakers.default.rq_retry_open: 0
cluster.httpbin_service.circuit_breakers.high.rq_retry_open: 0
cluster.httpbin_service.retry.upstream_rq_500: 9
cluster.httpbin_service.retry.upstream_rq_5xx: 9
cluster.httpbin_service.retry.upstream_rq_completed: 9
cluster.httpbin_service.retry_or_shadow_abandoned: 0
cluster.httpbin_service.upstream_rq_retry: 9
cluster.httpbin_service.upstream_rq_retry_backoff_exponential: 9
cluster.httpbin_service.upstream_rq_retry_backoff_ratelimited: 0
cluster.httpbin_service.upstream_rq_retry_limit_exceeded: 3
cluster.httpbin_service.upstream_rq_retry_overflow: 0
cluster.httpbin_service.upstream_rq_retry_success: 0
vhost.httpbin_local_service.vcluster.other.upstream_rq_retry: 0
vhost.httpbin_local_service.vcluster.other.upstream_rq_retry_limit_exceeded: 0
vhost.httpbin_local_service.vcluster.other.upstream_rq_retry_overflow: 0
vhost.httpbin_local_service.vcluster.other.upstream_rq_retry_success: 0
```


### ë§ˆì¹˜ë©°


ì‹¤ì œ ì—”ë³´ì´ í”„ë¡ì‹œë¥¼ dockerë¡œ ë„ì–´ ì—¬ëŸ¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë´¤ë‹¤. ì—”ë³´ì´ì˜ ìœ ì—°í•œ L7ê¸°ëŠ¥(ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€)ê³¼ ë³µì›ì„± ë•ë¶„ì— istioì—ì„œ í”„ë¡ì‹œë¡œ ì‚¬ìš©í•˜ê³  ìˆë‹¤. íŠ¹íˆ APIë¥¼ í†µí•´ ì¬ì‹¤í–‰ì—†ì´ ë™ì ìœ¼ë¡œ ì„¤ì • ë³€ê²½ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒë„ í° ì¥ì ì¸ ê²ƒ ê°™ë‹¤. ë‹¤ìŒ í¸ì—ì„œëŠ” istio gatewayì— ëŒ€í•´ ì•Œì•„ë³¼ ì˜ˆì •ì´ë‹¤.

